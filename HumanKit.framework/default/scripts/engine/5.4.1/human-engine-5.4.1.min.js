/*
 * Human Engine v5.4.1
 *
 * (c) 2015 BioDigital, Inc.
 *
 * Built: Wed Feb 03 2016 12:10:37 GMT-0500 (EST)
 */

/*
 * SceneJS V4.2.0
 *
 * A WebGL-based 3D scene graph from xeoLabs
 * http://scenejs.org/
 *
 * Built on 2015-04-21
 *
 * MIT License
 * Copyright 2015, Lindsay Kay
 * http://xeolabs.com/
 *
 */
if(void 0===require){var requirejs,require,define;!function(ba){function J(a){return"[object Function]"===N.call(a)}function K(a){return"[object Array]"===N.call(a)}function z(a,b){if(a){var c;for(c=0;c<a.length&&(!a[c]||!b(a[c],c,a));c+=1);}}function O(a,b){if(a){var c;for(c=a.length-1;c>-1&&(!a[c]||!b(a[c],c,a));c-=1);}}function t(a,b){return ha.call(a,b)}function m(a,b){return t(a,b)&&a[b]}function H(a,b){for(var c in a)if(t(a,c)&&b(a[c],c))break}function S(a,b,c,d){return b&&H(b,function(b,e){(c||!t(a,e))&&(d&&"string"!=typeof b?(a[e]||(a[e]={}),S(a[e],b,c,d)):a[e]=b)}),a}function v(a,b){return function(){return b.apply(a,arguments)}}function ca(a){throw a}function da(a){if(!a)return a;var b=ba;return z(a.split("."),function(a){b=b[a]}),b}function B(a,b,c,d){return b=Error(b+"\nhttp://requirejs.org/docs/errors.html#"+a),b.requireType=a,b.requireModules=d,c&&(b.originalError=c),b}function ia(a){function b(a,b,c){var d,e,f,g,h,i,j,k=b&&b.split("/");d=k;var l=C.map,n=l&&l["*"];if(a&&"."===a.charAt(0))if(b){for(d=m(C.pkgs,b)?k=[b]:k.slice(0,k.length-1),b=a=d.concat(a.split("/")),d=0;b[d];d+=1)if(e=b[d],"."===e)b.splice(d,1),d-=1;else if(".."===e){if(1===d&&(".."===b[2]||".."===b[0]))break;d>0&&(b.splice(d-1,2),d-=2)}d=m(C.pkgs,b=a[0]),a=a.join("/"),d&&a===b+"/"+d.main&&(a=b)}else 0===a.indexOf("./")&&(a=a.substring(2));if(c&&l&&(k||n)){for(b=a.split("/"),d=b.length;d>0;d-=1){if(f=b.slice(0,d).join("/"),k)for(e=k.length;e>0;e-=1)if((c=m(l,k.slice(0,e).join("/")))&&(c=m(c,f))){g=c,h=d;break}if(g)break;!i&&n&&m(n,f)&&(i=m(n,f),j=d)}!g&&i&&(g=i,h=j),g&&(b.splice(0,h,g),a=b.join("/"))}return a}function c(a){A&&z(document.getElementsByTagName("script"),function(b){return b.getAttribute("data-requiremodule")===a&&b.getAttribute("data-requirecontext")===w.contextName?(b.parentNode.removeChild(b),!0):void 0})}function d(a){var b=m(C.paths,a);return b&&K(b)&&1<b.length?(c(a),b.shift(),w.require.undef(a),w.require([a]),!0):void 0}function e(a){var b,c=a?a.indexOf("!"):-1;return c>-1&&(b=a.substring(0,c),a=a.substring(c+1,a.length)),[b,a]}function f(a,c,d,f){var g,h,i=null,j=c?c.name:null,k=a,l=!0,n="";return a||(l=!1,a="_@r"+(M+=1)),a=e(a),i=a[0],a=a[1],i&&(i=b(i,j,f),h=m(I,i)),a&&(i?n=h&&h.normalize?h.normalize(a,function(a){return b(a,j,f)}):b(a,j,f):(n=b(a,j,f),a=e(n),i=a[0],n=a[1],d=!0,g=w.nameToUrl(n))),d=!i||h||d?"":"_unnormalized"+(N+=1),{prefix:i,name:n,parentMap:c,unnormalized:!!d,url:g,originalName:k,isDefine:l,id:(i?i+"!"+n:n)+d}}function g(a){var b=a.id,c=m(D,b);return c||(c=D[b]=new w.Module(a)),c}function i(a,b,c){var d=a.id,e=m(D,d);!t(I,d)||e&&!e.defineEmitComplete?(e=g(a),e.error&&"error"===b?c(e.error):e.on(b,c)):"defined"===b&&c(I[d])}function j(a,b){var c=a.requireModules,d=!1;b?b(a):(z(c,function(b){(b=m(D,b))&&(b.error=a,b.events.error&&(d=!0,b.emit("error",a)))}),d||h.onError(a))}function k(){U.length&&(ja.apply(G,[G.length-1,0].concat(U)),U=[])}function l(a){delete D[a],delete E[a]}function n(a,b,c){var d=a.map.id;a.error?a.emit("error",a.error):(b[d]=!0,z(a.depMaps,function(d,e){var f=d.id,g=m(D,f);g&&!a.depMatched[e]&&!c[f]&&(m(b,f)?(a.defineDep(e,I[f]),a.check()):n(g,b,c))}),c[d]=!0)}function o(){var a,b,e,f,g=(e=1e3*C.waitSeconds)&&w.startTime+e<(new Date).getTime(),h=[],i=[],k=!1,l=!0;if(!s){if(s=!0,H(E,function(e){if(a=e.map,b=a.id,e.enabled&&(a.isDefine||i.push(e),!e.error))if(!e.inited&&g)d(b)?k=f=!0:(h.push(b),c(b));else if(!e.inited&&e.fetched&&a.isDefine&&(k=!0,!a.prefix))return l=!1}),g&&h.length)return e=B("timeout","Load timeout for modules: "+h,null,h),e.contextName=w.contextName,j(e);l&&z(i,function(a){n(a,{},{})}),g&&!f||!k||!A&&!ea||y||(y=setTimeout(function(){y=0,o()},50)),s=!1}}function p(a){t(I,a[0])||g(f(a[0],null,!0)).init(a[1],a[2])}function q(a){var a=a.currentTarget||a.srcElement,b=w.onScriptLoad;return a.detachEvent&&!Z?a.detachEvent("onreadystatechange",b):a.removeEventListener("load",b,!1),b=w.onScriptError,(!a.detachEvent||Z)&&a.removeEventListener("error",b,!1),{node:a,id:a&&a.getAttribute("data-requiremodule")}}function r(){var a;for(k();G.length;){if(a=G.shift(),null===a[0])return j(B("mismatch","Mismatched anonymous define() module: "+a[a.length-1]));p(a)}}var s,u,w,x,y,C={waitSeconds:7,baseUrl:"./",paths:{},pkgs:{},shim:{},config:{}},D={},E={},F={},G=[],I={},L={},M=1,N=1;return x={require:function(a){return a.require?a.require:a.require=w.makeRequire(a.map)},exports:function(a){return a.usingExports=!0,a.map.isDefine?a.exports?a.exports:a.exports=I[a.map.id]={}:void 0},module:function(a){return a.module?a.module:a.module={id:a.map.id,uri:a.map.url,config:function(){var b=m(C.pkgs,a.map.id);return(b?m(C.config,a.map.id+"/"+b.main):m(C.config,a.map.id))||{}},exports:I[a.map.id]}}},u=function(a){this.events=m(F,a.id)||{},this.map=a,this.shim=m(C.shim,a.id),this.depExports=[],this.depMaps=[],this.depMatched=[],this.pluginMaps={},this.depCount=0},u.prototype={init:function(a,b,c,d){d=d||{},this.inited||(this.factory=b,c?this.on("error",c):this.events.error&&(c=v(this,function(a){this.emit("error",a)})),this.depMaps=a&&a.slice(0),this.errback=c,this.inited=!0,this.ignore=d.ignore,d.enabled||this.enabled?this.enable():this.check())},defineDep:function(a,b){this.depMatched[a]||(this.depMatched[a]=!0,this.depCount-=1,this.depExports[a]=b)},fetch:function(){if(!this.fetched){this.fetched=!0,w.startTime=(new Date).getTime();var a=this.map;if(!this.shim)return a.prefix?this.callPlugin():this.load();w.makeRequire(this.map,{enableBuildCallback:!0})(this.shim.deps||[],v(this,function(){return a.prefix?this.callPlugin():this.load()}))}},load:function(){var a=this.map.url;L[a]||(L[a]=!0,w.load(this.map.id,a))},check:function(){if(this.enabled&&!this.enabling){var a,b,c=this.map.id;b=this.depExports;var d=this.exports,e=this.factory;if(this.inited){if(this.error)this.emit("error",this.error);else if(!this.defining){if(this.defining=!0,1>this.depCount&&!this.defined){if(J(e)){if(this.events.error&&this.map.isDefine||h.onError!==ca)try{d=w.execCb(c,e,b,d)}catch(f){a=f}else d=w.execCb(c,e,b,d);if(this.map.isDefine&&((b=this.module)&&void 0!==b.exports&&b.exports!==this.exports?d=b.exports:void 0===d&&this.usingExports&&(d=this.exports)),a)return a.requireMap=this.map,a.requireModules=this.map.isDefine?[this.map.id]:null,a.requireType=this.map.isDefine?"define":"require",j(this.error=a)}else d=e;this.exports=d,this.map.isDefine&&!this.ignore&&(I[c]=d,h.onResourceLoad)&&h.onResourceLoad(w,this.map,this.depMaps),l(c),this.defined=!0}this.defining=!1,this.defined&&!this.defineEmitted&&(this.defineEmitted=!0,this.emit("defined",this.exports),this.defineEmitComplete=!0)}}else this.fetch()}},callPlugin:function(){var a=this.map,c=a.id,d=f(a.prefix);this.depMaps.push(d),i(d,"defined",v(this,function(d){var e,k;k=this.map.name;var n=this.map.parentMap?this.map.parentMap.name:null,o=w.makeRequire(a.parentMap,{enableBuildCallback:!0});this.map.unnormalized?(d.normalize&&(k=d.normalize(k,function(a){return b(a,n,!0)})||""),d=f(a.prefix+"!"+k,this.map.parentMap),i(d,"defined",v(this,function(a){this.init([],function(){return a},null,{enabled:!0,ignore:!0})})),(k=m(D,d.id))&&(this.depMaps.push(d),this.events.error&&k.on("error",v(this,function(a){this.emit("error",a)})),k.enable())):(e=v(this,function(a){this.init([],function(){return a},null,{enabled:!0})}),e.error=v(this,function(a){this.inited=!0,this.error=a,a.requireModules=[c],H(D,function(a){0===a.map.id.indexOf(c+"_unnormalized")&&l(a.map.id)}),j(a)}),e.fromText=v(this,function(b,d){var i=a.name,k=f(i),l=Q;d&&(b=d),l&&(Q=!1),g(k),t(C.config,c)&&(C.config[i]=C.config[c]);try{h.exec(b)}catch(m){return j(B("fromtexteval","fromText eval for "+c+" failed: "+m,m,[c]))}l&&(Q=!0),this.depMaps.push(k),w.completeLoad(i),o([i],e)}),d.load(a.name,o,e,C))})),w.enable(d,this),this.pluginMaps[d.id]=d},enable:function(){E[this.map.id]=this,this.enabling=this.enabled=!0,z(this.depMaps,v(this,function(a,b){var c,d;if("string"==typeof a){if(a=f(a,this.map.isDefine?this.map:this.map.parentMap,!1,!this.skipMap),this.depMaps[b]=a,c=m(x,a.id))return void(this.depExports[b]=c(this));this.depCount+=1,i(a,"defined",v(this,function(a){this.defineDep(b,a),this.check()})),this.errback&&i(a,"error",v(this,this.errback))}c=a.id,d=D[c],!t(x,c)&&d&&!d.enabled&&w.enable(a,this)})),H(this.pluginMaps,v(this,function(a){var b=m(D,a.id);b&&!b.enabled&&w.enable(a,this)})),this.enabling=!1,this.check()},on:function(a,b){var c=this.events[a];c||(c=this.events[a]=[]),c.push(b)},emit:function(a,b){z(this.events[a],function(a){a(b)}),"error"===a&&delete this.events[a]}},w={config:C,contextName:a,registry:D,defined:I,urlFetched:L,defQueue:G,Module:u,makeModuleMap:f,nextTick:h.nextTick,onError:j,configure:function(a){a.baseUrl&&"/"!==a.baseUrl.charAt(a.baseUrl.length-1)&&(a.baseUrl+="/");var b=C.pkgs,c=C.shim,d={paths:!0,config:!0,map:!0};H(a,function(a,b){d[b]?"map"===b?(C.map||(C.map={}),S(C[b],a,!0,!0)):S(C[b],a,!0):C[b]=a}),a.shim&&(H(a.shim,function(a,b){K(a)&&(a={deps:a}),!a.exports&&!a.init||a.exportsFn||(a.exportsFn=w.makeShimExports(a)),c[b]=a}),C.shim=c),a.packages&&(z(a.packages,function(a){a="string"==typeof a?{name:a}:a,b[a.name]={name:a.name,location:a.location||a.name,main:(a.main||"main").replace(ka,"").replace(fa,"")}}),C.pkgs=b),H(D,function(a,b){!a.inited&&!a.map.unnormalized&&(a.map=f(b))}),(a.deps||a.callback)&&w.require(a.deps||[],a.callback)},makeShimExports:function(a){return function(){var b;return a.init&&(b=a.init.apply(ba,arguments)),b||a.exports&&da(a.exports)}},makeRequire:function(c,d){function e(b,i,k){var l,m;return d.enableBuildCallback&&i&&J(i)&&(i.__requireJsBuild=!0),"string"==typeof b?J(i)?j(B("requireargs","Invalid require call"),k):c&&t(x,b)?x[b](D[c.id]):h.get?h.get(w,b,c,e):(l=f(b,c,!1,!0),l=l.id,t(I,l)?I[l]:j(B("notloaded",'Module name "'+l+'" has not been loaded yet for context: '+a+(c?"":". Use require([])")))):(r(),w.nextTick(function(){r(),m=g(f(null,c)),m.skipMap=d.skipMap,m.init(b,i,k,{enabled:!0}),o()}),e)}return d=d||{},S(e,{isBrowser:A,toUrl:function(a){var d,e=a.lastIndexOf("."),f=a.split("/")[0];return-1!==e&&("."!==f&&".."!==f||e>1)&&(d=a.substring(e,a.length),a=a.substring(0,e)),w.nameToUrl(b(a,c&&c.id,!0),d,!0)},defined:function(a){return t(I,f(a,c,!1,!0).id)},specified:function(a){return a=f(a,c,!1,!0).id,t(I,a)||t(D,a)}}),c||(e.undef=function(a){k();var b=f(a,c,!0),d=m(D,a);delete I[a],delete L[b.url],delete F[a],d&&(d.events.defined&&(F[a]=d.events),l(a))}),e},enable:function(a){m(D,a.id)&&g(a).enable()},completeLoad:function(a){var b,c,e=m(C.shim,a)||{},f=e.exports;for(k();G.length;){if(c=G.shift(),null===c[0]){if(c[0]=a,b)break;b=!0}else c[0]===a&&(b=!0);p(c)}if(c=m(D,a),!b&&!t(I,a)&&c&&!c.inited){if(C.enforceDefine&&(!f||!da(f)))return d(a)?void 0:j(B("nodefine","No define call for "+a,null,[a]));p([a,e.deps||[],e.exportsFn])}o()},nameToUrl:function(a,b,c){var d,e,f,g,i,j;if(h.jsExtRegExp.test(a))g=a+(b||"");else{for(d=C.paths,e=C.pkgs,g=a.split("/"),i=g.length;i>0;i-=1){if(j=g.slice(0,i).join("/"),f=m(e,j),j=m(d,j)){K(j)&&(j=j[0]),g.splice(0,i,j);break}if(f){a=a===f.name?f.location+"/"+f.main:f.location,g.splice(0,i,a);break}}g=g.join("/"),g+=b||(/\?/.test(g)||c?"":".js"),g=("/"===g.charAt(0)||g.match(/^[\w\+\.\-]+:/)?"":C.baseUrl)+g}return C.urlArgs?g+((-1===g.indexOf("?")?"?":"&")+C.urlArgs):g},load:function(a,b){h.load(w,a,b)},execCb:function(a,b,c,d){return b.apply(d,c)},onScriptLoad:function(a){("load"===a.type||la.test((a.currentTarget||a.srcElement).readyState))&&(R=null,a=q(a),w.completeLoad(a.id))},onScriptError:function(a){var b=q(a);return d(b.id)?void 0:j(B("scripterror","Script error for: "+b.id,a,[b.id]))}},w.require=w.makeRequire(),w}var h,x,y,E,L,F,R,M,s,ga,ma=/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/gm,na=/[^.]\s*require\s*\(\s*["']([^'"\s]+)["']\s*\)/g,fa=/\.js$/,ka=/^\.\//;x=Object.prototype;var N=x.toString,ha=x.hasOwnProperty,ja=Array.prototype.splice,A=!("undefined"==typeof window||!navigator||!window.document),ea=!A&&"undefined"!=typeof importScripts,la=A&&"PLAYSTATION 3"===navigator.platform?/^complete$/:/^(complete|loaded)$/,Z="undefined"!=typeof opera&&"[object Opera]"===opera.toString(),G={},u={},U=[],Q=!1;if("undefined"==typeof define){if("undefined"!=typeof requirejs){if(J(requirejs))return;u=requirejs,requirejs=void 0}"undefined"!=typeof require&&!J(require)&&(u=require,require=void 0),h=requirejs=function(a,b,c,d){var e,f="_";return!K(a)&&"string"!=typeof a&&(e=a,K(b)?(a=b,b=c,c=d):a=[]),e&&e.context&&(f=e.context),(d=m(G,f))||(d=G[f]=h.s.newContext(f)),e&&d.configure(e),d.require(a,b,c)},h.config=function(a){return h(a)},h.nextTick="undefined"!=typeof setTimeout?function(a){setTimeout(a,4)}:function(a){a()},require||(require=h),h.version="2.1.6",h.jsExtRegExp=/^\/|:|\?|\.js$/,h.isBrowser=A,x=h.s={contexts:G,newContext:ia},h({}),z(["toUrl","undef","defined","specified"],function(a){h[a]=function(){var b=G._;return b.require[a].apply(b,arguments)}}),A&&(y=x.head=document.getElementsByTagName("head")[0],E=document.getElementsByTagName("base")[0])&&(y=x.head=E.parentNode),h.onError=ca,h.load=function(a,b,c){var d,e=a&&a.config||{};if(A)return d=e.xhtml?document.createElementNS("http://www.w3.org/1999/xhtml","html:script"):document.createElement("script"),d.type=e.scriptType||"text/javascript",d.charset="utf-8",d.async=!0,d.setAttribute("data-requirecontext",a.contextName),d.setAttribute("data-requiremodule",b),!d.attachEvent||d.attachEvent.toString&&0>d.attachEvent.toString().indexOf("[native code")||Z?(d.addEventListener("load",a.onScriptLoad,!1),d.addEventListener("error",a.onScriptError,!1)):(Q=!0,d.attachEvent("onreadystatechange",a.onScriptLoad)),d.src=c,M=d,E?y.insertBefore(d,E):y.appendChild(d),M=null,d;if(ea)try{importScripts(c),a.completeLoad(b)}catch(f){a.onError(B("importscripts","importScripts failed for "+b+" at "+c,f,[b]))}},A&&O(document.getElementsByTagName("script"),function(a){return y||(y=a.parentNode),(L=a.getAttribute("data-main"))?(s=L,u.baseUrl||(F=s.split("/"),s=F.pop(),ga=F.length?F.join("/")+"/":"./",u.baseUrl=ga),s=s.replace(fa,""),h.jsExtRegExp.test(s)&&(s=L),u.deps=u.deps?u.deps.concat(s):[s],!0):void 0}),define=function(a,b,c){var d,e;"string"!=typeof a&&(c=b,b=a,a=null),K(b)||(c=b,b=null),!b&&J(c)&&(b=[],c.length&&(c.toString().replace(ma,"").replace(na,function(a,c){b.push(c)}),b=(1===c.length?["require"]:["require","exports","module"]).concat(b))),Q&&((d=M)||(R&&"interactive"===R.readyState||O(document.getElementsByTagName("script"),function(a){return"interactive"===a.readyState?R=a:void 0}),d=R),d&&(a||(a=d.getAttribute("data-requiremodule")),e=G[d.getAttribute("data-requirecontext")])),(e?e.defQueue:U).push([a,b,c])},define.amd={jQuery:!0},h.exec=function(b){return eval(b)},h(u)}}(this)}WebGLDebugUtils=function(){function a(a){if(null==m){m={};for(var b in a)"number"==typeof a[b]&&(m[a[b]]=b)}}function b(){if(null==m)throw"WebGLDebugUtils.init(ctx) not called"}function c(a){return b(),void 0!==m[a]}function d(a){b();var c=m[a];return void 0!==c?c:"*UNKNOWN WebGL ENUM (0x"+a.toString(16)+")"}function e(a,b,c){var e=l[a];return void 0!==e&&e[b]?d(c):null===c?"null":void 0===c?"undefined":c.toString()}function f(a,b){for(var c="",d=0;d<b.length;++d)c+=(0==d?"":", ")+e(a,d,b[d]);return c}function g(a,b,c){a.__defineGetter__(c,function(){return b[c]}),a.__defineSetter__(c,function(a){b[c]=a})}function h(b,c,f){function h(a,b){return function(){f&&f(b,arguments);var d=a[b].apply(a,arguments),e=a.getError();return 0!=e&&(i[e]=!0,c(e,b,arguments)),d}}a(b),c=c||function(a,b,c){for(var f="",g=0;g<c.length;++g)f+=(0==g?"":", ")+e(b,g,c[g]);k("WebGL error "+d(a)+" in "+b+"("+f+")")};var i={},j={};for(var l in b)"function"==typeof b[l]?j[l]=h(b,l):g(j,b,l);return j.getError=function(){for(var a in i)if(i.hasOwnProperty(a)&&i[a])return i[a]=!1,a;return b.NO_ERROR},j}function i(a){var b=a.getParameter(a.MAX_VERTEX_ATTRIBS),c=a.createBuffer();a.bindBuffer(a.ARRAY_BUFFER,c);for(var d=0;b>d;++d)a.disableVertexAttribArray(d),a.vertexAttribPointer(d,4,a.FLOAT,!1,0,0),a.vertexAttrib1f(d,0);a.deleteBuffer(c);for(var e=a.getParameter(a.MAX_TEXTURE_IMAGE_UNITS),d=0;e>d;++d)a.activeTexture(a.TEXTURE0+d),a.bindTexture(a.TEXTURE_CUBE_MAP,null),a.bindTexture(a.TEXTURE_2D,null);for(a.activeTexture(a.TEXTURE0),a.useProgram(null),a.bindBuffer(a.ARRAY_BUFFER,null),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),a.bindFramebuffer(a.FRAMEBUFFER,null),a.bindRenderbuffer(a.RENDERBUFFER,null),a.disable(a.BLEND),a.disable(a.CULL_FACE),a.disable(a.DEPTH_TEST),a.disable(a.DITHER),a.disable(a.SCISSOR_TEST),a.blendColor(0,0,0,0),a.blendEquation(a.FUNC_ADD),a.blendFunc(a.ONE,a.ZERO),a.clearColor(0,0,0,0),a.clearDepth(1),a.clearStencil(-1),a.colorMask(!0,!0,!0,!0),a.cullFace(a.BACK),a.depthFunc(a.LESS),a.depthMask(!0),a.depthRange(0,1),a.frontFace(a.CCW),a.hint(a.GENERATE_MIPMAP_HINT,a.DONT_CARE),a.lineWidth(1),a.pixelStorei(a.PACK_ALIGNMENT,4),a.pixelStorei(a.UNPACK_ALIGNMENT,4),a.pixelStorei(a.UNPACK_FLIP_Y_WEBGL,!1),a.pixelStorei(a.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),a.UNPACK_COLORSPACE_CONVERSION_WEBGL&&a.pixelStorei(a.UNPACK_COLORSPACE_CONVERSION_WEBGL,a.BROWSER_DEFAULT_WEBGL),a.polygonOffset(0,0),a.sampleCoverage(1,!1),a.scissor(0,0,a.canvas.width,a.canvas.height),a.stencilFunc(a.ALWAYS,0,4294967295),a.stencilMask(4294967295),a.stencilOp(a.KEEP,a.KEEP,a.KEEP),a.viewport(0,0,a.canvas.width,a.canvas.height),a.clear(a.COLOR_BUFFER_BIT|a.DEPTH_BUFFER_BIT|a.STENCIL_BUFFER_BIT);a.getError(););}function j(a){function b(a){return"function"==typeof a?a:function(b){a.handleEvent(b)}}function c(a){var b=a.addEventListener;a.addEventListener=function(c,d){switch(c){case"webglcontextlost":x(d);break;case"webglcontextrestored":y(d);break;default:b.apply(a,arguments)}}}function d(){for(var a=Object.keys(w),b=0;b<a.length;++b)delete w[a]}function e(){++t,q||s==t&&a.loseContext()}function f(a,b){var c=a[b];return function(){if(e(),!q){var b=c.apply(a,arguments);return b}}}function h(){for(var a=0;a<r.length;++a){var b=r[a];b instanceof WebGLBuffer?l.deleteBuffer(b):b instanceof WebGLFramebuffer?l.deleteFramebuffer(b):b instanceof WebGLProgram?l.deleteProgram(b):b instanceof WebGLRenderbuffer?l.deleteRenderbuffer(b):b instanceof WebGLShader?l.deleteShader(b):b instanceof WebGLTexture&&l.deleteTexture(b)}}function j(a){return{statusMessage:a,preventDefault:function(){u=!0}}}function k(a){for(var b in a)"function"==typeof a[b]?m[b]=f(a,b):g(m,a,b);m.getError=function(){if(e(),!q)for(var a;a=l.getError();)w[a]=!0;for(var a in w)if(w[a])return delete w[a],a;return m.NO_ERROR};for(var c=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],d=0;d<c.length;++d){var h=c[d];m[h]=function(b){return function(){if(e(),q)return null;var c=b.apply(a,arguments);return c.__webglDebugContextLostId__=p,r.push(c),c}}(a[h])}for(var i=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"],d=0;d<i.length;++d){var h=i[d];m[h]=function(b){return function(){return e(),q?null:b.apply(a,arguments)}}(m[h])}for(var j=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"],d=0;d<j.length;++d){var h=j[d];m[h]=function(b){return function(){return e(),q?!1:b.apply(a,arguments)}}(m[h])}return m.checkFramebufferStatus=function(b){return function(){return e(),q?m.FRAMEBUFFER_UNSUPPORTED:b.apply(a,arguments)}}(m.checkFramebufferStatus),m.getAttribLocation=function(b){return function(){return e(),q?-1:b.apply(a,arguments)}}(m.getAttribLocation),m.getVertexAttribOffset=function(b){return function(){return e(),q?0:b.apply(a,arguments)}}(m.getVertexAttribOffset),m.isContextLost=function(){return q},m}var l,m,n=[],o=[],m={},p=1,q=!1,r=[],s=0,t=0,u=!1,v=0,w={};a.getContext=function(b){return function(){var c=b.apply(a,arguments);if(c instanceof WebGLRenderingContext){if(c!=l){if(l)throw"got different context";l=c,m=k(l)}return m}return c}}(a.getContext);var x=function(a){n.push(b(a))},y=function(a){o.push(b(a))};return c(a),a.loseContext=function(){if(!q){for(q=!0,s=0,++p;l.getError(););d(),w[l.CONTEXT_LOST_WEBGL]=!0;var b=j("context lost"),c=n.slice();setTimeout(function(){for(var d=0;d<c.length;++d)c[d](b);v>=0&&setTimeout(function(){a.restoreContext()},v)},0)}},a.restoreContext=function(){q&&o.length&&setTimeout(function(){if(!u)throw"can not restore. webglcontestlost listener did not call event.preventDefault";h(),i(l),q=!1,t=0,u=!1;for(var a=o.slice(),b=j("context restored"),c=0;c<a.length;++c)a[c](b)},0)},a.loseContextInNCalls=function(a){if(q)throw"You can not ask a lost contet to be lost";s=t+a},a.getNumCalls=function(){return t},a.setRestoreTimeout=function(a){v=a},a}var k=function(a){window.console&&window.console.log&&window.console.log(a)},l={enable:{0:!0},disable:{0:!0},getParameter:{0:!0},drawArrays:{0:!0},drawElements:{0:!0,2:!0},createShader:{0:!0},getShaderParameter:{1:!0},getProgramParameter:{1:!0},getVertexAttrib:{1:!0},vertexAttribPointer:{2:!0},bindTexture:{0:!0},activeTexture:{0:!0},getTexParameter:{0:!0,1:!0},texParameterf:{0:!0,1:!0},texParameteri:{0:!0,1:!0,2:!0},texImage2D:{0:!0,2:!0,6:!0,7:!0},texSubImage2D:{0:!0,6:!0,7:!0},copyTexImage2D:{0:!0,2:!0},copyTexSubImage2D:{0:!0},generateMipmap:{0:!0},bindBuffer:{0:!0},bufferData:{0:!0,2:!0},bufferSubData:{0:!0},getBufferParameter:{0:!0,1:!0},pixelStorei:{0:!0,1:!0},readPixels:{4:!0,5:!0},bindRenderbuffer:{0:!0},bindFramebuffer:{0:!0},checkFramebufferStatus:{0:!0},framebufferRenderbuffer:{0:!0,1:!0,2:!0},framebufferTexture2D:{0:!0,1:!0,2:!0},getFramebufferAttachmentParameter:{0:!0,1:!0,2:!0},getRenderbufferParameter:{0:!0,1:!0},renderbufferStorage:{0:!0,1:!0},clear:{0:!0},depthFunc:{0:!0},blendFunc:{0:!0,1:!0},blendFuncSeparate:{0:!0,1:!0,2:!0,3:!0},blendEquation:{0:!0},blendEquationSeparate:{0:!0,1:!0},stencilFunc:{0:!0},stencilFuncSeparate:{0:!0,1:!0},stencilMaskSeparate:{0:!0},stencilOp:{0:!0,1:!0,2:!0},stencilOpSeparate:{0:!0,1:!0,2:!0,3:!0},cullFace:{0:!0},frontFace:{0:!0}},m=null;return{init:a,mightBeEnum:c,glEnumToString:d,glFunctionArgToString:e,glFunctionArgsToString:f,makeDebugContext:h,makeLostContextSimulatingCanvas:j,resetToInitialState:i}}();var SceneJS_Map=function(a,b){this.items=a||[];var c=b||0,d=c+1;this.addItem=function(){var a;if(2==arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw SceneJS_error.fatalError(SceneJS.errors.ID_CLASH,"ID clash: '"+b+"'");return this.items[b]=a,b}for(;;){a=arguments[0];var c=d++;if(!this.items[c])return this.items[c]=a,c}},this.removeItem=function(a){delete this.items[a]}},SceneJS=new function(){this.VERSION="3.2",this._baseStateId=0,this._handleMap=new SceneJS_Map,this._topicSubs={},this._handleTopics={},this._topicPubs={},this._engines={},this._engineIds=new SceneJS_Map,this.WEBGL_INFO=function(){var a={WEBGL:!1},b=document.createElement("canvas");if(!b)return a;var c=b.getContext("webgl",{antialias:!0})||b.getContext("experimental-webgl",{antialias:!0});return a.WEBGL=!!c,a.WEBGL?(a.ANTIALIAS=c.getContextAttributes().antialias,a.FS_MAX_FLOAT_PRECISION=c.getShaderPrecisionFormat?c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.HIGH_FLOAT).precision>0?"highp":c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump",a.DEPTH_BUFFER_BITS=c.getParameter(c.DEPTH_BITS),a.MAX_TEXTURE_SIZE=c.getParameter(c.MAX_TEXTURE_SIZE),a.MAX_CUBE_MAP_SIZE=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),a.MAX_RENDERBUFFER_SIZE=c.getParameter(c.MAX_RENDERBUFFER_SIZE),a.MAX_TEXTURE_UNITS=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),a.MAX_VERTEX_ATTRIBS=c.getParameter(c.MAX_VERTEX_ATTRIBS),a.MAX_VERTEX_UNIFORM_VECTORS=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),a.MAX_FRAGMENT_UNIFORM_VECTORS=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),a.MAX_VARYING_VECTORS=c.getParameter(c.MAX_VARYING_VECTORS),a.SUPPORTED_EXTENSIONS={},c.getSupportedExtensions().forEach(function(b){a.SUPPORTED_EXTENSIONS[b]=!0}),a):a}(),this.publish=function(a,b,c){c||(this._topicPubs[a]=b);var d=this._topicSubs[a];if(d)for(var e in d)d.hasOwnProperty(e)&&d[e].call(this,b)},this.unpublish=function(a){var b=this._topicSubs[a];if(b)for(var c in b)b.hasOwnProperty(c)&&b[c].call(this,null);delete this._topicPubs[a]},this.on=function(a,b){var c=this._topicSubs[a];c||(c={},this._topicSubs[a]=c);var d=this._handleMap.addItem();c[d]=b,this._handleTopics[d]=a;var e=this._topicPubs[a];return e&&b.call(this,e),d},this.off=function(a){var b=this._handleTopics[a];if(b){delete this._handleTopics[a];var c=this._topicSubs[b];c&&delete c[a],this._handleMap.removeItem(a),"rendered"==b&&this._engine.branchDirty(this)}},this.once=function(a,b){var c=this,d=this.on(a,function(a){c.off(d),b(a)})},this.createScene=function(a,b){if(a=a||{},a.id){if(this._engines[a.id])throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Scene already exists with this ID: '"+a.id+"'");this._engineIds.addItem(a.id,{})}else a.id=this._engineIds.addItem({});var c=new SceneJS_Engine(a,b);return this._engines[a.id]=c,SceneJS_events.fireEvent(SceneJS_events.SCENE_CREATED,{engine:c}),c.scene.start(b),c.scene},this.scene=function(a){var b=this._engines[a];return b?b.scene:null},this.getScene=function(a){if(!a)for(var a in this._engines)if(this._engines.hasOwnProperty(a))return this._engines[a].scene;var b=this._engines[a];return b?b.scene:null},this.getScenes=function(){var a={};for(var b in this._engines)this._engines.hasOwnProperty(b)&&(a[b]=this._engines[b].scene);return a},this._isArray=function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},this._shallowClone=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},this._applyIf=function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0==b[c]||null==b[c])&&(b[c]=a[c]);return b},this._apply=function(a,b,c){var d;if(c)for(d in b)b.hasOwnProperty(d)&&delete b[d];for(d in a)a.hasOwnProperty(d)&&void 0!=a[d]&&(b[d]=a[d]);return b};var a=Object.prototype.hasOwnProperty;this._isEmpty=function(b){if(null==b)return!0;if(b.length>0)return!1;if(0===b.length)return!0;for(var c in b)if(a.call(b,c))return!1;return!0},this.reset=function(){var a=[];for(var b in this._engines)this._engines.hasOwnProperty(b)&&(a.push(this._engines[b]),delete this._engines[b],this._engineIds.removeItem(b));for(;a.length>0;)a.pop().destroy();SceneJS_events.fireEvent(SceneJS_events.RESET)}};!function(){var a;SceneJS.on("configs",function(b){if(b.pluginPath!=a){a=b.pluginPath;var c=a+"/lib";require.config({paths:{scenejsPluginDeps:c}})}})}();var SceneJS_eventManager=function(){this._handlerIds=new SceneJS_Map,this.typeHandlers={}};SceneJS_eventManager.prototype.createEvent=function(a){this.typeHandlers[a]||(this.typeHandlers[a]={handlers:{},numSubs:0})},SceneJS_eventManager.prototype.onEvent=function(a,b){var c=this.typeHandlers[a]||(this.typeHandlers[a]={handlers:{},numSubs:0}),d=this._handlerIds.addItem(a),e=c.handlers;return e[d]=b,c.numSubs++,d},SceneJS_eventManager.prototype.fireEvent=function(a,b){var c=this.typeHandlers[a]||(this.typeHandlers[a]={handlers:{},numSubs:0});if(c.numSubs>0){var d=c.handlers;for(var e in d)d.hasOwnProperty(e)&&d[e](b)}},SceneJS_eventManager.prototype.unEvent=function(a){var b=this._handlerIds.items[a];if(b){this._handlerIds.removeItem(a);var c=this.typeHandlers[b];c&&(delete c[a],this.typeHandlers[b].numSubs--)}},SceneJS.Plugins=new function(){function a(a,c,f,g){var h=d[a]||(d[a]={});h[c]=g,b(f,0,function(){for(var b=a+c,d=e[b]||(e[b]=[]);d.length>0;)d.pop()(g);delete e[b]})}function b(a,d,e){if(!a||d>=a.length)return void e();var f=a[d],g=SceneJS_configsModule.configs.pluginPath;if(!g)throw"no pluginPath config";f=g+"/"+f,c(f,function(){b(a,d+1,e)})}function c(a,b){var c=document.createElement("script");c.type="text/javascript",c.readyState?c.onreadystatechange=function(){("loaded"==c.readyState||"complete"==c.readyState)&&(c.onreadystatechange=null,b&&b())}:c.onload=function(){b&&b()},c.src=a,document.getElementsByTagName("head")[0].appendChild(c)}var d={},e={};this.addPlugin=function(){var b,c,d=arguments[0],e=arguments[1];4==arguments.length?(b=arguments[2],c=arguments[3]):c=arguments[2],a(d,e,b,c)},this.hasPlugin=function(a,b){var c=d[a];return c&&!!c[b]},this.getPlugin=function(a,b,f){var g=d[a];if(g){var h=g[b];if(h)return void f(h)}var i=a+b,j=e[i]||(e[i]=[]);if(j.push(f),!(j.length>1)){var k=SceneJS_configsModule.configs.pluginPath;if(!k)throw"no pluginPath config";var l=k+"/"+a+"/"+b+".js";c(l)}}};var SceneJS_events=new function(){this.ERROR=0,this.RESET=1,this.NODE_CREATED=2,this.SCENE_CREATED=3,this.SCENE_COMPILING=4,this.SCENE_DESTROYED=5,this.OBJECT_COMPILING=6,this.WEBGL_CONTEXT_LOST=7,this.WEBGL_CONTEXT_RESTORED=8,this.RENDER=9;var a=[];this.addListener=function(b,c,d){var e=a[b];e||(e=[],a[b]=e);for(var f={command:c,priority:void 0==d?e.length:d},g=-1,h=0,i=e.length;i>h;h++)if(!e[h]){g=h;break}0>g&&(e.push(f),g=e.length-1);var j=b+"."+g;return j},this.removeListener=function(b){var c=b.lastIndexOf("."),d=parseInt(b.substr(0,c)),e=parseInt(b.substr(c+1)),f=a[d];f&&delete f[e]},this.fireEvent=function(b,c){var d=a[b];if(d){c=c||{};for(var e=0;e<d.length;e++)d[e]&&d[e].command(c)}}};SceneJS.bind=function(a,b){switch(a){case"error":return SceneJS_events.addListener(SceneJS_events.ERROR,b);case"reset":return SceneJS_events.addListener(SceneJS_events.RESET,function(){b()});case"webglcontextlost":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_LOST,function(a){b(a)});case"webglcontextrestored":return SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(a){b(a)});default:throw SceneJS_error.fatalError("SceneJS.bind - this event type not supported: '"+a+"'")}},SceneJS.onEvent=SceneJS.bind,SceneJS.unEvent=function(a){return SceneJS_events.removeListener(a)},SceneJS.subscribe=SceneJS.addListener=SceneJS.onEvent=SceneJS.bind,SceneJS.unsubscribe=SceneJS.unEvent,SceneJS.on=SceneJS.onEvent,SceneJS.off=SceneJS.unEvent;var SceneJS_Canvas=function(a,b,c,d){if(this.canvasId,!b){b="canvas-"+a;var e=document.getElementsByTagName("body")[0],f=document.createElement("div"),g=f.style;g.height="100%",g.width="100%",g.padding="0",g.margin="0",g.left="0",g.top="0",g.position="absolute",f.innerHTML+='<canvas id="'+b+'" style="width: 100%; height: 100%; margin: 0; padding: 0;"></canvas>',e.appendChild(f)}var h=document.getElementById(b);if(!h)throw SceneJS_error.fatalError(SceneJS.errors.CANVAS_NOT_FOUND,"SceneJS.Scene attribute 'canvasId' does not match any elements in the page");this.canvasId=b,this.options=d||{},this.canvas=this.options.simulateWebGLContextLost?WebGLDebugUtils.makeLostContextSimulatingCanvas(h):h,this.resolutionScaling=this.options.resolutionScaling||1,this.canvas.width=this.canvas.clientWidth*this.resolutionScaling,this.canvas.height=this.canvas.clientHeight*this.resolutionScaling,this.contextAttr=c||{},this.contextAttr.alpha=!0,this.gl=null,this.initWebGL()};SceneJS_Canvas.prototype._WEBGL_CONTEXT_NAMES=["webgl","experimental-webgl","webkit-3d","moz-webgl","moz-glweb20"],SceneJS_Canvas.prototype.initWebGL=function(){for(var a=0;!this.gl&&a<this._WEBGL_CONTEXT_NAMES.length;a++)try{this.gl=this.canvas.getContext(this._WEBGL_CONTEXT_NAMES[a],this.contextAttr)}catch(b){}if(!this.gl)throw SceneJS_error.fatalError(SceneJS.errors.WEBGL_NOT_SUPPORTED,"Failed to get a WebGL context")},SceneJS_Canvas.prototype.loseWebGLContext=function(){this.options.simulateWebGLContextLost&&this.canvas.loseContext()},SceneJS_Canvas.prototype.setResolutionScaling=function(a){this.resolutionScaling=a,this.canvas.width=this.canvas.clientWidth*a,this.canvas.height=this.canvas.clientHeight*a};var SceneJS_Engine=function(a,b){a.type="scene",this.id=a.id,this._numPasses=a.numPasses||1,this.canvas=new SceneJS_Canvas(this.id,a.canvasId,a.contextAttr,b),
this.events=new SceneJS_eventManager,this._coreFactory=new SceneJS_CoreFactory,this._nodeFactory=new SceneJS_NodeFactory,this.display=new SceneJS_Display({canvas:this.canvas,transparent:a.transparent,dof:a.dof}),this.sceneDirty=!1,this._sceneBranchesDirty=!1,this._nodesToDestroy=[],this._numNodesToDestroy=0,this.fps=a.fps||0,this.running=!1,this.paused=!1,this.destroyed=!1,this.sceneStatus={nodes:{},numTasks:0};var c=this,d=a.nodes;a.nodes=null,this.scene=this.createNode(a),d&&(a.nodes=d,this.scene.addNodes(d)),SceneJS_events.addListener(SceneJS_events.RENDER,function(a){c.scene.publish("render",a)}),this.canvas.canvas.addEventListener("webglcontextlost",function(a){a.preventDefault(),c.stop(),SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_LOST,{scene:c.scene})},!1),this.canvas.canvas.addEventListener("webglcontextrestored",function(){c.canvas.initWebGL(),c._coreFactory.webglRestored(),c.display.webglRestored(),SceneJS_events.fireEvent(SceneJS_events.WEBGL_CONTEXT_RESTORED,{scene:c.scene}),c.start()},!1)};SceneJS_Engine.prototype.setNumPasses=function(a){this._numPasses=a},SceneJS_Engine.prototype.loseWebGLContext=function(){this.canvas.loseWebGLContext()},SceneJS_Engine.prototype.getNodeType=function(a,b){SceneJS_NodeFactory.getNodeType(a,b)},SceneJS_Engine.prototype.hasNodeType=function(a){return!!SceneJS_NodeFactory.nodeTypes[a]},SceneJS_Engine.prototype.createNode=function(a,b){this._doDestroyNodes(),a.type=a.type||"node";var c=this._coreFactory.getCore(a.type,a.coreId),d=this;return this._nodeFactory.getNode(this,a,c,function(c){if(!c._fromPlugin&&a.nodes)for(var e=0,f=0,g=a.nodes.length;g>f;f++)d.createNode(a.nodes[f],function(a){c.addNode(a),++e==g&&(b&&b(c),d.scene.publish("nodes/"+c.id,c))});else b&&(b(c),d.scene.publish("nodes/"+c.id,c))})},SceneJS_Engine.prototype._doDestroyNodes=function(){for(var a;this._numNodesToDestroy>0;)--this._numNodesToDestroy,a=this._nodesToDestroy[this._numNodesToDestroy],this._nodesToDestroy[this._numNodesToDestroy]=null,a._doDestroy(),this._coreFactory.putCore(a._core),this._nodeFactory.putNode(a)},SceneJS_Engine.prototype.findNode=function(a){return this._nodeFactory.nodes.items[a]},SceneJS_Engine.prototype.findNodes=function(a){var b=new RegExp(a),c=[],d=this._nodeFactory.nodes.items;for(var e in d)d.hasOwnProperty(e)&&b.test(e)&&c.push(d[e]);return c},SceneJS_Engine.prototype.hasCore=function(a,b){return this._coreFactory.hasCore(a,b)},SceneJS_Engine.prototype.branchDirty=function(a){if(!this.sceneDirty&&a!=window){a.branchDirty=!0,a.dirty=!0;for(var b=a.parent;b&&!b.dirty&&!b.branchDirty;b=b.parent)b.dirty=!0;this._sceneBranchesDirty=!0}},SceneJS_Engine.prototype.renderFrame=function(a){var b=!1;if(this._needCompile()||a&&a.force)for(var c=Date.now(),d=a&&a.force,e=0;e<this._numPasses;e++)this.scene.publish("rendering",{pass:e}),this._doCompile(),this.display.render({clear:0==e,force:d,opaqueOnly:a&&a.opaqueOnly}),this.scene.publish("rendered",{sceneId:this.id,time:c,pass:e}),b=!0;return b},SceneJS_Engine.prototype.start=function(){function a(){k=!1;for(var a=0;a<d._numPasses;a++)(d._needCompile()||k)&&(f=!1,o.pass=a,j.publish("rendering",o),d._doCompile(),p.clear=0==a,d.display.render(p),q.sceneId=d.id,q.time=g,q.pass=a,j.publish("rendered",q),k=!0);k||(f||(r.sceneId=d.id,r.startTime=i,r.prevTime=g,r.time=g,j.publish("sleep",r)),f=!0)}if(!this.running){this.running=!0,this.paused=!1,this.sceneDirty=!0;var b,c,d=this,e="__scenejs_sceneLoop"+this.id,f=!1,g=Date.now(),h=g,i=g,j=this.scene,k=!1,l=this.canvas.canvas,m=null,n=null;this.events.fireEvent("started",{sceneId:d.id,startTime:i});var o={pass:0},p={clear:!0},q={sceneId:d.id,time:g,pass:0},r={sceneId:d.id,startTime:g,prevTime:g,time:g},s={width:0,height:0,aspect:1},t={sceneId:d.id,startTime:g,prevTime:g,time:g};window[e]=function(){var f=d.canvas.resolutionScaling||1;if(b=l.width=l.clientWidth*f,c=l.height=l.clientHeight*f,(b!=m||c!=n)&&(s.width=b,s.height=c,s.aspect=b/c,j.publish("canvasSize",s),d.display.imageDirty=!0,m=b,n=c),d.running&&!d.paused){if(g=Date.now(),t.sceneId=d.id,t.startTime=i,t.prevTime=g,t.time=g,j.publish("tick",t),h=g,!d.running)return;d.fps>0?requestAnimationFrame(a):a()}d.running&&(d.fps>0?setTimeout(window[e],1e3/d.fps):requestAnimationFrame(window[e]))},setTimeout(window[e],0)}},SceneJS_Engine.prototype.pick=function(a,b,c){this._needCompile()&&this._doCompile();var d=this.display.pick({canvasX:a,canvasY:b,pickTriangle:c?c.rayPick:!1,pickRegion:c?c.regionPick:!1});return d},SceneJS_Engine.prototype.readPixels=function(a,b,c){return this._needCompile()&&this._doCompile(),this.display.readPixels(a,b,c)},SceneJS_Engine.prototype._needCompile=function(){return this.display.imageDirty||this.display.drawListDirty||this.display.stateSortDirty||this.display.stateOrderDirty||this.display.objectListDirty||this._sceneBranchesDirty||this.sceneDirty},SceneJS_Engine.prototype._doCompile=function(){if(this._sceneBranchesDirty||this.sceneDirty){this._sceneBranchesDirty=!1,SceneJS_events.fireEvent(SceneJS_events.SCENE_COMPILING,{engine:this}),this.pubSubProxy=new SceneJS_PubSubProxy(this.scene,null);var a={pubSubProxy:this.pubSubProxy};this.scene._compileNodes(a),this.sceneDirty=!1}this._doDestroyNodes()},SceneJS_Engine.prototype.pause=function(a){this.paused=a},SceneJS_Engine.prototype.stop=function(){this.running&&(this.running=!1,this.paused=!1,window["__scenejs_sceneLoop"+this.id]=null)},SceneJS_Engine.prototype.destroyNode=function(a){this._nodesToDestroy[this._numNodesToDestroy++]=a;var b=this.sceneStatus.nodes[a.id];b&&(this.sceneStatus.numTasks-=b.numTasks,delete this.sceneStatus.nodes[a.id])},SceneJS_Engine.prototype.destroy=function(){this.destroyed=!0},self.Int32Array||(self.Int32Array=Array,self.Float32Array=Array),function(){for(var a=0,b=["ms","moz","webkit","o"],c=0;c<b.length&&!window.requestAnimationFrame;++c)window.requestAnimationFrame=window[b[c]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[b[c]+"CancelAnimationFrame"]||window[b[c]+"RequestCancelAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(b){var c=(new Date).getTime(),d=Math.max(0,16-(c-a)),e=window.setTimeout(function(){b(c+d)},d);return a=c+d,e}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(a){clearTimeout(a)})}();var SceneJS_error=new function(){var a;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){a=b.engine.id}),SceneJS_events.addListener(SceneJS_events.RESET,function(){a=null},1e5),this.fatalError=function(b,c){"string"==typeof b&&(c=b,b=SceneJS.errors.ERROR);var d={errorName:SceneJS.errors._getErrorName(b)||"ERROR",code:b,exception:c,fatal:!0};return a&&(d.sceneId=a),SceneJS_events.fireEvent(SceneJS_events.ERROR,d),c},this.error=function(b,c){var d={errorName:SceneJS.errors._getErrorName(b)||"ERROR",code:b,exception:c,fatal:!1};a&&(d.sceneId=a),SceneJS_events.fireEvent(SceneJS_events.ERROR,d)}};!function(){SceneJS.errors={};var a=0;SceneJS.errors.ERROR=a++,SceneJS.errors.INVALID_FRAMEBUFFER=a++,SceneJS.errors.WEBGL_NOT_SUPPORTED=a++,SceneJS.errors.WEBGL_CONTEXT_LOST=a++,SceneJS.errors.NODE_CONFIG_EXPECTED=a++,SceneJS.errors.ILLEGAL_NODE_CONFIG=a++,SceneJS.errors.SHADER_COMPILATION_FAILURE=a++,SceneJS.errors.SHADER_LINK_FAILURE=a++,SceneJS.errors.CANVAS_NOT_FOUND=a++,SceneJS.errors.OUT_OF_VRAM=a++,SceneJS.errors.WEBGL_UNSUPPORTED_NODE_CONFIG=a++,SceneJS.errors.NODE_NOT_FOUND=a++,SceneJS.errors.NODE_ILLEGAL_STATE=a++,SceneJS.errors.ID_CLASH=a++,SceneJS.errors.PLUGIN_INVALID=a++}(),SceneJS.errors._getErrorName=function(a){for(var b in SceneJS.errors)if(SceneJS.errors.hasOwnProperty(b)&&SceneJS.errors[b]==a)return b;return null};var SceneJS_configsModule=new function(){this.configs={};var a={};this.setConfigs=function(b,c){if(b){for(var d,e,f=b.split("."),g=this.configs,h=0;h<f.length-1;h++)e=f[h],d=g[e],d||(d=g[e]={}),g=d;g[f.length-1]=c}else this.configs=c;var i=a[b||"_all"];if(i)for(var h=0,j=i.length;j>h;h++)i[h](g);SceneJS.publish("configs",this.configs)},this.getConfigs=function(a){if(a){for(var b=this.configs,c=a.split("."),d=0;b&&d<c.length;d++)b=b[c[d]];return void 0!=b?b:{}}return this.configs},this.on=function(b,c){b=b||"_all",(a[b]||(a[b]=[])).push(c),c(this.getConfigs(b))}};SceneJS.configure=SceneJS.setConfigs=SceneJS.setDebugConfigs=function(){if(1==arguments.length)SceneJS_configsModule.setConfigs(null,arguments[0]);else{if(2!=arguments.length)throw SceneJS_error.fatalError("Illegal arguments given to SceneJS.setDebugs - should be either ({String}:name, {Object}:cfg) or ({Object}:cfg)");SceneJS_configsModule.setConfigs(arguments[0],arguments[1])}},SceneJS.getConfigs=SceneJS.getDebugConfigs=function(a){return SceneJS_configsModule.getConfigs(a)},SceneJS.log=new function(){var a,b=null,c={},d=0,e="";SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){a=b.engine.id}),SceneJS_events.addListener(SceneJS_events.RESET,function(){c={},b=null,a=null},1e5),this._setIndent=function(a){d=a;for(var b=[],c=0;d>c;c++)b.push("----");e=b.join("")},this.error=function(a){this._log("error",a)},this.warn=function(a){this._log("warn",a)},this.info=function(a){this._log("info",a)},this.debug=function(a){this._log("debug",a)},this.setFuncs=function(a){if(a){b=a;for(var d in c)this._flush(d)}},this._flush=function(a){var d=c[a];if(d){var e=b?b[a]:null;if(e){for(var f=0;f<d.length;f++)e(d[f]);c[a]=[]}}},this._log=function(a,b){if(SceneJS._isArray(b))for(var c=0;c<b.length;c++)this.__log(a,b[c]);else this.__log(a,b)},this.__log=function(a,c){c=e+c,b&&b[a]?b[a](c):console&&console[a]&&console[a](c)},this.getFuncs=function(){return b}},function(){{var a=(new Float32Array(16),new Float32Array(16),new Float32Array(3)),b=new Float32Array(3),c=new Float32Array(3),d=new Float32Array(3),e=new Float32Array(3),f=new Float32Array(3);new Float32Array(4)}window.SceneJS_math_vec2=function(){return new Float32Array(2)},window.SceneJS_math_vec3=function(){return new Float32Array(3)},window.SceneJS_math_vec4=function(){return new Float32Array(4)},window.SceneJS_math_mat3=function(){return new Float32Array(9)},window.SceneJS_math_mat4=function(){return new Float32Array(16)},window.SceneJS_math_divVec3=function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c},window.SceneJS_math_negateVector4=function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b},window.SceneJS_math_addVec4=function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c},window.SceneJS_math_addVec4s=function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c},window.SceneJS_math_addVec3=function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c},window.SceneJS_math_addVec3s=function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c},window.SceneJS_math_addScalarVec4=function(a,b,c){return SceneJS_math_addVec4s(b,a,c)},window.SceneJS_math_subVec4=function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c},window.SceneJS_math_subVec3=function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c},window.SceneJS_math_lerpVec3=function(a,b,c,d,e,f){f=f||SceneJS_math_vec3();var g=(a-b)/(c-b),h=1-g;return f[0]=d[0]*h+e[0]*g,f[1]=d[1]*h+e[1]*g,f[2]=d[2]*h+e[2]*g,f},window.SceneJS_math_subVec2=function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c},window.SceneJS_math_subVec4Scalar=function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c},window.SceneJS_math_subScalarVec4=function(a,b,c){return c||(c=a),c[0]=b-a[0],c[1]=b-a[1],c[2]=b-a[2],c[3]=b-a[3],c},window.SceneJS_math_mulVec4=function(a,b,c){return c||(c=a),c[0]=a[0]*b[0],c[1]=a[1]*b[1],c[2]=a[2]*b[2],c[3]=a[3]*b[3],c},window.SceneJS_math_mulVec4Scalar=function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c},window.SceneJS_math_mulVec3Scalar=function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c},window.SceneJS_math_mulVec2Scalar=function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c},window.SceneJS_math_divVec4=function(a,b,c){return c||(c=a),c[0]=a[0]/b[0],c[1]=a[1]/b[1],c[2]=a[2]/b[2],c[3]=a[3]/b[3],c},window.SceneJS_math_divScalarVec3=function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c},window.SceneJS_math_divVec3s=function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c},window.SceneJS_math_divVec4s=function(a,b,c){return c||(c=a),c[0]=a[0]/b,c[1]=a[1]/b,c[2]=a[2]/b,c[3]=a[3]/b,c},window.SceneJS_math_divScalarVec4=function(a,b,c){return c||(c=b),c[0]=a/b[0],c[1]=a/b[1],c[2]=a/b[2],c[3]=a/b[3],c},window.SceneJS_math_dotVector4=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},window.SceneJS_math_cross3Vec4=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];return[d*h-e*g,e*f-c*h,c*g-d*f,0]},window.SceneJS_math_cross3Vec3=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=b[0],h=b[1],i=b[2];return c[0]=e*i-f*h,c[1]=f*g-d*i,c[2]=d*h-e*g,c},window.SceneJS_math_dotVec3=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},window.SceneJS_math_sqLenVec4=function(a){return SceneJS_math_dotVector4(a,a)},window.SceneJS_math_lenVec4=function(a){return Math.sqrt(SceneJS_math_sqLenVec4(a))},window.SceneJS_math_dotVector3=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},window.SceneJS_math_dotVector2=function(a,b){return a[0]*b[0]+a[1]*b[1]},window.SceneJS_math_sqLenVec3=function(a){return SceneJS_math_dotVector3(a,a)},window.SceneJS_math_sqLenVec2=function(a){return SceneJS_math_dotVector2(a,a)},window.SceneJS_math_lenVec3=function(a){return Math.sqrt(SceneJS_math_sqLenVec3(a))},window.SceneJS_math_lenVec2=function(a){return Math.sqrt(SceneJS_math_sqLenVec2(a))},window.SceneJS_math_rcpVec3=function(a,b){return SceneJS_math_divScalarVec3(1,a,b)},window.SceneJS_math_normalizeVec4=function(a,b){var c=1/SceneJS_math_lenVec4(a);return SceneJS_math_mulVec4Scalar(a,c,b)},window.SceneJS_math_normalizeVec3=function(a,b){var c=1/SceneJS_math_lenVec3(a);return SceneJS_math_mulVec3Scalar(a,c,b)},window.SceneJS_math_normalizeVec2=function(a,b){var c=1/SceneJS_math_lenVec2(a);return SceneJS_math_mulVec2Scalar(a,c,b)},window.SceneJS_math_mat4=function(){return new Array(16)},window.SceneJS_math_dupMat4=function(a){return a.slice(0,16)},window.SceneJS_math_getCellMat4=function(a,b,c){return a[b+4*c]},window.SceneJS_math_setCellMat4=function(a,b,c,d){a[b+4*c]=d},window.SceneJS_math_getRowMat4=function(a,b){return[a[b],a[b+4],a[b+8],a[b+12]]},window.SceneJS_math_setRowMat4=function(a,b,c){a[b]=c[0],a[b+4]=c[1],a[b+8]=c[2],a[b+12]=c[3]},window.SceneJS_math_setRowMat4c=function(a,b,c,d,e,f){SceneJS_math_setRowMat4(a,b,[c,d,e,f])},window.SceneJS_math_setRowMat4s=function(a,b,c){SceneJS_math_setRowMat4c(a,b,c,c,c,c)},window.SceneJS_math_getColMat4=function(a,b){var c=4*b;return[a[c],a[c+1],a[c+2],a[c+3]]},window.SceneJS_math_setColMat4v=function(a,b,c){var d=4*b;a[d]=c[0],a[d+1]=c[1],a[d+2]=c[2],a[d+3]=c[3]},window.SceneJS_math_setColMat4c=function(a,b,c,d,e,f){SceneJS_math_setColMat4v(a,b,[c,d,e,f])},window.SceneJS_math_setColMat4Scalar=function(a,b,c){SceneJS_math_setColMat4c(a,b,c,c,c,c)},window.SceneJS_math_mat4To3=function(a){return[a[0],a[1],a[2],a[4],a[5],a[6],a[8],a[9],a[10]]},window.SceneJS_math_m4s=function(a){return[a,a,a,a,a,a,a,a,a,a,a,a,a,a,a,a]},window.SceneJS_math_setMat4ToZeroes=function(){return SceneJS_math_m4s(0)},window.SceneJS_math_setMat4ToOnes=function(){return SceneJS_math_m4s(1)},window.SceneJS_math_diagonalMat4v=function(a){return[a[0],0,0,0,0,a[1],0,0,0,0,a[2],0,0,0,0,a[3]]},window.SceneJS_math_diagonalMat4c=function(a,b,c,d){return SceneJS_math_diagonalMat4v([a,b,c,d])},window.SceneJS_math_diagonalMat4s=function(a){return SceneJS_math_diagonalMat4c(a,a,a,a)},window.SceneJS_math_identityMat4=function(){return SceneJS_math_diagonalMat4v([1,1,1,1])},window.SceneJS_math_isIdentityMat4=function(a){return 1!==a[0]||0!==a[1]||0!==a[2]||0!==a[3]||0!==a[4]||1!==a[5]||0!==a[6]||0!==a[7]||0!==a[8]||0!==a[9]||1!==a[10]||0!==a[11]||0!==a[12]||0!==a[13]||0!==a[14]||1!==a[15]?!1:!0},window.SceneJS_math_negateMat4=function(a,b){return b||(b=a),b[0]=-a[0],b[1]=-a[1],b[2]=-a[2],b[3]=-a[3],b[4]=-a[4],b[5]=-a[5],b[6]=-a[6],b[7]=-a[7],b[8]=-a[8],b[9]=-a[9],b[10]=-a[10],b[11]=-a[11],b[12]=-a[12],b[13]=-a[13],b[14]=-a[14],b[15]=-a[15],b},window.SceneJS_math_addMat4=function(a,b,c){return c||(c=a),c[0]=a[0]+b[0],c[1]=a[1]+b[1],c[2]=a[2]+b[2],c[3]=a[3]+b[3],c[4]=a[4]+b[4],c[5]=a[5]+b[5],c[6]=a[6]+b[6],c[7]=a[7]+b[7],c[8]=a[8]+b[8],c[9]=a[9]+b[9],c[10]=a[10]+b[10],c[11]=a[11]+b[11],c[12]=a[12]+b[12],c[13]=a[13]+b[13],c[14]=a[14]+b[14],c[15]=a[15]+b[15],c},window.SceneJS_math_addMat4Scalar=function(a,b,c){return c||(c=a),c[0]=a[0]+b,c[1]=a[1]+b,c[2]=a[2]+b,c[3]=a[3]+b,c[4]=a[4]+b,c[5]=a[5]+b,c[6]=a[6]+b,c[7]=a[7]+b,c[8]=a[8]+b,c[9]=a[9]+b,c[10]=a[10]+b,c[11]=a[11]+b,c[12]=a[12]+b,c[13]=a[13]+b,c[14]=a[14]+b,c[15]=a[15]+b,c},window.SceneJS_math_addScalarMat4=function(a,b,c){return SceneJS_math_addMat4Scalar(b,a,c)},window.SceneJS_math_subMat4=function(a,b,c){return c||(c=a),c[0]=a[0]-b[0],c[1]=a[1]-b[1],c[2]=a[2]-b[2],c[3]=a[3]-b[3],c[4]=a[4]-b[4],c[5]=a[5]-b[5],c[6]=a[6]-b[6],c[7]=a[7]-b[7],c[8]=a[8]-b[8],c[9]=a[9]-b[9],c[10]=a[10]-b[10],c[11]=a[11]-b[11],c[12]=a[12]-b[12],c[13]=a[13]-b[13],c[14]=a[14]-b[14],c[15]=a[15]-b[15],c},window.SceneJS_math_subMat4Scalar=function(a,b,c){return c||(c=a),c[0]=a[0]-b,c[1]=a[1]-b,c[2]=a[2]-b,c[3]=a[3]-b,c[4]=a[4]-b,c[5]=a[5]-b,c[6]=a[6]-b,c[7]=a[7]-b,c[8]=a[8]-b,c[9]=a[9]-b,c[10]=a[10]-b,c[11]=a[11]-b,c[12]=a[12]-b,c[13]=a[13]-b,c[14]=a[14]-b,c[15]=a[15]-b,c},window.SceneJS_math_subScalarMat4=function(a,b,c){return c||(c=b),c[0]=a-b[0],c[1]=a-b[1],c[2]=a-b[2],c[3]=a-b[3],c[4]=a-b[4],c[5]=a-b[5],c[6]=a-b[6],c[7]=a-b[7],c[8]=a-b[8],c[9]=a-b[9],c[10]=a-b[10],c[11]=a-b[11],c[12]=a-b[12],c[13]=a-b[13],c[14]=a-b[14],c[15]=a-b[15],c},window.SceneJS_math_mulMat4=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},window.SceneJS_math_mulMat4s=function(a,b,c){return c||(c=a),c[0]=a[0]*b,c[1]=a[1]*b,c[2]=a[2]*b,c[3]=a[3]*b,c[4]=a[4]*b,c[5]=a[5]*b,c[6]=a[6]*b,c[7]=a[7]*b,c[8]=a[8]*b,c[9]=a[9]*b,c[10]=a[10]*b,c[11]=a[11]*b,c[12]=a[12]*b,c[13]=a[13]*b,c[14]=a[14]*b,c[15]=a[15]*b,c},window.SceneJS_math_mulMat4v4=function(a,b){var c=b[0],d=b[1],e=b[2],f=b[3];return[a[0]*c+a[4]*d+a[8]*e+a[12]*f,a[1]*c+a[5]*d+a[9]*e+a[13]*f,a[2]*c+a[6]*d+a[10]*e+a[14]*f,a[3]*c+a[7]*d+a[11]*e+a[15]*f]},window.SceneJS_math_transposeMat4=function(a,b){var c=a[4],d=a[14],e=a[8],f=a[13],g=a[12],h=a[9];if(!b||a==b){var i=a[1],j=a[2],k=a[3],l=a[6],m=a[7],n=a[11];return a[1]=c,a[2]=e,a[3]=g,a[4]=i,a[6]=h,a[7]=f,a[8]=j,a[9]=l,a[11]=d,a[12]=k,a[13]=m,a[14]=n,a}return b[0]=a[0],b[1]=c,b[2]=e,b[3]=g,b[4]=a[1],b[5]=a[5],b[6]=h,b[7]=f,b[8]=a[2],b[9]=a[6],b[10]=a[10],b[11]=d,b[12]=a[3],b[13]=a[7],b[14]=a[11],b[15]=a[15],b},window.SceneJS_math_determinantMat4=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=a[4],g=a[5],h=a[6],i=a[7],j=a[8],k=a[9],l=a[10],m=a[11],n=a[12],o=a[13],p=a[14],q=a[15];return n*k*h*e-j*o*h*e-n*g*l*e+f*o*l*e+j*g*p*e-f*k*p*e-n*k*d*i+j*o*d*i+n*c*l*i-b*o*l*i-j*c*p*i+b*k*p*i+n*g*d*m-f*o*d*m-n*c*h*m+b*o*h*m+f*c*p*m-b*g*p*m-j*g*d*q+f*k*d*q+j*c*h*q-b*k*h*q-f*c*l*q+b*g*l*q},window.SceneJS_math_inverseMat4=function(a,b){b||(b=a);var c=a[0],d=a[1],e=a[2],f=a[3],g=a[4],h=a[5],i=a[6],j=a[7],k=a[8],l=a[9],m=a[10],n=a[11],o=a[12],p=a[13],q=a[14],r=a[15],s=c*h-d*g,t=c*i-e*g,u=c*j-f*g,v=d*i-e*h,w=d*j-f*h,x=e*j-f*i,y=k*p-l*o,z=k*q-m*o,A=k*r-n*o,B=l*q-m*p,C=l*r-n*p,D=m*r-n*q,E=1/(s*D-t*C+u*B+v*A-w*z+x*y);return b[0]=(h*D-i*C+j*B)*E,b[1]=(-d*D+e*C-f*B)*E,b[2]=(p*x-q*w+r*v)*E,b[3]=(-l*x+m*w-n*v)*E,b[4]=(-g*D+i*A-j*z)*E,b[5]=(c*D-e*A+f*z)*E,b[6]=(-o*x+q*u-r*t)*E,b[7]=(k*x-m*u+n*t)*E,b[8]=(g*C-h*A+j*y)*E,b[9]=(-c*C+d*A-f*y)*E,b[10]=(o*w-p*u+r*s)*E,b[11]=(-k*w+l*u-n*s)*E,b[12]=(-g*B+h*z-i*y)*E,b[13]=(c*B-d*z+e*y)*E,b[14]=(-o*v+p*t-q*s)*E,b[15]=(k*v-l*t+m*s)*E,b},window.SceneJS_math_traceMat4=function(a){return a[0]+a[5]+a[10]+a[15]},window.SceneJS_math_translationMat4v=function(a){var b=SceneJS_math_identityMat4();return b[12]=a[0],b[13]=a[1],b[14]=a[2],b},window.SceneJS_math_translationMat4c=function(a,b,c){return SceneJS_math_translationMat4v([a,b,c])},window.SceneJS_math_translationMat4s=function(a){return SceneJS_math_translationMat4c(a,a,a)},window.SceneJS_math_rotationMat4v=function(a,b){var c,d,e,f,g,h,i=SceneJS_math_normalizeVec4([b[0],b[1],b[2],0]),j=Math.sin(a),k=Math.cos(a),l=1-k,m=i[0],n=i[1],o=i[2];c=m*n,d=n*o,e=o*m,f=m*j,g=n*j,h=o*j;var p=SceneJS_math_mat4();return p[0]=l*m*m+k,p[1]=l*c+h,p[2]=l*e-g,p[3]=0,p[4]=l*c-h,p[5]=l*n*n+k,p[6]=l*d+f,p[7]=0,p[8]=l*e+g,p[9]=l*d-f,p[10]=l*o*o+k,p[11]=0,p[12]=0,p[13]=0,p[14]=0,p[15]=1,p},window.SceneJS_math_rotationMat4c=function(a,b,c,d){return SceneJS_math_rotationMat4v(a,[b,c,d])},window.SceneJS_math_scalingMat4v=function(a){var b=SceneJS_math_identityMat4();return b[0]=a[0],b[5]=a[1],b[10]=a[2],b},window.SceneJS_math_scalingMat4c=function(a,b,c){return SceneJS_math_scalingMat4v([a,b,c])},window.SceneJS_math_scalingMat4s=function(a){return SceneJS_math_scalingMat4c(a,a,a)},window.SceneJS_math_LOOKAT_OBJ={eye:{x:0,y:0,z:10},look:{x:0,y:0,z:0},up:{x:0,y:1,z:0}},window.SceneJS_math_LOOKAT_ARRAYS={eye:[0,0,10],look:[0,0,0],up:[0,1,0]},window.SceneJS_math_ORTHO_OBJ={left:-1,right:1,bottom:-1,near:.1,top:1,far:5e3},window.SceneJS_math_lookAtMat4v=function(a,b,c,d){d||(d=SceneJS_math_mat4());var e=a[0],f=a[1],g=a[2],h=c[0],i=c[1],j=c[2],k=b[0],l=b[1],m=b[2];if(e==k&&f==l&&g==m)return SceneJS_math_identityMat4();var n,o,p,q,r,s,t,u,v,w;return n=e-k,o=f-l,p=g-m,w=1/Math.sqrt(n*n+o*o+p*p),n*=w,o*=w,p*=w,q=i*p-j*o,r=j*n-h*p,s=h*o-i*n,w=Math.sqrt(q*q+r*r+s*s),w?(w=1/w,q*=w,r*=w,s*=w):(q=0,r=0,s=0),t=o*s-p*r,u=p*q-n*s,v=n*r-o*q,w=Math.sqrt(t*t+u*u+v*v),w?(w=1/w,t*=w,u*=w,v*=w):(t=0,u=0,v=0),d[0]=q,d[1]=t,d[2]=n,d[3]=0,d[4]=r,d[5]=u,d[6]=o,d[7]=0,d[8]=s,d[9]=v,d[10]=p,d[11]=0,d[12]=-(q*e+r*f+s*g),d[13]=-(t*e+u*f+v*g),d[14]=-(n*e+o*f+p*g),d[15]=1,d},window.SceneJS_math_lookAtMat4c=function(a,b,c,d,e,f,g,h,i){return SceneJS_math_lookAtMat4v([a,b,c],[d,e,f],[g,h,i])},window.SceneJS_math_orthoMat4c=function(a,b,c,d,e,f,g){g||(g=SceneJS_math_mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2/i,g[6]=0,g[7]=0,g[8]=0,g[9]=0,g[10]=-2/j,g[11]=0,g[12]=-(a+b)/h,g[13]=-(d+c)/i,g[14]=-(f+e)/j,g[15]=1,g},window.SceneJS_math_frustumMat4v=function(a,b){var c=[a[0],a[1],a[2],0],d=[b[0],b[1],b[2],0],e=SceneJS_math_mat4();SceneJS_math_addVec4(d,c,e);var f=SceneJS_math_mat4();SceneJS_math_subVec4(d,c,f);var g=2*c[2],h=SceneJS_math_mat4(),i=f[0],j=f[1],k=f[2];return h[0]=g/i,h[1]=0,h[2]=0,h[3]=0,h[4]=0,h[5]=g/j,h[6]=0,h[7]=0,h[8]=e[0]/i,h[9]=e[1]/j,h[10]=-e[2]/k,h[11]=-1,h[12]=0,h[13]=0,h[14]=-g*d[2]/k,h[15]=0,h},window.SceneJS_math_frustumMatrix4=function(a,b,c,d,e,f,g){g||(g=SceneJS_math_mat4());var h=b-a,i=d-c,j=f-e;return g[0]=2*e/h,g[1]=0,g[2]=0,g[3]=0,g[4]=0,g[5]=2*e/i,g[6]=0,g[7]=0,g[8]=(b+a)/h,g[9]=(d+c)/i,g[10]=-(f+e)/j,g[11]=-1,g[12]=0,g[13]=0,g[14]=-(f*e*2)/j,g[15]=0,g},window.SceneJS_math_perspectiveMatrix4=function(a,b,c,d){var e=[],f=[];return e[2]=c,f[2]=d,f[1]=e[2]*Math.tan(a/2),e[1]=-f[1],f[0]=f[1]*b,e[0]=-f[0],SceneJS_math_frustumMat4v(e,f)},window.SceneJS_math_transformPoint3=function(a,b){var c=b[0],d=b[1],e=b[2];return[a[0]*c+a[4]*d+a[8]*e+a[12],a[1]*c+a[5]*d+a[9]*e+a[13],a[2]*c+a[6]*d+a[10]*e+a[14],a[3]*c+a[7]*d+a[11]*e+a[15]]},window.SceneJS_math_transformPoints3=function(a,b){for(var c,d,e,f,g=new Array(b.length),h=b.length,i=a[0],j=a[1],k=a[2],l=a[3],m=a[4],n=a[5],o=a[6],p=a[7],q=a[8],r=a[9],s=a[10],t=a[11],u=a[12],v=a[13],w=a[14],x=a[15],y=0;h>y;++y)f=b[y],c=f[0],d=f[1],e=f[2],g[y]=[i*c+m*d+q*e+u,j*c+n*d+r*e+v,k*c+o*d+s*e+w,l*c+p*d+t*e+x];return g},window.SceneJS_math_transformVector3=function(a,b,c){var d=b[0],e=b[1],f=b[2];return c=c||SceneJS_math_vec3(),c[0]=a[0]*d+a[4]*e+a[8]*f,c[1]=a[1]*d+a[5]*e+a[9]*f,c[2]=a[2]*d+a[6]*e+a[10]*f,c},window.SceneJS_math_transformVector4=function(a,b,c){var d=b[0],e=b[1],f=b[2],g=b[3];return c=c||SceneJS_math_vec4(),c[0]=a[0]*d+a[4]*e+a[8]*f+a[12]*g,c[1]=a[1]*d+a[5]*e+a[9]*f+a[13]*g,c[2]=a[2]*d+a[6]*e+a[10]*f+a[14]*g,c[3]=a[3]*d+a[7]*e+a[11]*f+a[15]*g,c},window.SceneJS_math_projectVec4=function(a){var b=1/a[3];return[a[0]*b,a[1]*b,a[2]*b,1]},window.SceneJS_math_Plane3=function(a,b,c){if(this.normal=[0,0,1],this.offset=0,a&&b){var d=a[0],e=a[1],f=a[2];if(this.offset=b,c){var g=Math.sqrt(d*d+e*e+f*f);g>0&&(g=1/g,this.normal[0]=d*g,this.normal[1]=e*g,this.normal[2]=f*g,this.offset*=g)}}},window.SceneJS_math_MAX_DOUBLE=Number.POSITIVE_INFINITY,window.SceneJS_math_MIN_DOUBLE=Number.NEGATIVE_INFINITY,window.SceneJS_math_Box3=function(a,b){this.min=a||[SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE,SceneJS_math_MAX_DOUBLE],this.max=b||[SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE,SceneJS_math_MIN_DOUBLE],this.init=function(a,b){return this.min[0]=a[0],this.min[1]=a[1],this.min[2]=a[2],this.max[0]=b[0],this.max[1]=b[1],this.max[2]=b[2],this},this.fromPoints=function(a){for(var b=a.length,c=0;b>c;++c){var d=a[c][3],e=a[c][0]/d,f=a[c][1]/d,g=a[c][2]/d;e<this.min[0]&&(this.min[0]=e),f<this.min[1]&&(this.min[1]=f),g<this.min[2]&&(this.min[2]=g),e>this.max[0]&&(this.max[0]=e),f>this.max[1]&&(this.max[1]=f),g>this.max[2]&&(this.max[2]=g)}return this},this.isEmpty=function(){return this.min[0]>=this.max[0]&&this.min[1]>=this.max[1]&&this.min[2]>=this.max[2]},this.getCenter=function(){return[(this.max[0]+this.min[0])/2,(this.max[1]+this.min[1])/2,(this.max[2]+this.min[2])/2]},this.getSize=function(){return[this.max[0]-this.min[0],this.max[1]-this.min[1],this.max[2]-this.min[2]]},this.getFacesAreas=function(){var a=this.size;return[a[1]*a[2],a[0]*a[2],a[0]*a[1]]},this.getSurfaceArea=function(){var a=this.getFacesAreas();return 2*(a[0]+a[1]+a[2])},this.getVolume=function(){var a=this.size;return a[0]*a[1]*a[2]},this.getOffset=function(a){return this.min[0]-=a,this.min[1]-=a,this.min[2]-=a,this.max[0]+=a,this.max[1]+=a,this.max[2]+=a,this}},window.SceneJS_math_AxisBox3=function(a,b){var c=a[0],d=a[1],e=a[2],f=b[0],g=b[1],h=b[2];this.verts=[[c,d,e],[f,d,e],[f,g,e],[c,g,e],[c,d,h],[f,d,h],[f,g,h],[c,g,h]],this.toBox3=function(){for(var a=new SceneJS_math_Box3,b=0;8>b;++b)for(var c=this.verts[b],d=0;3>d;++d)c[d]<a.min[d]&&(a.min[d]=c[d]),c[d]>a.max[d]&&(a.max[d]=c[d])}},window.SceneJS_math_Sphere3=function(a,b){this.center=[a[0],a[1],a[2]],this.radius=b,this.isEmpty=function(){return 0===this.radius},this.surfaceArea=function(){return 4*Math.PI*this.radius*this.radius},this.getVolume=function(){var a=this.radius;return 4/3*Math.PI*a*a*a}},window.SceneJS_math_billboardMat=function(a){var b=[SceneJS_math_getColMat4(a,0),SceneJS_math_getColMat4(a,1),SceneJS_math_getColMat4(a,2)],c=[SceneJS_math_lenVec4(b[0]),SceneJS_math_lenVec4(b[1]),SceneJS_math_lenVec4(b[2])],d=SceneJS_math_mat4();SceneJS_math_rcpVec3(c,d);var e=SceneJS_math_scalingMat4v(c);SceneJS_math_mulVec4Scalar(b[0],d[0]),SceneJS_math_mulVec4Scalar(b[1],d[1]),SceneJS_math_mulVec4Scalar(b[2],d[2]);var f=SceneJS_math_identityMat4();return SceneJS_math_setRowMat4(f,0,b[0]),SceneJS_math_setRowMat4(f,1,b[1]),SceneJS_math_setRowMat4(f,2,b[2]),SceneJS_math_mulMat4(f,e)},window.SceneJS_math_FrustumPlane=function(a,b,c,d){var e=1/Math.sqrt(a*a+b*b+c*c);this.normal=[a*e,b*e,c*e],this.offset=d*e,this.testVertex=[this.normal[0]>=0?1:0,this.normal[1]>=0?1:0,this.normal[2]>=0?1:0]},window.SceneJS_math_OUTSIDE_FRUSTUM=3,window.SceneJS_math_INTERSECT_FRUSTUM=4,window.SceneJS_math_INSIDE_FRUSTUM=5,window.SceneJS_math_Frustum=function(a,b,c){var d=SceneJS_math_mat4();SceneJS_math_mulMat4(b,a,d);var e=d[0],f=d[1],g=d[2],h=d[3],i=d[4],j=d[5],k=d[6],l=d[7],m=d[8],n=d[9],o=d[10],p=d[11],q=d[12],r=d[13],s=d[14],t=d[15],u=[new SceneJS_math_FrustumPlane(h-e,l-i,p-m,t-q),new SceneJS_math_FrustumPlane(h+e,l+i,p+m,t+q),new SceneJS_math_FrustumPlane(h-f,l-j,p-n,t-r),new SceneJS_math_FrustumPlane(h+f,l+j,p+n,t+r),new SceneJS_math_FrustumPlane(h-g,l-k,p-o,t-s),new SceneJS_math_FrustumPlane(h+g,l+k,p+o,t+s)],v=[SceneJS_math_getColMat4(a,0),SceneJS_math_getColMat4(a,1),SceneJS_math_getColMat4(a,2)],w=[SceneJS_math_lenVec4(v[0]),SceneJS_math_lenVec4(v[1]),SceneJS_math_lenVec4(v[2])],x=SceneJS_math_rcpVec3(w),y=SceneJS_math_scalingMat4v(w),z=SceneJS_math_scalingMat4v(x);SceneJS_math_mulVec4Scalar(v[0],x[0]),SceneJS_math_mulVec4Scalar(v[1],x[1]),SceneJS_math_mulVec4Scalar(v[2],x[2]);var A=SceneJS_math_identityMat4();SceneJS_math_setRowMat4(A,0,v[0]),SceneJS_math_setRowMat4(A,1,v[1]),SceneJS_math_setRowMat4(A,2,v[2]),this.matrix||(this.matrix=SceneJS_math_mat4()),SceneJS_math_mulMat4(b,a,this.matrix),this.billboardMatrix||(this.billboardMatrix=SceneJS_math_mat4()),SceneJS_math_mulMat4(z,SceneJS_math_mulMat4(A,y),this.billboardMatrix),this.viewport=c.slice(0,4),this.textAxisBoxIntersection=function(a){for(var b=SceneJS_math_INSIDE_FRUSTUM,c=[a.min,a.max],d=null,e=0;6>e;++e){if(d=u[e],d.normal[0]*c[d.testVertex[0]][0]+d.normal[1]*c[d.testVertex[1]][1]+d.normal[2]*c[d.testVertex[2]][2]+d.offset<0)return SceneJS_math_OUTSIDE_FRUSTUM;d.normal[0]*c[1-d.testVertex[0]][0]+d.normal[1]*c[1-d.testVertex[1]][1]+d.normal[2]*c[1-d.testVertex[2]][2]+d.offset<0&&(b=SceneJS_math_INTERSECT_FRUSTUM)}return b},this.getProjectedSize=function(a){var b=SceneJS_math_mat4();SceneJS_math_subVec3(a.max,a.min,b);var d=SceneJS_math_lenVec3(b),e=Math.abs(d),f=[.5*(a.min[0]+a.max[0]),.5*(a.min[1]+a.max[1]),.5*(a.min[2]+a.max[2]),0],g=.5*e,h=[-g,0,0,1],i=[g,0,0,1];return h=SceneJS_math_mulMat4v4(this.billboardMatrix,h),h=SceneJS_math_addVec4(h,f),h=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,h)),i=SceneJS_math_mulMat4v4(this.billboardMatrix,i),i=SceneJS_math_addVec4(i,f),i=SceneJS_math_projectVec4(SceneJS_math_mulMat4v4(this.matrix,i)),c[2]*Math.abs(i[0]-h[0])},this.getProjectedState=function(a){for(var b,d,e,f=SceneJS_math_transformPoints3(this.matrix,a),g=1e7,h=1e7,i=-1e7,j=-1e7,k=f.length,l=0;k>l;++l)b=SceneJS_math_projectVec4(f[l]),d=b[0],e=b[1],-.5>d&&(d=-.5),-.5>e&&(e=-.5),d>.5&&(d=.5),e>.5&&(e=.5),g>d&&(g=d),h>e&&(h=e),d>i&&(i=d),e>j&&(j=e);g+=.5,h+=.5,i+=.5,j+=.5;var m=c[2],n=c[3];g*=m+15,h*=n+15,i*=m+15,j*=n+15;var o=SceneJS_math_mat4();SceneJS_math_subVec2([i,j],[g,h],o);var p=SceneJS_math_lenVec2(o);return 0>g&&(g=0),i>m&&(i=m),0>h&&(h=0),j>n&&(j=n),{canvasBox:{min:[g,h],max:[i,j]},canvasSize:p}}},window.SceneJS_math_identityQuaternion=function(){return[0,0,0,1]},window.SceneJS_math_angleAxisQuaternion=function(a,b,c,d){var e=d/180*Math.PI,f=e/2,g=Math.sin(f);return[g*a,g*b,g*c,Math.cos(f)]},window.SceneJS_math_mulQuaternions=function(a,b){var c=a[0],d=a[1],e=a[2],f=a[3],g=b[0],h=b[1],i=b[2],j=b[3];return[f*g+c*j+d*i-e*h,f*h+d*j+e*g-c*i,f*i+e*j+c*h-d*g,f*j-c*g-d*h-e*i]},window.SceneJS_math_newMat4FromQuaternion=function(a){var b=a[0],c=a[1],d=a[2],e=a[3],f=2*b,g=2*c,h=2*d,i=f*e,j=g*e,k=h*e,l=f*b,m=g*b,n=h*b,o=g*c,p=h*c,q=h*d,r=SceneJS_math_identityMat4();return SceneJS_math_setCellMat4(r,0,0,1-(o+q)),SceneJS_math_setCellMat4(r,0,1,m-k),SceneJS_math_setCellMat4(r,0,2,n+j),SceneJS_math_setCellMat4(r,1,0,m+k),SceneJS_math_setCellMat4(r,1,1,1-(l+q)),SceneJS_math_setCellMat4(r,1,2,p-i),SceneJS_math_setCellMat4(r,2,0,n-j),SceneJS_math_setCellMat4(r,2,1,p+i),SceneJS_math_setCellMat4(r,2,2,1-(l+o)),r},window.SceneJS_math_slerp=function(a,b,c){var d=.0174532925*b[3],e=.0174532925*c[3],f=d*e+b[0]*c[0]+b[1]*c[1]+b[2]*c[2];if(Math.abs(f)>=1)return[b[0],b[1],b[2],b[3]];var g=Math.acos(f),h=Math.sqrt(1-f*f);

if(Math.abs(h)<.001)return[.5*b[0]+.5*c[0],.5*b[1]+.5*c[1],.5*b[2]+.5*c[2],.5*b[3]+.5*c[3]];var i=Math.sin((1-a)*g)/h,j=Math.sin(a*g)/h;return[b[0]*i+c[0]*j,b[1]*i+c[1]*j,b[2]*i+c[2]*j,57.295779579*(d*i+e*j)]},window.SceneJS_math_normalizeQuaternion=function(a){var b=SceneJS_math_lenVec4([a[0],a[1],a[2],a[3]]);return[a[0]/b,a[1]/b,a[2]/b,a[3]/b]},window.SceneJS_math_conjugateQuaternion=function(a){return[-a[0],-a[1],-a[2],a[3]]},window.SceneJS_math_angleAxisFromQuaternion=function(a){a=SceneJS_math_normalizeQuaternion(a);var b=a[3],c=2*Math.acos(b),d=Math.sqrt(1-b*b);return.001>d?{x:a[0],y:a[1],z:a[2],angle:57.295779579*c}:{x:a[0]/d,y:a[1]/d,z:a[2]/d,angle:57.295779579*c}},window.SceneJS_math_getPickPrimitives=function(a,b,c,d){c=c||{};for(var e,f,g,h,i,j=[],k=[],l=[],m=0,n=0,o=0;o<b.length;o+=3)n++,n=o+1,d?(f=Math.random(),g=Math.random(),h=Math.random(),i=1):(h=(n>>16&255)/255,g=(n>>8&255)/255,f=(255&n)/255,i=1),e=b[o+0],j.push(a[3*e+0]),j.push(a[3*e+1]),j.push(a[3*e+2]),k.push(f),k.push(g),k.push(h),k.push(i),l.push(m++),e=b[o+1],j.push(a[3*e+0]),j.push(a[3*e+1]),j.push(a[3*e+2]),k.push(f),k.push(g),k.push(h),k.push(i),l.push(m++),e=b[o+2],j.push(a[3*e+0]),j.push(a[3*e+1]),j.push(a[3*e+2]),k.push(f),k.push(g),k.push(h),k.push(i),l.push(m++);return c.pickPositions=j,c.pickColors=k,c.pickIndices=l,c},window.SceneJS_math_getPickIndices=function(a){for(var b=[],c=0,d=0;d<a.length;d+=3)b.push(c++),b.push(c++),b.push(c++);return b},window.SceneJS_math_getPickPositions=function(a,b){for(var c,d=[],e=0,f=0;f<b.length;f+=3)e++,e=f+1,c=b[f+0],d.push(a[3*c+0]),d.push(a[3*c+1]),d.push(a[3*c+2]),c=b[f+1],d.push(a[3*c+0]),d.push(a[3*c+1]),d.push(a[3*c+2]),c=b[f+2],d.push(a[3*c+0]),d.push(a[3*c+1]),d.push(a[3*c+2]);return d},window.SceneJS_math_getPickColors=function(a){for(var b,c,d,e,f=[],g=0,h=0;h<a.length;h+=3)e=(g>>24&255)/255,d=(g>>16&255)/255,c=(g>>8&255)/255,b=(255&g)/255,f.push(b),f.push(c),f.push(d),f.push(e),f.push(b),f.push(c),f.push(d),f.push(e),f.push(b),f.push(c),f.push(d),f.push(e),g++;return f},window.SceneJS_math_rayTriangleIntersect=function(f,g,h,i,j,k){k=k||SceneJS_math_vec3();var l=1e-6,m=SceneJS_math_subVec3(i,h,a),n=SceneJS_math_subVec3(j,h,b),o=SceneJS_math_cross3Vec3(g,n,c),p=SceneJS_math_dotVec3(m,o);if(l>p)return null;var q=SceneJS_math_subVec3(f,h,d),r=SceneJS_math_dotVec3(q,o);if(0>r||r>p)return null;var s=SceneJS_math_cross3Vec3(q,m,e),t=SceneJS_math_dotVec3(g,s);if(0>t||r+t>p)return null;var u=SceneJS_math_dotVec3(n,s)/p;return k[0]=f[0]+u*g[0],k[1]=f[1]+u*g[1],k[2]=f[2]+u*g[2],k},window.SceneJS_math_rayPlaneIntersect=function(e,f,g,h,i,j){j=j||SceneJS_math_vec3(),f=SceneJS_math_normalizeVec3(f,a);var k=SceneJS_math_subVec3(h,g,b),l=SceneJS_math_subVec3(i,g,c),m=SceneJS_math_cross3Vec3(k,l,d);SceneJS_math_normalizeVec3(m,m);var n=-SceneJS_math_dotVec3(g,m),o=-(SceneJS_math_dotVec3(e,m)+n)/SceneJS_math_dotVec3(f,m);return j[0]=e[0]+o*f[0],j[1]=e[1]+o*f[1],j[2]=e[2]+o*f[2],j},window.SceneJS_math_cartesianToBarycentric=function(g,h,i,j,k){var l=SceneJS_math_subVec3(h,g,a),m=SceneJS_math_subVec3(i,g,b),n=SceneJS_math_subVec3(j,g,c),o=SceneJS_math_subVec3(h,i,d),p=SceneJS_math_subVec3(h,j,e),q=SceneJS_math_lenVec3(SceneJS_math_cross3Vec3(o,p,f));return k[0]=SceneJS_math_lenVec3(SceneJS_math_cross3Vec3(m,n,f))/q,k[1]=SceneJS_math_lenVec3(SceneJS_math_cross3Vec3(n,l,f))/q,k[2]=SceneJS_math_lenVec3(SceneJS_math_cross3Vec3(l,m,f))/q,k},window.SceneJS_math_cartesianToBarycentric2=function(d,e,f,g,h){var i=SceneJS_math_subVec3(g,e,a),j=SceneJS_math_subVec3(f,e,b),k=SceneJS_math_subVec3(d,e,c),l=SceneJS_math_dotVector3(i,i),m=SceneJS_math_dotVector3(i,j),n=SceneJS_math_dotVector3(i,k),o=SceneJS_math_dotVector3(j,j),p=SceneJS_math_dotVector3(j,k),q=l*o-m*m;if(0===q)return null;var r=1/q,s=(o*n-m*p)*r,t=(l*p-m*n)*r;return h[0]=1-s-t,h[1]=t,h[2]=s,h},window.SceneJS_math_barycentricInsideTriangle=function(a){var b=a[1],c=a[2];return c>=0&&b>=0&&1>c+b},window.SceneJS_math_barycentricToCartesian=function(a,b,c,d,e){e=e||SceneJS_math_vec3();var f=a[0],g=a[1],h=a[2];return e[0]=b[0]*f+c[0]*g+d[0]*h,e[1]=b[1]*f+c[1]*g+d[1]*h,e[2]=b[2]*f+c[2]*g+d[2]*h,e}}();var SceneJS_sceneStatusModule=new function(){function a(){var a=document.getElementsByTagName("body")[0],b=document.createElement("div"),c=b.style;return c.position="absolute",c.width="200px",c.right="10px",c.top="0",c.padding="10px",c["z-index"]="10000",a.appendChild(b),b}function b(a,b){var c=document.createElement("div"),d=c.style;return d["font-family"]="Helvetica",d["font-size"]="14px",d.padding="5px",d.margin="4px",d["padding-left"]="12px",d.border="1px solid #000055",d.color="black",d.background="#AAAAAA",d.opacity="0.8",d["border-radius"]="3px",d["-moz-border-radius"]="3px",d["box-shadow"]="3px 3px 3px #444444",c.innerHTML=b,a.appendChild(c),c}function c(a){a.style.background="#AAFFAA";var b=.8,c=setInterval(function(){0>=b?(a.parentNode.removeChild(a),clearInterval(c)):(a.style.opacity=b,b-=.1)},100)}function d(a){a.style.background="#FFAAAA"}this.sceneStatus={};var e=new SceneJS_Map,f={},g={},h=this;SceneJS_events.addListener(SceneJS_events.SCENE_DESTROYED,function(a){var b=a.engine.id;delete h.sceneStatus[b],delete g[b]}),this.taskStarted=function(c,d){var h=SceneJS_configsModule.configs.statusPopups!==!1,i=c.getScene(),j=i.getId(),k=c.getId(),l=i.getCanvas(),m=e.addItem(),n=this.sceneStatus[j];n||(n=this.sceneStatus[j]={numTasks:0}),n.numTasks++;var o=g[j];o||(o=g[j]={sceneId:j,nodeStates:{},scene:i,popupContainer:h?a(l):null,descCounts:{}});var p=o.descCounts[d];void 0==p&&(p=o.descCounts[d]=0),o.descCounts[d]++;var q=o.nodeStates[k];q||(q=o.nodeStates[k]={nodeId:k,numTasks:0,tasks:{}}),d=d+" "+o.descCounts[d]+"...",q.numTasks++;var r={sceneState:o,nodeState:q,description:d,element:h?b(o.popupContainer,d):null};return q.tasks[m]=r,f[m]=r,m},this.taskFinished=function(a){if(-1==a||null==a)return null;var b=f[a];if(!b)return null;var d=b.sceneState;this.sceneStatus[d.sceneId].numTasks--,b.element&&c(b.element);var e=b.nodeState;return--e.numTasks<0&&(e.numTasks=0),delete e.tasks[a],0==e.numTasks&&delete d.nodeStates[e.nodeId],null},this.taskFailed=function(a){if(-1==a||null==a)return null;var b=f[a];if(!b)return null;var c=!!SceneJS_configsModule.configs.statusPopups,e=b.sceneState;this.sceneStatus[e.sceneId].numTasks--,c&&d(b.element);var g=b.nodeState;return g.numTasks--,delete g.tasks[a],0==g.numTasks&&delete b.sceneState.nodeStates[g.nodeId],null}};SceneJS._webgl={},SceneJS._webgl.ArrayBuffer=function(a,b,c,d,e,f){this.allocated=!1;var g=c.constructor==Uint8Array?a.UNSIGNED_BYTE:c.constructor==Uint16Array?a.UNSIGNED_SHORT:c.constructor==Uint32Array?a.UNSIGNED_INT:a.FLOAT;this.gl=a,this.type=b,this.itemType=g,this.numItems=d,this.itemSize=e,this.usage=f,this._allocate(c,d)},SceneJS._webgl.ArrayBuffer.prototype._allocate=function(a,b){if(this.allocated=!1,this.handle=this.gl.createBuffer(),!this.handle)throw SceneJS_error.fatalError(SceneJS.errors.OUT_OF_VRAM,"Failed to allocate WebGL ArrayBuffer");this.handle&&(this.gl.bindBuffer(this.type,this.handle),this.gl.bufferData(this.type,a,this.usage),this.gl.bindBuffer(this.type,null),this.numItems=b,this.length=a.length,this.allocated=!0)},SceneJS._webgl.ArrayBuffer.prototype.setData=function(a,b){this.allocated&&(a.length>this.length?(this.destroy(),this._allocate(a,a.length)):b||0===b?this.gl.bufferSubData(this.type,b,a):this.gl.bufferData(this.type,a))},SceneJS._webgl.ArrayBuffer.prototype.unbind=function(){this.allocated&&this.gl.bindBuffer(this.type,null)},SceneJS._webgl.ArrayBuffer.prototype.destroy=function(){this.allocated&&(this.gl.deleteBuffer(this.handle),this.handle=null,this.allocated=!1)},SceneJS._webgl.ArrayBuffer.prototype.bind=function(){this.allocated&&this.gl.bindBuffer(this.type,this.handle)},SceneJS._webgl.Attribute=function(a,b,c,d,e,f){this.gl=a,this.location=f,this.bindFloatArrayBuffer=function(b){b&&(b.bind(),a.enableVertexAttribArray(f),a.vertexAttribPointer(f,b.itemSize,a.FLOAT,!1,0,0))}},SceneJS._webgl.Attribute.prototype.bindInterleavedFloatArrayBuffer=function(a,b,c){this.gl.enableVertexAttribArray(this.location),this.gl.vertexAttribPointer(this.location,a,this.gl.FLOAT,!1,b,c)},SceneJS._webgl.enumMap={funcAdd:"FUNC_ADD",funcSubtract:"FUNC_SUBTRACT",funcReverseSubtract:"FUNC_REVERSE_SUBTRACT",zero:"ZERO",one:"ONE",srcColor:"SRC_COLOR",oneMinusSrcColor:"ONE_MINUS_SRC_COLOR",dstColor:"DST_COLOR",oneMinusDstColor:"ONE_MINUS_DST_COLOR",srcAlpha:"SRC_ALPHA",oneMinusSrcAlpha:"ONE_MINUS_SRC_ALPHA",dstAlpha:"DST_ALPHA",oneMinusDstAlpha:"ONE_MINUS_DST_ALPHA",contantColor:"CONSTANT_COLOR",oneMinusConstantColor:"ONE_MINUS_CONSTANT_COLOR",constantAlpha:"CONSTANT_ALPHA",oneMinusConstantAlpha:"ONE_MINUS_CONSTANT_ALPHA",srcAlphaSaturate:"SRC_ALPHA_SATURATE",front:"FRONT",back:"BACK",frontAndBack:"FRONT_AND_BACK",never:"NEVER",less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL",always:"ALWAYS",cw:"CW",ccw:"CCW",linear:"LINEAR",nearest:"NEAREST",linearMipMapNearest:"LINEAR_MIPMAP_NEAREST",nearestMipMapNearest:"NEAREST_MIPMAP_NEAREST",nearestMipMapLinear:"NEAREST_MIPMAP_LINEAR",linearMipMapLinear:"LINEAR_MIPMAP_LINEAR",repeat:"REPEAT",clampToEdge:"CLAMP_TO_EDGE",mirroredRepeat:"MIRRORED_REPEAT",alpha:"ALPHA",rgb:"RGB",rgba:"RGBA",luminance:"LUMINANCE",luminanceAlpha:"LUMINANCE_ALPHA",textureBinding2D:"TEXTURE_BINDING_2D",textureBindingCubeMap:"TEXTURE_BINDING_CUBE_MAP",compareRToTexture:"COMPARE_R_TO_TEXTURE",unsignedByte:"UNSIGNED_BYTE"},SceneJS._webgl.RenderBuffer=function(a){this.allocated=!1,this.canvas=a.canvas,this.gl=a.canvas.gl,this.buf=null,this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.webglRestored=function(a){this.gl=a,this.buf=null,this.allocated=!1,this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.bind=function(){this._touch(),this.bound||(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.bound=!0)},SceneJS._webgl.RenderBuffer.prototype._touch=function(){var a=this.canvas.canvas.width,b=this.canvas.canvas.height;if(this.buf){if(this.buf.width==a&&this.buf.height==b)return;this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf)}this.buf={framebuf:this.gl.createFramebuffer(),renderbuf:this.gl.createRenderbuffer(),texture:this.gl.createTexture(),width:a,height:b},this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),this.gl.bindTexture(this.gl.TEXTURE_2D,this.buf.texture),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.NEAREST),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE);try{this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,null)}catch(c){var d=new WebGLUnsignedByteArray(a*b*3);this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,a,b,0,this.gl.RGBA,this.gl.UNSIGNED_BYTE,d)}if(this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.renderbufferStorage(this.gl.RENDERBUFFER,this.gl.DEPTH_COMPONENT16,a,b),this.gl.framebufferTexture2D(this.gl.FRAMEBUFFER,this.gl.COLOR_ATTACHMENT0,this.gl.TEXTURE_2D,this.buf.texture,0),this.gl.framebufferRenderbuffer(this.gl.FRAMEBUFFER,this.gl.DEPTH_ATTACHMENT,this.gl.RENDERBUFFER,this.buf.renderbuf),this.gl.bindTexture(this.gl.TEXTURE_2D,null),this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,this.buf.framebuf),!this.gl.isFramebuffer(this.buf.framebuf))throw SceneJS_error.fatalError(SceneJS.errors.INVALID_FRAMEBUFFER,"Invalid framebuffer");var e=this.gl.checkFramebufferStatus(this.gl.FRAMEBUFFER);switch(e){case this.gl.FRAMEBUFFER_COMPLETE:break;case this.gl.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");case this.gl.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");case this.gl.FRAMEBUFFER_UNSUPPORTED:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: FRAMEBUFFER_UNSUPPORTED");default:throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Incomplete framebuffer: "+e)}this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.clear=function(){if(!this.bound)throw"Render buffer not bound";this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.gl.disable(this.gl.BLEND)},SceneJS._webgl.RenderBuffer.prototype.read=function(a,b){var c=a,d=this.canvas.canvas.height-b,e=new Uint8Array(4);return this.gl.readPixels(c,d,1,1,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),e},SceneJS._webgl.RenderBuffer.prototype.unbind=function(){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,null),this.bound=!1},SceneJS._webgl.RenderBuffer.prototype.getTexture=function(){var a=this;return{bind:function(b){return a.buf&&a.buf.texture?(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,a.buf.texture),!0):!1},unbind:function(b){a.buf&&a.buf.texture&&(a.gl.activeTexture(a.gl["TEXTURE"+b]),a.gl.bindTexture(a.gl.TEXTURE_2D,null))}}},SceneJS._webgl.RenderBuffer.prototype.destroy=function(){this.buf&&(this.gl.deleteTexture(this.buf.texture),this.gl.deleteFramebuffer(this.buf.framebuf),this.gl.deleteRenderbuffer(this.buf.renderbuf),this.buf=null,this.bound=!1)},SceneJS._webgl.Program=function(a,b,c){this.allocated=!1,this.gl=a,this._uniforms={},this._samplers={},this._attributes={},this.uniformValues=[],this.materialSettings={specularColor:[0,0,0],specular:0,shine:0,emit:0,alpha:0},this._shaders=[];var d,e,f,g,h,i;for(e=0;e<b.length;e++)this._shaders.push(new SceneJS._webgl.Shader(a,a.VERTEX_SHADER,b[e]));for(e=0;e<c.length;e++)this._shaders.push(new SceneJS._webgl.Shader(a,a.FRAGMENT_SHADER,c[e]));if(this.handle=a.createProgram(),this.handle){for(e=0;e<this._shaders.length;e++)i=this._shaders[e],i.valid&&a.attachShader(this.handle,i.handle);a.linkProgram(this.handle);var j=a.getProgramParameter(this.handle,a.ACTIVE_UNIFORMS),k=0;for(e=0;j>e;++e)f=a.getActiveUniform(this.handle,e),f&&(g=f.name,"\x00"==g[g.length-1]&&(g=g.substr(0,g.length-1)),h=a.getUniformLocation(this.handle,g),f.type==a.SAMPLER_2D||f.type==a.SAMPLER_CUBE||35682==f.type?this._samplers[g]=new SceneJS._webgl.Sampler(a,this.handle,g,f.type,f.size,h):(this._uniforms[g]=new SceneJS._webgl.Uniform(a,this.handle,g,f.type,f.size,h,k),this.uniformValues[k]=null,++k));var l=a.getProgramParameter(this.handle,a.ACTIVE_ATTRIBUTES);for(e=0;l>e;e++)d=a.getActiveAttrib(this.handle,e),d&&(h=a.getAttribLocation(this.handle,d.name),this._attributes[d.name]=new SceneJS._webgl.Attribute(a,this.handle,d.name,d.type,d.size,h));this.allocated=!0}},SceneJS._webgl.Program.prototype.bind=function(){this.allocated&&(this.gl.useProgram(this.handle),this.uniformValues.length=0)},SceneJS._webgl.Program.prototype.getUniformLocation=function(a){if(this.allocated){var b=this._uniforms[a];return b?b.getLocation():void 0}},SceneJS._webgl.Program.prototype.getUniform=function(a){if(this.allocated){var b=this._uniforms[a];return b?b:void 0}},SceneJS._webgl.Program.prototype.getAttribute=function(a){if(this.allocated){var b=this._attributes[a];return b?b:void 0}},SceneJS._webgl.Program.prototype.bindFloatArrayBuffer=function(a,b){if(this.allocated){var c=this._attributes[a];c&&c.bindFloatArrayBuffer(b)}},SceneJS._webgl.Program.prototype.bindTexture=function(a,b,c){if(!this.allocated)return!1;var d=this._samplers[a];return d?d.bindTexture(b,c):!1},SceneJS._webgl.Program.prototype.destroy=function(){if(this.allocated){this.gl.deleteProgram(this.handle);for(var a in this._shaders)this.gl.deleteShader(this._shaders[a].handle);this.handle=null,this._attributes=null,this._uniforms=null,this._samplers=null,this.allocated=!1}},SceneJS._webgl.Program.prototype.setUniform=function(a,b){if(this.allocated){var c=this._uniforms[a];c&&(this.uniformValues[c.index]===b&&c.numberValue||(c.setValue(b),this.uniformValues[c.index]=b))}},SceneJS._webgl.Sampler=function(a,b,c,d,e,f){this.bindTexture=function(b,c){return b.bind(c)?(a.uniform1i(f,c),!0):!1}},SceneJS._webgl.Shader=function(a,b,c){if(this.allocated=!1,this.handle=a.createShader(b),!this.handle)throw SceneJS_error.fatalError(SceneJS.errors.OUT_OF_VRAM,"Failed to create WebGL shader");if(a.shaderSource(this.handle,c),a.compileShader(this.handle),this.valid=0!=a.getShaderParameter(this.handle,a.COMPILE_STATUS),!this.valid&&!a.isContextLost()){SceneJS.log.error("Shader program failed to compile: "+a.getShaderInfoLog(this.handle)),SceneJS.log.error("Shader source:");for(var d=c.split("\n"),e=0;e<d.length;e++)SceneJS.log.error(e+1+": "+d[e]);throw SceneJS_error.fatalError(SceneJS.errors.SHADER_COMPILATION_FAILURE,"Shader program failed to compile")}this.allocated=!0},SceneJS._webgl.Texture2D=function(a,b){this.allocated=!1,this.target=b.target||a.TEXTURE_2D,this.minFilter=b.minFilter,this.magFilter=b.magFilter,this.wrapS=b.wrapS,this.wrapT=b.wrapT,this.update=b.update,this.texture=b.texture,this.format=a.RGBA,this.isDepth=!1,this.depthMode=0,this.depthCompareMode=0,this.depthCompareFunc=0;try{a.bindTexture(this.target,this.texture),b.minFilter&&a.texParameteri(this.target,a.TEXTURE_MIN_FILTER,b.minFilter),b.magFilter&&a.texParameteri(this.target,a.TEXTURE_MAG_FILTER,b.magFilter),b.wrapS&&a.texParameteri(this.target,a.TEXTURE_WRAP_S,b.wrapS),b.wrapT&&a.texParameteri(this.target,a.TEXTURE_WRAP_T,b.wrapT),(b.minFilter==a.NEAREST_MIPMAP_NEAREST||b.minFilter==a.LINEAR_MIPMAP_NEAREST||b.minFilter==a.NEAREST_MIPMAP_LINEAR||b.minFilter==a.LINEAR_MIPMAP_LINEAR)&&a.generateMipmap(this.target),a.bindTexture(this.target,null),this.allocated=!0}catch(c){throw SceneJS_error.fatalError(SceneJS.errors.OUT_OF_VRAM,"Failed to create texture: "+c.message||c)}this.bind=function(b){return this.allocated?this.texture?(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,this.texture),this.update&&this.update(a),!0):!1:void 0},this.unbind=function(b){this.allocated&&this.texture&&(a.activeTexture(a["TEXTURE"+b]),a.bindTexture(this.target,null))},this.destroy=function(){this.allocated&&this.texture&&(a.deleteTexture(this.texture),this.texture=null)}},SceneJS._webgl.clampImageSize=function(a,b){var c=a.width*a.height;if(c>b){var d=b/c,e=a.width*d,f=a.height*d,g=document.createElement("canvas");g.width=SceneJS._webgl.nextHighestPowerOfTwo(e),g.height=SceneJS._webgl.nextHighestPowerOfTwo(f);var h=g.getContext("2d");h.drawImage(a,0,0,a.width,a.height,0,0,g.width,g.height),a=g}return a},SceneJS._webgl.ensureImageSizePowerOfTwo=function(a){if(!SceneJS._webgl.isPowerOfTwo(a.width)||!SceneJS._webgl.isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=SceneJS._webgl.nextHighestPowerOfTwo(a.width),b.height=SceneJS._webgl.nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b}return a},SceneJS._webgl.isPowerOfTwo=function(a){return 0==(a&a-1)},SceneJS._webgl.nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},SceneJS._webgl.Uniform=function(a,b,c,d,e,f,g){var h=null,i=null;if(d===a.BOOL)h=function(b){i!==b&&(i=b,a.uniform1i(f,b))};else if(d===a.BOOL_VEC2)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1])&&(i=b,a.uniform2iv(f,b))};else if(d===a.BOOL_VEC3)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1]||i[2]!==b[2])&&(i=b,a.uniform3iv(f,b))};else if(d===a.BOOL_VEC4)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1]||i[2]!==b[2]||i[3]!==b[3])&&(i=b,a.uniform4iv(f,b))};else if(d===a.INT)h=function(b){i!==b&&(i=b,a.uniform1iv(f,b))};else if(d===a.INT_VEC2)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1])&&(i=b,a.uniform2iv(f,b))};else if(d===a.INT_VEC3)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1]||i[2]!==b[2])&&(i=b,a.uniform3iv(f,b))};else if(d===a.INT_VEC4)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1]||i[2]!==b[2]||i[3]!==b[3])&&(i=b,a.uniform4iv(f,b))};else if(d===a.FLOAT)h=function(b){i!==b&&(i=b,a.uniform1f(f,b))};else if(d===a.FLOAT_VEC2)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1])&&(i=b,a.uniform2fv(f,b))};else if(d===a.FLOAT_VEC3)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1]||i[2]!==b[2])&&(i=b,a.uniform3fv(f,b))};else if(d===a.FLOAT_VEC4)h=function(b){(null===i||i[0]!==b[0]||i[1]!==b[1]||i[2]!==b[2]||i[3]!==b[3])&&(i=b,a.uniform4fv(f,b))};else if(d===a.FLOAT_MAT2)h=function(b){a.uniformMatrix2fv(f,a.FALSE,b)};else if(d===a.FLOAT_MAT3)h=function(b){a.uniformMatrix3fv(f,a.FALSE,b)};else{if(d!==a.FLOAT_MAT4)throw"Unsupported shader uniform type: "+d;h=function(b){a.uniformMatrix4fv(f,a.FALSE,b)}}this.setValue=h,this.getLocation=function(){return f},this.index=g};var SceneJS_nodeEventsModule=new function(){var a,b=[],c=[],d=0,e={type:"listeners",stateId:SceneJS._baseStateId++,empty:!0,listeners:[]};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){d=0,a=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(f){if(a){if(d>0){var g={type:"listeners",stateId:b[d-1],listeners:c.slice(0,d)};f.display.renderListeners=g}else f.display.renderListeners=e;a=!1}}),this.preVisitNode=function(e){var f=e._topicSubs.rendered,g=e._topicSubs.worldPos,h=e._topicSubs.viewPos,i=e._topicSubs.cameraPos,j=e._topicSubs.projPos,k=e._topicSubs.canvasPos;(f||g||h||i||j||k)&&(b[d]=e.id,c[d]=function(a){f&&e.publish("rendered",a,!0),g&&e.publish("worldPos",a.getWorldPos()),h&&e.publish("viewPos",a.getViewPos()),i&&e.publish("cameraPos",a.getCameraPos()),j&&e.publish("projPos",a.getProjPos()),k&&e.publish("canvasPos",a.getCanvasPos())},d++,a=!0)},this.postVisitNode=function(c){c.id==b[d-1]&&(d--,a=!0)}},SceneJS_Core=function(a){this.type=a,this.coreId=null,this.stateId=null,this.useCount=0},SceneJS_CoreFactory=function(){this._stateMap=new SceneJS_Map(null,SceneJS._baseStateId),this._cores={}};SceneJS_CoreFactory.coreTypes={},SceneJS_CoreFactory.createCoreType=function(){},SceneJS_CoreFactory.addCoreBuilder=function(){},SceneJS_CoreFactory.coreAliases={rotate:"xform",translate:"xform",scale:"xform",matrix:"xform",xform:"xform"},SceneJS_CoreFactory.prototype.getCore=function(a,b){var c=SceneJS_CoreFactory.coreAliases[a];c&&(a=c);var d=this._cores[a];d||(d=this._cores[a]={});var e;return b&&(e=d[b])?(e.useCount++,e):(e=new SceneJS_Core(a),e.useCount=1,e.stateId=this._stateMap.addItem(e),e.coreId=void 0!=b&&null!=b?b:e.stateId,d[e.coreId]=e,e)},SceneJS_CoreFactory.prototype.hasCore=function(a,b){var c=SceneJS_CoreFactory.coreAliases[a];c&&(a=c);var d=this._cores[a];return d&&d[b]},SceneJS_CoreFactory.prototype.putCore=function(a){if(0!=a.useCount&&--a.useCount<=0){var b=this._cores[a.type];delete b[a.coreId],this._stateMap.removeItem(a.stateId)}},SceneJS_CoreFactory.prototype.webglRestored=function(){var a,b;for(var c in this._cores)if(this._cores.hasOwnProperty(c)&&(a=this._cores[c]))for(var d in a)a.hasOwnProperty(d)&&(b=a[d],b&&b.webglRestored&&b.webglRestored())},SceneJS.Node=function(){},SceneJS.Node.prototype.constructor=SceneJS.Node,SceneJS.Node.prototype._construct=function(a,b,c,d){this._engine=a,this._core=b,this.coreId=b.coreId,this.id=c.id||c.nodeId||d,this.type=c.type||"node",this.data=c.data,this.parent=null,this.nodes=[],this._handleMap=new SceneJS_Map,this._topicSubs={},this._handleTopics={},this._topicPubs={},this._listeners={},this._numListeners=0,this.dirty=!1,this.branchDirty=!1,this._init&&this._init(c)},SceneJS.Node.prototype.taskStarted=function(a){return SceneJS_sceneStatusModule.taskStarted(this,a||"Task")},SceneJS.Node.prototype.taskFinished=function(a){return SceneJS_sceneStatusModule.taskFinished(a)},SceneJS.Node.prototype.taskFailed=function(a){return SceneJS_sceneStatusModule.taskFailed(a)},SceneJS.Node.prototype.log=function(){var a,b;switch(1==arguments.length?(a="info",b=arguments[0]):2==arguments.length&&(a=arguments[0],b=arguments[1]),a){case"warn":b="WARN;  [SceneJS.Node type="+this.type+", id="+this.id+"] : "+b;break;case"error":b="ERROR; [SceneJS.Node type="+this.type+", id="+this.id+"] : "+b;break;default:b="INFO;  [SceneJS.Node type="+this.type+", id="+this.id+"] : "+b}console[a]?console[a](b):console.log(b)},SceneJS.Node.prototype.publish=function(a,b,c){if(c||(this._topicPubs[a]=b),this._topicSubs[a]){var d=this._topicSubs[a];for(var e in d)d.hasOwnProperty(e)&&d[e].call(this,b)}},SceneJS.Node.prototype.unpublish=function(a){var b=this._topicSubs[a];if(b)for(var c in b)b.hasOwnProperty(c)&&b[c].call(this,null);delete this._topicPubs[a]},SceneJS.Node.prototype.on=function(a,b){var c=this._topicSubs[a];c||(c={},this._topicSubs[a]=c);var d=this._handleMap.addItem();c[d]=b,this._handleTopics[d]=a;var e=this._topicPubs[a];return e&&b.call(this,e),"rendered"==a&&this._engine.branchDirty(this),d},SceneJS.Node.prototype.off=function(a){var b=this._handleTopics[a];if(b){delete this._handleTopics[a];var c=this._topicSubs[b];c&&delete c[a],this._handleMap.removeItem(a),"rendered"==b&&this._engine.branchDirty(this)}},SceneJS.Node.prototype.once=function(a,b){var c=this,d=this.on(a,function(a){c.off(d),b(a)})},SceneJS.Node.prototype.getScene=function(){return this._engine.scene},SceneJS.Node.prototype.getCoreId=function(){return this._core.coreId},SceneJS.Node.prototype.getID=function(){return this.id},SceneJS.Node.prototype.getId=function(){return this.id},SceneJS.Node.prototype.getNodeId=function(){return this.id},SceneJS.Node.prototype.getType=function(){return this.type},SceneJS.Node.prototype.getData=function(){return this.data},SceneJS.Node.prototype.setData=function(a){return this.data=a,this},SceneJS.Node.prototype.getNumNodes=function(){return this.nodes.length},SceneJS.Node.prototype.getNodes=function(){return this.nodes.slice(0)},SceneJS.Node.prototype.getNodeAt=function(a){return 0>a||a>=this.nodes.length?null:this.nodes[a]},SceneJS.Node.prototype.getFirstNode=function(){return 0==this.nodes.length?null:this.nodes[0]},SceneJS.Node.prototype.getLastNode=function(){return 0==this.nodes.length?null:this.nodes[this.nodes.length-1]},SceneJS.Node.prototype.getNode=function(a){for(var b=0;b<this.nodes.length;b++)if(this.nodes[b].id==a)return this.nodes[b];return null},SceneJS.Node.prototype.disconnectNodeAt=function(a){var b=this.nodes.splice(a,1);return b.length>0?(b[0].parent=null,this._engine.branchDirty(this),b[0]):null},SceneJS.Node.prototype.disconnect=function(){if(this.parent){for(var a=0;a<this.parent.nodes.length;a++)if(this.parent.nodes[a]===this){var b=this.parent.disconnectNodeAt(a);return this.parent=null,b}this.parent=null}return null},SceneJS.Node.prototype.removeNodeAt=function(a){var b=this.disconnectNodeAt(a);b&&b.destroy()},SceneJS.Node.prototype.removeNode=function(a){if(!a)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#removeNode - node argument undefined");if(!a._compile&&"string"==typeof a){var b=this._engine.findNode(a);if(!b)throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - node not found anywhere: '"+a+"'");a=b}if(a._compile)for(var c=0;c<this.nodes.length;c++)if(this.nodes[c]===a){var d=this.removeNodeAt(c);return d}throw SceneJS_error.fatalError(SceneJS.errors.NODE_NOT_FOUND,"Node#removeNode - child node not found: "+(a._compile?": "+a.id:a))},SceneJS.Node.prototype.disconnectNodes=function(){for(var a=this.nodes.length,b=0;a>b;b++)this.nodes[b].parent=null;var c=this.nodes;return this.nodes=[],this._engine.branchDirty(this),c},SceneJS.Node.prototype.removeNodes=function(){for(var a=this.disconnectNodes(),b=0;b<a.length;b++)a[b].destroy()},SceneJS.Node.prototype.splice=function(){var a,b;if(null==this.parent)return null;var c=this.parent,d=this.disconnectNodes();for(a=0,b=d.length;b>a;a++)d[a].parent=this.parent;for(a=0,b=c.nodes.length;b>a;a++)if(c.nodes[a]===this)return c.nodes.splice.apply(c.nodes,[a,1].concat(d)),this.nodes=[],this.parent=null,this.destroy(),this._engine.branchDirty(c),c},SceneJS.Node.prototype.addNodes=function(a,b){if(!a)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNodes - nodes argument is undefined");for(var c,d=[],e=a.length,f=a.length-1;f>=0;f--){var g=a[f];if("node"==g.type||this._engine.hasNodeType(g.type)){if(c=this.addNode(g),d[f]=c,0==--e)return b&&b(a),a}else{var h=this;!function(){var c=f;h.addNode(g,function(f){d[c]=f,0==--e&&b&&b(a)})}()}}return null},SceneJS.Node.prototype.addNode=function(a,b){if(a=a||{},a._compile){if(null!=a.parent)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is still attached to another parent");return this.nodes.push(a),a.parent=this,this._engine.branchDirty(a),b&&b(a),a}if("string"==typeof a){var c=this._engine.findNode(a);if(!c)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node not found: '"+a+"'");if(a=c,null!=a.parent)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Node#addNode - node argument is still attached to another parent");return this.nodes.push(a),a.parent=this,this._engine.branchDirty(a),b&&b(a),a}if(a.type=a.type||"node","node"==a.type||this._engine.hasNodeType(a.type))return a=this._engine.createNode(a),this.nodes.push(a),a.parent=this,this._engine.branchDirty(a),b&&b(a),a;var d=this;return this._engine.createNode(a,function(a){d.nodes.push(a),a.parent=d,d._engine.branchDirty(a),b&&b(a)}),null},SceneJS.Node.prototype.insertNode=function(a,b){if(!a)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node argument is undefined");if(a._compile||(a=this._engine.createNode(a)),!a._compile)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node argument is not a SceneJS.Node");if(null!=a.parent)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node argument is still attached to another parent");if(void 0===b||null===b)a.addNodes(this.disconnectNodes()),this.addNode(a);else{if(0>b)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Node#insertNode - node index out of range: -1");b>=this.nodes.length?this.nodes.push(a):this.nodes.splice(b,0,a)}return a.parent=this,a},SceneJS.Node.prototype.mapNodes=function(a){if(a(this))return this;for(var b,c=0;c<this.nodes.length;c++)if(b=this.nodes[c].mapNodes(a))return b;return null},SceneJS.Node.prototype.addListener=function(a,b,c){var d=this._listeners[a];return d||(d=[],this._listeners[a]=d),d.push({eventName:a,fn:b,options:c||{}}),this._numListeners++,this},SceneJS.Node.prototype._fireEvent=function(a,b,c){var d=this._listeners[a];if(d){b||(b={});for(var e,f={name:a,params:b,options:c||{}},g=0,h=d.length;h>g;g++)e=d[g],e.options.scope?e.fn.call(e.options.scope,f):e.fn.call(this,f)}},SceneJS.Node.prototype.removeListener=function(a,b){var c=this._listeners[a];if(!c)return null;for(var d=0;d<c.length;d++)if(c[d].fn==b)return c.splice(d,1),b;return this._numListeners--,null},SceneJS.Node.prototype.hasListener=function(a){return this._listeners[a]},SceneJS.Node.prototype.hasListeners=function(){return this._numListeners>0},SceneJS.Node.prototype.removeListeners=function(){return this._listeners={},this._numListeners=0,this},SceneJS.Node.prototype.getParent=function(){return this.parent},SceneJS.Node.prototype.getParentOfType=function(a){for(var b=this.parent;b&&b.type!=a;)b=b.parent;return b},SceneJS.Node.prototype.eachParent=function(a){if(!a)throw"SceneJS.Node.eachParent param 'fn' is null or undefined";for(var b=0,c=this;c.parent;){if(a.call(c.parent,b++)===!0)return c.parent;c=c.parent}return null},SceneJS.Node.prototype.hasNode=function(a){if(null===a||void 0===a)throw"SceneJS.Node.hasNode param 'node' is null or undefined";var b,c=typeof a;

if("number"==c)b=this.getNodeAt(a);else{if("string"!=c)throw"SceneJS.Node.hasNode param 'node' should be either an index number or an ID string";b=this.getNode(a)}return void 0!=b&&null!=b},SceneJS.Node.prototype.node=function(a){if(null===a||void 0===a)throw"SceneJS.Node.node param 'node' is null or undefined";var b,c=typeof a;if("number"==c)b=this.getNodeAt(a);else{if("string"!=c)throw"SceneJS.Node.node param 'node' should be either an index number or an ID string";b=this.getNode(a)}if(!b)throw"SceneJS.Node.node - node not found: '"+a+"'";return b},SceneJS.Node.prototype.eachNode=function(a,b){if(!a)throw"SceneJS.Node.eachNode param 'fn' is null or undefined";if("function"!=typeof a)throw"SceneJS.Node.eachNode param 'fn' should be a function";var c;b=b||{};var d=0;return b.andSelf&&a.call(this,d++)===!0?this:(b.depthFirst||b.breadthFirst?b.depthFirst&&(c=this._iterateEachNodeDepthFirst(a,this,d,!1)):c=this._iterateEachNode(a,this,d),c?c:void 0)},SceneJS.Node.prototype.numNodes=function(){return this.nodes.length},SceneJS.Node.prototype._iterateEachNode=function(a,b,c){for(var d,e=b.nodes.length,f=0;e>f;f++)if(d=b.nodes[f],a.call(d,c++)===!0)return d;return null},SceneJS.Node.prototype._iterateEachNodeDepthFirst=function(a,b,c,d){if(d&&a.call(b,c++)===!0)return b;d=!0;for(var e,f=b.nodes.length,g=0;f>g;g++)if(e=this._iterateEachNodeDepthFirst(a,b.nodes[g],c,d))return e;return null},SceneJS.Node.prototype.findNodesByType=function(a,b){return this._findNodesByType(a,[],b)},SceneJS.Node.prototype._findNodesByType=function(a,b,c){var d;for(d=0;d<this.nodes.length;d++){var e=this.nodes[d];e.type==a&&b.push(e)}if(c)for(d=0;d<this.nodes.length;d++)this.nodes[d]._findNodesByType(a,b,c);return b},SceneJS.Node.prototype.findParentByType=function(a){for(var b=this.parent;b&&b.type!=a;)b=b.parent;return b},SceneJS.Node.prototype.set=function(a,b){if("object"!=typeof a){if(this._set){var c=this._set[a];if(c)return c.call(this,b)}return this._createAccessor("set",a,b)}for(var d in a)a.hasOwnProperty(d)&&this.set(d,a[d])},SceneJS.Node.prototype.get=function(a){if(this._get){var b=this._get[a];if(b)return b.call(this)}return this._createAccessor("get",a)},SceneJS.Node.prototype.add=function(a,b){if("object"!=typeof a){if(this._add){var c=this._add[a];if(c)return c.call(this,b)}return this._createAccessor("add",a,b)}for(var d in a)a.hasOwnProperty(d)&&this.add(d,a[d])},SceneJS.Node.prototype.inc=function(a,b){if("object"!=typeof a){if(this._inc){var c=this._inc[a];if(c)return c.call(this,b)}return this._createAccessor("inc",a,b)}for(var d in a)a.hasOwnProperty(d)&&this.inc(d,a[d])},SceneJS.Node.prototype.insert=function(a,b){if("object"!=typeof a){if(this._set){var c=this._set[a];if(c)return c.call(this,b)}return this._createAccessor("insert",a,b)}for(var d in a)a.hasOwnProperty(d)&&this.insert(d,a[d])},SceneJS.Node.prototype.remove=function(a,b){if("object"!=typeof a){if(this._remove){var c=this._remove[a];if(c)return c.call(this,b)}return this._createAccessor("remove",a,b)}for(var d in a)a.hasOwnProperty(d)&&this.remove(d,a[d])},SceneJS.Node.prototype._createAccessor=function(a,b,c){var d=a+b.substr(0,1).toUpperCase()+b.substr(1),e=this[d];if(!e)throw"Method not found on node: '"+d+"'";var f,g=this.__proto__;switch(a){case"set":f=g._set||(g._set={});break;case"get":f=g._get||(g._get={});break;case"inc":f=g._inc||(g._inc={});break;case"add":f=g._add||(g._add={});break;case"insert":f=g._insert||(g._insert={});break;case"remove":f=g._remove||(g._remove={})}return f[b]=e,e.call(this,c)},SceneJS.Node.prototype.bind=function(a,b){if(!a)throw"SceneJS.Node.bind param 'name' null or undefined";if("string"!=typeof a)throw"SceneJS.Node.bind param 'name' should be a string";if(!b)throw"SceneJS.Node.bind param 'handler' null or undefined";if("function"!=typeof b)throw"SceneJS.Node.bind param 'handler' should be a function";return this.addListener(a,b,{scope:this}),this._engine.branchDirty(this),b},SceneJS.Node.prototype.getJSON=function(){return this},SceneJS.Node.prototype._compile=function(a){this.preCompile&&this.preCompile(),this._compileNodes(a),this.postCompile&&this.postCompile()},SceneJS.Node.prototype._compileNodes=function(a){var b=this._topicSubs.rendered;b&&SceneJS_nodeEventsModule.preVisitNode(this);for(var c,d=0,e=this.nodes.length;e>d;d++)c=this.nodes[d],c.branchDirty=c.branchDirty||this.branchDirty,(c.dirty||c.branchDirty||this._engine.sceneDirty)&&(c._compile(a),c.dirty=!1,c.branchDirty=!1);b&&SceneJS_nodeEventsModule.postVisitNode(this)},SceneJS.Node.prototype.destroy=function(){if(!this.destroyed){if(this.parent)for(var a=this.parent.nodes,b=a.length,c=0;b>c;c++)if(a[c].id===this.id){a.splice(c,1);break}this._engine.scene.unpublish("nodes/"+this.id),this._destroyTree(),this._engine.display.objectListDirty=!0}return this},SceneJS.Node.prototype._destroyTree=function(){this.destroyed=!0,this._engine.destroyNode(this);for(var a,b=0,c=this.nodes.length;c>b;b++)a=this.nodes[b],this._engine.scene.unpublish("nodes/"+a.id),a._destroyTree()},SceneJS.Node.prototype._doDestroy=function(){return this._destroy&&this._destroy(),this},SceneJS_PubSubProxy=function(a,b){this.scene=a,this.proxy=b};var SceneJS_NodeFactory=function(){this.nodes=new SceneJS_Map({})};SceneJS_NodeFactory.nodeTypes={},SceneJS_NodeFactory._subs={},SceneJS_NodeFactory.createNodeType=function(a,b,c){if(SceneJS_NodeFactory.nodeTypes[a])throw"Node type already defined: "+a;var d=function(){SceneJS.Node.apply(this,arguments),this.type=a};d.prototype=new SceneJS.Node,d.prototype.constructor=d,SceneJS_NodeFactory.nodeTypes[a]=d;var e=SceneJS_NodeFactory.nodeTypes[a];if(!e)throw"Node type plugin did not install itself correctly";c&&c(d);var f=SceneJS_NodeFactory._subs[a];if(f){for(;f.length>0;)f.pop()(e);delete f[a]}return d},SceneJS_NodeFactory.prototype.getNode=function(a,b,c,d){b.type=b.type||"node";var e;if(e="node"==b.type?SceneJS.Node:SceneJS_NodeFactory.nodeTypes[b.type])return this._createNode(e,a,b,c,d);var f=this;this._getType(a,b.type,function(e){f._createNode(e,a,b,c,d)})},SceneJS_NodeFactory.prototype._createNode=function(a,b,c,d,e){var f=new a,g=c.id||c.nodeId;return g?this.nodes.addItem(g,f):g=this.nodes.addItem(f),f._construct(b,d,c,g),e&&e(f),f},SceneJS_NodeFactory.prototype._getType=function(a,b,c){var d=SceneJS_NodeFactory.nodeTypes[b];if(d)return void c(d);var e=SceneJS_NodeFactory._subs[b]||(SceneJS_NodeFactory._subs[b]=[]);if(e.push(c),!(e.length>1)){var f=SceneJS_sceneStatusModule.taskStarted(a.scene,"Loading plugin");e.push(function(){SceneJS_sceneStatusModule.taskFinished(f)});var g=SceneJS_configsModule.configs.pluginPath;if(!g)throw"no typePath config";this._loadScript(g+"/node/"+b+".js",function(){SceneJS_sceneStatusModule.taskFailed(f)})}},SceneJS_NodeFactory.prototype._loadScript=function(a,b){var c=document.createElement("script");c.type="text/javascript",c.src=a,c.onerror=b,document.getElementsByTagName("head")[0].appendChild(c)},SceneJS_NodeFactory.prototype.putNode=function(a){this.nodes.removeItem(a.id)},function(){function a(a){var b=a.optics;if("ortho"==b.type?a.matrix=SceneJS_math_orthoMat4c(b.left,b.right,b.bottom,b.top,b.near,b.far):"frustum"==b.type?a.matrix=SceneJS_math_frustumMatrix4(b.left,b.right,b.bottom,b.top,b.near,b.far):"perspective"==b.type&&(a.matrix=SceneJS_math_perspectiveMatrix4(b.fovy*Math.PI/180,b.aspect,b.near,b.far)),a.pan){var c=a.pan,d=SceneJS_math_translationMat4v([c.x||0,c.y||0,c.z||0]);a.matrix=SceneJS_math_mulMat4(d,a.matrix,[])}a.mat?a.mat.set(a.matrix):a.mat=new Float32Array(a.matrix)}var b=SceneJS_math_perspectiveMatrix4(45,1,.1,1e4),c=new Float32Array(b),d={type:"camera",stateId:SceneJS._baseStateId++,matrix:b,mat:c,optics:{type:"perspective",fovy:45,aspect:1,near:.1,far:1e4},checkAspect:function(b,c){b.optics.aspect!=c&&(b.optics.aspect=c,a(this))}},e=[],f=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){a.engine.display.projTransform=d,f=0}),SceneJS.Camera=SceneJS_NodeFactory.createNodeType("camera"),SceneJS.Camera.prototype._init=function(b){if(1==this._core.useCount){b.optics=b.optics||{};var c=this.getScene().getCanvas();b.optics.aspect=c.width/c.height,this.setOptics(b.optics),b.pan&&this.setPan(b.pan);var d=this;this._canvasSizeSub=this.getScene().on("canvasSize",function(b){d._core.optics.aspect=b.aspect,a(d._core),d._engine.display.imageDirty=!0})}},SceneJS.Camera.getDefaultMatrix=function(){return c},SceneJS.Camera.prototype.setOptics=function(b){var c=this._core;if(b){var d=b.type;if(d||c.optics&&(d=c.optics.type),d=d||"perspective","ortho"==d)c.optics=SceneJS._applyIf(SceneJS_math_ORTHO_OBJ,{type:d,left:b.left,bottom:b.bottom,near:b.near,right:b.right,top:b.top,far:b.far});else if("frustum"==d)c.optics={type:d,left:b.left||-1,bottom:b.bottom||-1,near:b.near||.1,right:b.right||1,top:b.top||1,far:b.far||1e4};else{if("perspective"!=d)throw b.type?SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not supported - supported types are 'perspective', 'frustum' and 'ortho'"):SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Camera configuration invalid: optics type not specified - supported types are 'perspective', 'frustum' and 'ortho'");c.optics={type:d,fovy:b.fovy||60,aspect:void 0==b.aspect?1:b.aspect,near:b.near||.1,far:b.far||1e4}}}else c.optics={type:"perspective",fovy:60,aspect:1,near:.1,far:1e4};this._core.optics.pan=b.pan,a(this._core),this.publish("matrix",this._core.matrix),this._engine.display.imageDirty=!0},SceneJS.Camera.prototype.setPan=function(b){this._core.pan=b,a(this._core),this.publish("matrix",this._core.matrix),this._engine.display.imageDirty=!0},SceneJS.Camera.prototype.getOptics=function(){var a={};for(var b in this._core.optics)this._core.optics.hasOwnProperty(b)&&(a[b]=this._core.optics[b]);return a},SceneJS.Camera.prototype.getMatrix=function(){return this._core.matrix.slice(0)},SceneJS.Camera.prototype._compile=function(a){this._engine.display.projTransform=e[f++]=this._core,this._compileNodes(a),this._engine.display.projTransform=--f>0?e[f-1]:d,e[f]=null},SceneJS.Camera.prototype._destroy=function(){this.getScene().off(this._canvasSizeSub)}}(),function(){var a={type:"clips",stateId:SceneJS._baseStateId++,empty:!0,hash:"",clips:[]},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.clips=a,c=0}),SceneJS.Clips=SceneJS_NodeFactory.createNodeType("clips"),SceneJS.Clips.prototype._init=function(a){if(1==this._core.useCount){var b=a.clips;if(!b)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"clips node attribute missing : 'clips'");this._core.clips=this._core.clips||[];for(var c=0,d=b.length;d>c;c++)this._setClip(c,b[c])}},SceneJS.Clips.prototype.setClips=function(a){var b;for(var c in a)if(a.hasOwnProperty(c)&&(void 0!=c||null!=c)){if(b=parseInt(c),0>b||b>=this._core.clips.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'clips': index out of range ("+this._core.clips.length+" clips defined)");this._setClip(b,a[c]||{})}this._engine.display.imageDirty=!0},SceneJS.Clips.prototype._setClip=function(a,b){var c=this._core.clips[a]||(this._core.clips[a]={});c.normalAndDist=[b.x||0,b.y||0,b.z||0,b.dist||0];var d=b.mode||c.mode||"disabled";if("inside"!=d&&"outside"!=d&&"disabled"!=d)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"clips node invalid value for property 'mode': should be 'inside' or 'outside' or 'disabled'");c.mode=d,this._core.hash=null},SceneJS.Clips.prototype._compile=function(d){this._core.hash||(this._core.hash=this._core.clips.length),this._engine.display.clips=b[c++]=this._core,this._compileNodes(d),this._engine.display.clips=--c>0?b[c-1]:a,b[c]=null}}(),function(){var a={stateId:SceneJS._baseStateId++,type:"enable",enabled:!0},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.enable=a,c=0}),SceneJS.Enable=SceneJS_NodeFactory.createNodeType("enable"),SceneJS.Enable.prototype._init=function(a){1==this._core.useCount&&(this._core.enabled=!0,void 0!=a.enabled&&this.setEnabled(a.enabled))},SceneJS.Enable.prototype.setEnabled=function(a){return a!==this._core.enabled&&(this._core.enabled=a,this._engine.display.drawListDirty=!0,this.publish("enabled",a)),this},SceneJS.Enable.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Enable.prototype._compile=function(d){this._engine.display.enable=b[c++]=this._core,this._compileNodes(d),this._engine.display.enable=--c>0?b[c-1]:a,b[c]=null}}(),function(){function a(a){return(a.reflective?"refl":"")+";"+(a.solid?"s":"")+";"+(a.skybox?"sky":"")+";"}var b={stateId:SceneJS._baseStateId++,type:"flags",picking:!0,clipping:!0,enabled:!0,transparent:!1,backfaces:!0,frontface:"ccw",reflective:!0,solid:!1,solidColor:[1,1,1],skybox:!1,hash:"refl;;;"},c=[],d=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){a.engine.display.flags=b,d=0}),SceneJS.Flags=SceneJS_NodeFactory.createNodeType("flags"),SceneJS.Flags.prototype._init=function(a){1==this._core.useCount&&(this._core.picking=!0,this._core.clipping=!0,this._core.enabled=!0,this._core.transparent=!1,this._core.backfaces=!0,this._core.frontface="ccw",this._core.reflective=!0,this._core.solid=!1,this._core.solidColor=[1,1,1],this._core.skybox=!1,a.flags&&this.setFlags(a.flags))},SceneJS.Flags.prototype.setFlags=function(c){var d=this._core;if(void 0!=c.picking&&(d.picking=!!c.picking,this._engine.display.drawListDirty=!0),void 0!=c.clipping&&(d.clipping=!!c.clipping,this._engine.display.imageDirty=!0),void 0!=c.enabled&&(d.enabled=!!c.enabled,this._engine.display.drawListDirty=!0),void 0!=c.transparent&&(d.transparent=!!c.transparent,this._engine.display.stateSortDirty=!0),void 0!=c.backfaces&&(d.backfaces=!!c.backfaces,this._engine.display.imageDirty=!0),void 0!=c.frontface&&(d.frontface=c.frontface,this._engine.display.imageDirty=!0),void 0!=c.reflective&&(d.reflective=c.reflective,this._engine.branchDirty(this),this._engine.display.imageDirty=!0),void 0!=c.solid&&(d.solid=c.solid,this._engine.branchDirty(this),this._engine.display.imageDirty=!0),void 0!=c.solidColor){var e=b.solidColor,f=c.solidColor;d.solidColor=f?[void 0!=f.r&&null!=f.r?f.r:e[0],void 0!=f.g&&null!=f.g?f.g:e[1],void 0!=f.b&&null!=f.b?f.b:e[2]]:b.solidColor,this._engine.display.imageDirty=!0}return void 0!=c.skybox&&(d.skybox=c.skybox,this._engine.branchDirty(this),this._engine.display.imageDirty=!0),d.hash=a(d),this},SceneJS.Flags.prototype.getFlags=function(){var a=this._core;return{picking:a.picking,clipping:a.clipping,enabled:a.enabled,transparent:a.transparent,backfaces:a.backfaces,frontface:a.frontface,reflective:a.reflective,solid:a.solid,solidColor:a.solidColor}},SceneJS.Flags.prototype.setPicking=function(a){return a=!!a,this._core.picking!=a&&(this._core.picking=a,this._engine.display.drawListDirty=!0),this},SceneJS.Flags.prototype.getPicking=function(){return this._core.picking},SceneJS.Flags.prototype.setClipping=function(a){return a=!!a,this._core.clipping!=a&&(this._core.clipping=a,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getClipping=function(){return this._core.clipping},SceneJS.Flags.prototype.setEnabled=function(a){return a=!!a,this._core.enabled!=a&&(this._core.enabled=a,this._engine.display.drawListDirty=!0),this},SceneJS.Flags.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Flags.prototype.setTransparent=function(a){return a=!!a,this._core.transparent!=a&&(this._core.transparent=a,this._engine.display.stateOrderDirty=!0),this},SceneJS.Flags.prototype.getTransparent=function(){return this._core.transparent},SceneJS.Flags.prototype.setBackfaces=function(a){return a=!!a,this._core.backfaces!=a&&(this._core.backfaces=a,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getBackfaces=function(){return this._core.backfaces},SceneJS.Flags.prototype.setFrontface=function(a){return this._core.frontface!=a&&(this._core.frontface=a,this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getFrontface=function(){return this._core.frontface},SceneJS.Flags.prototype.setReflective=function(b){return b=!!b,this._core.reflective!=b&&(this._core.reflective=b,this._core.hash=a(this._core),this._engine.branchDirty(this),this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getReflective=function(){return this._core.reflective},SceneJS.Flags.prototype.setSolid=function(b){return b=!!b,this._core.solid!=b&&(this._core.solid=b,this._core.hash=a(this._core),this._engine.branchDirty(this),this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getSolid=function(){return this._core.solid},SceneJS.Flags.prototype.setSolidColor=function(a){var c=b.solidColor;return this._core.solidColor=a?[void 0!=a.r&&null!=a.r?a.r:c[0],void 0!=a.g&&null!=a.g?a.g:c[1],void 0!=a.b&&null!=a.b?a.b:c[2]]:b.solidColor,this._engine.display.imageDirty=!0,this},SceneJS.Flags.prototype.getSolidColor=function(){return{r:this._core.solidColor[0],g:this._core.solidColor[1],b:this._core.solidColor[2]}},SceneJS.Flags.prototype.setSkybox=function(b){return b=!!b,this._core.skybox!=b&&(this._core.skybox=b,this._core.hash=a(this._core),this._engine.branchDirty(this),this._engine.display.imageDirty=!0),this},SceneJS.Flags.prototype.getSkybox=function(){return this._core.skybox},SceneJS.Flags.prototype._compile=function(a){this._engine.display.flags=c[d++]=this._core,this._compileNodes(a),this._engine.display.flags=--d>0?c[d-1]:b,c[d]=null}}(),new function(){var a={type:"renderTarget",stateId:SceneJS._baseStateId++,targets:null},b={},c=[],d=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.renderTarget=a,d=0}),SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(){for(var a in b)b.hasOwnProperty(a)&&b[a]._core.renderBuf.webglRestored()}),SceneJS.ColorTarget=SceneJS_NodeFactory.createNodeType("colorTarget"),SceneJS.ColorTarget.prototype._init=function(){b[this._core.coreId]=this,this._core.bufType="color",this._core.renderBuf=new SceneJS._webgl.RenderBuffer({canvas:this._engine.canvas})},SceneJS.ColorTarget.prototype._compile=function(b){this.__core||(this.__core=this._engine._coreFactory.getCore("renderTarget"));var e=this._engine.display.renderTarget;this._core.empty||(this.__core.targets=e&&e.targets?e.targets.concat([this._core]):[this._core]),c[d++]=this.__core,this._engine.display.renderTarget=this.__core,this._compileNodes(b),this._engine.display.renderTarget=--d>0?c[d-1]:a,c[d]=null},SceneJS.ColorTarget.prototype._destroy=function(){this._core&&(this._core.renderBuf&&this._core.renderBuf.destroy(),delete b[this._core.coreId])}},new function(){var a={type:"renderTarget",stateId:SceneJS._baseStateId++,targets:null},b={},c=[],d=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.renderTarget=a,d=0}),SceneJS_events.addListener(SceneJS_events.WEBGL_CONTEXT_RESTORED,function(){for(var a in b)b.hasOwnProperty(a)&&b[a]._buildNodeCore()}),SceneJS.DepthTarget=SceneJS_NodeFactory.createNodeType("depthTarget"),SceneJS.DepthTarget.prototype._init=function(){b[this._core.coreId]=this,this._core.bufType="depth",this._core.renderBuf=new SceneJS._webgl.RenderBuffer({canvas:this._engine.canvas})},SceneJS.DepthTarget.prototype._compile=function(b){this.__core||(this.__core=this._engine._coreFactory.getCore("renderTarget"));var e=this._engine.display.renderTarget;this._core.empty||(this.__core.targets=e&&e.targets?e.targets.concat([this._core]):[this._core]),c[d++]=this.__core,this._engine.display.renderTarget=this.__core,this._compileNodes(b),this._engine.display.renderTarget=--d>0?c[d-1]:a,c[d]=null},SceneJS.DepthTarget.prototype._destroy=function(){this._core&&(this._core.renderBuf&&this._core.renderBuf.destroy(),delete b[this._core.coreId])}},new function(){var a=[],b=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){b=0}),SceneJS.Geometry=SceneJS_NodeFactory.createNodeType("geometry"),SceneJS.Geometry.prototype._init=function(a){if(1==this._core.useCount){this._initNodeCore(a,{origin:a.origin,scale:a.scale,autoNormals:"auto"==a.normals}),this._buildNodeCore(this._engine.canvas.gl,this._core);var b=this;this._core.webglRestored=function(){b._buildNodeCore(b._engine.canvas.gl,b._core)}}},SceneJS.Geometry.prototype._initNodeCore=function(a,b){var c=this;b=b||{};var d=a.primitive||"triangles",e=this._core,f=SceneJS.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint?Uint32Array:Uint16Array;e.primitive=this._getPrimitiveType(d),e.primitiveName=d,a.normals&&"triangles"==d&&("auto"===a.normals||a.normals===!0)&&a.positions&&a.indices&&this._buildNormals(a),e.arrays={},a.positions&&(a.positions.constructor!=Float32Array&&(a.positions=new Float32Array(a.positions)),(b.scale||b.origin)&&this._applyOptions(a.positions,b),e.arrays.positions=a.positions),a.normals&&(a.normals.constructor!=Float32Array&&(a.normals=new Float32Array(a.normals)),e.arrays.normals=a.normals),a.uv&&(a.uv.constructor!=Float32Array&&(a.uv=new Float32Array(a.uv)),e.arrays.uv=a.uv),a.uv2&&(a.uv2.constructor!=Float32Array&&(a.uv2=new Float32Array(a.uv2)),e.arrays.uv2=a.uv2),a.colors&&(a.colors.constructor!=Float32Array&&(a.colors=new Float32Array(a.colors)),e.arrays.colors=a.colors),a.indices&&(a.indices.constructor!=Uint16Array&&a.indices.constructor!=Uint32Array&&(a.indices=new f(a.indices)),e.arrays.indices=a.indices),e.getTangents=function(){if(e.tangentBuf)return e.tangentBuf;var a=e.arrays;if(a.positions&&a.indices&&a.uv){var b=c._engine.canvas.gl,d=new Float32Array(c._buildTangents(a));e.arrays.tangents=d;var f=b.STATIC_DRAW;return e.tangentBuf=new SceneJS._webgl.ArrayBuffer(b,b.ARRAY_BUFFER,d,d.length,3,f)}},e.getPickPositions=function(){if(e.pickPositionsBuf)return e.pickPositionsBuf;if(e.arrays.positions){var a=c._engine.canvas.gl,b=SceneJS_math_getPickPositions(e.arrays.positions,e.arrays.indices);e.pickPositionsBuf=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(b),b.length,3,a.STATIC_DRAW)}return e.pickPositionsBuf},e.getPickColors=function(){if(e.pickColorsBuf)return e.pickColorsBuf;var a=c._engine.canvas.gl,b=SceneJS_math_getPickColors(e.arrays.indices);return e.pickColorsBuf=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(b),b.length,4,a.STATIC_DRAW),e.pickColorsBuf},e.getPickIndices=function(){if(e.pickIndicesBuf)return e.pickIndicesBuf;if(e.arrays.indices){var a=c._engine.canvas.gl,b=SceneJS_math_getPickIndices(e.arrays.indices);e.pickIndicesBuf=new SceneJS._webgl.ArrayBuffer(a,a.ELEMENT_ARRAY_BUFFER,new Uint16Array(b),b.length,1,a.STATIC_DRAW)}return e.pickIndicesBuf}},SceneJS.Geometry.prototype._getPrimitiveType=function(a){var b=this._engine.canvas.gl;switch(a){case"points":return b.POINTS;case"lines":return b.LINES;case"line-loop":return b.LINE_LOOP;case"line-strip":return b.LINE_STRIP;case"triangles":return b.TRIANGLES;case"triangle-strip":return b.TRIANGLE_STRIP;case"triangle-fan":return b.TRIANGLE_FAN;default:throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"geometry primitive unsupported: '"+a+"' - supported types are: 'points', 'lines', 'line-loop', 'line-strip', 'triangles', 'triangle-strip' and 'triangle-fan'")}},SceneJS.Geometry.prototype._applyOptions=function(a,b){if(b.scale)for(var c=void 0!=b.scale.x?b.scale.x:1,d=void 0!=b.scale.y?b.scale.y:1,e=void 0!=b.scale.z?b.scale.z:1,f=0,g=a.length;g>f;f+=3)a[f]*=c,a[f+1]*=d,a[f+2]*=e;if(b.origin)for(var h=void 0!=b.origin.x?b.origin.x:0,i=void 0!=b.origin.y?b.origin.y:0,j=void 0!=b.origin.z?b.origin.z:0,f=0,g=a.length;g>f;f+=3)a[f]-=h,a[f+1]-=i,a[f+2]-=j;return a};var c=function(a){a.vertexBuf&&(a.vertexBuf.destroy(),a.vertexBuf=null),a.normalBuf&&(a.normalBuf.destroy(),a.normalBuf=null),a.uvBuf&&(a.uvBuf.destroy(),a.uvBuf=null),a.uvBuf2&&(a.uvBuf2.destroy(),a.uvBuf2=null),a.colorBuf&&(a.colorBuf.destroy(),a.colorBuf=null),a.tangentBuf&&(a.tangentBuf.destroy(),a.tangentBuf=null),a.indexBuf&&(a.indexBuf.destroy(),a.indexBuf=null),a.interleavedBuf&&(a.interleavedBuf.destroy(),a.interleavedBuf=null)};SceneJS.Geometry.prototype._buildNodeCore=function(a,b){var d=a.STATIC_DRAW;try{var e=b.arrays,f=SceneJS.getConfigs("enableInterleaving")!==!1,g=0,h=0,i=[],j=[],k=function(a,b){return 0==g?g=a.length/b:a.length/b!=g&&(f=!1),i.push(a),j.push(b),h+=b,4*(h-b)};if(e.positions&&(f&&(b.interleavedPositionOffset=k(e.positions,3)),b.vertexBuf=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,e.positions,e.positions.length,3,d)),e.normals&&(f&&(b.interleavedNormalOffset=k(e.normals,3)),b.normalBuf=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,e.normals,e.normals.length,3,d)),e.uv&&(f&&(b.interleavedUVOffset=k(e.uv,2)),b.uvBuf=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,e.uv,e.uv.length,2,d)),e.uv2&&(f&&(b.interleavedUV2Offset=k(e.uv2,2)),b.uvBuf2=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,e.uv2,e.uv2.length,2,d)),e.colors&&(f&&(b.interleavedColorOffset=k(e.colors,4)),b.colorBuf=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,e.colors,e.colors.length,4,d)),e.indices&&(b.indexBuf=new SceneJS._webgl.ArrayBuffer(a,a.ELEMENT_ARRAY_BUFFER,e.indices,e.indices.length,1,d)),h>0&&f){for(var l=[],m=i.length,n=0;g>n;++n)for(var o=0;m>o;++o)for(var p=j[o],q=0;p>q;++q)l.push(i[o][n*p+q]);b.interleavedStride=4*h,b.interleavedBuf=new SceneJS._webgl.ArrayBuffer(a,a.ARRAY_BUFFER,new Float32Array(l),l.length,h,d),b.interleavedBuf.dirty=!1}}catch(r){throw c(b),SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate geometry: "+r)}},SceneJS.Geometry.prototype._updateArray=function(a,b,c){var d=a.length,e=b.length;e+c>d&&(e-=e+c-d);for(var f=c,g=0;e>g;f++,g++)a[f]=b[g]},SceneJS.Geometry.prototype._buildNormals=function(a){for(var b,c,d,e,f,g,h=a.positions,i=a.indices,j=new Array(h.length/3),k=0,l=i.length-3;l>k;k+=3){b=i[k+0],c=i[k+1],d=i[k+2],e=[h[3*b+0],h[3*b+1],h[3*b+2]],f=[h[3*c+0],h[3*c+1],h[3*c+2]],g=[h[3*d+0],h[3*d+1],h[3*d+2]],f=SceneJS_math_subVec4(f,e,[0,0,0,0]),g=SceneJS_math_subVec4(g,e,[0,0,0,0]);var m=SceneJS_math_normalizeVec4(SceneJS_math_cross3Vec4(f,g,[0,0,0,0]),[0,0,0,0]);j[b]||(j[b]=[]),j[c]||(j[c]=[]),j[d]||(j[d]=[]),j[b].push(m),j[c].push(m),j[d].push(m)}for(var n=new Float32Array(h.length),k=0,l=j.length;l>k;k++){var o=j[k];if(o){for(var p=o.length,q=0,r=0,s=0,t=0;p>t;t++)q+=o[t][0],r+=o[t][1],s+=o[t][2];n[3*k+0]=q/p,n[3*k+1]=r/p,n[3*k+2]=s/p}}a.normals=n},SceneJS.Geometry.prototype._buildTangents=function(a){for(var b=a.positions,c=a.indices,d=a.uv,e=[],f=0;f<c.length;f+=3){var g=c[f],h=[b[3*g],b[3*g+1],b[3*g+2]],i=[d[2*g],d[2*g+1]];g=c[f+1];var j=[b[3*g],b[3*g+1],b[3*g+2]],k=[d[2*g],d[2*g+1]];g=c[f+2];for(var l=[b[3*g],b[3*g+1],b[3*g+2]],m=[d[2*g],d[2*g+1]],n=SceneJS_math_subVec3(j,h,[]),o=SceneJS_math_subVec3(l,h,[]),p=SceneJS_math_subVec2(k,i,[]),q=SceneJS_math_subVec2(m,i,[]),r=1/(p[0]*q[1]-p[1]*q[0]),s=SceneJS_math_mulVec3Scalar(SceneJS_math_subVec3(SceneJS_math_mulVec3Scalar(n,q[1],[]),SceneJS_math_mulVec3Scalar(o,p[1],[]),[]),r,[]),t=0;3>t;t++){var u=c[f+t];e[u]="undefined"!=typeof e[u]?SceneJS_math_addVec3(e[u],s,[]):s}}for(var v=[],w=0;w<e.length;w++)v=v.concat(e[w]);return v},SceneJS.Geometry.prototype.setSource=function(a){this._sourceConfigs=a;var b=this._source;b&&b.configure&&b.configure(a)},SceneJS.Geometry.prototype.getSource=function(){return this._sourceConfigs||{}},SceneJS.Geometry.prototype.setPositions=function(a){if(a.positions&&this._core.vertexBuf){this._boundary=null;var b=this._core;b.vertexBuf.bind(),b.vertexBuf.setData(new Float32Array(a.positions),a.positionsOffset||0),b.arrays.positions.set(a.positions,a.positionsOffset||0),this._engine.display.imageDirty=!0,b.interleavedBuf&&(b.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getPositions=function(){return this._core.arrays?this._core.arrays.positions:null},SceneJS.Geometry.prototype.setNormals=function(a){if(a.normals&&this._core.normalBuf){var b=this._core;b.normalBuf.bind(),b.normalBuf.setData(new Float32Array(a.normals),a.normalsOffset||0),b.arrays.normals.set(a.normals,a.normalsOffset||0),this._engine.display.imageDirty=!0,b.interleavedBuf&&(b.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getNormals=function(){return this._core.arrays?this._core.arrays.normals:null},SceneJS.Geometry.prototype.setColors=function(a){if(a.colors&&this._core.colorBuf){var b=this._core;b.colorBuf.bind(),b.colorBuf.setData(new Float32Array(a.colors),a.colorsOffset||0),b.arrays.colors.set(a.colors,a.colorsOffset||0),this._engine.display.imageDirty=!0,b.interleavedBuf&&(b.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getColors=function(){return this._core.arrays?this._core.arrays.colors:null},SceneJS.Geometry.prototype.setIndices=function(a){if(a.indices&&this._core.indexBuf){this._boundary=null;var b=this._core;b.indexBuf.bind();var c=this._engine.canvas.UINT_INDEX_ENABLED?Uint32Array:Uint16Array;b.indexBuf.setData(new c(a.indices),a.indicesOffset||0),b.arrays.indices.set(a.indices,a.indicesOffset||0),this._engine.display.imageDirty=!0}},SceneJS.Geometry.prototype.getIndices=function(){return this._core.arrays?this._core.arrays.indices:null},SceneJS.Geometry.prototype.setUV=function(a){if(a.uv&&this._core.uvBuf){var b=this._core;b.uvBuf.bind(),b.uvBuf.setData(new Float32Array(a.uv),a.uvOffset||0),b.arrays.uv.set(a.uv,a.uvOffset||0),this._engine.display.imageDirty=!0,b.interleavedBuf&&(b.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getUV=function(){return this._core.arrays?this._core.arrays.uv:null},SceneJS.Geometry.prototype.setUV2=function(a){if(a.uv2&&this._core.uv2Buf){var b=this._core;b.uv2Buf.bind(),b.uv2Buf.setData(new Float32Array(a.uv2),a.uv2Offset||0),b.arrays.uv2.set(a.uv2,a.uv2Offset||0),this._engine.display.imageDirty=!0,b.interleavedBuf&&(b.interleavedBuf.dirty=!0)}},SceneJS.Geometry.prototype.getUV2=function(){return this._core.arrays?this._core.arrays.uv2:null},SceneJS.Geometry.prototype.getPrimitive=function(){return this.primitive},SceneJS.Geometry.prototype.getBoundary=function(){if(this._boundary)return this._boundary;var a=this._core.arrays;if(!a)return null;var b=a.positions;if(!b)return null;this._boundary={xmin:SceneJS_math_MAX_DOUBLE,ymin:SceneJS_math_MAX_DOUBLE,zmin:SceneJS_math_MAX_DOUBLE,xmax:SceneJS_math_MIN_DOUBLE,ymax:SceneJS_math_MIN_DOUBLE,zmax:SceneJS_math_MIN_DOUBLE};for(var c,d,e,f=0,g=b.length-2;g>f;f+=3)c=b[f],d=b[f+1],e=b[f+2],c<this._boundary.xmin&&(this._boundary.xmin=c),d<this._boundary.ymin&&(this._boundary.ymin=d),e<this._boundary.zmin&&(this._boundary.zmin=e),c>this._boundary.xmax&&(this._boundary.xmax=c),d>this._boundary.ymax&&(this._boundary.ymax=d),e>this._boundary.zmax&&(this._boundary.zmax=e);return this._boundary},SceneJS.Geometry.prototype._compile=function(c){if(this._core._loading)return void this._compileNodes(c);var d=this._core;d.vertexBuf||(d=this._inheritVBOs(d)),d.indexBuf?(d.hash=[d.normalBuf?"t":"f",d.arrays&&d.arrays.tangents?"t":"f",d.uvBuf?"t":"f",d.uvBuf2?"t":"f",d.colorBuf?"t":"f",d.primitive].join(""),d.stateId=this._core.stateId,d.type="geometry",this._engine.display.geometry=a[b++]=d,SceneJS_events.fireEvent(SceneJS_events.OBJECT_COMPILING,{display:this._engine.display}),this._engine.display.buildObject(this.id)):a[b++]=this._core,this._compileNodes(c),b--,a[b]=null},SceneJS.Geometry.prototype._inheritVBOs=function(c){for(var d={arrays:c.arrays,primitive:c.primitive,primitiveName:c.primitiveName,boundary:c.boundary,normalBuf:c.normalBuf,uvBuf:c.uvBuf,uvBuf2:c.uvBuf2,colorBuf:c.colorBuf,interleavedBuf:c.interleavedBuf,indexBuf:c.indexBuf,interleavedStride:c.interleavedStride,interleavedPositionOffset:c.interleavedPositionOffset,interleavedNormalOffset:c.interleavedNormalOffset,interleavedUVOffset:c.interleavedUVOffset,interleavedUV2Offset:c.interleavedUV2Offset,interleavedColorOffset:c.interleavedColorOffset,getPickIndices:c.getPickIndices,getPickPositions:c.getPickPositions,getPickColors:c.getPickColors},e=b-1;e>=0;e--)if(a[e].vertexBuf)return d.vertexBuf=a[e].vertexBuf,
d.boundary=a[e].boundary,d.normalBuf=a[e].normalBuf,d.uvBuf=a[e].uvBuf,d.uvBuf2=a[e].uvBuf2,d.colorBuf=a[e].colorBuf,d.interleavedBuf=a[e].interleavedBuf,d.interleavedStride=a[e].interleavedStride,d.interleavedPositionOffset=a[e].interleavedPositionOffset,d.interleavedNormalOffset=a[e].interleavedNormalOffset,d.interleavedUVOffset=a[e].interleavedUVOffset,d.interleavedUV2Offset=a[e].interleavedUV2Offset,d.interleavedColorOffset=a[e].interleavedColorOffset,d;return d},SceneJS.Geometry.prototype._destroy=function(){this._engine.display.removeObject(this.id),1==this._core.useCount&&(this._destroyNodeCore(),this._source&&this._source.destroy&&this._source.destroy())},SceneJS.Geometry.prototype._destroyNodeCore=function(){document.getElementById(this._engine.canvas.canvasId)&&c(this._core)}},function(){var a={type:"stage",stateId:SceneJS._baseStateId++,priority:0,pickable:!0,enabled:!0},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.stage=a,c=0}),SceneJS.Stage=SceneJS_NodeFactory.createNodeType("stage"),SceneJS.Stage.prototype._init=function(a){1==this._core.useCount&&(this._core.priority=a.priority||0,this._core.enabled=a.enabled!==!1,this._core.pickable=!!a.pickable)},SceneJS.Stage.prototype.setPriority=function(a){a=a||0,this._core.priority!=a&&(this._core.priority=a,this._engine.display.stateOrderDirty=!0)},SceneJS.Stage.prototype.getPriority=function(){return this._core.priority},SceneJS.Stage.prototype.setEnabled=function(a){a=!!a,this._core.enabled!=a&&(this._core.enabled=a,this._engine.display.drawListDirty=!0)},SceneJS.Stage.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Stage.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Stage.prototype._compile=function(d){this._engine.display.stage=b[c++]=this._core,this._compileNodes(d),this._engine.display.stage=--c>0?b[c-1]:a,b[c]=null}}(),function(){var a={type:"layer",stateId:SceneJS._baseStateId++,priority:0,enabled:!0},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.layer=a,c=0}),SceneJS.Layer=SceneJS_NodeFactory.createNodeType("layer"),SceneJS.Layer.prototype._init=function(a){1==this._core.useCount&&(this._core.priority=a.priority||0,this._core.enabled=a.enabled!==!1)},SceneJS.Layer.prototype.setPriority=function(a){a=a||0,this._core.priority!=a&&(this._core.priority=a,this._engine.display.stateOrderDirty=!0)},SceneJS.Layer.prototype.getPriority=function(){return this._core.priority},SceneJS.Layer.prototype.setEnabled=function(a){a=!!a,this._core.enabled!=a&&(this._core.enabled=a,this._engine.display.drawListDirty=!0)},SceneJS.Layer.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Layer.prototype.getEnabled=function(){return this._core.enabled},SceneJS.Layer.prototype.setClearDepth=function(a){a=a||0,this._core.clearDepth!=a&&(this._core.clearDepth=a,this._engine.display.drawListDirty=!0)},SceneJS.Layer.prototype.getClearDepth=function(){return this._core.clearDepth},SceneJS.Layer.prototype._compile=function(d){this._engine.display.layer=b[c++]=this._core,this._compileNodes(d),this._engine.display.layer=--c>0?b[c-1]:a,b[c]=null}}(),SceneJS.Library=SceneJS_NodeFactory.createNodeType("library"),SceneJS.Library.prototype._compile=function(){},function(){function a(a){if(a.lights&&a.lights.length>0){for(var b,c=a.lights,d=[],e=0,f=c.length;f>e;e++)b=c[e],d.push(b.mode),b.specular&&d.push("s"),b.diffuse&&d.push("d"),d.push("world"==b.space?"w":"v");a.hash=d.join("")}else a.hash=""}var b={type:"lights",stateId:SceneJS._baseStateId++,hash:null,empty:!1,lights:[{mode:"ambient",color:[.7,.7,.8],diffuse:!0,specular:!1},{mode:"dir",color:[1,1,1],diffuse:!0,specular:!0,dir:[-.5,-.5,-1],space:"view"},{mode:"dir",color:[1,1,1],diffuse:!1,specular:!0,dir:[1,-.9,-.7],space:"view"}]};a(b);var c=[],d=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){a.engine.display.lights=b,d=0}),SceneJS.Lights=SceneJS_NodeFactory.createNodeType("lights"),SceneJS.Lights.prototype._init=function(a){if(1==this._core.useCount){var b=a.lights;if(!b)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"lights node attribute missing : 'lights'");this._core.lights=this._core.lights||[];for(var c=0,d=b.length;d>c;c++)this._initLight(c,b[c])}},SceneJS.Lights.prototype._initLight=function(a,b){var c={};this._core.lights[a]=c;var d=b.mode||"dir";if("dir"!=d&&"point"!=d&&"ambient"!=d)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Light mode not supported - should be 'dir' or 'point' or 'ambient'");var e=b.pos,f=b.dir,g=b.color;c.color=[void 0!=g.r?g.r:1,void 0!=g.g?g.g:1,void 0!=g.b?g.b:1],c.mode=d,c.diffuse="ambient"==d?!0:void 0!=b.diffuse?b.diffuse:!0,c.specular="ambient"==d?!1:void 0!=b.specular?b.specular:!0,c.pos=b.pos?[e.x||0,e.y||0,e.z||0]:[0,0,0],c.dir=b.dir?[f.x||0,f.y||0,f.z||0]:[0,0,1],c.attenuation=[void 0!=b.constantAttenuation?b.constantAttenuation:0,b.linearAttenuation||0,b.quadraticAttenuation||0];var h=b.space;if(h){if("view"!=h&&"world"!=h)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"lights node invalid value for property 'space': '"+h+"' - should be 'view' or 'world'")}else h="world";c.space=h,this._core.hash=null},SceneJS.Lights.prototype.setLights=function(a){var b;for(var c in a)if(a.hasOwnProperty(c)&&(void 0!=c||null!=c)){if(b=parseInt(c),0>b||b>=this._core.lights.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid argument to set 'lights': index out of range ("+this._core.lights.length+" lights defined)");this._setLight(b,a[c]||{})}this._engine.branchDirty(this)},SceneJS.Lights.prototype._setLight=function(a,b){var c=this._core.lights[a],d=!1,e=!1;if(b.mode&&b.mode!=c.mode){var f=b.mode;if("dir"!=f&&"point"!=f&&"ambient"!=f)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Light mode not supported - should be 'dir' or 'point' or 'ambient'");c.mode=f,c.diffuse="ambient"==f?!0:void 0!=b.diffuse?b.diffuse:!0,c.specular="ambient"==f?!1:void 0!=b.specular?b.specular:!0,e=!0}if(b.color){var g=b.color;c.color=[void 0!=g.r?g.r:1,void 0!=g.g?g.g:1,void 0!=g.b?g.b:1],d=!0}var h=b.pos;h&&(c.pos=[h.x||0,h.y||0,h.z||0],d=!0);var i=b.dir;if(i&&(c.dir=[i.x||0,i.y||0,i.z||0],d=!0),void 0!=b.constantAttenuation&&(c.attenuation[0]=b.constantAttenuation,d=!0),void 0!=b.linearAttenuation&&(c.attenuation[1]=b.linearAttenuation,d=!0),void 0!=b.quadraticAttenuation&&(c.attenuation[2]=b.quadraticAttenuation,d=!0),b.space&&b.space!=c.space){var j=b.space;if("view"!=j&&"world"!=j)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"lights node invalid value for property 'space': '"+j+"' - should be 'view' or 'world'");c.space=j,this._core.hash=null,e=!0}void 0!=b.specular&&b.specular!=c.specular&&(c.specular=b.specular,e=!0),void 0!=b.diffuse&&b.diffuse!=c.diffuse&&(c.diffuse=b.diffuse,e=!0),e?this._engine.branchDirty(this):d&&(this._engine.display.imageDirty=!0),this._core.hash=null},SceneJS.Lights.prototype._compile=function(e){this._core.hash||a(this._core),this._engine.display.lights=c[d++]=this._core,this._compileNodes(e),this._engine.display.lights=--d>0?c[d-1]:b,c[d]=null}}(),function(){var a=SceneJS_math_lookAtMat4c(0,0,10,0,0,0,0,1,0),b=new Float32Array(a),c=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(b,SceneJS_math_mat4())),d=new Float32Array(c),e={type:"lookAt",stateId:SceneJS._baseStateId++,matrix:a,mat:b,normalMatrix:c,normalMat:d,lookAt:SceneJS_math_LOOKAT_ARRAYS},f=[],g=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){a.engine.display.viewTransform=e,g=0}),SceneJS.Lookat=SceneJS_NodeFactory.createNodeType("lookAt"),SceneJS.Lookat.prototype._init=function(a){if(this._mat=null,this._xf={type:"lookat"},1==this._core.useCount){this._core.eyeX=0,this._core.eyeY=0,this._core.eyeZ=10,this._core.lookX=0,this._core.lookY=0,this._core.lookZ=0,this._core.upX=0,this._core.upY=1,this._core.upZ=0,a.eye||a.look||a.up?(this.setEye(a.eye),this.setLook(a.look),this.setUp(a.up)):(this.setEye({x:0,y:0,z:10}),this.setLook({x:0,y:0,z:0}),this.setUp({x:0,y:1,z:0}));var b=this._core,c=this;this._core.rebuild=function(){b.matrix=SceneJS_math_lookAtMat4c(b.eyeX,b.eyeY,b.eyeZ,b.lookX,b.lookY,b.lookZ,b.upX,b.upY,b.upZ),b.lookAt={eye:[b.eyeX,b.eyeY,b.eyeZ],look:[b.lookX,b.lookY,b.lookZ],up:[b.upX,b.upY,b.upZ]},b.mat?(b.mat.set(b.matrix),b.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(b.matrix,SceneJS_math_mat4())))):(b.mat=new Float32Array(b.matrix),b.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(b.matrix,SceneJS_math_mat4())))),c.publish("matrix",b.matrix),b.dirty=!1},this._core.dirty=!0,this._tick=this.getScene().on("tick",function(){c._core.dirty&&c._core.rebuild()})}},SceneJS.Lookat.getDefaultMatrix=function(){return b},SceneJS.Lookat.prototype.setEye=function(a){return a=a||{},void 0!=a.x&&null!=a.x&&(this._core.eyeX=a.x),void 0!=a.y&&null!=a.y&&(this._core.eyeY=a.y),void 0!=a.z&&null!=a.z&&(this._core.eyeZ=a.z),this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEye=function(a){return a=a||{},this._core.eyeX+=void 0!=a.x&&null!=a.x?a.x:0,this._core.eyeY+=void 0!=a.y&&null!=a.y?a.y:0,this._core.eyeZ+=void 0!=a.z&&null!=a.z?a.z:0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setEyeX=function(a){return this._core.eyeX=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setEyeY=function(a){return this._core.eyeY=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setEyeZ=function(a){return this._core.eyeZ=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEyeX=function(a){return this._core.eyeX+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEyeY=function(a){return this._core.eyeY+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incEyeZ=function(a){return this._core.eyeZ+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.getEye=function(){return{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ}},SceneJS.Lookat.prototype.setLook=function(a){return a=a||{},void 0!=a.x&&null!=a.x&&(this._core.lookX=a.x),void 0!=a.y&&null!=a.y&&(this._core.lookY=a.y),void 0!=a.z&&null!=a.z&&(this._core.lookZ=a.z),this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLook=function(a){return a=a||{},this._core.lookX+=void 0!=a.x&&null!=a.x?a.x:0,this._core.lookY+=void 0!=a.y&&null!=a.y?a.y:0,this._core.lookZ+=void 0!=a.z&&null!=a.z?a.z:0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setLookX=function(a){return this._core.lookX=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setLookY=function(a){return this._core.lookY=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setLookZ=function(a){return this._core.lookZ=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLookX=function(a){return this._core.lookX+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLookY=function(a){return this._core.lookY+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incLookZ=function(a){return this._core.lookZ+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.getLook=function(){return{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ}},SceneJS.Lookat.prototype.setUp=function(a){return a=a||{},void 0!=a.x&&null!=a.x&&(this._core.upX=a.x),void 0!=a.y&&null!=a.y&&(this._core.upY=a.y),void 0!=a.z&&null!=a.z&&(this._core.upZ=a.z),this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUp=function(a){return a=a||{},this._core.upX+=void 0!=a.x&&null!=a.x?a.x:0,this._core.upY+=void 0!=a.y&&null!=a.y?a.y:0,this._core.upZ+=void 0!=a.z&&null!=a.z?a.z:0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setUpX=function(a){return this._core.upX=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setUpY=function(a){return this._core.upY=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.setUpZ=function(a){return this._core.upZ=a||0,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUpX=function(a){return this._core.upX+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUpY=function(a){return this._core.upY+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.incUpZ=function(a){return this._core.upZ+=a,this._core.dirty=!0,this._engine.display.imageDirty=!0,this},SceneJS.Lookat.prototype.getUp=function(){return{x:this._core.upX,y:this._core.upY,z:this._core.upZ}},SceneJS.Lookat.prototype.getMatrix=function(){return this._core.dirty&&this._core.rebuild(),this._core.matrix.slice(0)},SceneJS.Lookat.prototype.getAttributes=function(){return{look:{x:this._core.lookX,y:this._core.lookY,z:this._core.lookZ},eye:{x:this._core.eyeX,y:this._core.eyeY,z:this._core.eyeZ},up:{x:this._core.upX,y:this._core.upY,z:this._core.upZ}}},SceneJS.Lookat.prototype._compile=function(a){this._engine.display.viewTransform=f[g++]=this._core,this._compileNodes(a),this._engine.display.viewTransform=--g>0?f[g-1]:e,f[g]=null},SceneJS.Lookat.prototype._destroy=function(){this.getScene().off(this._tick)}}(),new function(){var a={type:"material",stateId:SceneJS._baseStateId++,baseColor:[1,1,1],specularColor:[1,1,1],emitColor:[1,1,1],specular:1,shine:70,alpha:1,emit:0},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.material=a,c=0}),SceneJS.Material=SceneJS_NodeFactory.createNodeType("material"),SceneJS.Material.prototype._init=function(a){1==this._core.useCount&&(this.setBaseColor(a.color||a.baseColor),this.setSpecularColor(a.specularColor),this.setEmitColor(a.emitColor),this.setSpecular(a.specular),this.setShine(a.shine),this.setEmit(a.emit),this.setAlpha(a.alpha))},SceneJS.Material.prototype.setBaseColor=function(b){var c=a.baseColor;return this._core.baseColor=b?[void 0!=b.r&&null!=b.r?b.r:c[0],void 0!=b.g&&null!=b.g?b.g:c[1],void 0!=b.b&&null!=b.b?b.b:c[2]]:a.baseColor,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.setColor=SceneJS.Material.prototype.setBaseColor,SceneJS.Material.prototype.getBaseColor=function(){return{r:this._core.baseColor[0],g:this._core.baseColor[1],b:this._core.baseColor[2]}},SceneJS.Material.prototype.getColor=SceneJS.Material.prototype.getBaseColor,SceneJS.Material.prototype.setSpecularColor=function(b){var c=a.specularColor;return this._core.specularColor=b?[void 0!=b.r&&null!=b.r?b.r:c[0],void 0!=b.g&&null!=b.g?b.g:c[1],void 0!=b.b&&null!=b.b?b.b:c[2]]:a.specularColor,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getSpecularColor=function(){return{r:this._core.specularColor[0],g:this._core.specularColor[1],b:this._core.specularColor[2]}},SceneJS.Material.prototype.setEmitColor=function(b){var c=a.emitColor;return this._core.emitColor=b?[void 0!=b.r&&null!=b.r?b.r:c[0],void 0!=b.g&&null!=b.g?b.g:c[1],void 0!=b.b&&null!=b.b?b.b:c[2]]:a.emitColor,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getEmitColor=function(){return{r:this._core.emitColor[0],g:this._core.emitColor[1],b:this._core.emitColor[2]}},SceneJS.Material.prototype.setSpecular=function(b){return this._core.specular=void 0!=b&&null!=b?b:a.specular,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getSpecular=function(){return this._core.specular},SceneJS.Material.prototype.setShine=function(b){return this._core.shine=void 0!=b&&null!=b?b:a.shine,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getShine=function(){return this._core.shine},SceneJS.Material.prototype.setEmit=function(b){return this._core.emit=void 0!=b&&null!=b?b:a.emit,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getEmit=function(){return this._core.emit},SceneJS.Material.prototype.setAlpha=function(b){return this._core.alpha=void 0!=b&&null!=b?b:a.alpha,this._engine.display.imageDirty=!0,this},SceneJS.Material.prototype.getAlpha=function(){return this._core.alpha},SceneJS.Material.prototype._compile=function(d){this._engine.display.material=b[c++]=this._core,this._compileNodes(d),this._engine.display.material=--c>0?b[c-1]:a,b[c]=null}},new function(){var a={type:"morphGeometry",stateId:SceneJS._baseStateId++,hash:"",morph:null},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.morphGeometry=a,c=0}),SceneJS.MorphGeometry=SceneJS_NodeFactory.createNodeType("morphGeometry"),SceneJS.MorphGeometry.prototype._init=function(a){if(1==this._core.useCount){this._pickPositionsDirty=!0,this._buildNodeCore(a),this._core.webglRestored=function(){};var b=this;this._core.getPickPositions=function(a,c){return b._pickPositionsDirty&&b._buildPickPositions(c),b._core.targets[a].pickPositionsBuf},this.setFactor(a.factor)}this._core.factor=a.factor||0,this._core.clamp=!!a.clamp},SceneJS.MorphGeometry.prototype._buildNodeCore=function(a){var b=a.targets||[];if(b.length<2)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node should have at least two targets");var c=a.keys||[];if(c.length!=b.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"morphGeometry node mismatch in number of keys and targets");var d=this._core,e=this._engine.canvas.gl,f=e.STATIC_DRAW;d.keys=c,d.targets=[],d.key1=0,d.key2=1;for(var g,h,i,j,k,l=0,m=b.length;m>l;l++)k=b[l],!g&&k.positions&&(g=k.positions),!h&&k.normals&&(h=k.normals),!i&&k.uv&&(i=k.uv),!j&&k.uv2&&(j=k.uv2);try{for(var n,o,l=0,m=b.length;m>l;l++)k=b[l],n={},o=k.positions||g,o&&(n.positions=o.constructor==Float32Array?o:new Float32Array(o),n.vertexBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,n.positions,o.length,3,f),g=o),o=k.normals||h,o&&(n.normals=o.constructor==Float32Array?o:new Float32Array(o),n.normalBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,n.normals,o.length,3,f),h=o),o=k.uv||i,o&&(n.uv=o.constructor==Float32Array?o:new Float32Array(o),n.uvBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,n.uv,o.length,2,f),i=o),o=k.uv2||j,o&&(n.uv2=o.constructor==Float32Array?o:new Float32Array(o),n.uvBuf2=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,n.uv2,o.length,2,f),j=o),d.targets.push(n)}catch(p){for(var l=0,m=d.targets.length;m>l;l++)n=d.targets[l],n.vertexBuf&&n.vertexBuf.destroy(),n.normalBuf&&n.normalBuf.destroy(),n.uvBuf&&n.uvBuf.destroy(),n.uvBuf2&&n.uvBuf2.destroy();throw SceneJS_error.fatalError(SceneJS.errors.ERROR,"Failed to allocate VBO(s) for morphGeometry: "+p)}this._pickPositionsDirty=!0},SceneJS.MorphGeometry.prototype._buildPickPositions=function(a){for(var b,c=this._core,d=null,e=this._engine.canvas.gl,f=e.STATIC_DRAW,g=0,h=c.targets.length;h>g;g++)d=c.targets[g],d.positions&&(d.pickPositionsBuf&&(d.pickPositionsBuf.destroy(),d.pickPositionsBuf=null),b=SceneJS_math_getPickPositions(d.positions,a),d.pickPositionsBuf=new SceneJS._webgl.ArrayBuffer(e,e.ARRAY_BUFFER,new Float32Array(b),b.length,3,f));this._pickPositionsDirty=!1},SceneJS.MorphGeometry.prototype.setFactor=function(a){a=a||0;var b=this._core,c=b.keys,d=b.key1,e=b.key2,f=b.factor;if(a<c[0])d=0,e=1;else if(a>c[c.length-1])d=c.length-2,e=d+1;else{for(;c[d]>a;)d--,e--;for(;c[e]<a;)d++,e++}var g=d!=b.key1;b.factor=(a-c[d])/(c[e]-c[d]),this._factor=a;var h=g||f!=b.factor;if(b.key1=d,b.key2=e,h){var i=this.getCurrentFrame();this.publish("update",i),g&&this.publish("frameUpdate",i)}this._engine.display.imageDirty=!0},SceneJS.MorphGeometry.prototype.getFactor=function(){return this._factor},SceneJS.MorphGeometry.prototype.getKeys=function(){return this._core.keys},SceneJS.MorphGeometry.prototype.getTargets=function(){return this._core.targets},SceneJS.MorphGeometry.prototype.getCurrentFrame=function(){var a=this._core,b=a.key1,c=a.key2;return{key1:b,key2:c,factor:a.factor,target1:a.targets[b],target2:a.targets[c]}},SceneJS.MorphGeometry.prototype._compile=function(d){this._core.hash||this._makeHash(),this._engine.display.morphGeometry=b[c++]=this._core,this._compileNodes(d),this._engine.display.morphGeometry=--c>0?b[c-1]:a,b[c]=null},SceneJS.MorphGeometry.prototype._makeHash=function(){var a=this._core;if(a.targets.length>0){var b=a.targets[0],c="t",d="f";a.hash=[b.vertexBuf?c:d,b.normalBuf?c:d,b.uvBuf?c:d,b.uvBuf2?c:d].join("")}else a.hash=""},SceneJS.MorphGeometry.prototype._destroy=function(){if(1==this._core.useCount&&document.getElementById(this._engine.canvas.canvasId))for(var a,b=this._core,c=0,d=b.targets.length;d>c;c++)a=b.targets[c],a.vertexBuf&&a.vertexBuf.destroy(),a.pickPositionsBuf&&a.pickPositionsBuf.destroy(),a.normalBuf&&a.normalBuf.destroy(),a.uvBuf&&a.uvBuf.destroy(),a.uvBuf2&&a.uvBuf2.destroy()}},function(){var a={type:"name",stateId:SceneJS._baseStateId++,name:null},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.name=a,c=0}),SceneJS.Name=SceneJS_NodeFactory.createNodeType("name"),SceneJS.Name.prototype._init=function(a){this.setName(a.name),this._core.nodeId=this.id},SceneJS.Name.prototype.setName=function(a){this._core.name=a||"unnamed",this._engine.branchDirty(this)},SceneJS.Name.prototype.getName=function(){return this._core.name},SceneJS.Name.prototype._compile=function(d){this._engine.display.name=b[c++]=this._core;for(var e,f=[],g=0;c>g;g++)e=b[g].name,e&&f.push(e);this._core.path=f.join("."),this._compileNodes(d),this._engine.display.name=--c>0?b[c-1]:a,b[c]=null}}(),new function(){function a(a){var c;if(f>0){c={};for(var d in a)a.hasOwnProperty(d)&&void 0!=a[d]&&(c[d]=g(d))}return b(a.props),{props:a,setProps:function(b){h(b,a)},restoreProps:function(a){c&&i(a,c)}}}function b(a){var b;for(var c in a)a.hasOwnProperty(c)&&(b=a[c],void 0!=b&&null!=b&&(k[c]?a[c]=k[c](null,b):l[c]&&(a[c]=l[c](null,b))))}var c,d={type:"renderer",stateId:SceneJS._baseStateId++,props:null},e=[],f=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){c=a.engine.canvas,f=0,a.engine.display.renderer=e[f++]=d});var g=function(a){for(var b,c,d=f-1;d>=0;d--)if(b=e[d].props,b&&(c=b[a],void 0!=c&&null!=c))return b[a];return null},h=function(a,b){for(var c in b)if(b.hasOwnProperty(c)){var d=k[c];d&&d(a,b[c])}b.viewport&&l.viewport(a,b.viewport),b.scissor&&l.clear(a,b.scissor),b.clear&&l.clear(a,b.clear)},i=function(a,b){var c;for(var d in b)if(b.hasOwnProperty(d)&&(c=b[d],void 0!=c&&null!=c)){var e=k[d];e&&e(a,c)}b.viewport&&l.viewport(a,b.viewport),b.scissor&&l.clear(a,b.scissor)},j=function(a,b){if(!b)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,'Null SceneJS.State node config: "'+b+'"');var c=SceneJS._webgl.enumMap[b];if(!c)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,'Unrecognised SceneJS.State node config value: "'+b+'"');var d=a[c];if(!d)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"This browser's WebGL does not support renderer node config value: \""+b+'"');return d},k={enableBlend:function(a,b){return a?void(b?a.enable(a.BLEND):a.disable(a.BLEND)):((null==b||void 0==b)&&(b=!1),b)},blendColor:function(a,b){return a?void a.blendColor(b.r,b.g,b.b,b.a):(b=b||{},{r:b.r||0,g:b.g||0,b:b.b||0,a:void 0==b.a||null==b.a?1:b.a})},blendEquation:function(a,b){return a?void a.blendEquation(a,j(a,b)):b||"funcAdd"},blendEquationSeparate:function(a,b){return a?void a.blendEquation(j(a,b.rgb),j(a,b.alpha)):(b=b||{},{rgb:b.rgb||"funcAdd",alpha:b.alpha||"funcAdd"})},blendFunc:function(a,b){return a?void a.blendFunc(j(a,b.sfactor||"srcAlpha"),j(a,b.dfactor||"oneMinusSrcAlpha")):(b=b||{},{sfactor:b.sfactor||"srcAlpha",dfactor:b.dfactor||"oneMinusSrcAlpha"})},blendFuncSeparate:function(a,b){return a?void a.blendFuncSeparate(j(a,b.srcRGB||"zero"),j(a,b.dstRGB||"zero"),j(a,b.srcAlpha||"zero"),j(a,b.dstAlpha||"zero")):(b=b||{},{srcRGB:b.srcRGB||"zero",dstRGB:b.dstRGB||"zero",srcAlpha:b.srcAlpha||"zero",dstAlpha:b.dstAlpha||"zero"})},clearColor:function(a,b){return a?void a.clearColor(b.r,b.g,b.b,b.a):(b=b||{},{r:b.r||0,g:b.g||0,b:b.b||0,a:void 0==b.a||null==b.a?1:b.a})},clearDepth:function(a,b){return a?void a.clearDepth(b):null==b||void 0==b?1:b},clearStencil:function(a,b){return a?void a.clearStencil(b):b||0},colorMask:function(a,b){return a?void a.colorMask(b.r,b.g,b.b,b.a):(b=b||{},{r:b.r||0,g:b.g||0,b:b.b||0,a:void 0==b.a||null==b.a?1:b.a})},enableCullFace:function(a,b){return a?void(b?a.enable(a.CULL_FACE):a.disable(a.CULL_FACE)):b},cullFace:function(a,b){return a?void a.cullFace(j(a,b)):b||"back"},enableDepthTest:function(a,b){return a?void(b?a.enable(a.DEPTH_TEST):a.disable(a.DEPTH_TEST)):((null==b||void 0==b)&&(b=!0),b)},depthFunc:function(a,b){return a?void a.depthFunc(j(a,b)):b||"less"},enableDepthMask:function(a,b){return a?void a.depthMask(b):((null==b||void 0==b)&&(b=!0),b)},depthRange:function(a,b){return a?void a.depthRange(b.zNear,b.zFar):(b=b||{},{zNear:void 0==b.zNear||null==b.zNear?0:b.zNear,zFar:void 0==b.zFar||null==b.zFar?1:b.zFar})},frontFace:function(a,b){return a?void a.frontFace(j(a,b)):b||"ccw"},lineWidth:function(a,b){return a?void a.lineWidth(b):b||1},enableScissorTest:function(a,b){return a?void(b?a.enable(a.SCISSOR_TEST):(b=!1,a.disable(a.SCISSOR_TEST))):b}},l={viewport:function(a,b){return a?void a.viewport(b.x,b.y,b.width,b.height):(b=b||{},{x:b.x||1,y:b.y||1,width:b.width||c.canvas.width,height:b.height||c.canvas.height})},scissor:function(a,b){return a?void a.scissor(b.x,b.y,b.width,b.height):(b=b||{},{x:b.x||0,y:b.y||0,width:b.width||1,height:b.height||1})},clear:function(a,b){if(!a)return b=b||{};var c;b.color&&(c=a.COLOR_BUFFER_BIT),b.depth&&(c|=a.DEPTH_BUFFER_BIT),b.stencil&&(c|=a.STENCIL_BUFFER_BIT)}};SceneJS.Renderer=SceneJS_NodeFactory.createNodeType("renderer"),SceneJS.Renderer.prototype._init=function(a){if(1==this._core.useCount){for(var b in a)a.hasOwnProperty(b)&&(this._core[b]=a[b]);this._core.dirty=!0}},SceneJS.Renderer.prototype.setViewport=function(a){this._core.viewport=a?{x:a.x||1,y:a.y||1,width:a.width||1e3,height:a.height||1e3}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getViewport=function(){return this._core.viewport?{x:this._core.viewport.x,y:this._core.viewport.y,width:this._core.viewport.width,height:this._core.viewport.height}:void 0},SceneJS.Renderer.prototype.setScissor=function(a){this._core.scissor=a?{x:a.x||1,y:a.y||1,width:a.width||1e3,height:a.height||1e3}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getScissor=function(){return this._core.scissor?{x:this._core.scissor.x,y:this._core.scissor.y,width:this._core.scissor.width,height:this._core.scissor.height}:void 0},SceneJS.Renderer.prototype.setClear=function(a){this._core.clear=a?{r:a.r||0,g:a.g||0,b:a.b||0}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getClear=function(){return this._core.clear?{r:this._core.clear.r,g:this._core.clear.g,b:this._core.clear.b}:null},SceneJS.Renderer.prototype.setEnableBlend=function(a){this._core.enableBlend=a,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getEnableBlend=function(){return this._core.enableBlend},SceneJS.Renderer.prototype.setBlendColor=function(a){this._core.blendColor=a?{r:a.r||0,g:a.g||0,b:a.b||0,a:void 0==a.a||null==a.a?1:a.a}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendColor=function(){return this._core.blendColor?{r:this._core.blendColor.r,g:this._core.blendColor.g,b:this._core.blendColor.b,a:this._core.blendColor.a}:void 0},SceneJS.Renderer.prototype.setBlendEquation=function(a){this._core.blendEquation=a,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendEquation=function(){return this._core.blendEquation},SceneJS.Renderer.prototype.setBlendEquationSeparate=function(a){this._core.blendEquationSeparate=a?{rgb:a.rgb||"funcAdd",alpha:a.alpha||"funcAdd"}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendEquationSeparate=function(){return this._core.blendEquationSeparate?{rgb:this._core.rgb,alpha:this._core.alpha}:void 0},SceneJS.Renderer.prototype.setBlendFunc=function(a){this._core.blendFunc=a?{sfactor:a.sfactor||"srcAlpha",dfactor:a.dfactor||"one"}:void 0,this._core.dirty=!0,this._engine.display.imageDirty=!0},SceneJS.Renderer.prototype.getBlendFunc=function(){return this._core.blendFunc?{sfactor:this._core.sfactor,dfactor:this._core.dfactor}:void 0},SceneJS.Renderer.prototype.setBlendFuncSeparate=function(a){this._core.blendFuncSeparate=a?{srcRGB:a.srcRGB||"zero",dstRGB:a.dstRGB||"zero",srcAlpha:a.srcAlpha||"zero",dstAlpha:a.dstAlpha||"zero"}:void 0,this._core.dirty=!0},SceneJS.Renderer.prototype.getBlendFuncSeparate=function(){return this._core.blendFuncSeparate?{srcRGB:this._core.blendFuncSeparate.srcRGB,dstRGB:this._core.blendFuncSeparate.dstRGB,srcAlpha:this._core.blendFuncSeparate.srcAlpha,dstAlpha:this._core.blendFuncSeparate.dstAlpha}:void 0},SceneJS.Renderer.prototype.setEnableCullFace=function(a){this._core.enableCullFace=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableCullFace=function(){return this._core.enableCullFace},SceneJS.Renderer.prototype.setCullFace=function(a){this._core.cullFace=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getCullFace=function(){return this._core.cullFace},SceneJS.Renderer.prototype.setEnableDepthTest=function(a){this._core.enableDepthTest=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableDepthTest=function(){return this._core.enableDepthTest},SceneJS.Renderer.prototype.setDepthFunc=function(a){this._core.depthFunc=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getDepthFunc=function(){return this._core.depthFunc},SceneJS.Renderer.prototype.setEnableDepthMask=function(a){this._core.enableDepthMask=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableDepthMask=function(){return this._core.enableDepthMask},SceneJS.Renderer.prototype.setClearDepth=function(a){this._core.clearDepth=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getClearDepth=function(){return this._core.clearDepth},SceneJS.Renderer.prototype.setDepthRange=function(a){this._core.depthRange=a?{zNear:void 0==a.zNear||null==a.zNear?0:a.zNear,zFar:void 0==a.zFar||null==a.zFar?1:a.zFar}:void 0,this._core.dirty=!0},SceneJS.Renderer.prototype.getDepthRange=function(){return this._core.depthRange?{zNear:this._core.depthRange.zNear,zFar:this._core.depthRange.zFar}:void 0},SceneJS.Renderer.prototype.setFrontFace=function(a){this._core.frontFace=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getFrontFace=function(){return this._core.frontFace},SceneJS.Renderer.prototype.setLineWidth=function(a){this._core.lineWidth=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getLineWidth=function(){return this._core.lineWidth},SceneJS.Renderer.prototype.setEnableScissorTest=function(a){this._core.enableScissorTest=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getEnableScissorTest=function(){return this._core.enableScissorTest},SceneJS.Renderer.prototype.setClearStencil=function(a){this._core.clearStencil=a,this._core.dirty=!0},SceneJS.Renderer.prototype.getClearStencil=function(){return this._core.clearStencil},SceneJS.Renderer.prototype.setColorMask=function(a){this._core.colorMask=a?{r:a.r||0,g:a.g||0,b:a.b||0,a:void 0==a.a||null==a.a?1:a.a}:void 0,this._core.dirty=!0},SceneJS.Renderer.prototype.getColorMask=function(){return this._core.colorMask?{r:this._core.colorMask.r,g:this._core.colorMask.g,
b:this._core.colorMask.b,a:this._core.colorMask.a}:void 0},SceneJS.Renderer.prototype._compile=function(b){this._core.dirty&&(this._core.props=a(this._core),this._core.dirty=!1),this._engine.display.renderer=e[f++]=this._core,this._compileNodes(b),this._engine.display.renderer=--f>0?e[f-1]:d,e[f]=null}},function(){var a={less:"LESS",equal:"EQUAL",lequal:"LEQUAL",greater:"GREATER",notequal:"NOTEQUAL",gequal:"GEQUAL"},b={type:"depthBuffer",stateId:SceneJS._baseStateId++,enabled:!0,clearDepth:1,depthFunc:null,_depthFuncName:"less"},c=[],d=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){null===b.depthFunc&&(b.depthFunc=a.engine.canvas.gl.LESS),a.engine.display.depthBuffer=b,d=0}),SceneJS.DepthBuf=SceneJS_NodeFactory.createNodeType("depthBuffer"),SceneJS.DepthBuf.prototype._init=function(a){void 0!=a.enabled?this.setEnabled(a.enabled):1==this._core.useCount&&this.setEnabled(!0),void 0!=a.clearDepth?this.setClearDepth(a.clearDepth):1==this._core.useCount&&this.setClearDepth(1),void 0!=a.depthFunc?this.setDepthFunc(a.depthFunc):1==this._core.useCount&&this.setDepthFunc("less"),void 0!=a.clear?this.setClear(a.clear):1==this._core.useCount&&this.setClear(!0)},SceneJS.DepthBuf.prototype.setEnabled=function(a){return this._core.enabled!=a&&(this._core.enabled=a,this._engine.display.imageDirty=!0),this},SceneJS.DepthBuf.prototype.getEnabled=function(){return this._core.enabled},SceneJS.DepthBuf.prototype.setClear=function(a){return this._core.clear!=a&&(this._core.clear=a,this._engine.display.imageDirty=!0),this},SceneJS.DepthBuf.prototype.getClear=function(){return this._core.clear},SceneJS.DepthBuf.prototype.setClearDepth=function(a){return this._core.clearDepth!=a&&(this._core.clearDepth=a,this._engine.display.imageDirty=!0),this},SceneJS.DepthBuf.prototype.getClearDepth=function(){return this._core.clearDepth},SceneJS.DepthBuf.prototype.setDepthFunc=function(b){if(this._core._depthFuncName!=b){var c=a[b];if(void 0==c)throw"unsupported value for 'clearFunc' attribute on depthBuffer node: '"+b+"' - supported values are 'less', 'equal', 'lequal', 'greater', 'notequal' and 'gequal'";this._core.depthFunc=this._engine.canvas.gl[c],this._core._depthFuncName=b,this._engine.display.imageDirty=!0}return this},SceneJS.DepthBuf.prototype.getDepthFunc=function(){return this._core._depthFuncName},SceneJS.DepthBuf.prototype._compile=function(a){this._engine.display.depthBuffer=c[d++]=this._core,this._compileNodes(a),this._engine.display.depthBuffer=--d>0?c[d-1]:b,c[d]=null}}(),function(){var a={type:"colorBuffer",stateId:SceneJS._baseStateId++,blendEnabled:!1,colorMask:{r:!0,g:!0,b:!0,a:!0}},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.colorBuffer=a,c=0}),SceneJS.ColorBuffer=SceneJS_NodeFactory.createNodeType("colorBuffer"),SceneJS.ColorBuffer.prototype._init=function(a){void 0!=a.blendEnabled?this.setBlendEnabled(a.blendEnabled):1==this._core.useCount&&this.setBlendEnabled(!1),this.setColorMask(a)},SceneJS.ColorBuffer.prototype.setBlendEnabled=function(a){this._core.blendEnabled!=a&&(this._core.blendEnabled=a,this._engine.display.imageDirty=!0),this._engine.display.imageDirty=!0},SceneJS.ColorBuffer.prototype.getBlendEnabled=function(){return this._core.blendEnabled},SceneJS.ColorBuffer.prototype.setColorMask=function(a){this._core.colorMask={r:void 0!=a.r&&null!=a.r?a.r:!0,g:void 0!=a.g&&null!=a.g?a.g:!0,b:void 0!=a.b&&null!=a.b?a.b:!0,a:void 0!=a.a&&null!=a.a?a.a:!0},this._engine.display.imageDirty=!0},SceneJS.ColorBuffer.prototype.getColorMask=function(){return this._core.colorMask},SceneJS.ColorBuffer.prototype._compile=function(d){this._engine.display.colorBuffer=b[c++]=this._core,this._compileNodes(d),this._engine.display.colorBuffer=--c>0?b[c-1]:a,b[c]=null,this._engine.display.imageDirty=!0}}(),function(){var a={type:"view",stateId:SceneJS._baseStateId++,scissorTestEnabled:!1},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.view=a,c=0}),SceneJS.View=SceneJS_NodeFactory.createNodeType("view"),SceneJS.View.prototype._init=function(a){void 0!=a.scissorTestEnabled?this.setScissorTestEnabled(a.scissorTestEnabled):1==this._core.useCount&&this.setScissorTestEnabled(!1)},SceneJS.View.prototype.setScissorTestEnabled=function(a){return this._core.scissorTestEnabled!=a&&(this._core.scissorTestEnabled=a,this._engine.display.imageDirty=!0),this},SceneJS.View.prototype.getScissorTestEnabled=function(){return this._core.scissorTestEnabled},SceneJS.View.prototype._compile=function(d){this._engine.display.view=b[c++]=this._core,this._compileNodes(d),this._engine.display.view=--c>0?b[c-1]:a,b[c]=null}}(),SceneJS.Scene=SceneJS_NodeFactory.createNodeType("scene"),SceneJS.Scene.prototype._init=function(a){a.tagMask&&this.setTagMask(a.tagMask),this._tagSelector=null,this.transparent=a.transparent===!0},SceneJS.Scene.prototype.loseWebGLContext=function(){this._engine.loseWebGLContext()},SceneJS.Scene.prototype.getCanvas=function(){return this._engine.canvas.canvas},SceneJS.Scene.prototype.getGL=function(){return this._engine.canvas.gl},SceneJS.Scene.prototype.getZBufferDepth=function(){var a=this._engine.canvas.gl;return a.getParameter(a.DEPTH_BITS)},SceneJS.Scene.prototype.setResolutionScaling=function(a){return this._engine.canvas.setResolutionScaling(a)},SceneJS.Scene.prototype.setTagMask=function(a){a=a||"XXXXXXXXXXXXXXXXXXXXXXXXXX",this._tagSelector||(this._tagSelector={}),this._tagSelector.mask=a,this._tagSelector.regex=a?new RegExp(a):null,this._engine.display.selectTags(this._tagSelector)},SceneJS.Scene.prototype.getTagMask=function(){return this._tagSelector?this._tagSelector.mask:null},SceneJS.Scene.prototype.setNumPasses=function(a){this._engine.setNumPasses(a)},SceneJS.Scene.prototype.renderFrame=function(a){return this._engine.renderFrame(a)},SceneJS.Scene.prototype.needFrame=function(){this._engine.display.imageDirty=!0},SceneJS.Scene.prototype.start=function(a){this._engine.start(a)},SceneJS.Scene.prototype.setFPS=function(a){this._engine.fps=a},SceneJS.Scene.prototype.pause=function(a){this._engine.pause(a)},SceneJS.Scene.prototype.isRunning=function(){return this._engine.running},SceneJS.Scene.prototype.pick=function(a,b,c){var d=this._engine.pick(a,b,c);return this.renderFrame({force:!0}),d?(this.publish("pick",d),d):void this.publish("nopick")},SceneJS.Scene.prototype.readPixels=function(a,b,c){return this._engine.readPixels(a,b,c)},SceneJS.Scene.prototype._destroy=function(){this.destroyed||(delete SceneJS._engines[this.id],SceneJS._engineIds.removeItem(this.id),this.destroyed=!0)},SceneJS.Scene.prototype.isActive=function(){return!this._engine.destroyed},SceneJS.Scene.prototype.stop=function(){this._engine.stop()},SceneJS.Scene.prototype.containsNode=function(a){return!!this._engine.findNode(a)},SceneJS.Scene.prototype.findNodes=function(a){return this._engine.findNodes(a)},SceneJS.Scene.prototype.findNode=function(a,b){return this.getNode(a,b)},SceneJS.Scene.prototype.getNode=function(a,b){var c=this._engine.findNode(a);return c?(b&&b(c),c):b?void this.once("nodes/"+a,b):null},SceneJS.Scene.prototype.hasCore=function(a,b){return this._engine.hasCore(a,b)},SceneJS.Scene.prototype.getStatus=function(){var a=SceneJS_sceneStatusModule.sceneStatus[this.id];return a?SceneJS._shallowClone(a):{destroyed:!0}},new function(){function a(a){for(var b,c,d={},e=0;i>e;e++){b=a[e];for(c in b)b.hasOwnProperty(c)&&(d[c]=b[c])}return d}var b={type:"shader",stateId:SceneJS._baseStateId++,hash:"",empty:!0,shader:{}},c=[],d=[],e=[],f=[],g=[],h=[],i=0,j=!0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){a.engine.display.shader=b,i=0,j=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(k){if(j){if(i>0){var l={type:"shader",stateId:c[i-1],hash:c.slice(0,i).join("."),shaders:{fragment:{code:f.slice(0,i).join(""),hooks:a(g)},vertex:{code:d.slice(0,i).join(""),hooks:a(e)}},paramsStack:h.slice(0,i)};k.display.shader=l}else k.display.shader=b;j=!1}}),SceneJS.Shader=SceneJS_NodeFactory.createNodeType("shader"),SceneJS.Shader.prototype._init=function(a){1==this._core.useCount&&(this._setShaders(a.shaders),this.setParams(a.params))},SceneJS.Shader.prototype._setShaders=function(a){a=a||[],this._core.shaders={};for(var b,c=0,d=a.length;d>c;c++){if(b=a[c],!b.stage)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"shader 'stage' attribute expected");var e;b.code&&(e=SceneJS._isArray(b.code)?b.code.join(""):b.code),this._core.shaders[b.stage]={code:e,hooks:b.hooks}}},SceneJS.Shader.prototype.setParams=function(a){a=a||{};var b=this._core.params;b||(b=this._core.params={});for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);this._engine.display.imageDirty=!0},SceneJS.Shader.prototype.getParams=function(){var a=this._core.params;if(!a)return{};var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},SceneJS.Shader.prototype._compile=function(a){c[i]=this._core.coreId;var b=this._core.shaders,k=b.fragment||{},l=b.vertex||{};f[i]=k.code||"",g[i]=k.hooks||{},d[i]=l.code||"",e[i]=l.hooks||{},h[i]=this._core.params||{},i++,j=!0,this._compileNodes(a),i--,j=!0}},new function(){var a,b={type:"shaderParams",stateId:SceneJS._baseStateId++,empty:!0},c=[],d=[],e=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(c){c.engine.display.shaderParams=b,e=0,a=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(f){if(a){if(e>0){var g={type:"shaderParams",stateId:c[e-1],paramsStack:d.slice(0,e)};f.display.shaderParams=g}else f.display.shaderParams=b;a=!1}}),SceneJS.ShaderParams=SceneJS_NodeFactory.createNodeType("shaderParams"),SceneJS.ShaderParams.prototype._init=function(a){1==this._core.useCount&&this.setParams(a.params)},SceneJS.ShaderParams.prototype.setParams=function(a){a=a||{};var b=this._core;b.params||(b.params={});for(var c in a)a.hasOwnProperty(c)&&(b.params[c]=a[c]);this._engine.display.imageDirty=!0},SceneJS.ShaderParams.prototype.getParams=function(){var a=this._core.params;if(!a)return{};var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},SceneJS.ShaderParams.prototype._compile=function(b){c[e]=this._core.coreId,d[e]=this._core.params,e++,a=!0,this._compileNodes(b),e--,a=!0}},function(){var a={type:"style",stateId:SceneJS._baseStateId++,lineWidth:1},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.style=a,c=0}),SceneJS.Style=SceneJS_NodeFactory.createNodeType("style"),SceneJS.Style.prototype._init=function(a){void 0!=a.lineWidth&&this.setLineWidth(a.lineWidth)},SceneJS.Style.prototype.setLineWidth=function(a){return this._core.lineWidth!=a&&(this._core.lineWidth=a,this._engine.display.imageDirty=!0),this},SceneJS.Style.prototype.getLineWidth=function(){return this._core.lineWidth},SceneJS.Style.prototype._compile=function(d){this._engine.display.style=b[c++]=this._core,this._compileNodes(d),this._engine.display.style=--c>0?b[c-1]:a,b[c]=null}}(),function(){var a={type:"tag",stateId:SceneJS._baseStateId++,tag:null},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.tag=a,c=0}),SceneJS.Tag=SceneJS_NodeFactory.createNodeType("tag"),SceneJS.Tag.prototype._init=function(a){if(1==this._core.useCount){if(!a.tag)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"tag node attribute missing : 'tag'");this.setTag(a.tag)}},SceneJS.Tag.prototype.setTag=function(a){var b=this._core;b.tag=a,b.pattern=null,b.matched=!1,this._engine.display.drawListDirty=!0},SceneJS.Tag.prototype.getTag=function(){return this._core.tag},SceneJS.Tag.prototype._compile=function(d){this._engine.display.tag=b[c++]=this._core,this._compileNodes(d),this._engine.display.tag=--c>0?b[c-1]:a,b[c]=null}}(),new function(){var a={type:"texture",stateId:SceneJS._baseStateId++,empty:!0,hash:""},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.texture=a,c=0}),SceneJS.Texture=SceneJS_NodeFactory.createNodeType("_texture"),SceneJS.Texture.prototype._init=function(a){if(1==this._core.useCount){this._core.layers=[],this._core.params={};var b=void 0==a.waitForLoad?!0:a.waitForLoad;if(!a.layers)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers missing");if(!SceneJS._isArray(a.layers))throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layers should be an array");for(var c,d=this._engine.canvas.gl,e=0;e<a.layers.length;e++){if(c=a.layers[e],!(c.source||c.uri||c.src||c.colorTarget||c.video))throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+e+"  has no uri, src, source, colorTarget, video or canvasId specified");if(c.applyFrom&&"uv"!=c.applyFrom&&"uv2"!=c.applyFrom&&"normal"!=c.applyFrom&&"geometry"!=c.applyFrom)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+e+"  applyFrom value is unsupported - should be either 'uv', 'uv2', 'normal' or 'geometry'");if(c.applyTo&&"baseColor"!=c.applyTo&&"color"!=c.applyTo&&"specular"!=c.applyTo&&"emit"!=c.applyTo&&"alpha"!=c.applyTo&&"normals"!=c.applyTo&&"shine"!=c.applyTo)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+e+" applyTo value is unsupported - should be either 'color', 'baseColor', 'specular' or 'normals'");if(c.blendMode&&"add"!=c.blendMode&&"multiply"!=c.blendMode&&"mix"!=c.blendMode)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer "+e+" blendMode value is unsupported - should be either 'add', 'multiply' or 'mix'");"color"==c.applyTo&&(c.applyTo="baseColor");var f=SceneJS._apply(c,{waitForLoad:b,texture:null,applyFrom:c.applyFrom||"uv",applyTo:c.applyTo||"baseColor",blendMode:c.blendMode||"multiply",blendFactor:void 0!=c.blendFactor&&null!=c.blendFactor?c.blendFactor:1,translate:{x:0,y:0},scale:{x:1,y:1},rotate:{z:0}});if(this._core.layers.push(f),this._setLayerTransform(c,f),f.colorTarget){var g=this._engine.findNode(f.colorTarget);g&&"colorTarget"==g.type&&(f.texture=g._core.colorTarget.getTexture())}else this._loadLayerTexture(d,f);f.image&&"baseColor"==f.applyTo&&!this._imagePublished&&(this.publish("image",f.image),this._imagePublished=!0)}var h=this;this._core.webglRestored=function(){for(var a=h._core.layers,b=h._engine.canvas.gl,c=0,d=a.length;d>c;c++)h._loadLayerTexture(b,a[c])}}},SceneJS.Texture.prototype._loadLayerTexture=function(a,b){var c=this,d=b.source;if(d){if(!d.type)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"texture layer config expected: source.type");SceneJS.Plugins.getPlugin("texture",d.type,function(e){if(!e.getSource)throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'getSource' method missing on plugin for texture source type '"+d.type+"'.");var f=e.getSource({gl:a});if(!f.subscribe)throw SceneJS_error.fatalError(SceneJS.errors.PLUGIN_INVALID,"texture: 'subscribe' method missing on plugin for texture source type '"+d.type+"'");var g=SceneJS_sceneStatusModule.taskStarted(c,"Loading texture");f.subscribe(function(){var d=!1;return function(e){d?c._engine.display.imageDirty=!0:(d=!0,c._setLayerTexture(a,b,e),SceneJS_sceneStatusModule.taskFinished(g))}}()),f.configure&&f.configure(d),b._source=f})}else{var e=b.uri||b.src,f=b.preloadURI||b.preloadSrc,g=b.preloadColor||{r:.57735,g:.57735,b:.57735};g.a=void 0===g.a?1:g.a,g=new Uint8Array([Math.floor(255*g.r),Math.floor(255*g.g),Math.floor(255*g.b),Math.floor(255*g.a)]);var h=SceneJS_sceneStatusModule.taskStarted(this,"Loading texture"),i=a.createTexture(),j=!1,k=!1;if(a.bindTexture(a.TEXTURE_2D,i),b.image)return c._setTextureImage(a,i,b.image),c._setLayerTexture(a,b,i),void SceneJS_sceneStatusModule.taskFinished(h);if(a.texImage2D(a.TEXTURE_2D,0,a.RGBA,1,1,0,a.RGBA,a.UNSIGNED_BYTE,g),c._setLayerTexture(a,b,i),f){var l=new Image;l.onload=function(){j||(c._setTextureImage(a,i,l),c._setLayerTexture(a,b,i),SceneJS_sceneStatusModule.taskFinished(h),k=!0)},c._fetchImage(l,f)}var m=new Image;m.onload=function(){c._setTextureImage(a,i,m),c._setLayerTexture(a,b,i),k||SceneJS_sceneStatusModule.taskFinished(h),b.image=m,j=!0,c.publish("image",m)},m.onerror=function(){SceneJS_sceneStatusModule.taskFailed(h)},c._fetchImage(m,e)}},SceneJS.Texture.prototype._fetchImage=function(a,b){0==b.indexOf("data")?a.src=b:(a.crossOrigin="Anonymous",a.src=b)},SceneJS.Texture.prototype._setTextureImage=function(a,b,c){a.bindTexture(a.TEXTURE_2D,b);var d=SceneJS_configsModule.configs.maxTextureSize;return d&&(c=SceneJS._webgl.clampImageSize(c,d)),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,a.RGBA,a.UNSIGNED_BYTE,this._ensureImageSizePowerOfTwo(c)),this._engine.display.imageDirty=!0,c},SceneJS.Texture.prototype._ensureImageSizePowerOfTwo=function(a){if(!this._isPowerOfTwo(a.width)||!this._isPowerOfTwo(a.height)){var b=document.createElement("canvas");b.width=this._nextHighestPowerOfTwo(a.width),b.height=this._nextHighestPowerOfTwo(a.height);var c=b.getContext("2d");c.drawImage(a,0,0,a.width,a.height,0,0,b.width,b.height),a=b,a.crossOrigin=""}return a},SceneJS.Texture.prototype._isPowerOfTwo=function(a){return 0==(a&a-1)},SceneJS.Texture.prototype._nextHighestPowerOfTwo=function(a){--a;for(var b=1;32>b;b<<=1)a|=a>>b;return a+1},SceneJS.Texture.prototype._setLayerTexture=function(a,b,c){b.texture=new SceneJS._webgl.Texture2D(a,{texture:c,minFilter:this._getGLOption("minFilter",a,b,a.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",a,b,a.LINEAR),wrapS:this._getGLOption("wrapS",a,b,a.REPEAT),wrapT:this._getGLOption("wrapT",a,b,a.REPEAT),isDepth:this._getOption(b.isDepth,!1),depthMode:this._getGLOption("depthMode",a,b,a.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",a,b,a.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",a,b,a.LEQUAL),flipY:this._getOption(b.flipY,!0),width:this._getOption(b.width,1),height:this._getOption(b.height,1),internalFormat:this._getGLOption("internalFormat",a,b,a.LEQUAL),sourceFormat:this._getGLOption("sourceType",a,b,a.ALPHA),sourceType:this._getGLOption("sourceType",a,b,a.UNSIGNED_BYTE),update:null}),this.destroyed&&b.texture.destroy(),this._engine.display.imageDirty=!0},SceneJS.Texture.prototype._getGLOption=function(a,b,c,d){var e=c[a];if(void 0==e)return d;var f=SceneJS._webgl.enumMap[e];if(void 0==f)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+a+"' value: '"+e+"'");var g=b[f];return g},SceneJS.Texture.prototype._getOption=function(a,b){return void 0==a?b:a},SceneJS.Texture.prototype.setLayer=function(a){if(void 0==a.index||null==a.index)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index null or undefined");if(a.index<0||a.index>=this._core.layers.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)");this._setLayer(parseInt(a.index),a),this._engine.display.imageDirty=!0},SceneJS.Texture.prototype.setLayers=function(a){var b;for(var c in a)if(a.hasOwnProperty(c)&&(void 0!=c||null!=c)){if(b=parseInt(c),0>b||b>=this._core.layers.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Invalid texture set layer argument: index out of range ("+this._core.layers.length+" layers defined)");this._setLayer(b,a[c]||{})}this._engine.display.imageDirty=!0},SceneJS.Texture.prototype._setLayer=function(a,b){b=b||{};var c=this._core.layers[a];if(void 0!=b.blendFactor&&null!=b.blendFactor&&(c.blendFactor=b.blendFactor),b.source){var d=c._source;d&&d.configure&&d.configure(b.source)}(b.translate||b.rotate||b.scale)&&this._setLayerTransform(b,c)},SceneJS.Texture.prototype._setLayerTransform=function(a,b){var c,d;if(a.translate){var e=a.translate;void 0!=e.x&&(b.translate.x=e.x),void 0!=e.y&&(b.translate.y=e.y),c=SceneJS_math_translationMat4v([e.x||0,e.y||0,0])}if(a.scale){var f=a.scale;void 0!=f.x&&(b.scale.x=f.x),void 0!=f.y&&(b.scale.y=f.y),d=SceneJS_math_scalingMat4v([f.x||1,f.y||1,1]),c=c?SceneJS_math_mulMat4(c,d):d}if(a.rotate){var g=a.rotate;void 0!=g.z&&(b.rotate.z=g.z||0),d=SceneJS_math_rotationMat4v(.0174532925*g.z,[0,0,1]),c=c?SceneJS_math_mulMat4(c,d):d}c&&(b.matrix=c,b.matrixAsArray?b.matrixAsArray.set(b.matrix):b.matrixAsArray=new Float32Array(b.matrix),b.matrixAsArray=new Float32Array(b.matrix))},SceneJS.Texture.prototype._compile=function(d){this._core.hash||this._makeHash(),this._engine.display.texture=b[c++]=this._core,this._compileNodes(d),this._engine.display.texture=--c>0?b[c-1]:a,b[c]=null},SceneJS.Texture.prototype._makeHash=function(){var a,b=this._core;if(b.layers&&b.layers.length>0){for(var c,d=b.layers,e=[],f=0,g=d.length;g>f;f++)c=d[f],e.push("/"),e.push(c.applyFrom),e.push("/"),e.push(c.applyTo),e.push("/"),e.push(c.blendMode),c.matrix&&e.push("/anim");a=e.join("")}else a="";b.hash!=a&&(b.hash=a)},SceneJS.Texture.prototype._destroy=function(){if(1==this._core.useCount)for(var a,b,c=this._core.layers,d=0,e=c.length;e>d;d++)a=c[d],a.texture&&a.texture.destroy(),b=a._source,b&&b.destroy&&b.destroy()}},new function(){function a(){var a,b;(0!=this.translate.x||0!=this.translate.y)&&(a=SceneJS_math_translationMat4v([this.translate.x||0,this.translate.y||0,0])),(1!=this.scale.x||1!=this.scale.y)&&(b=SceneJS_math_scalingMat4v([this.scale.x||1,this.scale.y||1,1]),a=a?SceneJS_math_mulMat4(a,b):b),0!=this.rotate&&(b=SceneJS_math_rotationMat4v(.0174532925*this.rotate,[0,0,1]),a=a?SceneJS_math_mulMat4(a,b):b),a&&(this.matrix=a,this.matrixAsArray?this.matrixAsArray.set(this.matrix):this.matrixAsArray=new Float32Array(this.matrix)),this._matrixDirty=!1}var b={type:"texture",stateId:SceneJS._baseStateId++,empty:!0,hash:""};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){a.engine.display.texture=b,d=0});var c=[],d=0;SceneJS.TextureMap=SceneJS_NodeFactory.createNodeType("texture"),SceneJS.TextureMap.prototype._init=function(b){var c=this;if(1==this._core.useCount){if(b.applyFrom&&"uv"!=b.applyFrom&&"uv2"!=b.applyFrom&&"normal"!=b.applyFrom&&"geometry"!=b.applyFrom)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture applyFrom value is unsupported - should be either 'uv', 'uv2', 'normal' or 'geometry'");if(b.applyTo&&"baseColor"!=b.applyTo&&"color"!=b.applyTo&&"specular"!=b.applyTo&&"emit"!=b.applyTo&&"alpha"!=b.applyTo&&"normals"!=b.applyTo&&"shine"!=b.applyTo)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture applyTo value is unsupported - should be either 'color', 'baseColor', 'specular' or 'normals'");if(b.blendMode&&"add"!=b.blendMode&&"multiply"!=b.blendMode)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"texture layer blendMode value is unsupported - should be either 'add' or 'multiply'");"color"==b.applyTo&&(b.applyTo="baseColor"),SceneJS._apply({waitForLoad:void 0==b.waitForLoad?!0:b.waitForLoad,texture:null,applyFrom:b.applyFrom?b.applyFrom:"uv",applyTo:b.applyTo?b.applyTo:"baseColor",blendMode:b.blendMode?b.blendMode:"multiply",blendFactor:void 0!=b.blendFactor&&null!=b.blendFactor?b.blendFactor:1,translate:b.translate?SceneJS._apply(b.translate,{x:0,y:0}):{x:0,y:0},scale:b.scale?SceneJS._apply(b.scale,{x:1,y:1}):{x:1,y:1},rotate:b.rotate||0,matrix:null,_matrixDirty:!0,buildMatrix:a},this._core),a.call(this._core),b.src?(this._initTexture(b.preloadColor),this._core.src=b.src,this._loadTexture(b.src,b.preloadSrc)):b.image?(this._initTexture(b.preloadColor),this._core.image=b.image,this._setTextureImage(b.image)):b.target&&this.getScene().getNode(b.target,function(a){c.setTarget(a)}),this._core.webglRestored=function(){c._core.image?(c._initTexture(b.preloadColor),c._setTextureImage(c._core.image)):c._core.src?(c._initTexture(b.preloadColor),c._loadTexture(c._core.src)):c._core.target}}},SceneJS.TextureMap.prototype._initTexture=function(a){var b=this._engine.canvas.gl;a=a||{r:.57735,g:.57735,b:.57735},a.a=void 0===a.a?1:a.a,a=new Uint8Array([Math.floor(255*a.r),Math.floor(255*a.g),Math.floor(255*a.b),Math.floor(255*a.a)]);var c=b.createTexture();b.bindTexture(b.TEXTURE_2D,c),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,1,1,0,b.RGBA,b.UNSIGNED_BYTE,a),this._setCoreTexture(c)},SceneJS.TextureMap.prototype._loadTexture=function(a,b){var c=this,d=SceneJS_sceneStatusModule.taskStarted(this,"Loading texture"),e=new Image,f=!1,g=!1;if(b){var h=new Image;h.onload=function(){f||(c._setTextureImage(h),SceneJS_sceneStatusModule.taskFinished(d),g=!0,c._engine.display.imageDirty=!0)},this._fetchImage(h,b)}e.onload=function(){c._setTextureImage(e),g||SceneJS_sceneStatusModule.taskFinished(d),f=!0,c._engine.display.imageDirty=!0},e.onerror=function(){SceneJS_sceneStatusModule.taskFailed(d)},this._fetchImage(e,a)},SceneJS.TextureMap.prototype._fetchImage=function(a,b){0==b.indexOf("data")?a.src=b:(a.crossOrigin="Anonymous",a.src=b)},SceneJS.TextureMap.prototype._setTextureImage=function(a){var b=this._engine.canvas.gl,c=this._core.texture?this._core.texture.texture:b.createTexture();b.bindTexture(b.TEXTURE_2D,c);var d=SceneJS_configsModule.configs.maxTextureSize;d&&(a=SceneJS._webgl.clampImageSize(a,d)),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,SceneJS._webgl.ensureImageSizePowerOfTwo(a)),this._core.image=a,this._setCoreTexture(c)},SceneJS.TextureMap.prototype._setCoreTexture=function(a){var b=this._engine.canvas.gl;this._core.texture=new SceneJS._webgl.Texture2D(b,{texture:a,minFilter:this._getGLOption("minFilter",b.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",b.LINEAR),wrapS:this._getGLOption("wrapS",b.REPEAT),wrapT:this._getGLOption("wrapT",b.REPEAT),isDepth:this._getOption(this._core.isDepth,!1),depthMode:this._getGLOption("depthMode",b.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",b.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",b.LEQUAL),flipY:this._getOption(this._core.flipY,!0),width:this._getOption(this._core.width,1),height:this._getOption(this._core.height,1),internalFormat:this._getGLOption("internalFormat",b.ALPHA),sourceFormat:this._getGLOption("sourceFormat",b.ALPHA),sourceType:this._getGLOption("sourceType",b.UNSIGNED_BYTE),update:null}),this.destroyed&&this._core.texture.destroy(),this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype._getGLOption=function(a,b){var c=this._engine.canvas.gl,d=this._core[a];if(void 0==d)return b;var e=SceneJS._webgl.enumMap[d];if(void 0==e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+a+"' value: '"+d+"'");return c[e]},SceneJS.TextureMap.prototype._getOption=function(a,b){return void 0==a?b:a},SceneJS.TextureMap.prototype.setSrc=function(a){this._core.image=null,this._core.src=a,this._core.target=null,this._loadTexture(a)},SceneJS.TextureMap.prototype.setImage=function(a){this._core.image=a,this._core.src=null,this._core.target=null,this._setTextureImage(a)},SceneJS.TextureMap.prototype.setTarget=function(a){return"colorTarget"!=a.type&&"depthTarget"!=a.type?void console.log("Target node type not compatible: "+a.type):(delete this._core.src,this._core.target=a,this._core.src=null,this._core.image=null,this._core.texture=a._core.renderBuf.getTexture(),this._core.texture.bufType=a._core.bufType,void(this._engine.display.imageDirty=!0))},SceneJS.TextureMap.prototype.setBlendFactor=function(a){this._core.blendFactor=a,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getBlendFactor=function(){return this._core.blendFactor},SceneJS.TextureMap.prototype.setTranslate=function(a){this._core.translate||(this._core.translate={x:0,y:0}),this._core.translate.x=a.x,this._core.translate.y=a.y,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getTranslate=function(){return this._core.translate},SceneJS.TextureMap.prototype.setScale=function(a){this._core.scale||(this._core.scale={x:0,y:0}),this._core.scale.x=a.x,this._core.scale.y=a.y,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getScale=function(){return this._core.scale},SceneJS.TextureMap.prototype.setRotate=function(a){this._core.rotate=a,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.TextureMap.prototype.getRotate=function(){return this._core.rotate},SceneJS.TextureMap.prototype.getMatrix=function(){return this._core._matrixDirty&&this._core.buildMatrix.call(this.core)(),this.core.matrix},SceneJS.TextureMap.prototype._compile=function(a){this.__core||(this.__core=this._engine._coreFactory.getCore("texture"));var e=this._engine.display.texture;this._core.empty||(this.__core.layers=e&&e.layers?e.layers.concat([this._core]):[this._core]),this._makeHash(this.__core),c[d++]=this.__core,this._engine.display.texture=this.__core,this._compileNodes(a),this._engine.display.texture=--d>0?c[d-1]:b,c[d]=null},SceneJS.TextureMap.prototype._makeHash=function(a){var b;if(a.layers&&a.layers.length>0){for(var c,d=a.layers,e=[],f=0,g=d.length;g>f;f++)c=d[f],e.push("/"),e.push(c.applyFrom),e.push("/"),e.push(c.applyTo),e.push("/"),e.push(c.blendMode),c.matrix&&e.push("/anim");b=e.join("")}else b="";a.hash!=b&&(a.hash=b)},SceneJS.TextureMap.prototype._destroy=function(){1==this._core.useCount&&this._core.texture&&!this._core.target&&(this._core.texture.destroy(),this._core.texture=null),this._core&&this._engine._coreFactory.putCore(this._core)}},new function(){function a(){var a,b;(0!=this.translate.x||0!=this.translate.y)&&(a=SceneJS_math_translationMat4v([this.translate.x||0,this.translate.y||0,0])),(1!=this.scale.x||1!=this.scale.y)&&(b=SceneJS_math_scalingMat4v([this.scale.x||1,this.scale.y||1,1]),a=a?SceneJS_math_mulMat4(a,b):b),0!=this.rotate&&(b=SceneJS_math_rotationMat4v(.0174532925*this.rotate,[0,0,1]),a=a?SceneJS_math_mulMat4(a,b):b),a&&(this.matrix=a,this.matrixAsArray?this.matrixAsArray.set(this.matrix):this.matrixAsArray=new Float32Array(this.matrix)),this._matrixDirty=!1}var b={type:"decal",stateId:SceneJS._baseStateId++,empty:!0,hash:""};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(a){a.engine.display.decal=b,d=0});var c=[],d=0;SceneJS.Decal=SceneJS_NodeFactory.createNodeType("decal"),SceneJS.Decal.prototype._init=function(b){var c=this;if(1==this._core.useCount){if(b.applyFrom&&"uv"!=b.applyFrom&&"uv2"!=b.applyFrom)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"decal applyFrom value is unsupported - should be either 'uv' or 'uv2'");if(b.applyTo&&"baseColor"!=b.applyTo&&"color"!=b.applyTo&&"specular"!=b.applyTo&&"emit"!=b.applyTo&&"alpha"!=b.applyTo&&"normals"!=b.applyTo&&"shine"!=b.applyTo)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"decal applyTo value is unsupported - should be either 'color', 'baseColor', 'specular' or 'normals'");if(b.blendMode&&"add"!=b.blendMode&&"multiply"!=b.blendMode)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"decal layer blendMode value is unsupported - should be either 'add' or 'multiply'");"color"==b.applyTo&&(b.applyTo="baseColor"),SceneJS._apply({texture:null,applyFrom:b.applyFrom?b.applyFrom:"uv",applyTo:b.applyTo?b.applyTo:"baseColor",blendMode:b.blendMode?b.blendMode:"multiply",blendFactor:void 0!=b.blendFactor&&null!=b.blendFactor?b.blendFactor:1,translate:b.translate?SceneJS._apply(b.translate,{x:0,y:0}):{x:0,y:0},scale:b.scale?SceneJS._apply(b.scale,{x:1,y:1}):{x:1,y:1},rotate:b.rotate||0,matrix:null,_matrixDirty:!0,buildMatrix:a},this._core),a.call(this._core),this._setTextureImage(b.image),this._core.webglRestored=function(){c._setTextureImage(c._core.image)}}},SceneJS.Decal.prototype._setTextureImage=function(a){var b=this._engine.canvas.gl,c=this._core.texture?this._core.texture.texture:b.createTexture();b.bindTexture(b.TEXTURE_2D,c),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,SceneJS._webgl.ensureImageSizePowerOfTwo(a)),this._core.texture=new SceneJS._webgl.Texture2D(b,{
texture:c,minFilter:this._getGLOption("minFilter",b.LINEAR_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",b.LINEAR),wrapS:this._getGLOption("wrapS",b.REPEAT),wrapT:this._getGLOption("wrapT",b.REPEAT),isDepth:this._getOption(this._core.isDepth,!1),depthMode:this._getGLOption("depthMode",b.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",b.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",b.LEQUAL),flipY:this._getOption(this._core.flipY,!0),width:this._getOption(this._core.width,1),height:this._getOption(this._core.height,1),internalFormat:this._getGLOption("internalFormat",b.ALPHA),sourceFormat:this._getGLOption("sourceFormat",b.ALPHA),sourceType:this._getGLOption("sourceType",b.UNSIGNED_BYTE),update:null}),this._core.image=a,this._engine.display.imageDirty=!0},SceneJS.Decal.prototype._getGLOption=function(a,b){var c=this._engine.canvas.gl,d=this._core[a];if(void 0==d)return b;var e=SceneJS._webgl.enumMap[d];if(void 0==e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+a+"' value: '"+d+"'");return c[e]},SceneJS.Decal.prototype._getOption=function(a,b){return void 0==a?b:a},SceneJS.Decal.prototype.setImage=function(a){this._core.image=a,this._core.src=null,this._core.target=null,this._setTextureImage(a)},SceneJS.Decal.prototype.setBlendFactor=function(a){this._core.blendFactor=a,this._engine.display.imageDirty=!0},SceneJS.Decal.prototype.getBlendFactor=function(){return this._core.blendFactor},SceneJS.Decal.prototype.setTranslate=function(a){this._core.translate||(this._core.translate={x:0,y:0}),this._core.translate.x=a.x,this._core.translate.y=a.y,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.Decal.prototype.getTranslate=function(){return this._core.translate},SceneJS.Decal.prototype.setScale=function(a){this._core.scale||(this._core.scale={x:0,y:0}),this._core.scale.x=a.x,this._core.scale.y=a.y,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.Decal.prototype.getScale=function(){return this._core.scale},SceneJS.Decal.prototype.setRotate=function(a){this._core.rotate=a,this._core._matrixDirty=!0,this._engine.display.imageDirty=!0},SceneJS.Decal.prototype.getRotate=function(){return this._core.rotate},SceneJS.Decal.prototype.getMatrix=function(){return this._core._matrixDirty&&this._core.buildMatrix.call(this.core)(),this.core.matrix},SceneJS.Decal.prototype._compile=function(a){this._makeHash(),c[d++]=this._core,this._engine.display.decal=this._core,this._compileNodes(a),this._engine.display.decal=--d>0?c[d-1]:b},SceneJS.Decal.prototype._makeHash=function(){var a,b=[];b.push("/"),b.push(this._core.applyFrom),b.push("/"),b.push(this._core.applyTo),b.push("/"),b.push(this._core.blendMode),this._core.matrix&&b.push("/anim"),a=b.join(""),this._core.hash!=a&&(this._core.hash=a)},SceneJS.Decal.prototype._destroy=function(){1==this._core.useCount&&this._core.texture&&!this._core.target&&(this._core.texture.destroy(),this._core.texture=null),this._core&&this._engine._coreFactory.putCore(this._core)}},new function(){var a={type:"fresnel",stateId:SceneJS._baseStateId++,centerBias:1,edgeBias:0,power:1,centerColor:[1,1,1],edgeColor:[0,0,0],empty:!0,hash:""};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.fresnel=a,c=0});var b=[],c=0;SceneJS.Fresnel=SceneJS_NodeFactory.createNodeType("fresnel"),SceneJS.Fresnel.prototype._init=function(a){if(1==this._core.useCount){if(a.applyTo&&"color"!=a.applyTo&&"specular"!=a.applyTo&&"alpha"!=a.applyTo&&"reflect"!=a.applyTo&&"emit"!=a.applyTo&&"fragment"!=a.applyTo)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"fresnel applyTo value is unsupported - should be either 'color', 'specular', 'alpha', 'reflect', 'emit' or 'fragment'");this._core.applyTo=a.applyTo,this.setCenterBias(a.centerBias),this.setEdgeBias(a.edgeBias),this.setPower(a.power),this.setCenterColor(a.centerColor),this.setEdgeColor(a.edgeColor)}},SceneJS.Fresnel.prototype.getApplyTo=function(){return this._core.applyTo},SceneJS.Fresnel.prototype.setCenterBias=function(b){this._core.centerBias=void 0!==b&&null!==b?b:a.centerBias,this._engine.display.imageDirty=!0},SceneJS.Fresnel.prototype.getCenterBias=function(){return this._core.centerBias},SceneJS.Fresnel.prototype.setEdgeBias=function(b){this._core.edgeBias=void 0!==b&&null!==b?b:a.edgeBias,this._engine.display.imageDirty=!0},SceneJS.Fresnel.prototype.getEdgeBias=function(){return this._core.edgeBias},SceneJS.Fresnel.prototype.setPower=function(b){this._core.power=void 0!==b&&null!==b?b:a.power,this._engine.display.imageDirty=!0},SceneJS.Fresnel.prototype.getPower=function(){return this._core.power},SceneJS.Fresnel.prototype.setCenterColor=function(b){var c=a.centerColor;return this._core.centerColor=b?[void 0!=b.r&&null!=b.r?b.r:c[0],void 0!=b.g&&null!=b.g?b.g:c[1],void 0!=b.b&&null!=b.b?b.b:c[2]]:a.centerColor,this._engine.display.imageDirty=!0,this},SceneJS.Fresnel.prototype.getCenterColor=function(){return{r:this._core.centerColor[0],g:this._core.centerColor[1],b:this._core.centerColor[2]}},SceneJS.Fresnel.prototype.setEdgeColor=function(b){var c=a.edgeColor;return this._core.edgeColor=b?[void 0!=b.r&&null!=b.r?b.r:c[0],void 0!=b.g&&null!=b.g?b.g:c[1],void 0!=b.b&&null!=b.b?b.b:c[2]]:a.edgeColor,this._engine.display.imageDirty=!0,this},SceneJS.Fresnel.prototype.getEdgeColor=function(){return{r:this._core.edgeColor[0],g:this._core.edgeColor[1],b:this._core.edgeColor[2]}},SceneJS.Fresnel.prototype._compile=function(d){this.__core||(this.__core=this._engine._coreFactory.getCore("fresnel"));var e=this._engine.display.fresnel;this._core.empty||(this.__core.diffuse="color"==this._core.applyTo?this._core:e.diffuse,this.__core.specular="specular"==this._core.applyTo?this._core:e.specular,this.__core.alpha="alpha"==this._core.applyTo?this._core:e.alpha,this.__core.reflect="reflect"==this._core.applyTo?this._core:e.reflect,this.__core.emit="emit"==this._core.applyTo?this._core:e.emit,this.__core.fragment="fragment"==this._core.applyTo?this._core:e.fragment),this._makeHash(this.__core),b[c++]=this.__core,this._engine.display.fresnel=this.__core,this._compileNodes(d),this._engine.display.fresnel=--c>0?b[c-1]:a,b[c]=null},SceneJS.Fresnel.prototype._makeHash=function(a){var b=[];a.diffuse&&b.push("d;"),a.specular&&b.push("s;"),a.alpha&&b.push("a;"),a.reflect&&b.push("r;"),a.emit&&b.push("e;"),a.fragment&&b.push("f;"),b=b.join(""),a.hash!=b&&(a.hash=b)},SceneJS.Fresnel.prototype._destroy=function(){this._core&&this._engine._coreFactory.putCore(this._core)}},function(){var a={type:"cubemap",stateId:SceneJS._baseStateId++,empty:!0,texture:null,hash:""},b=[],c=0;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(b){b.engine.display.cubemap=a,c=0}),SceneJS.Reflect=SceneJS_NodeFactory.createNodeType("reflect"),SceneJS.Reflect.prototype._init=function(a){if(1==this._core.useCount){if(this._core.hash="y",a.blendMode&&"add"!=a.blendMode&&"multiply"!=a.blendMode)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"reflection blendMode value is unsupported - should be either 'add' or 'multiply'");this._core.blendMode=a.blendMode||"multiply",this._core.intensity=void 0!=a.intensity&&null!=a.intensity?a.intensity:1,this._core.applyTo="reflect";for(var b=this,c=this._engine.canvas.gl,d=c.createTexture(),e=[c.TEXTURE_CUBE_MAP_POSITIVE_X,c.TEXTURE_CUBE_MAP_NEGATIVE_X,c.TEXTURE_CUBE_MAP_POSITIVE_Y,c.TEXTURE_CUBE_MAP_NEGATIVE_Y,c.TEXTURE_CUBE_MAP_POSITIVE_Z,c.TEXTURE_CUBE_MAP_NEGATIVE_Z],f=[],g=SceneJS_sceneStatusModule.taskStarted(this,"Loading reflection texture"),h=!1,i=0;i<e.length;i++){var j=new Image;j.onload=function(){var a=j;return function(){if(!h&&(f.push(a),f.length==e.length)){c.bindTexture(c.TEXTURE_CUBE_MAP,d),c.pixelStorei(c.UNPACK_FLIP_Y_WEBGL,!1);for(var i=0,j=f.length;j>i;i++)c.texImage2D(e[i],0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,SceneJS._webgl.ensureImageSizePowerOfTwo(f[i]));b._core.texture=new SceneJS._webgl.Texture2D(c,{texture:d,target:c.TEXTURE_CUBE_MAP,minFilter:c.LINEAR,magFilter:c.LINEAR,wrapS:c.CLAMP_TO_EDGE,wrapT:c.CLAMP_TO_EDGE}),SceneJS_sceneStatusModule.taskFinished(g),b._engine.display.imageDirty=!0}}}(),j.onerror=function(){h=!0,SceneJS_sceneStatusModule.taskFailed(g)},j.src=a.src[i]}}},SceneJS.Reflect.prototype._compile=function(d){this.__core||(this.__core=this._engine._coreFactory.getCore("cubemap"));var e=this._engine.display.cubemap;this._core.empty||(this.__core.layers=e&&e.layers?e.layers.concat([this._core]):[this._core]),this._makeHash(this.__core),b[c++]=this.__core,this._engine.display.cubemap=this.__core,this._compileNodes(d),this._engine.display.cubemap=--c>0?b[c-1]:a,b[c]=null},SceneJS.Reflect.prototype._makeHash=function(a){var b;if(a.layers&&a.layers.length>0){for(var c,d=a.layers,e=[],f=0,g=d.length;g>f;f++)c=d[f],e.push("/"),e.push(c.applyTo),e.push("/"),e.push(c.blendMode);b=e.join("")}else b="";a.hash!=b&&(a.hash=b)},SceneJS.Reflect.prototype._destroy=function(){1==this._core.useCount&&this._core.texture&&(this._core.texture.destroy(),this._core.texture=null),this._core&&this._engine._coreFactory.putCore(this._core)}}(),new function(){var a={type:"regionMap",stateId:SceneJS._baseStateId++,empty:!0,texture:null,regionColor:[-1,-1,-1],highlightFactor:[1.5,1.5,0],hideAlpha:0,regionData:[],mode:"info",hash:""};SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(c){c.engine.display.regionMap=a,b=0});var b=0,c={info:!0,highlight:!0,hide:!0,isolate:!0};SceneJS.RegionMap=SceneJS_NodeFactory.createNodeType("regionMap"),SceneJS.RegionMap.prototype._init=function(a){var b=this;1==this._core.useCount&&(SceneJS._apply({regionMap:null},this._core),a.src?(this._initTexture(),this._core.src=a.src,this._loadTexture(a.src)):a.image?(this._initTexture(a.preloadColor),this._core.image=a.image,this._setTextureImage(a.image)):a.target&&this.getScene().getNode(a.target,function(a){b.setTarget(a)}),this._core.webglRestored=function(){b._core.image?(b._initTexture(),b._setTextureImage(b._core.image)):b._core.src?(b._initTexture(),b._loadTexture(b._core.src)):b._core.target},this.setRegionColor(a.regionColor),this.setHighlightFactor(a.highlightFactor),this.setHideAlpha(a.hideAlpha),this.setRegionData(a.regionData),this.setMode(a.mode))},SceneJS.RegionMap.prototype._initTexture=function(){var a=this._engine.canvas.gl,b={r:.57735,g:.57735,b:.57735};b.a=void 0===b.a?1:b.a,b=new Uint8Array([Math.floor(255*b.r),Math.floor(255*b.g),Math.floor(255*b.b),Math.floor(255*b.a)]);var c=a.createTexture();a.bindTexture(a.TEXTURE_2D,c),a.texImage2D(a.TEXTURE_2D,0,a.RGBA,1,1,0,a.RGBA,a.UNSIGNED_BYTE,b),this._setCoreTexture(c)},SceneJS.RegionMap.prototype._loadTexture=function(a){var b=this,c=SceneJS_sceneStatusModule.taskStarted(this,"Loading texture"),d=new Image,e=!1,f=!1;d.onload=function(){b._setTextureImage(d),f||SceneJS_sceneStatusModule.taskFinished(c),e=!0,b._engine.display.imageDirty=!0},d.onerror=function(){SceneJS_sceneStatusModule.taskFailed(c)},this._fetchImage(d,a)},SceneJS.RegionMap.prototype._fetchImage=function(a,b){0==b.indexOf("data")?a.src=b:(a.crossOrigin="Anonymous",a.src=b)},SceneJS.RegionMap.prototype._setTextureImage=function(a){var b=this._engine.canvas.gl,c=this._core.texture?this._core.texture.texture:b.createTexture();b.bindTexture(b.TEXTURE_2D,c),b.texImage2D(b.TEXTURE_2D,0,b.RGBA,b.RGBA,b.UNSIGNED_BYTE,SceneJS._webgl.ensureImageSizePowerOfTwo(a)),this._core.image=a,this._setCoreTexture(c)},SceneJS.RegionMap.prototype._setCoreTexture=function(a){var b=this._engine.canvas.gl;this._core.texture=new SceneJS._webgl.Texture2D(b,{texture:a,minFilter:this._getGLOption("minFilter",b.NEAREST_MIPMAP_NEAREST),magFilter:this._getGLOption("magFilter",b.NEAREST),wrapS:this._getGLOption("wrapS",b.REPEAT),wrapT:this._getGLOption("wrapT",b.REPEAT),isDepth:this._getOption(this._core.isDepth,!1),depthMode:this._getGLOption("depthMode",b.LUMINANCE),depthCompareMode:this._getGLOption("depthCompareMode",b.COMPARE_R_TO_TEXTURE),depthCompareFunc:this._getGLOption("depthCompareFunc",b.LEQUAL),flipY:this._getOption(this._core.flipY,!0),width:this._getOption(this._core.width,1),height:this._getOption(this._core.height,1),internalFormat:this._getGLOption("internalFormat",b.ALPHA),sourceFormat:this._getGLOption("sourceFormat",b.ALPHA),sourceType:this._getGLOption("sourceType",b.UNSIGNED_BYTE),update:null}),this.destroyed&&this._core.texture.destroy(),this._engine.display.imageDirty=!0},SceneJS.RegionMap.prototype._getGLOption=function(a,b){var c=this._engine.canvas.gl,d=this._core[a];if(void 0==d)return b;var e=SceneJS._webgl.enumMap[d];if(void 0==e)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"Unrecognised value for texture node property '"+a+"' value: '"+d+"'");return c[e]},SceneJS.RegionMap.prototype._getOption=function(a,b){return void 0==a?b:a},SceneJS.RegionMap.prototype.setSrc=function(a){this._core.image=null,this._core.src=a,this._core.target=null,this._loadTexture(a)},SceneJS.RegionMap.prototype.setImage=function(a){this._core.image=a,this._core.src=null,this._core.target=null,this._setTextureImage(a)},SceneJS.RegionMap.prototype.setTarget=function(a){return"colorTarget"!=a.type&&"depthTarget"!=a.type?void console.log("Target node type not compatible: "+a.type):(delete this._core.src,this._core.target=a,this._core.src=null,this._core.image=null,this._core.texture=a._core.renderBuf.getTexture(),this._core.texture.bufType=a._core.bufType,void(this._engine.display.imageDirty=!0))},SceneJS.RegionMap.prototype.setRegionColor=function(b){var c=a.regionColor;return this._core.regionColor=b?[void 0!=b.r&&null!=b.r?b.r:c[0],void 0!=b.g&&null!=b.g?b.g:c[1],void 0!=b.b&&null!=b.b?b.b:c[2]]:a.regionColor,this._engine.display.imageDirty=!0,this},SceneJS.RegionMap.prototype.setHighlightFactor=function(b){var c=a.highlightFactor;return this._core.highlightFactor=b?[void 0!=b.r&&null!=b.r?b.r:c[0],void 0!=b.g&&null!=b.g?b.g:c[1],void 0!=b.b&&null!=b.b?b.b:c[2]]:a.highlightFactor,this._engine.display.imageDirty=!0,this},SceneJS.RegionMap.prototype.setHideAlpha=function(b){return this._core.hideAlpha=void 0!=b?b:a.hideAlpha,this._engine.display.imageDirty=!0,this},SceneJS.RegionMap.prototype.setMode=function(b){return this._core.mode=b&&c[b]?b:a.mode,this._engine.branchDirty(this),this._engine.display.imageDirty=!0,this._core.hash="reg-"+b,this},SceneJS.RegionMap.prototype.setRegionData=function(b){return this._core.regionData=b?b:a.regionData,this},SceneJS.RegionMap.prototype._compile=function(a){var b=this._engine.display.regionMap;this._engine.display.regionMap=this._core,this._compileNodes(a),this._engine.display.regionMap=b},SceneJS.RegionMap.prototype._destroy=function(){1==this._core.useCount&&this._core.texture&&!this._core.target&&(this._core.texture.destroy(),this._core.texture=null)}},SceneJS.XForm=SceneJS_NodeFactory.createNodeType("xform"),SceneJS.XForm.prototype._init=function(a){1==this._core.useCount&&(SceneJS_modelXFormStack.buildCore(this._core),this.setElements(a.elements))},SceneJS.XForm.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.XForm.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.XForm.prototype.setElements=function(a){if(a=a||SceneJS_math_identityMat4(),16!=a.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.XForm elements should number 16");var b=this._core;if(b.matrix)for(var c=0;16>c;c++)b.matrix[c]=a[c];else b.matrix=a;return b.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.XForm.prototype._compile=function(a){SceneJS_modelXFormStack.push(this._core),this._compileNodes(a),SceneJS_modelXFormStack.pop()},SceneJS.Matrix=SceneJS_NodeFactory.createNodeType("matrix"),SceneJS.Matrix.prototype._init=function(a){1==this._core.useCount&&(SceneJS_modelXFormStack.buildCore(this._core),this.setElements(a.elements))},SceneJS.Matrix.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Matrix.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Matrix.prototype.setMatrix=function(a){if(a=a||SceneJS_math_identityMat4(),16!=a.length)throw SceneJS_error.fatalError(SceneJS.errors.ILLEGAL_NODE_CONFIG,"SceneJS.Matrix elements should number 16");var b=this._core;if(b.matrix)for(var c=0;16>c;c++)b.matrix[c]=a[c];else b.matrix=a;return b.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Matrix.prototype.setElements=SceneJS.Matrix.prototype.setMatrix,SceneJS.Matrix.prototype._compile=function(a){SceneJS_modelXFormStack.push(this._core),this._compileNodes(a),SceneJS_modelXFormStack.pop()},SceneJS.Rotate=SceneJS_NodeFactory.createNodeType("rotate"),SceneJS.Rotate.prototype._init=function(a){if(1==this._core.useCount){SceneJS_modelXFormStack.buildCore(this._core),this.setMultOrder(a.multOrder),this.setAngle(a.angle),this.setXYZ({x:a.x,y:a.y,z:a.z});var b=this._core;this._core.buildMatrix=function(){b.matrix=SceneJS_math_rotationMat4v(b.angle*Math.PI/180,[b.x,b.y,b.z])}}},SceneJS.Rotate.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Rotate.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Rotate.prototype.setMultOrder=function(a){if(a=a||"post","post"!=a&&"pre"!=a)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for rotate node - '"+a+"' should be 'pre' or 'post'");this._core.multOrder=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.setAngle=function(a){this._core.angle=a||0,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getAngle=function(){return this._core.angle},SceneJS.Rotate.prototype.setXYZ=function(a){a=a||{},this._core.x=a.x||0,this._core.y=a.y||0,this._core.z=a.z||0,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}},SceneJS.Rotate.prototype.setX=function(a){this._core.x=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getX=function(){return this._core.x},SceneJS.Rotate.prototype.setY=function(a){this._core.y=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getY=function(){return this._core.y},SceneJS.Rotate.prototype.setZ=function(a){this._core.z=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype.getZ=function(){return this._core.z},SceneJS.Rotate.prototype.incAngle=function(a){this._core.angle+=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Rotate.prototype._compile=function(a){SceneJS_modelXFormStack.push(this._core),this._compileNodes(a),SceneJS_modelXFormStack.pop()},SceneJS.Translate=SceneJS_NodeFactory.createNodeType("translate"),SceneJS.Translate.prototype._init=function(a){if(1==this._core.useCount){SceneJS_modelXFormStack.buildCore(this._core),this.setMultOrder(a.multOrder),this.setXYZ({x:a.x,y:a.y,z:a.z});var b=this._core;this._core.buildMatrix=function(){b.matrix=SceneJS_math_translationMat4v([b.x,b.y,b.z],b.matrix)}}},SceneJS.Translate.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Translate.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Translate.prototype.setMultOrder=function(a){if(a=a||"post","post"!=a&&"pre"!=a)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for translate node - '"+a+"' should be 'pre' or 'post'");this._core.multOrder=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Translate.prototype.setXYZ=function(a){return a=a||{},this._core.x=a.x||0,this._core.y=a.y||0,this._core.z=a.z||0,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}},SceneJS.Translate.prototype.setX=function(a){return this._core.x=a,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.setY=function(a){return this._core.y=a,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.setZ=function(a){return this._core.z=a,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.incX=function(a){return this._core.x+=a,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.incY=function(a){return this._core.y+=a,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.incZ=function(a){return this._core.z+=a,this._core.setDirty(),this._engine.display.imageDirty=!0,this},SceneJS.Translate.prototype.getX=function(){return this._core.x},SceneJS.Translate.prototype.getY=function(){return this._core.y},SceneJS.Translate.prototype.getZ=function(){return this._core.z},SceneJS.Translate.prototype._compile=function(a){SceneJS_modelXFormStack.push(this._core),this._compileNodes(a),SceneJS_modelXFormStack.pop()},SceneJS.Scale=SceneJS_NodeFactory.createNodeType("scale"),SceneJS.Scale.prototype._init=function(a){if(1==this._core.useCount){SceneJS_modelXFormStack.buildCore(this._core),this.setMultOrder(a.multOrder),this.setXYZ({x:a.x,y:a.y,z:a.z});var b=this._core;this._core.buildMatrix=function(){b.matrix=SceneJS_math_scalingMat4v([b.x,b.y,b.z])}}},SceneJS.Scale.prototype.getModelMatrix=function(){return this._core.dirty&&this._core.build(),this._core.matrix},SceneJS.Scale.prototype.getWorldMatrix=function(){return this._core.dirty&&this._core.build(),Array.apply([],this._core.mat)},SceneJS.Scale.prototype.setMultOrder=function(a){if(a=a||"post","post"!=a&&"pre"!=a)throw SceneJS_error.fatalError(SceneJS.errors.NODE_CONFIG_EXPECTED,"Illegal multOrder for scale node - '"+a+"' should be 'pre' or 'post'");this._core.multOrder=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.setXYZ=function(a){a=a||{},this._core.x=void 0==a.x?1:a.x,this._core.y=void 0==a.y?1:a.y,this._core.z=void 0==a.z?1:a.z,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.getXYZ=function(){return{x:this._core.x,y:this._core.y,z:this._core.z}},SceneJS.Scale.prototype.setX=function(a){this._core.x=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.setY=function(a){this._core.y=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.setZ=function(a){this._core.z=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.getX=function(){return this._core.x},SceneJS.Scale.prototype.getY=function(){return this._core.y},SceneJS.Scale.prototype.getZ=function(){return this._core.z},SceneJS.Scale.prototype.incX=function(a){this._core.x+=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype.incY=function(a){this._core.y+=a,this._core.matrixDirty=!0},SceneJS.Scale.prototype.incZ=function(a){this._core.z+=a,this._core.setDirty(),this._engine.display.imageDirty=!0},SceneJS.Scale.prototype._compile=function(a){SceneJS_modelXFormStack.push(this._core),this._compileNodes(a),SceneJS_modelXFormStack.pop()};var SceneJS_modelXFormStack=new function(){var a=SceneJS_math_identityMat4(),b=new Float32Array(a),c=SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(SceneJS_math_identityMat4(),SceneJS_math_mat4())),d=new Float32Array(c),e={type:"xform",stateId:SceneJS._baseStateId++,matrix:a,mat:b,normalMatrix:c,normalMat:d,parent:null,cores:[],numCores:0,dirty:!1,matrixDirty:!1},f=[],g=0;this.top=e;var h,i=this;SceneJS_events.addListener(SceneJS_events.SCENE_COMPILING,function(){g=0,i.top=e,h=!0}),SceneJS_events.addListener(SceneJS_events.OBJECT_COMPILING,function(a){h&&(a.display.modelTransform=g>0?f[g-1]:e,h=!1)}),this.buildCore=function(a){function b(a){a.dirty=!0,a.matrixDirty=!0;for(var c=0,d=a.numCores;d>c;c++)b(a.cores[c])}a.parent=null,a.cores=[],a.numCores=0,a.matrixDirty=!1,a.matrix=SceneJS_math_identityMat4(),a.mat=new Float32Array(a.matrix),a.normalMat=new Float32Array(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(a.matrix,SceneJS_math_mat4()))),a.dirty=!1,a.setDirty=function(){a.matrixDirty=!0,a.dirty,b(a)},a.build=function(){a.matrixDirty&&(a.buildMatrix&&a.buildMatrix(),a.matrixDirty=!1);var b,c=a.parent;if(c)for(b=a.matrix.slice(0);c;)c.matrixDirty&&(c.buildMatrix&&c.buildMatrix(),c.mat.set(c.matrix),c.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(c.matrix,SceneJS_math_mat4()))),c.matrixDirty=!1),SceneJS_math_mulMat4(c.matrix,b,b),!c.dirty,c=c.parent;else b=a.matrix;a.mat.set(b),a.normalMat.set(SceneJS_math_transposeMat4(SceneJS_math_inverseMat4(b,SceneJS_math_mat4()))),a.dirty=!1}},this.push=function(a){f[g++]=a,a.parent=this.top,a.dirty=!0,this.top&&(this.top.cores[this.top.numCores++]=a),a.numCores=0,this.top=a,h=!0},this.pop=function(){this.top=--g>0?f[g-1]:e,f[g]=null,h=!0}};SceneJS.Types=new function(){this.addType=function(a,b){SceneJS_NodeFactory.createNodeType(a,b,function(a){var c;for(var d in b)if(b.hasOwnProperty(d))switch(c=b[d],d){case"init":case"construct":!function(){var c=b[d];a.prototype._init=function(a){c.call(this,a)},a.prototype._fromPlugin=!0}();break;case"destroy":case"destruct":a.prototype._destroy=c;break;default:a.prototype[d]=c}})},this.hasType=function(a){return!!SceneJS_NodeFactory.nodeTypes[a]}};var SceneJS_Display=function(a){this._canvas=a.canvas,this._programFactory=new SceneJS_ProgramFactory({canvas:a.canvas}),this._chunkFactory=new SceneJS_ChunkFactory,this.transparent=a.transparent===!0,this.enable=null,this.flags=null,this.layer=null,this.stage=null,this.renderer=null,this.depthBuffer=null,this.colorBuffer=null,this.view=null,this.lights=null,this.material=null,this.texture=null,this.decal=null,this.fresnel=null,this.cubemap=null,this.modelTransform=null,this.viewTransform=null,this.projTransform=null,this.regionMap=null,this.renderTarget=null,this.clips=null,this.morphGeometry=null,this.name=null,this.tag=null,this.renderListeners=null,this.shader=null,this.shaderParams=null,this.style=null,this.geometry=null,this._objectFactory=new SceneJS_ObjectFactory,this._objects={},this._ambientColor=[0,0,0,1],this._objectList=[],this._objectListLen=0,this._objectPickList=[null],this._objectPickListLen=1,this._drawList=[],this._drawListLen=0,this._pickDrawList=[],this._pickDrawListLen=0,this._targetList=[],this._targetListLen=0,this._objectDrawList=[],this._objectDrawListLen=0,this._drawListTransparentIndex=-1,this._frameCtx={pickNames:[],regionData:[],canvas:this._canvas,VAO:null},this._frameCtx.renderListenerCtx=new SceneJS.RenderContext(this._frameCtx),this.objectListDirty=!0,this.stateOrderDirty=!0,this.stateSortDirty=!0,this.drawListDirty=!0,this.imageDirty=!0};SceneJS_Display.prototype.webglRestored=function(){this._programFactory.webglRestored(),this._chunkFactory.webglRestored();var a=this._canvas.gl;this.pickBuf&&this.pickBuf.webglRestored(a),this.imageDirty=!0},SceneJS_Display.prototype.buildObject=function(a){var b=this._objects[a];b||(b=this._objects[a]=this._objectFactory.getObject(a),this.objectListDirty=!0),b.modelTransform=this.modelTransform,b.viewTransform=this.viewTransform,b.projTransform=this.projTransform,b.stage=this.stage,b.layer=this.layer,b.renderTarget=this.renderTarget,b.texture=this.texture,b.decal=this.decal,b.cubemap=this.cubemap,b.geometry=this.geometry,b.morphGeometry=this.morphGeometry,b.enable=this.enable,b.flags=this.flags,b.tag=this.tag,b.name=this.name;var c=[this.geometry.hash,this.shader.hash,this.clips.hash,this.morphGeometry.hash,this.texture.hash,this.decal.hash,this.fresnel.hash,this.cubemap.hash,this.lights.hash,this.flags.hash,this.regionMap.hash].join(";");b.program&&c==b.hash||(b.program&&this._programFactory.putProgram(b.program),b.program=this._programFactory.getProgram(c,this),b.hash=c),this._setChunk(b,0,"program"),this._setChunk(b,1,"xform",this.modelTransform),this._setChunk(b,2,"lookAt",this.viewTransform),this._setChunk(b,3,"camera",this.projTransform),this._setChunk(b,4,"flags",this.flags),this._setChunk(b,5,"shader",this.shader),this._setChunk(b,6,"shaderParams",this.shaderParams),this._setChunk(b,7,"style",this.style),this._setChunk(b,8,"depthBuffer",this.depthBuffer),this._setChunk(b,9,"colorBuffer",this.colorBuffer),this._setChunk(b,10,"view",this.view),this._setChunk(b,11,"lights",this.lights),this._setChunk(b,12,"material",this.material),this._setChunk(b,13,"texture",this.texture),this._setChunk(b,14,"decal",this.decal),this._setChunk(b,15,"regionMap",this.regionMap),this._setChunk(b,16,"fresnel",this.fresnel),this._setChunk(b,17,"cubemap",this.cubemap),this._setChunk(b,18,"clips",this.clips),this._setChunk(b,19,"renderer",this.renderer),this._setChunk(b,20,"geometry",this.morphGeometry,this.geometry),this._setChunk(b,21,"listeners",this.renderListeners),this._setChunk(b,22,"draw",this.geometry),this.stateOrderDirty=!0},SceneJS_Display.prototype._setChunk=function(a,b,c,d,e){var f,g=this._chunkFactory.chunkTypes[c];if(d){if(d.empty){var h=a.chunks[b];return h&&this._chunkFactory.putChunk(h),void(a.chunks[b]=null)}f=g.prototype.programGlobal?"_"+d.stateId:"p"+a.program.id+"_"+d.stateId,e&&(f+="__"+e.stateId)}else f="p"+a.program.id;f=b+"__"+f;var h=a.chunks[b];if(h){if(h.id==f)return;this._chunkFactory.putChunk(h)}a.chunks[b]=this._chunkFactory.getChunk(f,c,a.program,d,e),"lights"==c&&this._setAmbient(d)},SceneJS_Display.prototype._setAmbient=function(a){for(var b,c=a.lights,d=0,e=c.length;e>d;d++)b=c[d],"ambient"==b.mode&&(this._ambientColor[0]=b.color[0],this._ambientColor[1]=b.color[1],this._ambientColor[2]=b.color[2])},SceneJS_Display.prototype.removeObject=function(a){var b=this._objects[a];if(b){this._programFactory.putProgram(b.program),b.program=null,b.hash=null;for(var c,d=0,e=b.chunks.length;e>d;d++)c=b.chunks[d],c&&this._chunkFactory.putChunk(c);this._objectFactory.putObject(b),delete this._objects[a],this.objectListDirty=!0}},SceneJS_Display.prototype.selectTags=function(a){this._tagSelector=a,this.drawListDirty=!0},SceneJS_Display.prototype.render=function(a){a=a||{},this.objectListDirty&&(this._buildObjectList(),this.objectListDirty=!1,this.stateOrderDirty=!0),this.stateOrderDirty&&(this._makeStateSortKeys(),this.stateOrderDirty=!1,this.stateSortDirty=!0),this.stateSortDirty&&(this._stateSort(),this.stateSortDirty=!1,this.drawListDirty=!0),this.drawListDirty&&(this._buildDrawList(),this.imageDirty=!0),(this.imageDirty||a.force)&&(SceneJS_events.fireEvent(SceneJS_events.RENDER,{forced:!!a.force}),this._doDrawList({clear:a.clear!==!1,opaqueOnly:a.opaqueOnly}),this.imageDirty=!1,this.pickBufDirty=!0)},SceneJS_Display.prototype._buildObjectList=function(){var a=this._objectListLen;this._objectListLen=0;for(var b in this._objects)this._objects.hasOwnProperty(b)&&(this._objectList[this._objectListLen++]=this._objects[b]);if(a>this._objectListLen)for(i=this._objectListLen;i<a;i++)this._objectList[i]=null},SceneJS_Display.prototype._makeStateSortKeys=function(){for(var a,b=0,c=this._objectListLen;c>b;b++)a=this._objectList[b],a.sortKey=a.program?1e12*(a.stage.priority+1)+1e9*(a.flags.transparent?2:1)+1e6*(a.layer.priority+1)+1e3*(a.program.id+1)+a.texture.stateId:-1},SceneJS_Display.prototype._stateSort=function(){this._objectList.length=this._objectListLen,this._objectList.sort(this._stateSortObjects)},SceneJS_Display.prototype._stateSortObjects=function(a,b){return a.sortKey-b.sortKey},SceneJS_Display.prototype._logObjectList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._objectListLen+" objects");for(var a=0,b=this._objectListLen;b>a;a++){
var c=this._objectList[a];console.log("SceneJS_Display : object["+a+"] sortKey = "+c.sortKey)}console.log("--------------------------------------------------------------------------------------------------")},SceneJS_Display.prototype._buildDrawList=function(){this._lastStateId=this._lastStateId||[],this._lastPickStateId=this._lastPickStateId||[];var a;for(a=0;25>a;a++)this._lastStateId[a]=null,this._lastPickStateId[a]=null;var b=this._drawListLen,c=this._pickDrawListLen,d=this._objectDrawListLen,e=this._objectPickListLen;this._drawListLen=0,this._pickDrawListLen=0,this._objectDrawListLen=0,this._objectPickListLen=1,this._drawListTransparentIndex=-1;var f,g,h,i,j,k={},l=[],m=[];for(this._tagSelector&&(g=this._tagSelector.mask,h=this._tagSelector.regex),a=0,len=this._objectListLen;a<len;a++)if(f=this._objectList[a],f.enable.enabled!==!1&&(j=f.flags,j.enabled!==!1&&f.layer.enabled&&(!g||(i=f.tag,!i.tag||(i.mask!=g&&(i.mask=g,i.matches=h.test(i.tag)),i.matches)))))if(f.renderTarget.targets)for(var n,o,p,q=f.renderTarget.targets,r=0,s=q.length;s>r;r++)n=q[r],o=n.coreId,p=k[o],p||(p=[],k[o]=p,l.push(p),m.push(this._chunkFactory.getChunk(n.stateId,"renderTarget",f.program,n))),p.push(f);else this._objectDrawList[this._objectDrawListLen++]=f;var p,n,f,t;for(a=0,len=l.length;a<len;a++){p=l[a],n=m[a],this._appendRenderTargetChunk(n);for(var r=0,s=p.length;s>r;r++)f=p[r],t=f.stage&&f.stage.pickable&&f.flags&&f.flags.picking,this._appendObjectToDrawLists(f,t)}for(f&&this._appendRenderTargetChunk(this._chunkFactory.getChunk(-1,"renderTarget",f.program,{})),a=0,len=this._objectDrawListLen;a<len;a++)f=this._objectDrawList[a],t=(!f.stage||f.stage&&f.stage.pickable)&&f.flags&&f.flags.picking,this._appendObjectToDrawLists(f,t);if(b>this._drawListLen)for(a=this._drawListLen;b>a;a++)this._drawList[a]=null;if(c>this._pickDrawListLen)for(a=this._pickDrawListLen;c>a;a++)this._pickDrawList[a]=null;if(d>this._objectDrawListLen)for(a=this._objectDrawListLen;d>a;a++)this._objectDrawList[a]=null;if(e>this._objectPickListLen)for(a=this._objectPickListLen;e>a;a++)this._objectPickList[a]=null;this.drawListDirty=!1},SceneJS_Display.prototype._appendRenderTargetChunk=function(a){this._drawList[this._drawListLen++]=a},SceneJS_Display.prototype._appendObjectToDrawLists=function(a,b){for(var c,d=a.chunks,e=0,f=d.length;f>e;e++)c=d[e],c&&(c.draw&&(c.unique||this._lastStateId[e]!=c.id)&&(this._drawList[this._drawListLen]=c,this._lastStateId[e]=c.id,c.core&&c.core&&c.core.transparent&&this._drawListTransparentIndex<0&&(this._drawListTransparentIndex=this._drawListLen),this._drawListLen++),c.pick&&b!==!1&&(c.unique||this._lastPickStateId[e]!=c.id)&&(this._pickDrawList[this._pickDrawListLen++]=c,this._lastPickStateId[e]=c.id));b&&(this._objectPickList[this._objectPickListLen++]=a)},SceneJS_Display.prototype._logDrawList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._drawListLen+" draw list chunks");for(var a=0,b=this._drawListLen;b>a;a++){var c=this._drawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},SceneJS_Display.prototype._logPickList=function(){console.log("--------------------------------------------------------------------------------------------------"),console.log(this._pickDrawListLen+" pick list chunks");for(var a=0,b=this._pickDrawListLen;b>a;a++){var c=this._pickDrawList[a];switch(console.log("[chunk "+a+"] type = "+c.type),c.type){case"draw":console.log("\n");break;case"renderTarget":console.log(" bufType = "+c.core.bufType)}}console.log("--------------------------------------------------------------------------------------------------")},function(){function a(a,b,c,d,e){var f=b.modelTransform.matrix,g=b.viewTransform.matrix,h=b.projTransform.matrix,i=SceneJS_math_mulMat4(g,f,m),j=SceneJS_math_mulMat4(h,i,n),k=SceneJS_math_inverseMat4(j,n),l=a.width,q=a.height,r=(c[0]-l/2)/(l/2),s=-(c[1]-q/2)/(q/2),t=SceneJS_math_transformVector4(k,[r,s,-1,1],o);t=SceneJS_math_mulVec4Scalar(t,1/t[3]);var u=SceneJS_math_transformVector4(k,[r,s,1,1],p);u=SceneJS_math_mulVec4Scalar(u,1/u[3]),d[0]=t[0],d[1]=t[1],d[2]=t[2],SceneJS_math_subVec3(u,t,e),SceneJS_math_normalizeVec3(e)}{var b=SceneJS_math_vec3(),c=SceneJS_math_vec3(),d=SceneJS_math_vec3(),e=SceneJS_math_vec3(),f=SceneJS_math_vec3(),g=SceneJS_math_vec3(),h=SceneJS_math_vec3(),i=SceneJS_math_vec3(),j=SceneJS_math_vec3(),k=SceneJS_math_vec3(),l=SceneJS_math_vec3(),m=SceneJS_math_mat4(),n=SceneJS_math_mat4(),o=SceneJS_math_vec4(),p=SceneJS_math_vec4(),q=(SceneJS_math_vec4(),SceneJS_math_vec3()),r=SceneJS_math_vec3(),s=SceneJS_math_vec3(),t=SceneJS_math_vec3(),u=(SceneJS_math_vec3(),SceneJS_math_vec3()),v=SceneJS_math_vec3(),w=SceneJS_math_vec3(),x=SceneJS_math_vec3();SceneJS_math_vec3()}SceneJS_Display.prototype.pick=function(m){var n,y=this._canvas.canvas,z=this._canvas.resolutionScaling,A=m.canvasX*z,B=m.canvasY*z,C=[A,B],D=this.pickBuf,E=null;D||(D=this.pickBuf=new SceneJS._webgl.RenderBuffer({canvas:this._canvas})),this.render(),D.bind(),D.clear(),this._doDrawList({pickObject:!0,clear:!0}),this._canvas.gl.finish();var F=D.read(A,B),G=F[0]+256*F[1]+256*F[2]*256+256*F[3]*256*256;if(n=this._objectPickList[G]){E={canvasPos:C};var H=n.name;H&&(E.name=H.name,E.path=H.path,E.nodeId=H.nodeId)}if(m.pickRegion&&(D.clear(),this._doDrawList({pickRegion:!0,object:n,clear:!0}),F=D.read(A,B),0!==F[0]||0!==F[1]||0!==F[2]||0!==F[3])){E=E||{canvasPos:C};for(var I,J,K={r:F[0]/255,g:F[1]/255,b:F[2]/255,a:F[3]/255},L=this._frameCtx.regionData,M=.01,N={},O=0,P=L.length;P>O;O++)if(I=L[O].color,K&&L[O].data&&(J=Math.max(Math.abs(K.r-I.r),Math.abs(K.g-I.g),Math.abs(K.b-I.b),Math.abs(K.a-(void 0===I.a?K.a:I.a))),M>J)){N=L[O].data;break}E.color=K,E.regionData=N}if(m.pickTriangle&&n){D.clear(),this._doDrawList({pickTriangle:!0,object:n,clear:!0}),F=D.read(A,B);var Q=F[0]+256*F[1]+256*F[2]*256+256*F[3]*256*256;Q*=3,E.primitiveIndex=Q;var R=n.geometry;if("triangles"===R.primitiveName){E.primitive="triangle",a(y,n,C,b,c);var S=R.arrays.indices,T=S[Q],U=S[Q+1],V=S[Q+2],W=3*T,X=3*U,Y=3*V,Z=SceneJS_math_vec3();Z[0]=T,Z[1]=U,Z[2]=V,E.indices=Z;var $=n.morphGeometry,_=$.targets;if(_&&_.length>0&&_[0].positions)this._lerpTargets($.keys,$.targets,"positions",T,U,V,$.factor,d,e,f);else{var aa=R.arrays.positions;d[0]=aa[W],d[1]=aa[W+1],d[2]=aa[W+2],e[0]=aa[X],e[1]=aa[X+1],e[2]=aa[X+2],f[0]=aa[Y],f[1]=aa[Y+1],f[2]=aa[Y+2]}var ba=E.position=SceneJS_math_rayPlaneIntersect(b,c,d,e,f,SceneJS_math_vec3());o.set(ba),o[3]=1,SceneJS_math_transformVector4(n.modelTransform.matrix,o,p),E.worldPos=p.slice(0,3);var ca=E.barycentric=SceneJS_math_cartesianToBarycentric2(ba,d,e,f,SceneJS_math_vec3()),da=!1;if(_&&_.length>0&&_[0].normals&&(this._lerpTargets($.keys,$.targets,"normals",T,U,V,$.factor,g,h,i),da=!0),!da){var ea=R.arrays.normals;ea&&(g[0]=ea[W],g[1]=ea[W+1],g[2]=ea[W+2],h[0]=ea[X],h[1]=ea[X+1],h[2]=ea[X+2],i[0]=ea[Y],i[1]=ea[Y+1],i[2]=ea[Y+2],da=!0)}da&&(E.normal=SceneJS_math_addVec3(SceneJS_math_addVec3(SceneJS_math_mulVec3Scalar(g,ca[0],q),SceneJS_math_mulVec3Scalar(h,ca[1],r),s),SceneJS_math_mulVec3Scalar(i,ca[2],t),SceneJS_math_vec3()));var fa=R.arrays.uv;fa&&(j[0]=fa[2*T],j[1]=fa[2*T+1],k[0]=fa[2*U],k[1]=fa[2*U+1],l[0]=fa[2*V],l[1]=fa[2*V+1],E.uv=SceneJS_math_addVec3(SceneJS_math_addVec3(SceneJS_math_mulVec2Scalar(j,ca[0],u),SceneJS_math_mulVec2Scalar(k,ca[1],v),w),SceneJS_math_mulVec2Scalar(l,ca[2],x),SceneJS_math_vec3()))}}return D.unbind(),E},SceneJS_Display.prototype._lerpTargets=function(a,b,c,d,e,f,g,h,i,j){for(var k=0;k<a.length;k++)if(a[k]===g){var l=b[k][c],m=3*d,n=3*e,o=3*f;return h[0]=l[m],h[1]=l[m+1],h[2]=l[m+2],i[0]=l[n],i[1]=l[n+1],i[2]=l[n+2],j[0]=l[o],j[1]=l[o+1],void(j[2]=l[o+2])}for(var p=0;a[p]<g;)p++;var q=p-1;this._lerpTargetPair(g,a[q],a[p],b[q][c],b[p][c],d,e,f,h,i,j)};var y=SceneJS_math_vec3(),z=SceneJS_math_vec3(),A=SceneJS_math_vec3(),B=SceneJS_math_vec3(),C=SceneJS_math_vec3(),D=SceneJS_math_vec3();SceneJS_Display.prototype._lerpTargetPair=function(a,b,c,d,e,f,g,h,i,j,k){var l=3*f,m=3*g,n=3*h;y[0]=d[l],y[1]=d[l+1],y[2]=d[l+2],z[0]=d[m],z[1]=d[m+1],z[2]=d[m+2],A[0]=d[n],A[1]=d[n+1],A[2]=d[n+2],B[0]=e[l],B[1]=e[l+1],B[2]=e[l+2],C[0]=e[m],C[1]=e[m+1],C[2]=e[m+2],D[0]=e[n],D[1]=e[n+1],D[2]=e[n+2],SceneJS_math_lerpVec3(a,b,c,y,B,i),SceneJS_math_lerpVec3(a,b,c,z,C,j),SceneJS_math_lerpVec3(a,b,c,A,D,k)}}(),SceneJS_Display.prototype._doDrawList=function(a){var b=this._canvas.gl,c=this._frameCtx;c.renderTarget=null,c.targetIndex=0,c.renderBuf=null,c.viewMat=null,c.modelMat=null,c.cameraMat=null,c.renderer=null,c.depthbufEnabled=null,c.clearDepth=null,c.depthFunc=b.LESS,c.scissorTestEnabled=!1,c.blendEnabled=!1,c.backfaces=!0,c.frontface="ccw",c.picking=!!a.pickObject||!!a.pickTriangle||!!a.pickRegion,c.pickObject=!!a.pickObject,c.pickTriangle=!!a.pickTriangle,c.pickRegion=!!a.pickRegion,c.pickIndex=1,c.textureUnit=0,c.lineWidth=1,c.transparent=!1,c.ambientColor=this._ambientColor,c.aspect=this._canvas.canvas.width/this._canvas.canvas.height,SceneJS.WEBGL_INFO.SUPPORTED_EXTENSIONS.OES_element_index_uint&&b.getExtension("OES_element_index_uint");var d=b.getExtension("OES_vertex_array_object");if(c.VAO=d?d:null,b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),this.transparent||c.picking?b.clearColor(0,0,0,0):b.clearColor(this._ambientColor[0],this._ambientColor[1],this._ambientColor[2],1),a.clear&&b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),b.frontFace(b.CCW),b.disable(b.CULL_FACE),b.disable(b.BLEND),a.pickObject)for(var e=0,f=this._pickDrawListLen;f>e;e++)this._pickDrawList[e].pick(c);else if(a.pickRegion||a.pickTriangle){if(a.object)for(var g,h=a.object.chunks,e=0,f=h.length;f>e;e++)g=h[e],g&&g.pick&&g.pick(c);else if(a.pickRegion)for(var e=0,f=this._pickDrawListLen;f>e;e++)this._pickDrawList[e].pick(c)}else for(var f=a.opaqueOnly&&this._drawListTransparentIndex>=0?this._drawListTransparentIndex:this._drawListLen,e=0;f>e;e++)this._drawList[e].draw(c);if(b.flush(),c.renderBuf&&c.renderBuf.unbind(),c.VAO){c.VAO.bindVertexArrayOES(null);for(var e=0;10>e;e++)b.disableVertexAttribArray(e)}},SceneJS_Display.prototype.readPixels=function(a,b,c){this._readPixelBuf||(this._readPixelBuf=new SceneJS._webgl.RenderBuffer({canvas:this._canvas})),this._readPixelBuf.bind(),this._readPixelBuf.clear(),this.render({force:!0,opaqueOnly:c});for(var d,e,f=0;b>f;f++)d=a[f]||(a[f]={}),e=this._readPixelBuf.read(d.x,d.y),d.r=e[0],d.g=e[1],d.b=e[2],d.a=e[3];this._readPixelBuf.unbind()},SceneJS_Display.prototype._unpackDepth=function(a){var b=[a[0]/256,a[1]/256,a[2]/256,a[3]/256],c=[1/16777216,1/65536,1/256,1];return SceneJS_math_dotVector4(b,c)},SceneJS_Display.prototype.destroy=function(){this._programFactory.destroy()};var SceneJS_ProgramSourceFactory=new function(){function a(){return j(),k("attribute vec3 SCENEJS_aVertex;"),k("attribute vec4 SCENEJS_aColor;"),k("uniform mat4 SCENEJS_uMMatrix;"),k("uniform mat4 SCENEJS_uVMatrix;"),k("uniform mat4 SCENEJS_uVNMatrix;"),k("uniform mat4 SCENEJS_uPMatrix;"),k("varying vec4 SCENEJS_vWorldVertex;"),E&&(k("attribute vec2 SCENEJS_aRegionMapUV;"),k("varying vec2 SCENEJS_vRegionMapUV;")),D&&(k("uniform float SCENEJS_uMorphFactor;"),n.morphGeometry.targets[0].vertexBuf&&k("attribute vec3 SCENEJS_aMorphVertex;")),k("varying vec4 SCENEJS_vColor;"),k("void main(void) {"),k("   vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); "),D&&n.morphGeometry.targets[0].vertexBuf&&k("  tmpVertex = vec4(mix(tmpVertex.xyz, SCENEJS_aMorphVertex, SCENEJS_uMorphFactor), 1.0); "),k("  SCENEJS_vWorldVertex = SCENEJS_uMMatrix * tmpVertex; "),k("mat4 vPosMatrix = SCENEJS_uVMatrix;"),A&&k("vPosMatrix[3].xyz = vec3(0.0);"),k("  gl_Position =  SCENEJS_uPMatrix * (vPosMatrix * SCENEJS_vWorldVertex);"),E&&k("SCENEJS_vRegionMapUV = SCENEJS_aRegionMapUV;"),k("SCENEJS_vColor = SCENEJS_aColor;"),k("}"),l()}function b(){if(j(),k("precision "+m(n._canvas.gl)+" float;"),k("varying vec4 SCENEJS_vWorldVertex;"),k("varying vec4  SCENEJS_vColor;"),k("uniform float  SCENEJS_uPickMode;"),k("uniform vec4  SCENEJS_uPickColor;"),k("uniform bool  SCENEJS_uClipping;"),C)for(var a=0;a<n.clips.clips.length;a++)k("uniform float SCENEJS_uClipMode"+a+";"),k("uniform vec4  SCENEJS_uClipNormalAndDist"+a+";");if(E&&(k("varying vec2 SCENEJS_vRegionMapUV;"),k("uniform sampler2D SCENEJS_uRegionMapSampler;")),k("void main(void) {"),C){k("if (SCENEJS_uClipping) {"),k("  float dist = 0.0;");for(var a=0;a<n.clips.clips.length;a++)k("  if (SCENEJS_uClipMode"+a+" != 0.0) {"),k("      dist += clamp(dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+a+".xyz) - SCENEJS_uClipNormalAndDist"+a+".w, 0.0, 1000.0);"),k("  }");k("  if (dist > 0.0) { discard; }"),k("}")}return k("    if  (SCENEJS_uPickMode == 0.0) {"),k("          gl_FragColor = SCENEJS_uPickColor;  "),k("    } else if (SCENEJS_uPickMode == 1.0) {"),k("          gl_FragColor = SCENEJS_vColor;  "),k("    } else {"),k(E?"          gl_FragColor = texture2D(SCENEJS_uRegionMapSampler, vec2(SCENEJS_vRegionMapUV.s, 1.0 - SCENEJS_vRegionMapUV.t));":"          gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);"),k("    }"),k("}"),l()}function c(){if(n.texture.layers&&n.texture.layers.length>0){if(n.geometry.uvBuf||n.geometry.uvBuf2)return!0;if(n.morphGeometry.targets&&(n.morphGeometry.targets[0].uvBuf||n.morphGeometry.targets[0].uvBuf2))return!0}return!1}function d(a){return a.flags.reflective&&a.cubemap.layers&&a.cubemap.layers.length>0&&a.geometry.normalBuf}function e(a){return a.geometry.normalBuf?!0:a.morphGeometry.targets&&a.morphGeometry.targets[0].normalBuf?!0:!1}function f(a){if(a.texture){var b=a.texture.layers;if(!b)return!1;for(var c=0,d=b.length;d>c;c++)if("normals"==b[c].applyTo)return!0}return!1}function g(){if(n.renderTarget&&n.renderTarget.targets)for(var a=n.renderTarget.targets,b=0,c=a.length;c>b;b++)if("depth"===a[b].bufType)return!0;return!1}function h(){var a=n.shader.shaders||{};if(a.vertex&&a.vertex.code&&""!=a.vertex.code&&SceneJS._isEmpty(a.vertex.hooks))return[a.vertex.code];var b=a.vertex||{},c=b.hooks||{},d=a.fragment||{},e=d.hooks||{};return j(),k("uniform mat4 SCENEJS_uMMatrix;"),k("uniform mat4 SCENEJS_uVMatrix;"),k("uniform mat4 SCENEJS_uPMatrix;"),k("attribute vec3 SCENEJS_aVertex;"),k("uniform vec3 SCENEJS_uWorldEye;"),k("varying vec3 SCENEJS_vViewEyeVec;"),y&&(k("attribute vec3 SCENEJS_aNormal;"),k("uniform   mat4 SCENEJS_uMNMatrix;"),k("uniform   mat4 SCENEJS_uVNMatrix;"),k("varying   vec3 SCENEJS_vViewNormal;"),v&&k("varying   vec3 SCENEJS_vWorldNormal;"),B&&(k("attribute vec4 SCENEJS_aTangent;"),k("varying   vec3 SCENEJS_vTangent;"))),(o||w)&&(n.geometry.uvBuf&&k("attribute vec2 SCENEJS_aUVCoord;"),n.geometry.uvBuf2&&k("attribute vec2 SCENEJS_aUVCoord2;")),n.geometry.colorBuf&&(k("attribute vec4 SCENEJS_aVertexColor;"),k("varying vec4 SCENEJS_vColor;")),(C||y)&&k("varying vec4 SCENEJS_vWorldVertex;"),k("varying vec4 SCENEJS_vViewVertex;"),(o||w)&&(n.geometry.uvBuf&&k("varying vec2 SCENEJS_vUVCoord;"),n.geometry.uvBuf2&&k("varying vec2 SCENEJS_vUVCoord2;")),F&&(k("attribute vec2 SCENEJS_aRegionMapUV;"),k("varying vec2 SCENEJS_vRegionMapUV;")),D&&(k("uniform float SCENEJS_uMorphFactor;"),n.morphGeometry.targets[0].vertexBuf&&k("attribute vec3 SCENEJS_aMorphVertex;"),y&&n.morphGeometry.targets[0].normalBuf&&k("attribute vec3 SCENEJS_aMorphNormal;")),b.code&&k("\n"+b.code+"\n"),k("void main(void) {"),k("  vec4 tmpVertex=vec4(SCENEJS_aVertex, 1.0); "),k("  vec4 modelVertex = tmpVertex; "),y&&k("  vec4 modelNormal = vec4(SCENEJS_aNormal, 0.0); "),D&&(n.morphGeometry.targets[0].vertexBuf&&(k("  vec4 vMorphVertex = vec4(SCENEJS_aMorphVertex, 1.0); "),k("  modelVertex = vec4(mix(modelVertex.xyz, vMorphVertex.xyz, SCENEJS_uMorphFactor), 1.0); ")),y&&n.morphGeometry.targets[0].normalBuf&&(k("  vec4 vMorphNormal = vec4(SCENEJS_aMorphNormal, 1.0); "),k("  modelNormal = vec4( mix(modelNormal.xyz, vMorphNormal.xyz, SCENEJS_uMorphFactor), 1.0); "))),k("  vec4 worldVertex = SCENEJS_uMMatrix * modelVertex;"),k("mat4 vPosMatrix = SCENEJS_uVMatrix;"),A&&k("vPosMatrix[3].xyz = vec3(0.0);"),c.viewMatrix&&k("vPosMatrix = "+c.viewMatrix+"(vPosMatrix);"),k("vec4 viewVertex  = vPosMatrix * worldVertex; "),c.viewPos&&k("viewVertex="+c.viewPos+"(viewVertex);"),y&&(k("  vec3 worldNormal = (SCENEJS_uMNMatrix * modelNormal).xyz; "),k("  SCENEJS_vViewNormal = (SCENEJS_uVNMatrix * vec4(worldNormal, 1.0)).xyz;"),v&&k("  SCENEJS_vWorldNormal = worldNormal;")),(C||y||e.worldPos)&&k("  SCENEJS_vWorldVertex = worldVertex;"),k("  SCENEJS_vViewVertex = viewVertex;"),k(c.projMatrix?"gl_Position = "+c.projMatrix+"(SCENEJS_uPMatrix) * viewVertex;":"  gl_Position = SCENEJS_uPMatrix * viewVertex;"),B&&(k("vec3 tangent = normalize((SCENEJS_uVNMatrix * SCENEJS_uMNMatrix * SCENEJS_aTangent).xyz);"),k("vec3 bitangent = cross(SCENEJS_vViewNormal, tangent);"),k("mat3 TBM = mat3(tangent, bitangent, SCENEJS_vViewNormal);"),k("SCENEJS_vTangent = tangent;")),k("SCENEJS_vViewEyeVec = ((SCENEJS_uVMatrix * vec4(SCENEJS_uWorldEye, 0.0)).xyz  - viewVertex.xyz);"),B&&k("SCENEJS_vViewEyeVec *= TBM;"),(o||w)&&(n.geometry.uvBuf&&k("SCENEJS_vUVCoord = SCENEJS_aUVCoord;"),n.geometry.uvBuf2&&k("SCENEJS_vUVCoord2 = SCENEJS_aUVCoord2;")),n.geometry.colorBuf&&k("SCENEJS_vColor = SCENEJS_aVertexColor;"),F&&k("SCENEJS_vRegionMapUV = SCENEJS_aRegionMapUV;"),k("gl_PointSize = 3.0;"),k("}"),l()}function i(){var a=n.shader.shaders||{};if(a.fragment&&a.fragment.code&&""!=a.fragment.code&&SceneJS._isEmpty(a.fragment.hooks))return[a.fragment.code];var b=a.fragment||{},c=b.hooks||{},d=n.fresnel.diffuse,e=n.fresnel.specular,f=n.fresnel.alpha,g=n.fresnel.reflect,h=n.fresnel.emit,i=n.fresnel.fragment;if(j(),k("precision "+m(n._canvas.gl)+" float;"),k("uniform mat4 SCENEJS_uVMatrix;"),(C||y)&&k("varying vec4 SCENEJS_vWorldVertex;"),k("varying vec4 SCENEJS_vViewVertex;"),k("uniform float SCENEJS_uZNear;"),k("uniform float SCENEJS_uZFar;"),k("uniform vec3 SCENEJS_uWorldEye;"),C)for(var p=0;p<n.clips.clips.length;p++)k("uniform float SCENEJS_uClipMode"+p+";"),k("uniform vec4  SCENEJS_uClipNormalAndDist"+p+";");if((o||w)&&(n.geometry.uvBuf&&k("varying vec2 SCENEJS_vUVCoord;"),n.geometry.uvBuf2&&k("varying vec2 SCENEJS_vUVCoord2;"),o&&(k("uniform sampler2D SCENEJS_uDecalSampler;"),n.decal.matrix&&k("uniform mat4 SCENEJS_uDecalMatrix;"),k("uniform float SCENEJS_uDecalBlendFactor;")),w))for(var q,p=0,r=n.texture.layers.length;r>p;p++)q=n.texture.layers[p],k("uniform sampler2D SCENEJS_uSampler"+p+";"),q.matrix&&k("uniform mat4 SCENEJS_uLayer"+p+"Matrix;"),k("uniform float SCENEJS_uLayer"+p+"BlendFactor;");if(y&&x)for(var q,p=0,r=n.cubemap.layers.length;r>p;p++)q=n.cubemap.layers[p],k("uniform samplerCube SCENEJS_uCubeMapSampler"+p+";"),k("uniform float SCENEJS_uCubeMapIntensity"+p+";");if(F&&(k("varying vec2 SCENEJS_vRegionMapUV;"),k("uniform sampler2D SCENEJS_uRegionMapSampler;"),k("uniform vec3 SCENEJS_uRegionMapRegionColor;"),k("uniform vec3 SCENEJS_uRegionMapHighlightFactor;"),k("uniform float SCENEJS_uRegionMapHideAlpha;")),k("uniform bool  SCENEJS_uClipping;"),z&&k("uniform vec3  SCENEJS_uSolidColor;"),k("uniform bool  SCENEJS_uDepthMode;"),k("uniform bool  SCENEJS_uTransparent;"),n.geometry.colorBuf&&k("varying vec4 SCENEJS_vColor;"),k("uniform vec3  SCENEJS_uAmbientColor;"),k("uniform vec3  SCENEJS_uMaterialColor;"),k("uniform vec3  SCENEJS_uMaterialSpecularColor;"),k("uniform vec3  SCENEJS_uMaterialEmitColor;"),k("uniform float SCENEJS_uMaterialSpecular;"),k("uniform float SCENEJS_uMaterialShine;"),k("uniform float SCENEJS_uMaterialAlpha;"),k("uniform float SCENEJS_uMaterialEmit;"),d&&(k("uniform float SCENEJS_uDiffuseFresnelCenterBias;"),k("uniform float SCENEJS_uDiffuseFresnelEdgeBias;"),k("uniform float SCENEJS_uDiffuseFresnelPower;"),k("uniform vec3 SCENEJS_uDiffuseFresnelCenterColor;"),k("uniform vec3 SCENEJS_uDiffuseFresnelEdgeColor;")),e&&(k("uniform float SCENEJS_uSpecularFresnelCenterBias;"),k("uniform float SCENEJS_uSpecularFresnelEdgeBias;"),k("uniform float SCENEJS_uSpecularFresnelPower;"),k("uniform vec3 SCENEJS_uSpecularFresnelCenterColor;"),k("uniform vec3 SCENEJS_uSpecularFresnelEdgeColor;")),f&&(k("uniform float SCENEJS_uAlphaFresnelCenterBias;"),k("uniform float SCENEJS_uAlphaFresnelEdgeBias;"),k("uniform float SCENEJS_uAlphaFresnelPower;"),k("uniform vec3 SCENEJS_uAlphaFresnelCenterColor;"),k("uniform vec3 SCENEJS_uAlphaFresnelEdgeColor;")),g&&(k("uniform float SCENEJS_uReflectFresnelCenterBias;"),k("uniform float SCENEJS_uReflectFresnelEdgeBias;"),k("uniform float SCENEJS_uReflectFresnelPower;"),k("uniform vec3 SCENEJS_uReflectFresnelCenterColor;"),k("uniform vec3 SCENEJS_uReflectFresnelEdgeColor;")),h&&(k("uniform float SCENEJS_uEmitFresnelCenterBias;"),k("uniform float SCENEJS_uEmitFresnelEdgeBias;"),k("uniform float SCENEJS_uEmitFresnelPower;"),k("uniform vec3 SCENEJS_uEmitFresnelCenterColor;"),k("uniform vec3 SCENEJS_uEmitFresnelEdgeColor;")),i&&(k("uniform float SCENEJS_uFragmentFresnelCenterBias;"),k("uniform float SCENEJS_uFragmentFresnelEdgeBias;"),k("uniform float SCENEJS_uFragmentFresnelPower;"),k("uniform vec3 SCENEJS_uFragmentFresnelCenterColor;"),k("uniform vec3 SCENEJS_uFragmentFresnelEdgeColor;")),k("varying vec3 SCENEJS_vViewEyeVec;"),y){k("uniform mat4 SCENEJS_uVNMatrix;"),k("varying vec3 SCENEJS_vViewNormal;"),v&&k("varying vec3 SCENEJS_vWorldNormal;"),B&&k("varying vec3 SCENEJS_vTangent;");for(var s,p=0;p<n.lights.lights.length;p++)s=n.lights.lights[p],"ambient"!=s.mode&&(k("uniform vec3  SCENEJS_uLightColor"+p+";"),"dir"==s.mode&&k("uniform vec3 SCENEJS_uLightDir"+p+";"),"point"==s.mode&&(k("uniform vec3  SCENEJS_uLightAttenuation"+p+";"),k("uniform vec3 SCENEJS_uLightPos"+p+";")))}if(b.code&&k("\n"+b.code+"\n"),(d||e||f||g||h||i)&&(k("float fresnel(vec3 viewDirection, vec3 worldNormal, float edgeBias, float centerBias, float power) {"),k("    float fr = abs(dot(viewDirection, worldNormal));"),k("    float finalFr = clamp((fr - edgeBias) / (centerBias - edgeBias), 0.0, 1.0);"),k("    return pow(finalFr, power);"),k("}")),k("void main(void) {"),C){k("if (SCENEJS_uClipping) {"),k("  float dist = 0.0;");for(var p=0;p<n.clips.clips.length;p++)k("  if (SCENEJS_uClipMode"+p+" != 0.0) {"),k("      dist += clamp(dot(SCENEJS_vWorldVertex.xyz, SCENEJS_uClipNormalAndDist"+p+".xyz) - SCENEJS_uClipNormalAndDist"+p+".w, 0.0, 1000.0);"),k("  }");k("  if (dist > 0.0) { discard; }"),k("}")}y&&(k("vec3 worldEyeVec = normalize(SCENEJS_uWorldEye - SCENEJS_vWorldVertex.xyz);"),v&&k("vec3 worldNormal = normalize(SCENEJS_vWorldNormal); "),z&&(k("  if (gl_FrontFacing == false) {"),k("     gl_FragColor = vec4(SCENEJS_uSolidColor.xyz, 1.0);"),k("     return;"),k("  }"))),k("  vec3 ambient= SCENEJS_uAmbientColor;"),w&&n.geometry.uvBuf&&c.texturePos&&k(c.texturePos+"(SCENEJS_vUVCoord);"),c.viewPos&&k(c.viewPos+"(SCENEJS_vViewVertex);"),y&&c.viewNormal&&k(c.viewNormal+"(SCENEJS_vViewNormal);"),k(n.geometry.colorBuf?"  vec3    color   = SCENEJS_vColor.rgb;":"  vec3    color   = SCENEJS_uMaterialColor;"),k("  float alpha         = SCENEJS_uMaterialAlpha;"),k("  float emit          = SCENEJS_uMaterialEmit;"),k("  float specular      = SCENEJS_uMaterialSpecular;"),k("  vec3  specularColor = SCENEJS_uMaterialSpecularColor;"),k("  vec3  emitColor     = SCENEJS_uMaterialEmitColor;"),k("  float shine         = SCENEJS_uMaterialShine;"),c.materialBaseColor&&k("color="+c.materialBaseColor+"(color);"),c.materialAlpha&&k("alpha="+c.materialAlpha+"(alpha);"),c.materialEmit&&k("emit="+c.materialEmit+"(emit);"),c.materialSpecular&&k("specular="+c.materialSpecular+"(specular);"),c.materialSpecularColor&&k("specularColor="+c.materialSpecularColor+"(specularColor);"),c.materialShine&&k("shine="+c.materialShine+"(shine);"),y&&(k("  float   attenuation = 1.0;"),k(B?"  vec3    viewNormalVec = vec3(0.0, 1.0, 0.0);":"  vec3    viewNormalVec = normalize(SCENEJS_vViewNormal);"),k("vec3 viewEyeVec = normalize(SCENEJS_vViewEyeVec);"));var q;if(o||w){if(k("  vec4    texturePos;"),k("  vec2    textureCoord=vec2(0.0,0.0);"),w)for(var p=0,r=n.texture.layers.length;r>p;p++){if(q=n.texture.layers[p],"normal"==q.applyFrom&&y){if(!n.geometry.normalBuf){SceneJS.log.warn("Texture layer applyFrom='normal' but geo has no normal vectors");continue}k("texturePos=vec4(viewNormalVec.xyz, 1.0);")}if("uv"==q.applyFrom){if(!n.geometry.uvBuf){SceneJS.log.warn("Texture layer applyTo='uv' but geometry has no UV coordinates");continue}k("texturePos = vec4(SCENEJS_vUVCoord.s, SCENEJS_vUVCoord.t, 1.0, 1.0);")}if("uv2"==q.applyFrom){if(!n.geometry.uvBuf2){SceneJS.log.warn("Texture layer applyTo='uv2' but geometry has no UV2 coordinates");continue}k("texturePos = vec4(SCENEJS_vUVCoord2.s, SCENEJS_vUVCoord2.t, 1.0, 1.0);")}k(q.matrix?"textureCoord=(SCENEJS_uLayer"+p+"Matrix * texturePos).xy;":"textureCoord=texturePos.xy;"),"alpha"==q.applyTo&&("multiply"==q.blendMode?k("alpha = alpha * (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);"):"add"==q.blendMode&&k("alpha = ((1.0 - SCENEJS_uLayer"+p+"BlendFactor) * alpha) + (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")),"baseColor"==q.applyTo&&k("multiply"==q.blendMode?"color = color * (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);":"color = ((1.0 - SCENEJS_uLayer"+p+"BlendFactor) * color) + (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);"),"emit"==q.applyTo&&k("multiply"==q.blendMode?"emit  = emit * (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"emit = ((1.0 - SCENEJS_uLayer"+p+"BlendFactor) * emit) + (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"specular"==q.applyTo&&y&&k("multiply"==q.blendMode?"specular  = specular * (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"specular = ((1.0 - SCENEJS_uLayer"+p+"BlendFactor) * specular) + (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"shine"==q.applyTo&&k("multiply"==q.blendMode?"shine  = shine * (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"shine = ((1.0 - SCENEJS_uLayer"+p+"BlendFactor) * shine) + (SCENEJS_uLayer"+p+"BlendFactor * texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"normals"==q.applyTo&&y&&k("viewNormalVec = normalize(texture2D(SCENEJS_uSampler"+p+", vec2(textureCoord.x, -textureCoord.y)).xyz * 2.0 - 1.0);")}o&&("normal"==n.decal.applyFrom&&y&&(n.geometry.normalBuf?k("texturePos=vec4(viewNormalVec.xyz, 1.0);"):SceneJS.log.warn("Texture decal applyFrom='normal' but geo has no normal vectors")),"uv"==n.decal.applyFrom&&(n.geometry.uvBuf?k("texturePos = vec4(SCENEJS_vUVCoord.s, SCENEJS_vUVCoord.t, 1.0, 1.0);"):SceneJS.log.warn("Texture decal applyTo='uv' but geometry has no UV coordinates")),"uv2"==n.decal.applyFrom&&(n.geometry.uvBuf2?k("texturePos = vec4(SCENEJS_vUVCoord2.s, SCENEJS_vUVCoord2.t, 1.0, 1.0);"):SceneJS.log.warn("Texture decal applyTo='uv2' but geometry has no UV2 coordinates")),k(n.decal.matrix?"textureCoord=(SCENEJS_uDecalMatrix * texturePos).xy;":"textureCoord=texturePos.xy;"),"alpha"==n.decal.applyTo&&("multiply"==n.decal.blendMode?k("alpha = alpha * (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).b);"):"add"==n.decal.blendMode&&k("alpha = ((1.0 - SCENEJS_uDecalBlendFactor) * alpha) + (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).b);")),"baseColor"==n.decal.applyTo&&k("multiply"==n.decal.blendMode?"color = color * (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);":"color = ((1.0 - SCENEJS_uDecalBlendFactor) * color) + (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).rgb);"),"emit"==n.decal.applyTo&&k("multiply"==n.decal.blendMode?"emit  = emit * (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"emit = ((1.0 - SCENEJS_uDecalBlendFactor) * emit) + (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"specular"==n.decal.applyTo&&y&&k("multiply"==n.decal.blendMode?"specular  = specular * (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"specular = ((1.0 - SCENEJS_uDecalBlendFactor) * specular) + (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"shine"==n.decal.applyTo&&k("multiply"==n.decal.blendMode?"shine  = shine * (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).r);":"shine = ((1.0 - SCENEJS_uDecalBlendFactor) * shine) + (SCENEJS_uDecalBlendFactor * texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, 1.0 - textureCoord.y)).r);"),"normals"==n.decal.applyTo&&y&&k("viewNormalVec = normalize(texture2D(SCENEJS_uDecalSampler, vec2(textureCoord.x, -textureCoord.y)).xyz * 2.0 - 1.0);"))}if(y&&x){k("float reflectFactor = 1.0;"),g&&(k("float reflectFresnel = fresnel(worldEyeVec, worldNormal, SCENEJS_uReflectFresnelEdgeBias,  SCENEJS_uReflectFresnelCenterBias, SCENEJS_uReflectFresnelPower);"),k("reflectFactor *= mix(SCENEJS_uReflectFresnelEdgeColor.b, SCENEJS_uReflectFresnelCenterColor.b, reflectFresnel);")),k("vec4 v = SCENEJS_uVNMatrix * vec4(SCENEJS_vViewEyeVec, 1.0);"),k("vec3 v1 = v.xyz;"),k("v = SCENEJS_uVNMatrix * vec4(viewNormalVec, 1.0);"),k("vec3 v2 = v.xyz;"),k("vec3 envLookup = reflect(v1, v2);"),k("envLookup.y = envLookup.y * -1.0;"),k("vec4 envColor;");for(var p=0,r=n.cubemap.layers.length;r>p;p++)q=n.cubemap.layers[p],k("envColor = textureCube(SCENEJS_uCubeMapSampler"+p+", envLookup);"),k("color = mix(color, envColor.rgb, reflectFactor * specular * SCENEJS_uCubeMapIntensity"+p+");")}if(k("  vec4    fragColor;"),y){k("  vec3    lightValue      = vec3(0.0, 0.0, 0.0);"),k("  vec3    specularValue   = vec3(0.0, 0.0, 0.0);"),k("  vec3    viewLightVec;"),k("  float   dotN;"),k("  float   lightDist;"),B&&(k("vec3 tangent = normalize(SCENEJS_vTangent);"),k("vec3 bitangent = cross(SCENEJS_vViewNormal, tangent);"),k("mat3 TBM = mat3(tangent, bitangent, SCENEJS_vViewNormal);"));for(var s,p=0,r=n.lights.lights.length;r>p;p++)s=n.lights.lights[p],"ambient"!=s.mode&&("point"==s.mode&&("world"==s.space?(k("viewLightVec = SCENEJS_uLightPos"+p+" - SCENEJS_vWorldVertex.xyz;"),k("viewLightVec = vec3(SCENEJS_uVMatrix * vec4(viewLightVec, 0.0)).xyz;"),B&&k("viewLightVec *= TBM;")):(k("viewLightVec = SCENEJS_uLightPos"+p+".xyz - SCENEJS_vViewVertex.xyz;"),B&&k("viewLightVec *= TBM;")),k("dotN = max(dot(viewNormalVec, normalize(viewLightVec)), 0.0);"),k("lightDist = length( SCENEJS_uLightPos"+p+" - SCENEJS_vWorldVertex.xyz);"),k("attenuation = 1.0 - (  SCENEJS_uLightAttenuation"+p+"[0] +   SCENEJS_uLightAttenuation"+p+"[1] * lightDist +   SCENEJS_uLightAttenuation"+p+"[2] * lightDist * lightDist);"),s.diffuse&&k("      lightValue += dotN * SCENEJS_uLightColor"+p+" * attenuation;"),s.specular&&k("    specularValue += specularColor * SCENEJS_uLightColor"+p+" * specular * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-SCENEJS_vViewVertex.xyz)), 0.0), shine) * attenuation;")),"dir"==s.mode&&("world"==s.space?(k("viewLightVec = normalize(SCENEJS_uLightDir"+p+");"),k("viewLightVec = vec3(SCENEJS_uVMatrix * vec4(viewLightVec, 0.0)).xyz;"),
B&&k("viewLightVec *= TBM;")):(k("viewLightVec = normalize(SCENEJS_uLightDir"+p+");"),B&&k("viewLightVec *= TBM;")),k("viewLightVec = -viewLightVec;"),k("dotN = max(dot(viewNormalVec, normalize(viewLightVec)), 0.0);"),s.diffuse&&k("lightValue += dotN * SCENEJS_uLightColor"+p+";"),s.specular&&k("specularValue += specularColor * SCENEJS_uLightColor"+p+" * specular * pow(max(dot(reflect(normalize(-viewLightVec), normalize(-viewNormalVec)), normalize(-SCENEJS_vViewVertex.xyz)), 0.0), shine);")));(d||e||f||h)&&(d&&(k("float diffuseFresnel = fresnel(worldEyeVec, worldNormal, SCENEJS_uDiffuseFresnelEdgeBias, SCENEJS_uDiffuseFresnelCenterBias, SCENEJS_uDiffuseFresnelPower);"),k("color.rgb *= mix(SCENEJS_uDiffuseFresnelEdgeColor.rgb, SCENEJS_uDiffuseFresnelCenterColor.rgb, diffuseFresnel);")),e&&(k("float specFresnel = fresnel(worldEyeVec, worldNormal, SCENEJS_uSpecularFresnelEdgeBias, SCENEJS_uSpecularFresnelCenterBias, SCENEJS_uSpecularFresnelPower);"),k("specularValue *= mix(SCENEJS_uSpecularFresnelEdgeColor.rgb, SCENEJS_uSpecularFresnelCenterColor.rgb, specFresnel);")),f&&(k("float alphaFresnel = fresnel(worldEyeVec, worldNormal, SCENEJS_uAlphaFresnelEdgeBias, SCENEJS_uAlphaFresnelCenterBias, SCENEJS_uAlphaFresnelPower);"),k("alpha *= mix(SCENEJS_uAlphaFresnelEdgeColor.r, SCENEJS_uAlphaFresnelCenterColor.r, alphaFresnel);")),h&&(k("float emitFresnel = fresnel(worldEyeVec, worldNormal, SCENEJS_uEmitFresnelEdgeBias, SCENEJS_uEmitFresnelCenterBias, SCENEJS_uEmitFresnelPower);"),k("emitColor.rgb *= mix(SCENEJS_uEmitFresnelEdgeColor.rgb, SCENEJS_uEmitFresnelCenterColor.rgb, emitFresnel);"))),k("fragColor = vec4((specularValue.rgb + color.rgb * (lightValue.rgb + ambient.rgb)) + (emit * emitColor.rgb), alpha);")}else k("fragColor = vec4((color.rgb + (emit * color.rgb)) *  (vec3(1.0, 1.0, 1.0) + ambient.rgb), alpha);");return F&&(k("vec3 regionColor = texture2D(SCENEJS_uRegionMapSampler, vec2(SCENEJS_vRegionMapUV.s, 1.0 - SCENEJS_vRegionMapUV.t)).rgb;"),k("float tolerance = 0.01;"),k("vec3 colorDelta = abs(SCENEJS_uRegionMapRegionColor - regionColor);"),"highlight"===n.regionMap.mode||"hide"===n.regionMap.mode?(k("if (max(colorDelta.x, max(colorDelta.y, colorDelta.z)) < tolerance) {"),k("highlight"===n.regionMap.mode?"  fragColor.rgb *= SCENEJS_uRegionMapHighlightFactor;":"  fragColor.a = SCENEJS_uRegionMapHideAlpha;"),k("}")):(k("if (max(colorDelta.x, max(colorDelta.y, colorDelta.z)) > tolerance) {"),k("  fragColor.a = SCENEJS_uRegionMapHideAlpha;"),k("}"))),c.pixelColor&&k("fragColor="+c.pixelColor+"(fragColor);"),G&&(k("    if (SCENEJS_uDepthMode) {"),k("          float depth = length(SCENEJS_vViewVertex) / (SCENEJS_uZFar - SCENEJS_uZNear);"),k("          const vec4 bias = vec4(1.0 / 255.0,"),k("          1.0 / 255.0,"),k("          1.0 / 255.0,"),k("          0.0);"),k("          float r = depth;"),k("          float g = fract(r * 255.0);"),k("          float b = fract(g * 255.0);"),k("          float a = fract(b * 255.0);"),k("          vec4 colour = vec4(r, g, b, a);"),k("          fragColor = colour - (colour.yzww * bias);"),k("    }")),i&&(k("float fragmentFresnel = fresnel(worldEyeVec, worldNormal, SCENEJS_uFragmentFresnelEdgeBias, SCENEJS_uFragmentFresnelCenterBias, SCENEJS_uFragmentFresnelPower);"),k("fragColor.rgb *= mix(SCENEJS_uFragmentFresnelEdgeColor.rgb, SCENEJS_uFragmentFresnelCenterColor.rgb, fragmentFresnel);")),k("gl_FragColor = fragColor;"),k("}"),l()}function j(){I=[]}function k(a){I.push(a||"")}function l(){return I}function m(a){return a.getShaderPrecisionFormat?a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.HIGH_FLOAT).precision>0?"highp":a.getShaderPrecisionFormat(a.FRAGMENT_SHADER,a.MEDIUM_FLOAT).precision>0?"mediump":"lowp":"mediump"}var n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H={},I="";this.getSource=function(j,k){var l=H[j];return l?(l.useCount++,l):(n=k,o=n.decal&&n.decal.texture,p=n.fresnel.diffuse,q=n.fresnel.specular,r=n.fresnel.alpha,s=n.fresnel.reflect,t=n.fresnel.emit,u=n.fresnel.fragment,v=p||q||r||s||t||u,w=c(n),x=d(n),y=e(n),z=n.flags.solid,A=n.flags.skybox,B=f(n),C=n.clips.clips.length>0,D=!!n.morphGeometry.targets,E=!n.regionMap.empty,F=E&&"info"!==n.regionMap.mode,G=g(),l=new SceneJS_ProgramSource(j,a(n),b(n),h(n),i(n)),H[j]=l,l)},this.putSource=function(a){var b=H[a];b&&0==--b.useCount&&(H[b.hash]=null)}},SceneJS_ProgramSource=function(a,b,c,d,e){this.hash=a,this.pickVertexSrc=b,this.pickFragmentSrc=c,this.drawVertexSrc=d,this.drawFragmentSrc=e,this.useCount=0},SceneJS_ProgramFactory=function(a){this._canvas=a.canvas,this._programs={},this._nextProgramId=0};SceneJS_ProgramFactory.prototype.getProgram=function(a,b){var c=this._programs[a];if(!c){var d=SceneJS_ProgramSourceFactory.getSource(a,b);c=new SceneJS_Program(this._nextProgramId++,a,d,this._canvas.gl),this._programs[a]=c}return c.useCount++,c},SceneJS_ProgramFactory.prototype.putProgram=function(a){--a.useCount<=0&&(a.draw.destroy(),a.pick.destroy(),SceneJS_ProgramSourceFactory.putSource(a.hash),delete this._programs[a.hash])},SceneJS_ProgramFactory.prototype.webglRestored=function(){var a,b=this._canvas.gl;for(var c in this._programs)this._programs.hasOwnProperty(c)&&(a=this._programs[c],a&&a.build&&a.build(b))},SceneJS_ProgramFactory.prototype.destroy=function(){};var SceneJS_Program=function(a,b,c,d){this.id=a,this.hash=c.hash,this.source=c,this.gl=d,this.draw=null,this.pick=null,this.useCount=0,this.build(d)};SceneJS_Program.prototype.build=function(a){this.gl=a,this.draw=new SceneJS._webgl.Program(a,[this.source.drawVertexSrc.join("\n")],[this.source.drawFragmentSrc.join("\n")]),this.pick=new SceneJS._webgl.Program(a,[this.source.pickVertexSrc.join("\n")],[this.source.pickFragmentSrc.join("\n")])};var SceneJS_ObjectFactory=function(){};SceneJS_ObjectFactory.prototype._freeObjects=[],SceneJS_ObjectFactory.prototype._numFreeObjects=0,SceneJS_ObjectFactory.prototype.getObject=function(a){var b;return this._numFreeObjects>0?(b=this._freeObjects[--this._numFreeObjects],b.id=a,b):new SceneJS_Object(a)},SceneJS_ObjectFactory.prototype.putObject=function(){};var SceneJS_Object=function(a){this.id=a,this.hash=null,this.sortKey=null,this.chunks=[],this.chunksLen=0,this.program=null,this.layer=null,this.texture=null,this.flags=null,this.tag=null};SceneJS.RenderContext=function(a){this._frameCtx=a},SceneJS.RenderContext.prototype.getCameraMatrix=function(){return this._frameCtx.cameraMat},SceneJS.RenderContext.prototype.getViewMatrix=function(){return this._frameCtx.viewMat},SceneJS.RenderContext.prototype.getModelMatrix=function(){return this._frameCtx.modelMat},SceneJS.RenderContext.prototype.getCanvasPos=function(a){this.getProjPos(a);var b=this._frameCtx.canvas.canvas,c=this._frameCtx.canvas.resolutionScaling,d=b.width/c,e=b.height/c,f=this._pc,g=f[0]/f[3]*d*.5,h=f[1]/f[3]*e*.5;return{x:g+.5*d,y:e-h-.5*e}},SceneJS.RenderContext.prototype.getCameraPos=function(a){return this.getProjPos(a),this._camPos=SceneJS_math_normalizeVec3(this._pc,[0,0,0]),{x:this._camPos[0],y:this._camPos[1],z:this._camPos[2]}},SceneJS.RenderContext.prototype.getProjPos=function(a){return this.getViewPos(a),this._pc=SceneJS_math_transformPoint3(this._frameCtx.cameraMat,this._vc),{x:this._pc[0],y:this._pc[1],z:this._pc[2],w:this._pc[3]}},SceneJS.RenderContext.prototype.getViewPos=function(a){return this.getWorldPos(a),this._vc=SceneJS_math_transformPoint3(this._frameCtx.viewMat,this._wc),{x:this._vc[0],y:this._vc[1],z:this._vc[2],w:this._vc[3]}},SceneJS.RenderContext.prototype.getWorldPos=function(a){return this._wc=SceneJS_math_transformPoint3(this._frameCtx.modelMat,a||[0,0,0]),{x:this._wc[0],y:this._wc[1],z:this._wc[2],w:this._wc[3]}};var SceneJS_Chunk=function(){};SceneJS_Chunk.prototype.init=function(a,b,c,d){this.id=a,this.program=b,this.core=c,this.core2=d,this.build&&this.build()};var SceneJS_ChunkFactory=function(){this._chunks={},this.chunkTypes=SceneJS_ChunkFactory.chunkTypes};SceneJS_ChunkFactory.chunkTypes={},SceneJS_ChunkFactory._freeChunks={},SceneJS_ChunkFactory.createChunkType=function(a){if(!a.type)throw"'type' expected in params";var b=SceneJS_Chunk,c=function(){this.useCount=0,this.init.apply(this,arguments)};return c.prototype=new b,c.prototype.constructor=c,a.drawAndPick&&(a.draw=a.pick=a.drawAndPick),SceneJS_ChunkFactory.chunkTypes[a.type]=c,SceneJS._apply(a,c.prototype),SceneJS_ChunkFactory._freeChunks[a.type]={chunks:[],chunksLen:0},c},SceneJS_ChunkFactory.prototype.getChunk=function(a,b,c,d,e){var f=SceneJS_ChunkFactory.chunkTypes[b];if(!f)throw"chunk type not supported: '"+b+"'";var g=this._chunks[a];return g?(g.useCount++,g):(g=new f(a,c,d,e),g.type=b,g.useCount=1,this._chunks[a]=g,g)},SceneJS_ChunkFactory.prototype.putChunk=function(a){0!=a.useCount&&--a.useCount<=0&&(a.recycle&&a.recycle(),delete this._chunks[a.id])},SceneJS_ChunkFactory.prototype.webglRestored=function(){var a;for(var b in this._chunks)this._chunks.hasOwnProperty(b)&&(a=this._chunks[b],a&&a.build&&a.build())},SceneJS_ChunkFactory.createChunkType({type:"camera",build:function(){this._uPMatrixDraw=this.program.draw.getUniform("SCENEJS_uPMatrix"),this._uZNearDraw=this.program.draw.getUniform("SCENEJS_uZNear"),this._uZFarDraw=this.program.draw.getUniform("SCENEJS_uZFar"),this._uPMatrixPick=this.program.pick.getUniform("SCENEJS_uPMatrix"),this._uZNearPick=this.program.pick.getUniform("SCENEJS_uZNear"),this._uZFarPick=this.program.pick.getUniform("SCENEJS_uZFar")},draw:function(a){this.core.checkAspect&&this.core.checkAspect(this.core,a.aspect);this.program.gl;this._uPMatrixDraw&&this._uPMatrixDraw.setValue(this.core.mat),this._uZNearDraw&&this._uZNearDraw.setValue(this.core.optics.near),this._uZFarDraw&&this._uZFarDraw.setValue(this.core.optics.far),a.cameraMat=this.core.mat},pick:function(a){this.core.checkAspect&&this.core.checkAspect(this.core,a.aspect);this.program.gl;this._uPMatrixPick&&this._uPMatrixPick.setValue(this.core.mat),a.rayPick&&(this._uZNearPick&&this._uZNearPick.setValue(this.core.optics.near),this._uZFarPick&&this._uZFarPick.setValue(this.core.optics.far)),a.cameraMat=this.core.mat}}),SceneJS_ChunkFactory.createChunkType({type:"clips",build:function(){this._draw=this._draw||[];for(var a=this.program.draw,b=0,c=this.core.clips.length;c>b;b++)this._draw[b]={uClipMode:a.getUniform("SCENEJS_uClipMode"+b),uClipNormalAndDist:a.getUniform("SCENEJS_uClipNormalAndDist"+b)};this._pick=this._pick||[];for(var d=this.program.pick,b=0,c=this.core.clips.length;c>b;b++)this._pick[b]={uClipMode:d.getUniform("SCENEJS_uClipMode"+b),uClipNormalAndDist:d.getUniform("SCENEJS_uClipNormalAndDist"+b)}},drawAndPick:function(a){for(var b,c,d,e=a.picking,f=e?this._pick:this._draw,g=this.core.clips,h=(this.program.gl,0),i=g.length;i>h;h++)e?(b=f[h].uClipMode,c=f[h].uClipNormalAndDist):(b=f[h].uClipMode,c=f[h].uClipNormalAndDist),b&&c&&(d=g[h],"inside"==d.mode?(b.setValue(2),c.setValue(d.normalAndDist)):"outside"==d.mode?(b.setValue(1),c.setValue(d.normalAndDist)):b.setValue(0))}}),SceneJS_ChunkFactory.createChunkType({type:"draw",unique:!0,build:function(){this._depthModeDraw=this.program.draw.getUniform("SCENEJS_uDepthMode"),this._uPickColor=this.program.pick.getUniform("SCENEJS_uPickColor")},draw:function(a){var b=this.core,c=this.program.gl;this._depthModeDraw&&this._depthModeDraw.setValue(a.depthMode),c.drawElements(b.primitive,b.indexBuf.numItems,b.indexBuf.itemType,0)},pick:function(a){var b=this.core,c=this.program.gl;if(a.pickObject||a.pickRegion){if(a.pickObject&&this._uPickColor){var d=a.pickIndex>>24&255,e=a.pickIndex>>16&255,f=a.pickIndex>>8&255,g=255&a.pickIndex;a.pickIndex++,this._uPickColor.setValue([g/255,f/255,e/255,d/255])}c.drawElements(b.primitive,b.indexBuf.numItems,b.indexBuf.itemType,0)}else if(a.pickTriangle){var h=b.getPickIndices();h&&c.drawElements(b.primitive,h.numItems,h.itemType,0)}}}),SceneJS_ChunkFactory.createChunkType({type:"flags",build:function(){var a=this.program.draw;this._uClippingDraw=a.getUniform("SCENEJS_uClipping"),this._uSolidDraw=a.getUniform("SCENEJS_uSolid"),this._uSolidColorDraw=a.getUniform("SCENEJS_uSolidColor");var b=this.program.pick;this._uClippingPick=b.getUniform("SCENEJS_uClipping")},drawAndPick:function(a){var b=this.program.gl,c=this.core.backfaces;a.backfaces!=c&&(c?b.disable(b.CULL_FACE):b.enable(b.CULL_FACE),a.backfaces=c);var d=this.core.frontface;a.frontface!=d&&(b.frontFace("ccw"==d?b.CCW:b.CW),a.frontface=d);var e=a.picking;if(e)this._uClippingPick&&this._uClippingPick.setValue(this.core.clipping);else{var f=this.core.transparent;a.transparent!=f&&(f?(b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA),a.blendEnabled=!0):(b.disable(b.BLEND),a.blendEnabled=!1),a.transparent=f),this._uClippingDraw&&this._uClippingDraw.setValue(this.core.clipping),this._uSolidDraw&&this._uSolidDraw.setValue(this.core.solid),this._uSolidColorDraw&&this._uSolidColorDraw.setValue(this.core.solidColor)}}}),SceneJS_ChunkFactory.createChunkType({type:"renderTarget",programGlobal:!0,draw:function(a){var b=this.program.gl;a.renderBuf&&(b.flush(),a.renderBuf.unbind(),a.renderBuf=null);var c=this.core.renderBuf;return c?(c.bind(),a.depthMode="depth"===this.core.bufType,a.depthMode||a.blendEnabled&&(b.enable(b.BLEND),b.blendFunc(b.SRC_ALPHA,b.ONE_MINUS_SRC_ALPHA)),b.viewport(0,0,b.drawingBufferWidth,b.drawingBufferHeight),b.clearColor(a.ambientColor[0],a.ambientColor[1],a.ambientColor[2],1),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT|b.STENCIL_BUFFER_BIT),void(a.renderBuf=c)):void(a.depthMode=!1)}}),SceneJS_ChunkFactory.createChunkType({type:"geometry",build:function(){var a=this.program.draw;this._aRegionMapUVDraw=a.getAttribute("SCENEJS_aRegionMapUV"),this._aVertexDraw=a.getAttribute("SCENEJS_aVertex"),this._aNormalDraw=a.getAttribute("SCENEJS_aNormal"),this._aUVDraw=a.getAttribute("SCENEJS_aUVCoord"),this._aUV2Draw=a.getAttribute("SCENEJS_aUVCoord2"),this._aTangentDraw=a.getAttribute("SCENEJS_aTangent"),this._aColorDraw=a.getAttribute("SCENEJS_aVertexColor"),this._aMorphVertexDraw=a.getAttribute("SCENEJS_aMorphVertex"),this._aMorphNormalDraw=a.getAttribute("SCENEJS_aMorphNormal"),this._uMorphFactorDraw=a.getUniform("SCENEJS_uMorphFactor");var b=this.program.pick;this._aRegionMapUVPick=b.getAttribute("SCENEJS_aRegionMapUV"),this._aVertexPick=b.getAttribute("SCENEJS_aVertex"),this._aColorPick=b.getAttribute("SCENEJS_aColor"),this._aMorphVertexPick=b.getAttribute("SCENEJS_aMorphVertex"),this._uMorphFactorPick=b.getUniform("SCENEJS_uMorphFactor"),this.VAO=null,this.VAOMorphKey1=0,this.VAOMorphKey2=0,this.VAOHasInterleavedBuf=!1},recycle:function(){if(this.VAO){var a=this.program.gl.getExtension("OES_vertex_array_object");a.deleteVertexArrayOES(this.VAO),this.VAO=null}},morphDraw:function(){this.VAOMorphKey1=this.core.key1,this.VAOMorphKey2=this.core.key2;var a=this.core.targets[this.core.key1],b=this.core.targets[this.core.key2];this._aMorphVertexDraw?(this._aVertexDraw.bindFloatArrayBuffer(a.vertexBuf),this._aMorphVertexDraw.bindFloatArrayBuffer(b.vertexBuf)):this._aVertexDraw&&this._aVertexDraw.bindFloatArrayBuffer(this.core2.vertexBuf),this._aMorphNormalDraw?(this._aNormalDraw.bindFloatArrayBuffer(a.normalBuf),this._aMorphNormalDraw.bindFloatArrayBuffer(b.normalBuf)):this._aNormalDraw&&this._aNormalDraw.bindFloatArrayBuffer(this.core2.normalBuf),this._aUVDraw&&this._aUVDraw.bindFloatArrayBuffer(this.core2.uvBuf),this._aUV2Draw&&this._aUV2Draw.bindFloatArrayBuffer(this.core2.uvBuf2),this._aColorDraw&&this._aColorDraw.bindFloatArrayBuffer(this.core2.colorBuf),this.setDrawMorphFactor()},setDrawMorphFactor:function(){this._uMorphFactorDraw&&this._uMorphFactorDraw.setValue(this.core.factor)},draw:function(a){var b=this.core.targets&&this.core.targets.length,c=this.core2.interleavedBuf&&!this.core2.interleavedBuf.dirty;if(this.VAO){if(a.VAO.bindVertexArrayOES(this.VAO),b){if(this.VAOMorphKey1==this.core.key1&&this.VAOMorphKey2==this.core.key2)return void this.setDrawMorphFactor()}else if(c||!this.VAOHasInterleavedBuf)return}else a.VAO&&(a.VAO.bindVertexArrayOES(null),this.VAO=a.VAO.createVertexArrayOES(),a.VAO.bindVertexArrayOES(this.VAO));b?this.morphDraw():c?(this.VAOHasInterleavedBuf=!0,this.core2.interleavedBuf.bind(),this._aVertexDraw&&this._aVertexDraw.bindInterleavedFloatArrayBuffer(3,this.core2.interleavedStride,this.core2.interleavedPositionOffset),this._aNormalDraw&&this._aNormalDraw.bindInterleavedFloatArrayBuffer(3,this.core2.interleavedStride,this.core2.interleavedNormalOffset),this._aUVDraw&&this._aUVDraw.bindInterleavedFloatArrayBuffer(2,this.core2.interleavedStride,this.core2.interleavedUVOffset),this._aUV2Draw&&this._aUV2Draw.bindInterleavedFloatArrayBuffer(2,this.core2.interleavedStride,this.core2.interleavedUV2Offset),this._aColorDraw&&this._aColorDraw.bindInterleavedFloatArrayBuffer(4,this.core2.interleavedStride,this.core2.interleavedColorOffset),this._aTangentDraw&&this._aTangentDraw.bindFloatArrayBuffer(this.core2.tangentBuf||this.core2.getTangents())):(this.VAOHasInterleavedBuf=!1,this._aVertexDraw&&this._aVertexDraw.bindFloatArrayBuffer(this.core2.vertexBuf),this._aNormalDraw&&this._aNormalDraw.bindFloatArrayBuffer(this.core2.normalBuf),this._aUVDraw&&this._aUVDraw.bindFloatArrayBuffer(this.core2.uvBuf),this._aUV2Draw&&this._aUV2Draw.bindFloatArrayBuffer(this.core2.uvBuf2),this._aColorDraw&&this._aColorDraw.bindFloatArrayBuffer(this.core2.colorBuf),this._aTangentDraw&&this._aTangentDraw.bindFloatArrayBuffer(this.core2.tangentBuf||this.core2.getTangents())),this._aRegionMapUVDraw&&this._aRegionMapUVDraw.bindFloatArrayBuffer(this.core2.uvBuf),this.core2.indexBuf.bind()},morphPick:function(a){var b=this.core,c=this.core2,d=b.targets[b.key1],e=b.targets[b.key2];if(a.pickObject||a.pickRegion)this._aMorphVertexPick?(this._aVertexPick.bindFloatArrayBuffer(d.vertexBuf),this._aMorphVertexPick.bindFloatArrayBuffer(e.vertexBuf)):this._aVertexPick&&this._aVertexPick.bindFloatArrayBuffer(c.vertexBuf),c.indexBuf.bind();else if(a.pickTriangle)if(this._aMorphVertexPick){var f=b.getPickPositions(b.key1,c.arrays.indices);f&&this._aVertexPick.bindFloatArrayBuffer(f),f=b.getPickPositions(b.key2,c.arrays.indices),f&&this._aMorphVertexPick.bindFloatArrayBuffer(f),this._aColorPick&&this._aColorPick.bindFloatArrayBuffer(c.getPickColors());var g=c.getPickIndices();g&&g.bind()}else this._aVertexPick&&(this._aVertexPick.bindFloatArrayBuffer(c.vertexBuf),c.indexBuf.bind());this._uMorphFactorPick&&this._uMorphFactorPick.setValue(b.factor)},pick:function(a){var b=this.core,c=this.core2;if(b.targets&&b.targets.length)this.morphPick(a);else if(a.pickObject||a.pickRegion)this._aVertexPick&&this._aVertexPick.bindFloatArrayBuffer(c.vertexBuf),this._aRegionMapUVPick&&this._aRegionMapUVPick.bindFloatArrayBuffer(c.uvBuf),c.indexBuf.bind();else if(a.pickTriangle){this._aVertexPick&&this._aVertexPick.bindFloatArrayBuffer(c.getPickPositions()),this._aColorPick&&this._aColorPick.bindFloatArrayBuffer(c.getPickColors());var d=c.getPickIndices();d&&d.bind()}}}),SceneJS_ChunkFactory.createChunkType({type:"lights",build:function(){this._uAmbientColor=this._uAmbientColor||[],this._uLightColor=this._uLightColor||[],this._uLightDir=this._uLightDir||[],this._uLightPos=this._uLightPos||[],this._uLightCutOff=this._uLightCutOff||[],this._uLightSpotExp=this._uLightSpotExp||[],this._uLightAttenuation=this._uLightAttenuation||[];for(var a=this.core.lights,b=this.program,c=0,d=a.length;d>c;c++)switch(a[c].mode){case"ambient":this._uAmbientColor[c]=b.draw.getUniform("SCENEJS_uAmbientColor");break;case"dir":this._uLightColor[c]=b.draw.getUniform("SCENEJS_uLightColor"+c),this._uLightPos[c]=null,this._uLightDir[c]=b.draw.getUniform("SCENEJS_uLightDir"+c);break;case"point":this._uLightColor[c]=b.draw.getUniform("SCENEJS_uLightColor"+c),this._uLightPos[c]=b.draw.getUniform("SCENEJS_uLightPos"+c),this._uLightDir[c]=null,this._uLightAttenuation[c]=b.draw.getUniform("SCENEJS_uLightAttenuation"+c)}},draw:function(a){a.dirty&&this.build();for(var b,c=this.core.lights,d=(this.program.gl,0),e=c.length;e>d;d++)b=c[d],this._uAmbientColor[d]?this._uAmbientColor[d].setValue(b.color):(this._uLightColor[d]&&this._uLightColor[d].setValue(b.color),this._uLightPos[d]&&(this._uLightPos[d].setValue(b.pos),this._uLightAttenuation[d]&&this._uLightAttenuation[d].setValue(b.attenuation)),this._uLightDir[d]&&this._uLightDir[d].setValue(b.dir))}}),SceneJS_ChunkFactory.createChunkType({type:"listeners",programGlobal:!0,build:function(){},draw:function(a){for(var b=this.core.listeners,c=a.renderListenerCtx,d=b.length-1;d>=0;d--)if(b[d](c)===!0)return!0}}),SceneJS_ChunkFactory.createChunkType({type:"lookAt",build:function(){this._uvMatrixDraw=this.program.draw.getUniform("SCENEJS_uVMatrix"),this._uVNMatrixDraw=this.program.draw.getUniform("SCENEJS_uVNMatrix"),this._uWorldEyeDraw=this.program.draw.getUniform("SCENEJS_uWorldEye"),this._uvMatrixPick=this.program.pick.getUniform("SCENEJS_uVMatrix")},draw:function(a){this.core.dirty&&this.core.rebuild();this.program.gl;this._uvMatrixDraw&&this._uvMatrixDraw.setValue(this.core.mat),this._uVNMatrixDraw&&this._uVNMatrixDraw.setValue(this.core.normalMat),this._uWorldEyeDraw&&this._uWorldEyeDraw.setValue(this.core.lookAt.eye),a.viewMat=this.core.mat},pick:function(a){this.program.gl;this._uvMatrixPick&&this._uvMatrixPick.setValue(this.core.mat),a.viewMat=this.core.mat}}),SceneJS_ChunkFactory.createChunkType({type:"material",build:function(){var a=this.program.draw;this._uMaterialBaseColor=a.getUniform("SCENEJS_uMaterialColor"),this._uMaterialSpecularColor=a.getUniform("SCENEJS_uMaterialSpecularColor"),this._uMaterialEmitColor=a.getUniform("SCENEJS_uMaterialEmitColor"),this._uMaterialSpecular=a.getUniform("SCENEJS_uMaterialSpecular"),this._uMaterialShine=a.getUniform("SCENEJS_uMaterialShine"),this._uMaterialEmit=a.getUniform("SCENEJS_uMaterialEmit"),this._uMaterialAlpha=a.getUniform("SCENEJS_uMaterialAlpha")},draw:function(){this.program.gl;this._uMaterialBaseColor&&this._uMaterialBaseColor.setValue(this.core.baseColor),this._uMaterialSpecularColor&&this._uMaterialSpecularColor.setValue(this.core.specularColor),this._uMaterialEmitColor&&this._uMaterialEmitColor.setValue(this.core.emitColor),this._uMaterialSpecular&&this._uMaterialSpecular.setValue(this.core.specular),this._uMaterialShine&&this._uMaterialShine.setValue(this.core.shine),this._uMaterialEmit&&this._uMaterialEmit.setValue(this.core.emit),this._uMaterialAlpha&&this._uMaterialAlpha.setValue(this.core.alpha)}}),SceneJS_ChunkFactory.createChunkType({type:"program",build:function(){this._depthModeDraw=this.program.draw.getUniform("SCENEJS_uDepthMode"),this._pickMode=this.program.pick.getUniform("SCENEJS_uPickMode")},draw:function(a){var b=this.program.draw;b.bind(),a.textureUnit=0;var c=this.program.gl;if(this._depthModeDraw&&this._depthModeDraw.setValue(a.depthMode),!a.VAO)for(var d=0;10>d;d++)c.disableVertexAttribArray(d);a.drawProgram=this.program.draw},pick:function(a){var b=this.program.pick;b.bind();var c=this.program.gl;this._pickMode.setValue(a.pickObject?0:a.pickTriangle?1:2),a.textureUnit=0;for(var d=0;10>d;d++)c.disableVertexAttribArray(d)}}),SceneJS_ChunkFactory.createChunkType({type:"renderer",build:function(){},drawAndPick:function(a){if(this.core.props){var b=this.program.gl;a.renderer&&(a.renderer.props.restoreProps(b),a.renderer=this.core),this.core.props.setProps(b)}}}),SceneJS_ChunkFactory.createChunkType({type:"regionMap",build:function(){this._uRegionMapRegionColor=this.program.draw.getUniform("SCENEJS_uRegionMapRegionColor"),this._uRegionMapHighlightFactor=this.program.draw.getUniform("SCENEJS_uRegionMapHighlightFactor"),this._uRegionMapHideAlpha=this.program.draw.getUniform("SCENEJS_uRegionMapHideAlpha"),this._uRegionMapSampler="SCENEJS_uRegionMapSampler"},draw:function(a){var b=this.core.texture;b&&(this.program.draw.bindTexture(this._uRegionMapSampler,b,a.textureUnit),a.textureUnit=(a.textureUnit+1)%SceneJS.WEBGL_INFO.MAX_TEXTURE_UNITS);var c=this.program.gl,d="hide"===this.core.mode||"isolate"===this.core.mode;a.transparent!=d&&(d?(c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA),a.blendEnabled=!0):(c.disable(c.BLEND),a.blendEnabled=!1),a.transparent=d),this._uRegionMapRegionColor&&this._uRegionMapRegionColor.setValue(this.core.regionColor),this._uRegionMapHighlightFactor&&this._uRegionMapHighlightFactor.setValue(this.core.highlightFactor),this._uRegionMapHideAlpha&&this._uRegionMapHideAlpha.setValue(this.core.hideAlpha)},pick:function(a){var b=this.core.texture;b&&(a.regionData=this.core.regionData,a.textureUnit=0,this.program.pick.bindTexture(this._uRegionMapSampler,b,a.textureUnit),a.textureUnit=(a.textureUnit+1)%SceneJS.WEBGL_INFO.MAX_TEXTURE_UNITS)}}),SceneJS_ChunkFactory.createChunkType({type:"depthBuffer",programGlobal:!0,drawAndPick:function(a){var b=this.program.gl,c=this.core.enabled;a.depthbufEnabled!=c&&(c?b.enable(b.DEPTH_TEST):b.disable(b.DEPTH_TEST),a.depthbufEnabled=c);var d=this.core.clearDepth;a.clearDepth!=d&&(b.clearDepth(d),a.clearDepth=d);var e=this.core.depthFunc;a.depthFunc!=e&&(b.depthFunc(e),a.depthFunc=e),this.core.clear&&b.clear(b.DEPTH_BUFFER_BIT)}}),SceneJS_ChunkFactory.createChunkType({type:"colorBuffer",programGlobal:!0,build:function(){},drawAndPick:function(a){if(!a.transparent){var b=this.core.blendEnabled,c=this.program.gl;a.blendEnabled!=b&&(b?c.enable(c.BLEND):c.disable(c.BLEND),a.blendEnabled=b);var d=this.core.colorMask;c.colorMask(d.r,d.g,d.b,d.a)}}}),SceneJS_ChunkFactory.createChunkType({type:"view",programGlobal:!0,build:function(){},drawAndPick:function(a){var b=this.core.scissorTestEnabled;if(a.scissorTestEnabled!=b){var c=this.program.gl;b?c.enable(c.SCISSOR_TEST):c.disable(c.SCISSOR_TEST),a.scissorTestEnabled=b}}}),SceneJS_ChunkFactory.createChunkType({type:"shader",build:function(){},drawAndPick:function(a){var b=this.core.paramsStack;if(b)for(var c,d,e=a.picking?this.program.pick:this.program.draw,f=0,g=b.length;g>f;f++){c=b[f];for(d in c)c.hasOwnProperty(d)&&e.setUniform(d,c[d])}}}),SceneJS_ChunkFactory.createChunkType({type:"shaderParams",build:function(){},drawAndPick:function(a){var b=this.core.paramsStack;if(b)for(var c,d,e=a.picking?this.program.pick:this.program.draw,f=0,g=b.length;g>f;f++){c=b[f];for(d in c)c.hasOwnProperty(d)&&e.setUniform(d,c[d])}}}),SceneJS_ChunkFactory.createChunkType({type:"style",programGlobal:!0,drawAndPick:function(a){var b=this.core.lineWidth;if(a.lineWidth!=b){var c=this.program.gl;c.lineWidth(b),a.lineWidth=b}}}),SceneJS_ChunkFactory.createChunkType({type:"texture",build:function(){this._uTexSampler=this._uTexSampler||[],this._uTexMatrix=this._uTexMatrix||[],this._uTexBlendFactor=this._uTexBlendFactor||[];var a=this.core.layers;if(a)for(var b,c=this.program.draw,d=0,e=a.length;e>d;d++)b=a[d],this._uTexSampler[d]="SCENEJS_uSampler"+d,this._uTexMatrix[d]=c.getUniform("SCENEJS_uLayer"+d+"Matrix"),this._uTexBlendFactor[d]=c.getUniform("SCENEJS_uLayer"+d+"BlendFactor")},draw:function(a){a.textureUnit=0;var b=this.core.layers;if(b)for(var c,d=this.program.draw,e=0,f=b.length;f>e;e++)c=b[e],this._uTexSampler[e]&&c.texture&&(d.bindTexture(this._uTexSampler[e],c.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%SceneJS.WEBGL_INFO.MAX_TEXTURE_UNITS,c._matrixDirty&&c.buildMatrix&&c.buildMatrix.call(c),this._uTexMatrix[e]&&this._uTexMatrix[e].setValue(c.matrixAsArray),this._uTexBlendFactor[e]&&this._uTexBlendFactor[e].setValue(c.blendFactor))}}),SceneJS_ChunkFactory.createChunkType({type:"decal",build:function(){var a=this.program.draw;this._uDecalSampler="SCENEJS_uDecalSampler",this._uDecalMatrix=a.getUniform("SCENEJS_uDecalMatrix"),this._uDecalBlendFactor=a.getUniform("SCENEJS_uDecalBlendFactor")},draw:function(a){var b=this.core;if(this._uDecalSampler&&b.texture){var c=this.program.draw;c.bindTexture(this._uDecalSampler,b.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%SceneJS.WEBGL_INFO.MAX_TEXTURE_UNITS,b._matrixDirty&&b.buildMatrix&&b.buildMatrix.call(b),this._uDecalMatrix&&this._uDecalMatrix.setValue(b.matrixAsArray),this._uDecalBlendFactor&&this._uDecalBlendFactor.setValue(b.blendFactor)}}}),SceneJS_ChunkFactory.createChunkType({type:"fresnel",build:function(){var a=this.program.draw,b=this.core;b.diffuse&&(this._uDiffuseFresnelCenterBias=a.getUniform("SCENEJS_uDiffuseFresnelCenterBias"),this._uDiffuseFresnelEdgeBias=a.getUniform("SCENEJS_uDiffuseFresnelEdgeBias"),this._uDiffuseFresnelPower=a.getUniform("SCENEJS_uDiffuseFresnelPower"),this._uDiffuseFresnelCenterColor=a.getUniform("SCENEJS_uDiffuseFresnelCenterColor"),this._uDiffuseFresnelEdgeColor=a.getUniform("SCENEJS_uDiffuseFresnelEdgeColor")),b.specular&&(this._uSpecularFresnelCenterBias=a.getUniform("SCENEJS_uSpecularFresnelCenterBias"),this._uSpecularFresnelEdgeBias=a.getUniform("SCENEJS_uSpecularFresnelEdgeBias"),this._uSpecularFresnelPower=a.getUniform("SCENEJS_uSpecularFresnelPower"),this._uSpecularFresnelCenterColor=a.getUniform("SCENEJS_uSpecularFresnelCenterColor"),this._uSpecularFresnelEdgeColor=a.getUniform("SCENEJS_uSpecularFresnelEdgeColor")),b.alpha&&(this._uAlphaFresnelCenterBias=a.getUniform("SCENEJS_uAlphaFresnelCenterBias"),this._uAlphaFresnelEdgeBias=a.getUniform("SCENEJS_uAlphaFresnelEdgeBias"),this._uAlphaFresnelPower=a.getUniform("SCENEJS_uAlphaFresnelPower"),this._uAlphaFresnelCenterColor=a.getUniform("SCENEJS_uAlphaFresnelCenterColor"),this._uAlphaFresnelEdgeColor=a.getUniform("SCENEJS_uAlphaFresnelEdgeColor")),b.reflect&&(this._uReflectFresnelCenterBias=a.getUniform("SCENEJS_uReflectFresnelCenterBias"),this._uReflectFresnelEdgeBias=a.getUniform("SCENEJS_uReflectFresnelEdgeBias"),this._uReflectFresnelPower=a.getUniform("SCENEJS_uReflectFresnelPower"),this._uReflectFresnelCenterColor=a.getUniform("SCENEJS_uReflectFresnelCenterColor"),this._uReflectFresnelEdgeColor=a.getUniform("SCENEJS_uReflectFresnelEdgeColor")),b.emit&&(this._uEmitFresnelCenterBias=a.getUniform("SCENEJS_uEmitFresnelCenterBias"),this._uEmitFresnelEdgeBias=a.getUniform("SCENEJS_uEmitFresnelEdgeBias"),this._uEmitFresnelPower=a.getUniform("SCENEJS_uEmitFresnelPower"),this._uEmitFresnelCenterColor=a.getUniform("SCENEJS_uEmitFresnelCenterColor"),this._uEmitFresnelEdgeColor=a.getUniform("SCENEJS_uEmitFresnelEdgeColor")),b.fragment&&(this._uFragmentFresnelCenterBias=a.getUniform("SCENEJS_uFragmentFresnelCenterBias"),this._uFragmentFresnelEdgeBias=a.getUniform("SCENEJS_uFragmentFresnelEdgeBias"),this._uFragmentFresnelPower=a.getUniform("SCENEJS_uFragmentFresnelPower"),this._uFragmentFresnelCenterColor=a.getUniform("SCENEJS_uFragmentFresnelCenterColor"),this._uFragmentFresnelEdgeColor=a.getUniform("SCENEJS_uFragmentFresnelEdgeColor"))},draw:function(){var a=(this.program.gl,this.core);a.diffuse&&(this._uDiffuseFresnelCenterBias&&this._uDiffuseFresnelCenterBias.setValue(a.diffuse.centerBias),this._uDiffuseFresnelEdgeBias&&this._uDiffuseFresnelEdgeBias.setValue(a.diffuse.edgeBias),this._uDiffuseFresnelPower&&this._uDiffuseFresnelPower.setValue(a.diffuse.power),this._uDiffuseFresnelCenterColor&&this._uDiffuseFresnelCenterColor.setValue(a.diffuse.centerColor),this._uDiffuseFresnelEdgeColor&&this._uDiffuseFresnelEdgeColor.setValue(a.diffuse.edgeColor)),a.specular&&(this._uSpecularFresnelCenterBias&&this._uSpecularFresnelCenterBias.setValue(a.specular.centerBias),this._uSpecularFresnelEdgeBias&&this._uSpecularFresnelEdgeBias.setValue(a.specular.edgeBias),this._uSpecularFresnelPower&&this._uSpecularFresnelPower.setValue(a.specular.power),this._uSpecularFresnelCenterColor&&this._uSpecularFresnelCenterColor.setValue(a.specular.centerColor),this._uSpecularFresnelEdgeColor&&this._uSpecularFresnelEdgeColor.setValue(a.specular.edgeColor)),a.alpha&&(this._uAlphaFresnelCenterBias&&this._uAlphaFresnelCenterBias.setValue(a.alpha.centerBias),this._uAlphaFresnelEdgeBias&&this._uAlphaFresnelEdgeBias.setValue(a.alpha.edgeBias),this._uAlphaFresnelPower&&this._uAlphaFresnelPower.setValue(a.alpha.power),this._uAlphaFresnelCenterColor&&this._uAlphaFresnelCenterColor.setValue(a.alpha.centerColor),this._uAlphaFresnelEdgeColor&&this._uAlphaFresnelEdgeColor.setValue(a.alpha.edgeColor)),a.reflect&&(this._uReflectFresnelCenterBias&&this._uReflectFresnelCenterBias.setValue(a.reflect.centerBias),
this._uReflectFresnelEdgeBias&&this._uReflectFresnelEdgeBias.setValue(a.reflect.edgeBias),this._uReflectFresnelPower&&this._uReflectFresnelPower.setValue(a.reflect.power),this._uReflectFresnelCenterColor&&this._uReflectFresnelCenterColor.setValue(a.reflect.centerColor),this._uReflectFresnelEdgeColor&&this._uReflectFresnelEdgeColor.setValue(a.reflect.edgeColor)),a.emit&&(this._uEmitFresnelCenterBias&&this._uEmitFresnelCenterBias.setValue(a.emit.centerBias),this._uEmitFresnelEdgeBias&&this._uEmitFresnelEdgeBias.setValue(a.emit.edgeBias),this._uEmitFresnelPower&&this._uEmitFresnelPower.setValue(a.emit.power),this._uEmitFresnelCenterColor&&this._uEmitFresnelCenterColor.setValue(a.emit.centerColor),this._uEmitFresnelEdgeColor&&this._uEmitFresnelEdgeColor.setValue(a.emit.edgeColor)),a.fragment&&(this._uFragmentFresnelCenterBias&&this._uFragmentFresnelCenterBias.setValue(a.fragment.centerBias),this._uFragmentFresnelEdgeBias&&this._uFragmentFresnelEdgeBias.setValue(a.fragment.edgeBias),this._uFragmentFresnelPower&&this._uFragmentFresnelPower.setValue(a.fragment.power),this._uFragmentFresnelCenterColor&&this._uFragmentFresnelCenterColor.setValue(a.fragment.centerColor),this._uFragmentFresnelEdgeColor&&this._uFragmentFresnelEdgeColor.setValue(a.fragment.edgeColor))}}),SceneJS_ChunkFactory.createChunkType({type:"cubemap",build:function(){this._uCubeMapSampler=this._uCubeMapSampler||[],this._uCubeMapIntensity=this._uCubeMapIntensity||[];var a=this.core.layers;if(a)for(var b,c=this.program.draw,d=0,e=a.length;e>d;d++)b=a[d],this._uCubeMapSampler[d]="SCENEJS_uCubeMapSampler"+d,this._uCubeMapIntensity[d]=c.getUniform("SCENEJS_uCubeMapIntensity"+d)},draw:function(a){var b=this.core.layers;if(b)for(var c,d=this.program.draw,e=0,f=b.length;f>e;e++)c=b[e],this._uCubeMapSampler[e]&&c.texture&&(d.bindTexture(this._uCubeMapSampler[e],c.texture,a.textureUnit),a.textureUnit=(a.textureUnit+1)%SceneJS.WEBGL_INFO.MAX_TEXTURE_UNITS,this._uCubeMapIntensity[e]&&this._uCubeMapIntensity[e].setValue(c.intensity))}}),SceneJS_ChunkFactory.createChunkType({type:"xform",build:function(){var a=this.program.draw;this._uMatLocationDraw=a.getUniform("SCENEJS_uMMatrix"),this._uNormalMatLocationDraw=a.getUniform("SCENEJS_uMNMatrix");var b=this.program.pick;this._uMatLocationPick=b.getUniform("SCENEJS_uMMatrix")},draw:function(a){(SceneJS_configsModule.configs.forceXFormCoreRebuild===!0||this.core.dirty&&this.core.build)&&this.core.build();this.program.gl;this._uMatLocationDraw&&this._uMatLocationDraw.setValue(this.core.mat),this._uNormalMatLocationDraw&&this._uNormalMatLocationDraw.setValue(this.core.normalMat),a.modelMat=this.core.mat},pick:function(a){this.core.dirty&&this.core.build();this.program.gl;this._uMatLocationPick&&this._uMatLocationPick.setValue(this.core.mat),a.modelMat=this.core.mat}}),SceneJS.configure({pluginPath:location.origin+location.pathname.substring(0,location.pathname.lastIndexOf("/"))+"/lib/scenejs/plugins"}),function(){function a(a){var b,c,d;a.size?(b=a.size[0],c=a.size[1],d=a.size[2]):(b=a.xSize||1,c=a.ySize||1,d=a.zSize||1);var e="geometry/box_"+b+"_"+c+"_"+d+(a.wire?"wire":"_solid");return this.getScene().hasCore("geometry",e)?{type:"geometry",coreId:e}:{type:"geometry",primitive:a.wire?"lines":"triangles",coreId:e,positions:new Float32Array([b,c,d,-b,c,d,-b,-c,d,b,-c,d,b,c,d,b,-c,d,b,-c,-d,b,c,-d,b,c,d,b,c,-d,-b,c,-d,-b,c,d,-b,c,d,-b,c,-d,-b,-c,-d,-b,-c,d,-b,-c,-d,b,-c,-d,b,-c,d,-b,-c,d,b,-c,-d,-b,-c,-d,-b,c,-d,b,c,-d]),normals:new Float32Array([0,0,1,0,0,1,0,0,1,0,0,1,1,0,0,1,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1]),uv:new Float32Array([b,c,0,c,0,0,b,0,0,c,0,0,b,0,b,c,b,0,b,c,0,c,0,0,b,c,0,c,0,0,b,0,0,0,b,0,b,c,0,c,0,0,b,0,b,c,0,c]),indices:new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23])}}SceneJS.Types.addType("geometry/box",{construct:function(b){this.addNode(a.call(this,b))}})}(),function(){function a(a){var b="geometry/quad"+(a.wire?"wire":"_solid");return this.getScene().hasCore("geometry",b)?{type:"geometry",coreId:b}:{type:"geometry",primitive:a.wire?"lines":"triangles",coreId:b,positions:[1,1,0,-1,1,0,-1,-1,0,1,-1,0],normals:[-1,0,0,-1,0,0,-1,0,0,-1,0,0],uv:[1,1,0,1,0,0,1,0],indices:[0,1,2,0,2,3]}}SceneJS.Types.addType("geometry/quad",{construct:function(b){this.addNode(a.call(this,b))}})}(),function(){function a(a){var b=a.latitudeBands||30,c=a.longitudeBands||30,d=a.radius||1,e="geometry/sphere_"+(a.wire?"wire":"_solid")+d+"_"+c+"_"+b;if(this.getScene().hasCore("geometry",e))return{type:"geometry",coreId:e};for(var f=[],g=[],h=[],i=0;b>=i;i++)for(var j=i*Math.PI/b,k=Math.sin(j),l=Math.cos(j),m=0;c>=m;m++){var n=2*m*Math.PI/c,o=Math.sin(n),p=Math.cos(n),q=p*k,r=l,s=o*k,t=1-m/c,u=i/b;g.push(q),g.push(r),g.push(s),h.push(t),h.push(u),f.push(d*q),f.push(d*r),f.push(d*s)}for(var v=[],i=0;b>i;i++)for(var m=0;c>m;m++){var w=i*(c+1)+m,x=w+c+1;v.push(w+1),v.push(x+1),v.push(x),v.push(w+1),v.push(x),v.push(w)}return{type:"geometry",primitive:a.wire?"lines":"triangles",coreId:e,positions:new Float32Array(f),normals:new Float32Array(g),uv:new Float32Array(h),indices:new Uint16Array(v)}}SceneJS.Types.addType("geometry/sphere",{construct:function(b){this.addNode(a.call(this,b))}})}(),function(){function a(a){var b=a.width||1,c=a.height||1,d=a.widthSegments||1,e=a.heightSegments||1,f="geometry/plane_"+(1==a.wire?"wire_":"")+c+"_"+d+"_"+e;if(this.getScene().hasCore("geometry",f))return{type:"geometry",coreId:f};var g,h,i,j,k=[],l=[],m=[],n=[],o=b/2,p=c/2,q=d,r=e,s=q+1,t=r+1,u=b/q,v=c/r;for(h=0;t>h;h++)for(g=0;s>g;g++)i=g*u-o,j=h*v-p,k.push(i),k.push(-j),k.push(0),l.push(0),l.push(0),l.push(1),m.push(g/q),m.push(1-h/r);var w,x,y,z;for(h=0;r>h;h++)for(g=0;q>g;g++)w=g+s*h,x=g+s*(h+1),y=g+1+s*(h+1),z=g+1+s*h,n.push(w),n.push(x),n.push(y),n.push(y),n.push(z),n.push(w);return{type:"geometry",primitive:a.wire?"lines":"triangles",coreId:f,positions:new Float32Array(k),normals:new Float32Array(l),uv:new Float32Array(m),indices:new Uint16Array(n)}}SceneJS.Types.addType("geometry/plane",{construct:function(b){this.addNode(a.call(this,b))}})}(),SceneJS.Types.addType("skybox",{construct:function(a){var b=this,c=a.src,d=a.size||5e3,e=SceneJS._isArray(c),f=b.addNode({type:"shader",shaders:[{stage:"vertex",code:["mat4 myViewMatrix(mat4 m) {","   m[3][0] =m[3][1] = m[3][2] = 0.0;","return m;","}"],hooks:{viewMatrix:"myViewMatrix"}}]}),g=f.addNode({type:"flags",flags:{specular:!1,diffuse:!1,ambient:!1,picking:!1}}),h=g.addNode({type:"material",color:{r:0,g:0,b:0},emit:0}),i=h.addNode({type:"scale",x:d,y:d,z:d});e?i.addNodes([{type:"texture",src:c[0],blendMode:"add",nodes:[{type:"geometry",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1],uv:[1,0,0,0,0,1,1,1],indices:[2,1,0,3,2,0]}]},{type:"texture",src:c[1],blendMode:"add",nodes:[{type:"geometry",positions:[1,1,1,1,-1,1,1,-1,-1,1,1,-1],uv:[1,0,0,0,0,1,1,1],indices:[2,1,0,3,2,0]}]},{type:"texture",src:c[2],blendMode:"add",nodes:[{type:"geometry",positions:[1,1,1,1,1,-1,-1,1,-1,-1,1,1],uv:[1,0,0,0,0,1,1,1],indices:[2,1,0,3,2,0]}]},{type:"texture",src:c[3],blendMode:"add",nodes:[{type:"geometry",positions:[-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1],uv:[1,0,0,0,0,1,1,1],indices:[0,1,2,0,2,3]}]},{type:"texture",src:c[4],blendMode:"add",nodes:[{type:"geometry",positions:[-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1],uv:[1,0,0,0,0,1,1,1],indices:[2,1,0,3,2,0]}]},{type:"texture",src:c[5],blendMode:"add",nodes:[{type:"geometry",positions:[1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[1,0,0,0,0,1,1,1],indices:[0,1,2,0,2,3]}]}]):h.addNode({type:"texture",src:c,blendMode:"add",nodes:[{type:"scale",x:d,y:d,z:d,nodes:[{type:"geometry",positions:[1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,1,1,-1,-1,1,1,-1,1,1,1,1,1,-1,-1,1,-1,-1,1,1,-1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,1,-1,-1,-1,-1,-1,-1,1,-1,1,1,-1],uv:[.5,.6666,.25,.6666,.25,.3333,.5,.3333,.5,.6666,.5,.3333,.75,.3333,.75,.6666,.5,.6666,.5,1,.25,1,.25,.6666,.25,.6666,0,.6666,0,.3333,.25,.3333,.25,0,.5,0,.5,.3333,.25,.3333,.75,.3333,1,.3333,1,.6666,.75,.6666],indices:[0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]}]}]})}}),function(){"use strict";var a=window.Human={},b="5.4.1";b=b.indexOf("ENGINE_VERSION")>0?"qa":b,a.VERSION=b,a.deployed="localhost"===window.location.hostname||/192\.168\.11\.\d{1,3}/.test(window.location.hostname)||"file:"===window.location.protocol?!1:!0,a.CANVAS_ID="theCanvas",a.CONTAINER_ID="container",a.SCENE_ROOT_ID="bds-human",a.CONTENT_ROOT_ID="outline",a.MATERIAL_ROOT_ID="human.outline",a.NULL_OBJECT_ID="null-object",a.NULL_OBJECT_ID2="null-object-2",a.CLIP_INDICATORS_ATTACH_ID="clip-indicators",a.CLIP_ATTACH_ID="clips",a.LOOKAT_ID="theLookat",a.CAMERA_ID="theCamera",a.VIEW_SPACE_ID="viewSpace";var c=[];a.onError=function(a){c.push(a)},a.error=function(b,c){return"string"==typeof b&&(c=b,b="ERROR"),a._error("ERROR",b,c,!1)},a._error=function(b,d,e,f){for(var g={errorName:b,code:d,exception:e,fatal:f},h=0,i=c.length;i>h;h++)c[h](g);return a.events.fire("error",{name:b,code:d,message:e,fatal:f}),e},a.fatalError=function(b,c){return"string"==typeof b&&(c=b,b="ERROR"),a._error("ERROR",b,c,!0)}}(),function(){"use strict";Human.Component=function(){},Human.Component.prototype={_init:function(a){this._ctx=a,this._handleMap=new Human.utils.Map,this._topicSubs={},this._handleTopics={},this._topicPubs={}},publish:function(a,b,c){c||(this._topicPubs[a]=b);var d=this._topicSubs[a];if(d)for(var e in d)d.hasOwnProperty(e)&&d[e].call(this,b)},on:function(a,b){var c=this._topicSubs[a];c||(c={},this._topicSubs[a]=c);var d=this._handleMap.addItem();c[d]=b,this._handleTopics[d]=a;var e=this._topicPubs[a];return e&&b.call(this,e),d},off:function(a){var b=this._handleTopics[a];if(b){delete this._handleTopics[a];var c=this._topicSubs[b];c&&delete c[a],this._handleMap.removeItem(a)}},once:function(a,b){var c=this,d=this.on(a,function(a){c.off(d),b(a)})}}}(),function(){"use strict";var a=window.Human=window.Human||{},b=a.webglInfo={canvas:!1,webgl:!1,webWorkers:"function"==typeof window.Worker,antialiasing:!1,fsMaxFloatPrecision:null,depthBufferBits:0,maxTextureSize:0,maxCubeMapSize:0,maxRenderBufferSize:0,maxVSTextureUnits:0,maxFSTextureUnits:0,maxCombinedTextureUnits:0,maxVertexAttributes:0,maxVSUniformVectors:0,maxFSUniformVectors:0,maxVaryingVectors:0,supportedExtensions:{ANGLE_instanced_arrays:!1,EXT_blend_minmax:!1,EXT_color_buffer_float:!1,EXT_color_buffer_half_float:!1,EXT_disjoint_timer_query:!1,EXT_float_blend:!1,EXT_frag_depth:!1,EXT_sRGB:!1,EXT_shader_texture_lod:!1,EXT_texture_filter_anisotropic:!1,OES_element_index_uint:!1,OES_fbo_render_mipmap:!1,OES_standard_derivatives:!1,OES_texture_float:!1,OES_texture_float_linear:!1,OES_texture_half_float:!1,OES_texture_half_float_linear:!1,OES_vertex_array_object:!1,WEBGL_color_buffer_float:!1,WEBGL_compressed_texture_astc_ldr:!1,WEBGL_compressed_texture_atc:!1,WEBGL_compressed_texture_es3:!1,WEBGL_compressed_texture_etc1:!1,WEBGL_compressed_texture_pvrtc:!1,WEBGL_compressed_texture_s3tc:!1,WEBGL_debug_renderer_info:!1,WEBGL_debug_shaders:!1,WEBGL_depth_texture:!1,WEBGL_draw_buffers:!1,WEBGL_dynamic_texture:!1,WEBGL_lose_context:!1,WEBGL_security_sensitive_resources:!1,WEBGL_shared_resources:!1,WEBGL_subscribe_uniform:!1}};!function(){var a=document.createElement("canvas");if(a){b.canvas=!0;var c=a.getContext("webgl",{antialias:!0})||a.getContext("experimental-webgl",{antialias:!0});c&&(b.webgl=!0,b.antialiasing=c.getContextAttributes().antialias,c.getShaderPrecisionFormat&&(b.fsMaxFloatPrecision=c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.HIGH_FLOAT).precision>0?"highp":c.getShaderPrecisionFormat(c.FRAGMENT_SHADER,c.MEDIUM_FLOAT).precision>0?"mediump":"lowp"),b.depthBufferBits=c.getParameter(c.DEPTH_BITS),b.maxTextureSize=c.getParameter(c.MAX_TEXTURE_SIZE),b.maxCubeMapSize=c.getParameter(c.MAX_CUBE_MAP_TEXTURE_SIZE),b.maxRenderBufferSize=c.getParameter(c.MAX_RENDERBUFFER_SIZE),b.maxVSTextureUnits=c.getParameter(c.MAX_VERTEX_TEXTURE_IMAGE_UNITS),b.maxFSTextureUnits=c.getParameter(c.MAX_TEXTURE_IMAGE_UNITS),b.maxCombinedTextureUnits=c.getParameter(c.MAX_COMBINED_TEXTURE_IMAGE_UNITS),b.maxVertexAttributes=c.getParameter(c.MAX_VERTEX_ATTRIBS),b.maxVSUniformVectors=c.getParameter(c.MAX_VERTEX_UNIFORM_VECTORS),b.maxFSUniformVectors=c.getParameter(c.MAX_FRAGMENT_UNIFORM_VECTORS),b.maxVaryingVectors=c.getParameter(c.MAX_VARYING_VECTORS),c.getSupportedExtensions().forEach(function(a){void 0!==b.supportedExtensions[a]&&(b.supportedExtensions[a]=!0)}))}}(),b.send=function(a,c){c=c||"POST",a=a||"/ws/user/analytics/webglstats";var d=new XMLHttpRequest;d.open(c,a),d.setRequestHeader("Content-Type","application/x-www-form-urlencoded; charset=UTF-8"),d.send("analytic_data="+encodeURIComponent(JSON.stringify(b)))}}(),function(){"use strict";function a(a,b){return b>a?-1:a>b?1:0}Human.utils=Human.utils||{},Human.utils.isArray=function(a){return a&&!a.propertyIsEnumerable("length")&&"object"==typeof a&&"number"==typeof a.length},Human.utils.isObject=function(a){return!!a&&"[object Object]"===Object.prototype.toString.call(a)},Human.utils.isPrimitive=function(a){return null===a||!!(typeof a).match(/^(string|number|boolean|undefined)$/)},Human.utils.isString=function(a){return"string"==typeof a||a instanceof String},Human.utils.extend=function(a,b){var c=function(){};c.prototype=b.prototype,a.prototype=new c,a.prototype.constructor=a},Human.utils.apply=function(a,b){for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},Human.utils.applyIf=function(a,b){for(var c in a)a.hasOwnProperty(c)&&(void 0===b[c]||null===b[c])&&(b[c]=a[c]);return b},Human.utils.applyIf2=function(a,b){a=a||{};var c={};for(var d in b)b.hasOwnProperty(d)&&(c[d]=void 0!==a[d]?a[d]:b[d]);return c},Human.utils.shallowClone=function(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b},Human.utils.isEmpty=function(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0},Human.utils.getDir=function(a){var b=a.lastIndexOf("/");return b>-1?a.substring(0,b>0?b+1:0):""},Human.utils.async=function(a){setTimeout(a,0)},Human.utils.noop=function(){},Human.utils.getKeys=function(a){var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b},Human.utils.createUUID=function(){for(var a=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F"],b=["8","9","A","B"],c=[],d=0;38>d;d++)switch(d){case 8:c.push("-");break;case 13:c.push("-");break;case 18:c.push("-");break;case 14:c.push("4");break;case 19:c.push(b[Math.round(3*Math.random())]);break;default:c.push(a[Math.round(15*Math.random())])}return c.join("")},Human.utils.binarySearch=function(b,c,d,e){d=d||a,e=e||{index1:null,index2:null,value1:null,value2:null};var f,g,h,i=0,j=b.length-1;if(d(b[0],c)>0)return e.index1=null,e.value1=null,e.index2=0,e.value2=b[0],e;if(d(b[j],c)<0)return e.index1=j,e.value1=b[j],e.index2=null,e.value2=null,e;for(;j>=i;){if(f=Math.floor((i+j)/2),g=b[f],h=b[f+1],d(g,c)<=0&&d(h,c)>=0)return e.index1=f,e.index2=f+1,e.value1=g,e.value2=h,e;d(g,c)>0?j=f-1:i=f+1}}}(),function(){"use strict";var a=Human.math={},b=new Float64Array(4),c=new Float64Array(16);a.clamp=function(a,b,c){return b>a?b:a>c?c:a},a.vec2=function(){return new Float64Array(2)},a.vec3=function(){return new Float64Array(3)},a.vec4=function(){return new Float64Array(4)},a.mat3=function(){return new Float64Array(9)},a.mat4=function(){return new Float64Array(16)},a.setVec=function(b,c){var d,e,f=c||a.vec4();for(d=0,e=f.length;e>d;d++)f[d]=b;return f},a.zeroVec=function(b){return a.setVec(0,b)},a.divVec3=function(b,c,d){var e=d||a.vec3();return e[0]=b[0]/c[0],e[1]=b[1]/c[1],e[2]=b[2]/c[2],e},a.negateVector4=function(b,c){var d=c||a.vec4();return d[0]=-b[0],d[1]=-b[1],d[2]=-b[2],d[3]=-b[3],d},a.addVec4=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]+c[0],e[1]=b[1]+c[1],e[2]=b[2]+c[2],e[3]=b[3]+c[3],e},a.addVec4s=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]+c,e[1]=b[1]+c,e[2]=b[2]+c,e[3]=b[3]+c,e},a.addScalarVec4=function(b,c,d){return a.addVec4s(c,b,d)},a.addVec3=function(b,c,d){var e=d||a.vec3();return e[0]=b[0]+c[0],e[1]=b[1]+c[1],e[2]=b[2]+c[2],e},a.addVec3s=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]+c,e[1]=b[1]+c,e[2]=b[2]+c,e},a.subVec4=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]-c[0],e[1]=b[1]-c[1],e[2]=b[2]-c[2],e[3]=b[3]-c[3],e},a.subVec3=function(b,c,d){var e=d||a.vec3();return e[0]=b[0]-c[0],e[1]=b[1]-c[1],e[2]=b[2]-c[2],e},a.lerpVec3=function(b,c,d,e,f,g){g=g||a.vec3();var h=(b-c)/(d-c);return g[0]=e[0]+h*(f[0]-e[0]),g[1]=e[1]+h*(f[1]-e[1]),g[2]=e[2]+h*(f[2]-e[2]),g},a.lerpVec2=function(b,c,d,e,f,g){var h=g||a.vec2(),i=(b-c)/(d-c);return h[0]=e[0]+i*(f[0]-e[0]),h[1]=e[1]+i*(f[1]-e[1]),h},a.negateVector3=function(b,c){var d=c||a.vec3();return d[0]=-b[0],d[1]=-b[1],d[2]=-b[2],d},a.subVec2=function(b,c,d){var e=d||a.vec2();return e[0]=b[0]-c[0],e[1]=b[1]-c[1],e},a.subVec4Scalar=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]-c,e[1]=b[1]-c,e[2]=b[2]-c,e[3]=b[3]-c,e},a.subScalarVec4=function(b,c,d){var e=d||a.vec4();return e[0]=c-b[0],e[1]=c-b[1],e[2]=c-b[2],e[3]=c-b[3],e},a.mulVec4=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]*c[0],e[1]=b[1]*c[1],e[2]=b[2]*c[2],e[3]=b[3]*c[3],e},a.mulVec4Scalar=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]*c,e[1]=b[1]*c,e[2]=b[2]*c,e[3]=b[3]*c,e},a.mulVec3Scalar=function(b,c,d){var e=d||a.vec3();return e[0]=b[0]*c,e[1]=b[1]*c,e[2]=b[2]*c,e},a.mulVec2Scalar=function(b,c,d){var e=d||a.vec2();return e[0]=b[0]*c,e[1]=b[1]*c,e},a.divVec4=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]/c[0],e[1]=b[1]/c[1],e[2]=b[2]/c[2],e[3]=b[3]/c[3],e},a.divScalarVec3=function(b,c,d){var e=d||a.vec3();return e[0]=b/c[0],e[1]=b/c[1],e[2]=b/c[2],e},a.divVec3s=function(b,c,d){var e=d||a.vec3();return e[0]=b[0]/c,e[1]=b[1]/c,e[2]=b[2]/c,e},a.divVec4s=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]/c,e[1]=b[1]/c,e[2]=b[2]/c,e[3]=b[3]/c,e},a.divScalarVec4=function(b,c,d){var e=d||a.vec4();return e[0]=b/c[0],e[1]=b/c[1],e[2]=b/c[2],e[3]=b/c[3],e},a.dotVector4=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]+a[3]*b[3]},a.cross3Vec4=function(c,d,e){var f=e||a.vec4();return b[0]=c[1]*d[2]-c[2]*d[1],b[1]=c[2]*d[0]-c[0]*d[2],b[2]=c[0]*d[1]-c[1]*d[0],b[3]=0,f[0]=b[0],f[1]=b[1],f[2]=b[2],f[3]=b[3],f},a.cross3Vec3=function(c,d,e){var f=e||a.vec3();return b[0]=c[1]*d[2]-c[2]*d[1],b[1]=c[2]*d[0]-c[0]*d[2],b[2]=c[0]*d[1]-c[1]*d[0],f[0]=b[0],f[1]=b[1],f[2]=b[2],f},a.sqLenVec4=function(b){return a.dotVector4(b,b)},a.lenVec4=function(b){return Math.sqrt(a.sqLenVec4(b))},a.dotVector3=function(a,b){return a[0]*b[0]+a[1]*b[1]+a[2]*b[2]},a.dotVector2=function(a,b){return a[0]*b[0]+a[1]*b[1]},a.sqLenVec3=function(b){return a.dotVector3(b,b)},a.sqLenVec2=function(b){return a.dotVector2(b,b)},a.lenVec3=function(b){return Math.sqrt(a.sqLenVec3(b))},a.lenVec2=function(b){return Math.sqrt(a.sqLenVec2(b))},a.rcpVec3=function(b,c){return a.divScalarVec3(1,b,c)},a.vec3ObjToArray=function(b,c){var d=c||a.vec3();return d[0]=b.x,d[1]=b.y,d[2]=b.z,d},a.vec3ArrayToObj=function(a){return{x:a[0],y:a[1],z:a[2]}},a.normalizeVec4=function(b,c){var d=1/a.lenVec4(b);return a.mulVec4Scalar(b,d,c)},a.normalizeVec3=function(b,c){var d=1/a.lenVec3(b);return a.mulVec3Scalar(b,d,c)},a.normalizeVec2=function(b,c){var d=1/a.lenVec2(b);return a.mulVec2Scalar(b,d,c)},a.dupMat4=function(b,c){var d=c||a.mat4();return d.set(b),d},a.getCellMat4=function(a,b,c){return a[b+4*c]},a.setCellMat4=function(a,b,c,d){a[b+4*c]=d},a.getRowMat4=function(b,c,d){var e=d||a.vec4();return e[0]=b[c+0],e[1]=b[c+4],e[2]=b[c+8],e[3]=b[c+12],e},a.setRowMat4=function(a,b,c){a[b+0]=c[0],a[b+4]=c[1],a[b+8]=c[2],a[b+12]=c[3]},a.setRowMat4c=function(b,c,d,e,f,g){a.setRowMat4(b,c,[d,e,f,g])},a.setRowMat4s=function(b,c,d){a.setRowMat4c(b,c,d,d,d,d)},a.getColMat4=function(b,c,d){var e=d||a.vec4(),f=4*c;return e[0]=b[f+0],e[1]=b[f+1],e[2]=b[f+2],e[3]=b[f+3],e},a.setColMat4v=function(a,b,c){var d=4*b;a[d+0]=c[0],a[d+1]=c[1],a[d+2]=c[2],a[d+3]=c[3]},a.setColMat4c=function(b,c,d,e,f,g){a.setColMat4v(b,c,[d,e,f,g])},a.setColMat4Scalar=function(b,c,d){a.setColMat4c(b,c,d,d,d,d)},a.mat4To3=function(b,c){var d=c||a.mat3();return d[0]=b[0],d[1]=b[1],d[2]=b[2],d[3]=b[4],d[4]=b[5],d[5]=b[6],d[6]=b[8],d[7]=b[9],d[8]=b[10],d},a.m4s=function(b,c){var d=c||a.mat4();return d[0]=b,d[1]=b,d[2]=b,d[3]=b,d[4]=b,d[5]=b,d[6]=b,d[7]=b,d[8]=b,d[9]=b,d[10]=b,d[11]=b,d[12]=b,d[13]=b,d[14]=b,d[15]=b,d},a.setMat4ToZeroes=function(b){return a.m4s(0,b)},a.setMat4ToOnes=function(b){return a.m4s(1,b)},a.diagonalMat4v=function(b,c){var d=c||a.mat4();return d[0]=b[0],d[1]=0,d[2]=0,d[3]=0,d[4]=0,d[5]=b[1],d[6]=0,d[7]=0,d[8]=0,d[9]=0,d[10]=b[2],d[11]=0,d[12]=0,d[13]=0,d[14]=0,d[15]=b[3],d},a.diagonalMat4c=function(b,c,d,e,f){return a.diagonalMat4v([b,c,d,e],f)},a.diagonalMat4s=function(b,c){return a.diagonalMat4c(b,b,b,b,c)},a.identityMat4=function(b){return a.diagonalMat4s(1,b)},a.isIdentityMat4=function(a){var b=0,c=0,d=0;for(b=0;4>b;++b)for(c=0;4>c;++c)if(d=a[b+4*c],b===c){if(1!==d)return!1}else if(0!==d)return!1;return!0},a.negateMat4=function(b,c){for(var d=c||a.mat4(),e=0;16>e;++e)d[e]=-b[e];return d},a.addMat4=function(b,c,d){for(var e=d||a.mat4(),f=0;16>f;++f)e[f]=b[f]+c[f];return e},a.addMat4Scalar=function(b,c,d){for(var e=d||a.mat4(),f=0;16>f;++f)e[f]=b[f]+c;return e},a.addScalarMat4=function(b,c,d){return a.addMat4Scalar(c,b,d)},a.subMat4=function(b,c,d){for(var e=d||a.mat4(),f=0;16>f;++f)e[f]=b[f]-c[f];return e},a.subMat4Scalar=function(b,c,d){for(var e=d||a.mat4(),f=0;16>f;++f)e[f]=b[f]-c;return e},a.subScalarMat4=function(b,c,d){for(var e=d||a.mat4(),f=0;16>f;++f)e[f]=b-c[f];return e},a.mulMat4=function(a,b,c){c||(c=a);var d=a[0],e=a[1],f=a[2],g=a[3],h=a[4],i=a[5],j=a[6],k=a[7],l=a[8],m=a[9],n=a[10],o=a[11],p=a[12],q=a[13],r=a[14],s=a[15],t=b[0],u=b[1],v=b[2],w=b[3],x=b[4],y=b[5],z=b[6],A=b[7],B=b[8],C=b[9],D=b[10],E=b[11],F=b[12],G=b[13],H=b[14],I=b[15];return c[0]=t*d+u*h+v*l+w*p,c[1]=t*e+u*i+v*m+w*q,c[2]=t*f+u*j+v*n+w*r,c[3]=t*g+u*k+v*o+w*s,c[4]=x*d+y*h+z*l+A*p,c[5]=x*e+y*i+z*m+A*q,c[6]=x*f+y*j+z*n+A*r,c[7]=x*g+y*k+z*o+A*s,c[8]=B*d+C*h+D*l+E*p,c[9]=B*e+C*i+D*m+E*q,c[10]=B*f+C*j+D*n+E*r,c[11]=B*g+C*k+D*o+E*s,c[12]=F*d+G*h+H*l+I*p,c[13]=F*e+G*i+H*m+I*q,c[14]=F*f+G*j+H*n+I*r,c[15]=F*g+G*k+H*o+I*s,c},a.mulMat4s=function(b,c,d){for(var e=d||a.mat4(),f=0;16>f;++f)e[f]=b[f]*c;return e},a.mulMat4v4=function(b,c,d){var e=d||a.vec4();return e[0]=b[0]*c[0]+b[4]*c[1]+b[8]*c[2]+b[12]*c[3],e[1]=b[1]*c[0]+b[5]*c[1]+b[9]*c[2]+b[13]*c[3],e[2]=b[2]*c[0]+b[6]*c[1]+b[10]*c[2]+b[14]*c[3],e[3]=b[3]*c[0]+b[7]*c[1]+b[11]*c[2]+b[15]*c[3],e},a.transposeMat4=function(b,c){var d=c||a.mat4(),e=0,f=0;for(e=0;4>e;++e)for(f=0;4>f;++f)d[e+4*f]=b[4*e+f];return d},a.determinantMat4=function(b){var c=a.getCellMat4;return c(b,0,3)*c(b,1,2)*c(b,2,1)*c(b,3,0)-c(b,0,2)*c(b,1,3)*c(b,2,1)*c(b,3,0)-c(b,0,3)*c(b,1,1)*c(b,2,2)*c(b,3,0)+c(b,0,1)*c(b,1,3)*c(b,2,2)*c(b,3,0)+c(b,0,2)*c(b,1,1)*c(b,2,3)*c(b,3,0)-c(b,0,1)*c(b,1,2)*c(b,2,3)*c(b,3,0)-c(b,0,3)*c(b,1,2)*c(b,2,0)*c(b,3,1)+c(b,0,2)*c(b,1,3)*c(b,2,0)*c(b,3,1)+c(b,0,3)*c(b,1,0)*c(b,2,2)*c(b,3,1)-c(b,0,0)*c(b,1,3)*c(b,2,2)*c(b,3,1)-c(b,0,2)*c(b,1,0)*c(b,2,3)*c(b,3,1)+c(b,0,0)*c(b,1,2)*c(b,2,3)*c(b,3,1)+c(b,0,3)*c(b,1,1)*c(b,2,0)*c(b,3,2)-c(b,0,1)*c(b,1,3)*c(b,2,0)*c(b,3,2)-c(b,0,3)*c(b,1,0)*c(b,2,1)*c(b,3,2)+c(b,0,0)*c(b,1,3)*c(b,2,1)*c(b,3,2)+c(b,0,1)*c(b,1,0)*c(b,2,3)*c(b,3,2)-c(b,0,0)*c(b,1,1)*c(b,2,3)*c(b,3,2)-c(b,0,2)*c(b,1,1)*c(b,2,0)*c(b,3,3)+c(b,0,1)*c(b,1,2)*c(b,2,0)*c(b,3,3)+c(b,0,2)*c(b,1,0)*c(b,2,1)*c(b,3,3)-c(b,0,0)*c(b,1,2)*c(b,2,1)*c(b,3,3)-c(b,0,1)*c(b,1,0)*c(b,2,2)*c(b,3,3)+c(b,0,0)*c(b,1,1)*c(b,2,2)*c(b,3,3)},a.inverseMat4=function(b,c){var d=b[0],e=b[1],f=b[2],g=b[3],h=b[4],i=b[5],j=b[6],k=b[7],l=b[8],m=b[9],n=b[10],o=b[11],p=b[12],q=b[13],r=b[14],s=b[15],t=c||a.mat4();a.identityMat4(t),t[0]=m*r*k-q*n*k+q*j*o-i*r*o-m*j*s+i*n*s,t[1]=q*n*g-m*r*g-q*f*o+e*r*o+m*f*s-e*n*s,t[2]=i*r*g-q*j*g+q*f*k-e*r*k-i*f*s+e*j*s,t[3]=m*j*g-i*n*g-m*f*k+e*n*k+i*f*o-e*j*o,t[4]=p*n*k-l*r*k-p*j*o+h*r*o+l*j*s-h*n*s,t[5]=l*r*g-p*n*g+p*f*o-d*r*o-l*f*s+d*n*s,t[6]=p*j*g-h*r*g-p*f*k+d*r*k+h*f*s-d*j*s,t[7]=h*n*g-l*j*g+l*f*k-d*n*k-h*f*o+d*j*o,t[8]=l*q*k-p*m*k+p*i*o-h*q*o-l*i*s+h*m*s,t[9]=p*m*g-l*q*g-p*e*o+d*q*o+l*e*s-d*m*s,t[10]=h*q*g-p*i*g+p*e*k-d*q*k-h*e*s+d*i*s,t[11]=l*i*g-h*m*g-l*e*k+d*m*k+h*e*o-d*i*o,t[12]=p*m*j-l*q*j-p*i*n+h*q*n+l*i*r-h*m*r,t[13]=l*q*f-p*m*f+p*e*n-d*q*n-l*e*r+d*m*r,t[14]=p*i*f-h*q*f-p*e*j+d*q*j+h*e*r-d*i*r,t[15]=h*m*f-l*i*f+l*e*j-d*m*j-h*e*n+d*i*n;for(var u=1/(p*m*j*g-l*q*j*g-p*i*n*g+h*q*n*g+l*i*r*g-h*m*r*g-p*m*f*k+l*q*f*k+p*e*n*k-d*q*n*k-l*e*r*k+d*m*r*k+p*i*f*o-h*q*f*o-p*e*j*o+d*q*j*o+h*e*r*o-d*i*r*o-l*i*f*s+h*m*f*s+l*e*j*s-d*m*j*s-h*e*n*s+d*i*n*s),v=0;16>v;++v)t[v]*=u;return t},a.traceMat4=function(a){return a[0]+a[5]+a[10]+a[15]},a.translationMat4v=function(b,c){var d=c||a.mat4();return a.identityMat4(d),d[12]=b[0],d[13]=b[1],d[14]=b[2],d},a.translationMat4c=function(b,c,d,e){return a.translationMat4v([b,c,d],e)},a.translationMat4s=function(b,c){return a.translationMat4c(b,b,b,c)},a.rotationMat4v=function(b,c,d){var e,f,g,h,i,j,k,l,m,n=a.normalizeVec4([c[0],c[1],c[2],0]),o=Math.sin(b),p=Math.cos(b),q=1-p,r=n[0],s=n[1],t=n[2];e=r*r,f=s*s,g=t*t,h=r*s,i=s*t,j=t*r,k=r*o,l=s*o,m=t*o;var u=d||a.mat4();return u[0]=q*e+p,u[1]=q*h+m,u[2]=q*j-l,u[3]=0,u[4]=q*h-m,u[5]=q*f+p,u[6]=q*i+k,u[7]=0,u[8]=q*j+l,u[9]=q*i-k,u[10]=q*g+p,u[11]=0,u[12]=0,u[13]=0,u[14]=0,u[15]=1,u},a.rotationEulerMat4v=function(b,c,d,e){var f=Math.cos(-c),g=Math.sin(-c),h=Math.cos(-d),i=Math.sin(-d),j=Math.cos(-b),k=Math.sin(-b),l=e||a.mat4();return l[0]=f*h,l[1]=g*k-f*i*j,l[2]=f*i*k+g*j,l[3]=0,l[4]=i,l[5]=h*j,l[6]=-h*k,l[7]=0,l[8]=-g*h,l[9]=g*i*j+f*k,l[10]=-g*i*k+f*j,l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,l},a.rotationMat4c=function(b,c,d,e,f){return a.rotationMat4v(b,[c,d,e],f)},a.scalingMat4v=function(b,c){var d=c||a.mat4();return a.identityMat4(d),d[0]=b[0],d[5]=b[1],d[10]=b[2],d},a.scalingMat4c=function(b,c,d,e){return a.scalingMat4v([b,c,d],e)},a.scalingMat4s=function(b,c){return a.scalingMat4c(b,b,b,c)};var d=a.vec4(),e=a.vec4(),f=a.vec4(),g=Human.math.vec4();a.lookAtMat4v=function(h,i,j,k){d[0]=h[0],d[1]=h[1],d[2]=h[2],d[3]=0,e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=0,f[0]=j[0],f[1]=j[1],f[2]=j[2],f[3]=0,a.subVec4(e,d,b),a.normalizeVec4(b,e),a.normalizeVec4(f,f),a.cross3Vec4(e,f,b),a.normalizeVec4(b,g),a.cross3Vec4(g,e,b),a.normalizeVec4(b,f);var l=k||a.mat4();return l[0]=g[0],l[1]=f[0],l[2]=-e[0],l[3]=0,l[4]=g[1],l[5]=f[1],l[6]=-e[1],l[7]=0,l[8]=g[2],l[9]=f[2],l[10]=-e[2],l[11]=0,l[12]=0,l[13]=0,l[14]=0,l[15]=1,a.negateVector4(d,d),a.translationMat4v(d,c),a.mulMat4(l,c,l),l},a.lookAtMat4c=function(b,c,d,e,f,g,h,i,j,k){return a.lookAtMat4v([b,c,d],[e,f,g],[h,i,j],k)},a.orthoMat4v=function(b,c,d){var e=[b[0],b[1],b[2],0],f=[c[0],c[1],c[2],0],g=a.addVec4(f,e),h=a.subVec4(f,e),i=d||a.mat4();return i[0]=2/h[0],i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=2/h[1],i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[10]=-2/h[2],i[11]=0,i[12]=-g[0]/h[0],i[13]=-g[1]/h[1],i[14]=-g[2]/h[2],i[15]=1,i},a.orthoMat4c=function(b,c,d,e,f,g,h){return a.orthoMat4v([b,d,f],[c,e,g],h)},a.frustumMat4v=function(b,c,d){var e=[b[0],b[1],b[2],0],f=[c[0],c[1],c[2],0],g=a.addVec4(f,e),h=a.subVec4(f,e),i=2*e[2],j=d||a.mat4();return j[0]=i/h[0],j[1]=0,j[2]=0,j[3]=0,j[4]=0,j[5]=i/h[1],j[6]=0,j[7]=0,j[8]=g[0]/h[0],j[9]=g[1]/h[1],j[10]=-g[2]/h[2],j[11]=-1,j[12]=0,j[13]=0,j[14]=-i*f[2]/h[2],j[15]=0,j},a.frustumMatrix4=function(b,c,d,e,f,g,h){return a.frustumMat4v([b,d,f],[c,e,g],h)},a.perspectiveMatrix4=function(b,c,d,e,f){var g=a.vec4(),h=a.vec4();return g[2]=d,h[2]=e,h[1]=g[2]*Math.tan(b/2),g[1]=-h[1],h[0]=h[1]*c,g[0]=-h[0],a.frustumMat4v(g,h,f)},a.transformPoint3=function(c,d,e){var f=e||a.vec4();return b[0]=c[0]*d[0]+c[4]*d[1]+c[8]*d[2]+c[12],b[1]=c[1]*d[0]+c[5]*d[1]+c[9]*d[2]+c[13],b[2]=c[2]*d[0]+c[6]*d[1]+c[10]*d[2]+c[14],b[3]=c[3]*d[0]+c[7]*d[1]+c[11]*d[2]+c[15],f[0]=b[0],f[1]=b[1],f[2]=b[2],f[3]=b[3],f},a.transformPoint4=function(c,d,e){var f=e||a.vec4();return b[0]=c[0]*d[0]+c[4]*d[1]+c[8]*d[2]+c[12]*d[3],b[1]=c[1]*d[0]+c[5]*d[1]+c[9]*d[2]+c[13]*d[3],b[2]=c[2]*d[0]+c[6]*d[1]+c[10]*d[2]+c[14]*d[3],b[3]=c[3]*d[0]+c[7]*d[1]+c[11]*d[2]+c[15]*d[3],f[0]=b[0],f[1]=b[1],f[2]=b[2],f[3]=b[3],f},a.transformPoints3=function(b,c){for(var d=c.length,e=new Array(d),f=0;d>f;f++)e[f]=a.transformPoint3(b,c[f]);return e},a.transformVector3=function(c,d,e){var f=e||a.vec3();return b[0]=c[0]*d[0]+c[4]*d[1]+c[8]*d[2],b[1]=c[1]*d[0]+c[5]*d[1]+c[9]*d[2],b[2]=c[2]*d[0]+c[6]*d[1]+c[10]*d[2],f[0]=b[0],f[1]=b[1],f[2]=b[2],f},a.projectVec4=function(b,c){var d=c||a.vec4(),e=1/b[3];return d[0]=b[0]*e,d[1]=b[1]*e,d[2]=b[2]*e,d[3]=1,d},a.Plane3=function(a,b,c){if(this.normal=new Float64Array([0,0,1]),this.offset=0,a&&b&&(this.normal[0]=a[0],this.normal[1]=a[1],this.normal[2]=a[2],this.offset=b,c)){var d=Math.sqrt(this.normal[0]*this.normal[0]+this.normal[1]*this.normal[1]+this.normal[2]*this.normal[2]);d>0&&(d=1/d,this.normal[0]*=d,this.normal[1]*=d,this.normal[2]*=d,this.offset*=d)}},a.MAX_DOUBLE=Number.POSITIVE_INFINITY,a.MIN_DOUBLE=Number.NEGATIVE_INFINITY,a.MAX_NUMBER=Number.POSITIVE_INFINITY,a.MIN_NUMBER=Number.NEGATIVE_INFINITY,a.Box3=function(b,c){this.min=b||[a.MAX_DOUBLE,a.MAX_DOUBLE,a.MAX_DOUBLE],this.max=c||[a.MIN_DOUBLE,a.MIN_DOUBLE,a.MIN_DOUBLE],this.init=function(a,b){for(var c=0;3>c;++c)this.min[c]=a[c],this.max[c]=b[c];return this},this.fromPoints=function(a){for(var b=[],c=0;c<a.length;c++)b.push([a[c][0]/a[c][3],a[c][1]/a[c][3],a[c][2]/a[c][3]]);for(a=b,c=0;c<a.length;c++)for(var d=a[c],e=0;3>e;e++)d[e]<this.min[e]&&(this.min[e]=d[e]),d[e]>this.max[e]&&(this.max[e]=d[e]);return this},this.isEmpty=function(){return this.min[0]>=this.max[0]&&this.min[1]>=this.max[1]&&this.min[2]>=this.max[2]},this.getCenter=function(){return new Float64Array([(this.max[0]+this.min[0])/2,(this.max[1]+this.min[1])/2,(this.max[2]+this.min[2])/2])},this.getSize=function(){return new Float64Array([this.max[0]-this.min[0],this.max[1]-this.min[1],this.max[2]-this.min[2]])},this.getFacesAreas=function(){var a=this.size;return new Float64Array([a[1]*a[2],a[0]*a[2],a[0]*a[1]])},this.getSurfaceArea=function(){var a=this.getFacesAreas();return 2*(a[0]+a[1]+a[2])},this.getVolume=function(){var a=this.size;return a[0]*a[1]*a[2]},this.getOffset=function(a){for(var b=0;3>b;++b)this.min[b]-=a,this.max[b]+=a;return this}},a.AxisBox3=function(b,c){this.verts=[[b[0],b[1],b[2]],[c[0],b[1],b[2]],[c[0],c[1],b[2]],[b[0],c[1],b[2]],[b[0],b[1],c[2]],[c[0],b[1],c[2]],[c[0],c[1],c[2]],[b[0],c[1],c[2]]],this.toBox3=function(){for(var b=new a.Box3,c=0;8>c;c++)for(var d=this.verts[c],e=0;3>e;e++)d[e]<b.min[e]&&(b.min[e]=d[e]),d[e]>b.max[e]&&(b.max[e]=d[e])},this.toBoundary=function(){for(var b=new a.Box3,c=0;8>c;c++)for(var d=this.verts[c],e=0;3>e;e++)d[e]<b.min[e]&&(b.min[e]=d[e]),d[e]>b.max[e]&&(b.max[e]=d[e])}},a.Sphere3=function(a,b){this.center=new Float64Array(a),this.radius=b,this.isEmpty=function(){return 0===this.radius},this.surfaceArea=function(){return 4*Math.PI*this.radius*this.radius},this.getVolume=function(){return 4/3*Math.PI*this.radius*this.radius*this.radius}},a.billboardMat=function(b,c){var d=[a.getColMat4(b,0),a.getColMat4(b,1),a.getColMat4(b,2)],e=new Float64Array([a.lenVec4(d[0]),a.lenVec4(d[1]),a.lenVec4(d[2])]),f=a.rcpVec3(e),g=a.scalingMat4v(e);a.mulVec4Scalar(d[0],f[0],d[0]),a.mulVec4Scalar(d[1],f[1],d[1]),a.mulVec4Scalar(d[2],f[2],d[2]);var h=c||a.mat4();return a.identityMat4(h),a.setRowMat4(h,0,d[0]),a.setRowMat4(h,1,d[1]),a.setRowMat4(h,2,d[2]),a.mulMat4(h,g,h),h},a.identityQuaternion=function(b){var c=b||a.vec4;return c[0]=0,c[1]=0,c[2]=0,c[3]=1,c},a.angleAxisQuaternion=function(b,c,d){var e=d||a.vec4(),f=c/2,g=Math.sin(f);return e[0]=g*b[0],e[1]=g*b[1],e[2]=g*b[2],e[3]=Math.cos(f),e},a.mulQuaternions=function(b,c,d){var e=d||a.vec4();return e[0]=b[3]*c[0]+b[0]*c[3]+b[1]*c[2]-b[2]*c[1],e[1]=b[3]*c[1]+b[1]*c[3]+b[2]*c[0]-b[0]*c[2],e[2]=b[3]*c[2]+b[2]*c[3]+b[0]*c[1]-b[1]*c[0],e[3]=b[3]*c[3]-b[0]*c[0]-b[1]*c[1]-b[2]*c[2],e},a.newMat4FromQuaternion=function(b,c){
var d=2*b[0],e=2*b[1],f=2*b[2],g=d*b[3],h=e*b[3],i=f*b[3],j=d*b[0],k=e*b[0],l=f*b[0],m=e*b[1],n=f*b[1],o=f*b[2],p=c||a.mat4();return a.identityMat4(p),a.setCellMat4(p,0,0,1-(m+o)),a.setCellMat4(p,0,1,k-i),a.setCellMat4(p,0,2,l+h),a.setCellMat4(p,1,0,k+i),a.setCellMat4(p,1,1,1-(j+o)),a.setCellMat4(p,1,2,n-g),a.setCellMat4(p,2,0,l-h),a.setCellMat4(p,2,1,n+g),a.setCellMat4(p,2,2,1-(j+m)),p},a.slerp=function(b,c,d,e){var f=e||a.vec4(),g=.0174532925*c[3],h=.0174532925*d[3],i=g*h+c[0]*d[0]+c[1]*d[1]+c[2]*d[2];if(Math.abs(i)>=1)return f[0]=c[0],f[1]=c[1],f[2]=c[2],f[3]=c[3],f;var j=Math.acos(i),k=Math.sqrt(1-i*i);if(Math.abs(k)<.001)return f[0]=.5*c[0]+.5*d[0],f[1]=.5*c[1]+.5*d[1],f[2]=.5*c[2]+.5*d[2],f[3]=.5*c[3]+.5*d[3],f;var l=Math.sin((1-b)*j)/k,m=Math.sin(b*j)/k;return f[0]=c[0]*l+d[0]*m,f[1]=c[1]*l+d[1]*m,f[2]=c[2]*l+d[2]*m,f[3]=57.295779579*(g*l+h*m),f},a.normalizeQuaternion=function(b,c){var d=c||a.vec4(),e=a.lenVec3([b[0],b[1],b[2]]);return d[0]=b[0]/e,d[1]=b[1]/e,d[2]=b[2]/e,d[3]=b[3]/e,d},a.conjugateQuaternion=function(b,c){var d=c||a.vec4();return d[0]=-b[0],d[1]=-b[1],d[2]=-b[2],d[3]=b[3],d},a.angleAxisFromQuaternion=function(b){a.normalizeQuaternion(b,b);var c=2*Math.acos(b[3]),d=Math.sqrt(1-b[3]*b[3]);return.001>d?{x:b[0],y:b[1],z:b[2],angle:c}:{x:b[0]/d,y:b[1]/d,z:b[2]/d,angle:c}},a.getBoundaryCenter=function(b,c){var d=c||a.vec3();return d[0]=.5*(b.xmax+b.xmin),d[1]=.5*(b.ymax+b.ymin),d[2]=.5*(b.zmax+b.zmin),d};var h=a.vec3(),i=a.vec3();a.getBoundaryDiag=function(c){return h[0]=c.xmin,h[1]=c.ymin,h[2]=c.zmin,i[0]=c.xmax,i[1]=c.ymax,i[2]=c.zmax,a.subVec3(i,h,b),Math.abs(a.lenVec3(b))},a.createPlane=function(c,d){var e={p:c||a.vec3(),n:d||a.vec3(),d:0};return e.update=function(b,c){e.p.set(b),e.n.set(c),e.d=-a.dotVector3(e.n,b)},e.distance=function(b){return a.dotVector3(e.n,b)+e.d},e.boundaryInside=function(a,c,d,f,g,h){var i=b;return i[0]=a,i[1]=d,i[2]=g,e.n[0]>=0&&(i[0]=c),e.n[1]>=0&&(i[1]=f),e.n[2]>=0&&(i[2]=h),e.distance(i)<0?!1:!0},e}}(),Human.utils.concurrentMapIterate=function(a,b,c,d,e){"use strict";function f(){++k>=j&&!l&&d()}function g(a){l||(l=!0,e(a))}var h=[];for(var i in a)a.hasOwnProperty(i)&&h.push(i);var j=h.length;if(0===j)return void d();var k=0,l=!1;if(b)for(var m=0,n=h.length;n>m;m++)c.call(b,h[m],a[h[m]],f,g);else for(m=0,n=h.length;n>m;m++)c(h[m],a[h[m]],f,g)},Human.utils.ConcurrentTasks=function(){"use strict";function a(){--f<=0&&!g&&c()}function b(a){g||(g=!0,d(a))}var c,d,e=[],f=0,g=!1;this.add=function(a){e[f++]=a},this.go=function(h,i){if(c=h,d=i,g=!1,f>0)for(var j=0,k=f;k>j;j++)e[j](a,b);else h()}},function(){"use strict";var a=Human.utils.fileExists={},b={},c=[],d=200;a.test=function(a,e){var f=b[a];if(void 0!==f)return void e(f);var g=new XMLHttpRequest;g.open("HEAD",a),g.onreadystatechange=function(){if(4===g.readyState){if(c.length>=d){var h=c.shift();delete b[h]}f=404!==g.status,b[a]=f,c.push(a),e(f)}},g.send()}}(),Human.utils.ArrayIteration=function(a,b,c,d){"use strict";function e(){0===a.length?c&&c():window.setTimeout(g,1)}function f(a){h||(h=!0,d?d(a):c&&c())}function g(){a.length>0&&b(a.shift(),e,f)}this.push=function(b){a.push(b),window.setTimeout(g,1)};var h=!1;return 0===a.length?void(c&&c()):void window.setTimeout(g,1)},Human.utils.TagMap=function(){"use strict";var a,b={},c={},d={};this.addItem=function(e,f,g){for(var h,i,j,k=0,l=f.length;l>k;k++)h=f[k],i=b[h],i||(i=b[h]={}),i[e]=g,j=c[h],j?c[h]++:c[h]=1;d[e]=g,a&&(a=null)},this.findItems=function(b){b=b||{};var c=b.tags||[],d=c.join("."),e=b.matching||"any";a||(a={});var f=a[e];f||(f=a[e]={});var g=f[d];if(!g){switch(e){case"most":g=this._findHitsMost(c);break;case"atLeast":g=this._findHitsAtLeast(c);break;case"any":g=this._findHitsAny(c)}f[d]=g}return g},this._findHitsMost=function(a){for(var c,d,e,f={},g=0,h=a.length;h>g;g++)if(c=a[g],d=b[c])for(var i in d)if(d.hasOwnProperty(i)){var j=f[i];j=j?++f[i]:f[i]=1,(!e||j>f[e])&&(e=i)}var k={};return e&&(k[e]=d[e]),k},this._findHitsAtLeast=function(a){for(var c,d,e={},f=a.length,g={},h=0,i=a.length;i>h;h++)if(c=a[h],d=b[c])for(var j in d)if(d.hasOwnProperty(j)){var k=e[j];k=k?++e[j]:e[j]=1,k===f&&(g[j]=d[j])}return g},this._findHitsAny=function(a){for(var c,d,e={},f=0,g=a.length;g>f;f++)if(c=a[f],d=b[c])for(var h in d)d.hasOwnProperty(h)&&(e[h]=d[h]);return e},this.removeItem=function(e){var f,g;for(var h in b)b.hasOwnProperty(h)&&(f=b[h],g=f[e],g&&(delete f[e],0===--c[h]&&(delete b[h],delete c[h])));delete d[e],a&&(a=null)}},Human.utils.TagMapList=function(){"use strict";var a,b={},c={},d={};this.addItem=function(e,f,g){if(0!==f.length){for(var h,i,j,k=0,l=f.length;l>k;k++)h=f[k],i=b[h],i||(i=b[h]={}),i[e]=g,j=c[h],j?c[h]++:c[h]=1;d[e]=g,a&&(a=null)}},this.findItems=function(b){b=b||{};var c=b.tags||[],d=c.join("."),e=b.matching||"any";a||(a={});var f=a[e];f||(f=a[e]={});var g=f[d];if(!g){switch(e){case"most":g=this._findHitsMost(c);break;case"atLeast":g=this._findHitsAtLeast(c);break;case"any":g=this._findHitsAny(c);break;case"except":g=this._findHitsExcept(c)}f[d]=g}return g},this._findHitsMost=function(a){for(var c,d,e,f={},g=0,h=a.length;h>g;g++)if(c=a[g],d=b[c])for(var i in d)if(d.hasOwnProperty(i)){var j=f[i];j=j?++f[i]:f[i]=1,(!e||j>f[e])&&(e=i)}var k=[];return e&&k.push(d[e]),k},this._findHitsAtLeast=function(a){for(var c,d,e={},f=a.length,g={},h=[],i=0,j=a.length;j>i;i++)if(c=a[i],d=b[c])for(var k in d)if(d.hasOwnProperty(k)&&!g[k]){var l=e[k];l=l?++e[k]:e[k]=1,l===f&&(h.push(d[k]),g[k]=!0)}return h},this._findHitsAny=function(a){for(var c,d,e={},f=[],g=0,h=a.length;h>g;g++)if(c=a[g],d=b[c])for(var i in d)d.hasOwnProperty(i)&&(e[i]||(f.push(d[i]),e[i]=!0));return f},this._findHitsExcept=function(a){var c=[];for(var e in d)if(d.hasOwnProperty(e))for(var f=0;f<a.length;f++){var g=b[a[f]];if(void 0!==g&&void 0!==g[e])break;f===a.length-1&&c.push(d[e])}return c},this.removeItem=function(e){var f,g;for(var h in b)b.hasOwnProperty(h)&&(f=b[h],g=f[e],g&&(delete f[e],0===--c[h]&&(delete b[h],delete c[h])));delete d[e],a&&(a=null)}},Human.utils.Map=function(a,b){"use strict";this.items=a||[];var c=b||0,d=c;"number"!=typeof c&&(d=c+"0"),this.addItem=function(){var a;if(2===arguments.length){var b=arguments[0];if(a=arguments[1],this.items[b])throw"ID clash: '"+b+"'";return this.items[b]=a,b}for(;;){a=arguments[0];var e;if("number"==typeof c?e=d++:(e=c+parseInt(d.substr(c.length)),d=c+(parseInt(d.substr(c.length))+1)),!this.items[e])return this.items[e]=a,e}},this.removeItem=function(a){var b=this.items[a];return void 0!==b&&(delete this.items[a],d=a),b}},Human.utils.IDPool=function(a){"use strict";a=a||{};var b=a.prefix||"id",c=b.length,d=[],e={},f={};this.getId=function(a){if(a){if(e[a]||f[a])throw"ID already in use: "+a;return e[a]=!0,a}for(var c,g=0,h=d.length;h>g;g++)if(!d[g]&&(c=b+g,!e[c]))return d[g]=!0,f[c]=!0,c;return d.push(!0),c=b+(d.length-1),f[c]=!0,c},this.containsId=function(a){return void 0!==e[a]||void 0!==f[a]},this.putId=function(a){if(e[a])delete e[a];else{if(!f[a])throw"ID does not exist: "+a;d[parseInt(a.substr(c))]=!1,delete f[a]}}},Human.utils.Loader=function(){"use strict";this._loadedModelLibs={},this.configure=function(){},this.load=function(a,b,c,d,e,f){if(this._loadedModelLibs[b]=this._loadedModelLibs[b]||{},this._loadedModelLibs[b][c])return Human.log.warn("Human.utils.Loader.load","Library '"+c+"' already loaded for model '"+b+"' - not reloading"),void e();var g=this,h=function(){g._loadedModelLibs[b][c]=!0,e()};this._load(a,b,c,d,h,f)},this._load=function(a,b,c,d,e){Human.log.error("Human.utils.Loader._load not implemented"),e()},this.unload=function(a){var b=this._loadedModelLibs[a];if(b){for(var c in b)b.hasOwnProperty(c)&&this._unload(a+"."+c);delete this._loadedModelLibs[a]}},this._unload=function(){Human.log.error("Human.utils.Loader._unload","This method needs to be implemented")}},function(){"use strict";function a(a,b){this.procName=a,this.callId=b}function b(a){return a&&"object"==typeof a?a===window?!1:"string"==typeof a.nodeName&&"function"==typeof a.querySelectorAll&&"function"==typeof a.getElementsByTagName?!1:"function"==typeof a.preventDefault&&"function"==typeof a.stopPropagation?!1:!0:!0}var c=Human.rpc={};c._procedures={};var d=[];a.prototype.setResult=function(a){for(var b=0,c=d.length;c>b;b++)d[b](this.callId,a)},a.prototype.info=function(a){Human.log.info(this.procName,a)},a.prototype.warn=function(a){Human.log.warn(this.procName,a)},a.prototype.error=function(a){Human.log.error(this.procName,a)},c.define=function(b,d){c._procedures[b]&&Human.log.warn("Human.rpc.define","Redefining procedure: "+b),c._procedures[b]=function(c,e){d.call(new a(b,c),e||{})}},c.onResult=function(a){d.push(a)},c.call=function(a,b,d){var e=c._procedures[b];return e?void e(a,d):void Human.log.warn("Human.rpc.call","Target procedure not found: "+name)},c.filterUnsafeProperties=function(a){if(!Human.utils.isObject(a))return a;var c={};for(var d in a)a.hasOwnProperty(d)&&b(a[d])&&(c[d]=a[d]);return c}}(),function(){"use strict";var a=Human.events={},b={},c=0,d=[{}],e={},f={};a.addBinder=function(a,c){(b[a]||(b[a]=[])).push(c)},a.createChannel=function(b){var c=d.length;return d.push({}),b&&b.enabled&&a.enableChannel(c,b.enabled),c},a.enableChannel=function(a,b){e[a]=b},a.onEvent=a.on=function(){var a,g,h,i;if("number"==typeof arguments[0]){if(a=arguments[0],a>d.length-1)return void Human.log.error("Human_event.onEvent","Channel not created: "+a+" - should be created first with Human.events.createChannel");g=arguments[1],h=arguments[2],i=arguments[3]}else if("object"==typeof arguments[0]){var j=arguments[0];g=j.type,h=j.fn;var k=b[g];if(k)for(var l=j.mask||{},m=0,n=k.length;n>m;m++)k[m](l,h);a=void 0!==j.channel&&null!==j.channel?j.channel:c,i=j.options}else a=c,g=arguments[0],h=arguments[1],i=arguments[2];e[a]=i&&void 0!==i.enable&&null!==i.enable?i.enable:!0,i=i||{};var o=d[a];o||(o=d[a]={});var p=o[g];p||(p=[],o[g]=p);var q={fn:h,priority:void 0===i.priority?p.length:i.priority,once:i.once};for(m=0;m<p.length;m++)if(p[m].priority>q.priority)return void p.splice(m,0,q);p.push(q),f[g]&&q.fn(f[g])},a.once=function(b,c){var d=function(e){a.off(b,d),c(e)};a.on(b,d)},a.fireEvent=a.fire=function(a,b,c){for(var g,h,i=0,j=d.length;j>i;i++)if(e[i]&&(g=d[i],h=g[a])){b||(b={});for(var k,l,m=0,n=h.length;n>m;m++){l=h[m];try{l.fn(b),l.once&&(k||(k=[]),k.push(m))}catch(o){Human.log.error(o)}}if(k)for(m=k.length-1;m>=0;m--)h.splice(k[m])}c&&(f[a]=b)},a.unEvent=a.off=function(a,b,e){if(void 0===e||null===e)e=c;else if(e>=d.length||0>e)throw"Channel does not exist: "+e;var f=d[e];f||(f=d[e]={});var g=f[a];g||(g=[],f[a]=g);for(var h=g.length;h--;)g[h].fn===b&&g.splice(h,1)}}(),function(){"use strict";function a(a){var c=b[a];if(c){var d=c[0],e=c[1];Human.unEvent(d,e),delete b[a]}}var b={};Human.rpc.define("events.on",function(a){var c=this,d=this.id;if(d&&b[d])return void this.error("an event is already bound to this ID: '"+d+"'");var e=a.type;if(!e)return void this.error("parameter expected: 'type'");var f=function(a){c.setResult(a)};a.mask?(a.fn=f,Human.events.on(a)):Human.events.on(a.type,f),d&&(b[d]=[e,f])}),Human.rpc.define("events.once",function(a){var b=this,c=a.type;return c?void Human.events.once(c,function(a){b.setResult(a)}):void this.error("parameter expected: 'type'")}),Human.rpc.define("events.fire",function(a){Human.events.fire(a.eventName,a.params)}),Human.rpc.define("events.off",function(c){if(c.id)a(c.id);else if(c.ids)for(var d=c.ids,e=0,f=d.length;f>e;e++)a(d[e]);else for(var g in b)b.hasOwnProperty(g)&&a(g)})}(),function(){"use strict";var a=Human.properties={},b=new Human.utils.IDPool;a.properties={};var c={},d={},e={};a.subscribe=function(f){f=f||{};var g=f.propId;if(!g)return Human.log.error("Human.properties.subscribe","Param expected: propId"),null;var h=f.callback;if(!h)return Human.log.error("Human.properties.subscribe","Param expected: callback"),null;if(f.subId&&b.containsId(f.subId))return Human.log.error("Human.properties.subscribe","Subscription already exists with this ID: "+f.subId),null;var i=f.value,j=b.getId(f.subId),k=a.properties[g];if(k)return i&&(a.properties[g]=i),c[j]=h,e[j]=g,h(i),j;var l=d[g]||(d[g]={});return l[j]=h,(void 0===i||null===i)&&(i={}),a.properties[g]=i,c[j]=h,e[j]=g,h(i),j},a.resubscribe=function(b,f){var g=c[b];if(!g)return void Human.log.warn("Human.properties.resubscribe","Subscription not found: '"+b+"'");var h=e[b],i=a.properties[f];h&&i&&(d[h]&&delete d[h][b],(d[f]||(d[f]={}))[b]=g,e[b]=f,g(i))},a.set=function(b){var c,e;for(var f in b)if(b.hasOwnProperty(f)&&(c=b[f],a.properties[f]=c,e=d[f]))for(var g in e)e.hasOwnProperty(g)&&e[g](c)},a.unsubscribe=function(a){var b=e[a];b&&(delete e[a],delete d[b][a])},a.query=function(b){if(!b)return a.properties;var c;if(b){var d=new RegExp(b);c={};for(var e in a.properties)a.properties.hasOwnProperty(e)&&d.test(e)&&(c[e]=a.properties[e])}return c}}(),function(){"use strict";function a(a){return a.length<45?a+"                                                           ".substr(0,45-a.length):a}var b=Human.log={};b.LOG_NONE=0,b.LOG_DEBUG=1,b.LOG_INFO=2,b.LOG_WARN=3,b.LOG_ERROR=4;var c=["none","debug","info","warn","error"],d=[],e=200,f=b.LOG_WARN;Human.properties.subscribe({propId:"log.level",value:f,callback:function(a){f=a}});var g={};b.setLevel=function(a){f=a},b.getLevel=function(){return f},b.log=function(a,h){switch(h=void 0===h||null===h?b.INFO:h){case b.LOG_DEBUG:f<=b.LOG_DEBUG&&window.console&&window.console.debug&&window.console.debug(a);break;case b.LOG_ERROR:f<=b.LOG_ERROR&&window.console&&window.console.error&&window.console.error(a);break;case b.LOG_INFO:f<=b.LOG_INFO&&window.console&&window.console.info&&window.console.info(a);break;case b.LOG_WARN:f<=b.LOG_WARN&&window.console&&window.console.warn&&window.console.warn(a)}var i={message:a,level:c[h]};for(var j in g)g.hasOwnProperty(j)&&Human.events.fire(j,i);d.length>e&&(d.length=0,d.push({message:"Logging buffer exceeded max length of "+e+" - messages to this point were flushed",level:c[b.LOG_WARN]})),d.push(i)},b.debug=function(){b.log(1===arguments.length?arguments[0]:"["+a(arguments[0])+"] "+arguments[1],b.LOG_DEBUG)},b.error=function(){b.log(1===arguments.length?arguments[0]:"["+a(arguments[0])+"] "+arguments[1],b.LOG_ERROR)},b.info=function(){b.log(1===arguments.length?arguments[0]:"["+a(arguments[0])+"] "+arguments[1],b.LOG_INFO)},b.warn=function(){b.log(1===arguments.length?arguments[0]:"["+a(arguments[0])+"] "+arguments[1],b.LOG_WARN)},Human.events.on("error",function(a){b.error(a.message)}),Human.rpc.define("log.createReporter",function(a){if(!a.id)return void b.error("param expected: id");var c="log.reporters."+a.id;if(!g[c]){g[c]={};for(var e=0,f=d.length;f>e;e++)Human.events.fire(c,d[e])}}),Human.rpc.define("log.destroyReporter",function(a){if(!a.id)return void b.error("param expected: id");var c="log.reporters."+a.id;delete g[c]})}(),function(){"use strict";Human.rpc.define("properties.set",function(a){var b=a.props||a;Human.properties.set(b||{})}),Human.rpc.define("properties.subscribe",function(a){var b=this;Human.properties.subscribe({subId:a.subId,propId:"myProperty",callback:function(a){b.setResult(a)}})}),Human.rpc.define("properties.resubscribe",function(a){Human.properties.resubscribe(a.subId,a.propId)}),Human.rpc.define("properties.unsubscribe",function(a){Human.properties.unsubscribe(a.subId)}),Human.rpc.define("properties.query",function(a){this.setResult(Human.properties.query(a.regex))})}(),function(){"use strict";var a=Human.cookies={};a.setCookie=function(a,b,c){var d;if(c){var e=new Date;e.setTime(e.getTime()+24*c*60*60*1e3),d="; expires="+e.toGMTString()}else d="";document.cookie=a+"="+b+d+"; path=/"},a.getCookie=function(a){for(var b=a+"=",c=document.cookie.split(";"),d=0;d<c.length;d++){for(var e=c[d];" "===e.charAt(0);)e=e.substring(1,e.length);if(0===e.indexOf(b))return e.substring(b.length,e.length)}return null},a.eraseCookie=function(b){a.setCookie(b,"",-1)}}(),function(){"use strict";var a,b,c,d=Human.request={};d.getHashStr=function(){return window.location.hash},d.getHashParams=function(){if(!b||a!==window.location.hash){b={};for(var c,d=window.location.hash.slice(1),e=d.split(","),f=0,g=e.length;g>f;f++)c=e[f].split("="),b[c[0]]=c[1];a=window.location.hash}return b},d.getHashParam=function(c){return b&&a===window.location.hash||d.getHashParams(),b[c]},d.getSearchStr=function(){return window.location.search},d.getSearchParams=function(){if(!c){c={};for(var a,b=window.location.search.slice(1),d=b.split("&"),e=0,f=d.length;f>e;e++)a=d[e].split("="),c[a[0]]=a[1]}return c},d.getSearchParam=function(a){return c||d.getSearchParams(),c[a]}}(),function(){"use strict";Human.rpc.define("request.getParams",function(){this.setResult({hashParams:Human.request.getHashParams(),hashStr:Human.request.getHashStr(),searchParams:Human.request.getSearchParams(),searchStr:Human.request.getSearchStr()})})}(),function(){"use strict";var a=Human.init={},b=[],c=!1;a.bookmark={},a.cameraBookmark={};var d=Human.request.getHashParams(),e=location.origin+location.pathname.substring(0,location.pathname.lastIndexOf("/"))+"/lib/scenejs/plugins",f="true"===d.validateShaders,g="false"!==d.enableVAO,h="false"!==d.enableInterleaving;SceneJS.setConfigs({texturing:{waitForLoad:!0},pluginPath:e,statusPopups:!1,validateShaders:f,enableVAO:g,enableInterleaving:h}),function(){function a(a,f){e||(e=!0,"true"===d.noErrorRedirect?b():(c(a.errorName||"ERROR",a.exception||a.message),-1===document.URL.indexOf("embedded.html")&&window.location.replace("webgl-error.html?error="+(a.errorName||"ERROR")+"&message=["+f+"] "+(a.exception||a.message))))}function b(){alert("An error has occurred; 'noErrorRedirect=true' is specified on URL, so logging debug info to console without redirecting to recovery page")}function c(a,b){jQuery.post("/ws/human-error",{category:a,log:(Human.log.messages||[]).join(),message:b})}var e;SceneJS.bind("error",function(b){a(b,"WEBGL")}),Human.onError(function(b){a(b,"HUMAN")}),window.__testError=function(){a({errorName:"A mock error",message:"A mock error has occurred for testing purposes"},"WEBGL")}}(),require.config({waitSeconds:30}),a.saveReset=function(){var b=Human.bookmarks.capture(),c=b.modules;if(c){var d=c.active;d&&d.length>1&&(c.active=[c.active[0]])}a.bookmark=b,a.bookmarkCamera=Human.bookmarks.capture({camera:!0})},a.require=function(a,d){return c?(Human.log.error("Human.init.require","Engine already started, ignoring script: "+a),this):(b.push({path:a,params:d||{}}),this)},a.step=function(a){return c?(a(),this):(b.push({callback:a}),this)},a.reset=function(b){return a.bookmark?void Human.bookmarks.restore(a.bookmark,function(){Human.events.fire("init.reset"),b&&b()},function(a){Human.log.error("Human.init.reset","Reset failed: "+a),b&&b()}):(Human.log.error("Human.init.reset","Bookmark for reset was not captured"),void(b&&b()))},a.resetCamera=function(b){var c=Human.timeline.getCurrentChapterCamera();if(c)return void Human.view.camera.fly.flyTo(c,b);var d,e,f=0,g=Human.modules.activeModules;for(var h in g)g.hasOwnProperty(h)&&(e=g[h],e.camera&&e.timeActivated>f&&(d=e));return d?void Human.view.camera.fly.flyTo(d.camera,b):a.bookmark?void Human.view.camera.fly.flyTo(a.bookmark.camera,b):(Human.log.error("Human.init.resetCamera","Bookmark for reset was not captured"),void(b&&b()))},a.reload=function(){window.location.reload()},a.start=function(d,e){function f(){function d(){function d(){--g>0||(c=!0,a.saveReset(),Human.events.fire("started"),e&&e())}if(!(--j>0)){var f=[];b.forEach(function(a){a.callback&&f.push(a.callback)});var g=f.length;return 0===g?void d():void f.forEach(function(a){a(d)})}}if(g&&h){var f=[],i=[];b.forEach(function(a){a.path&&(f.push(a.path),i.push(a.params))});var j=f.length;require(f,function(){var a=Array.prototype.slice.call(arguments);return 0===j?void d():void a.forEach(function(a,b){var c=f[b],e=i[b];Human.log.info("Human.init","Loading init script: "+c),a(e,d)})})}}var g=!1,h=!1;require([d],function(a){a(),g=!0,f()}),Human.renderer.init(function(){Human.events.fire("loaded"),h=!0,f()})}}(),function(){"use strict";Human.rpc.define("reset",function(){var a=this;Human.init.reset(function(){a.setResult(!0)})}),Human.rpc.define("reload",function(){Human.init.reload()}),Human.rpc.define("alert",function(a){window.alert(a.message||"")})}(),function(){"use strict";var a=Human.processes={};a.processes={},a.numProcesses=0,a.startProcess=function(b){var c=b.processId;return c?a.processes[c]?void Human.log.warn("Human.processes.startProcess","Process already exists: '"+c+"'"):(b.scaleProgress=b.scaleProgress||1,a.processes[c]=b,b.numProcesses=++a.numProcesses,void Human.events.fire("processes.started",b)):void Human.log.error("Human.processes.startProcess","Param expected: processId")},a.updateProcess=function(b){var c=b.processId;return c?void(a.processes[c]&&(b.scaleProgress=b.scaleProgress||1,b.numProcesses=a.numProcesses,Human.events.fire("processes.updated",b))):void Human.log.error("Human.processes.updateProcess","Param expected: processId")},a.finishProcess=function(b){var c=b.processId;return c?a.processes[c]?(delete a.processes[c],b.numProcesses=--a.numProcesses,void Human.events.fire("processes.finished",b)):void Human.log.warn("Human.processes.finishProcess","Process not found: '"+c+"'"):void Human.log.error("Human.processes.finishProcess","Param expected: processId")},a.failProcess=function(b){var c=b.processId;return c?a.processes[c]?(delete a.processes[c],b.numProcesses=--a.numProcesses,void Human.events.fire("processes.failed",b)):void Human.log.warn("Human.processes.failProcess","Process not found: '"+c+"'"):void Human.log.error("Human.processes.failProcess","Param expected: processId")}}(),function(){"use strict";function a(a,b,c,d,e){Human.log.info("Human.net#loadArrayBuffer","Loading from: "+a);var f=null;$.ajax({url:a,dataType:"json",type:"HEAD",success:function(a,b,c){f=c.getResponseHeader("Content-Length")}});var g,h=new XMLHttpRequest;h.addEventListener("progress",function(a){a.lengthComputable?(void 0===g&&(g=!0),d&&d(100*(a.loaded/a.total))):(void 0===g&&(g=!1,Human.log.info("Human.net","XHR load progress supported == NO; is server compressing this data?")),d&&d(null!==f&&void 0!==f?100*a.position/f:-1))},!1);var i=!1;h.onreadystatechange=function(){var a=null;4===h.readyState&&(h.status&&200!==h.status?c("Failed to load - status: "+h.status):(h.response?a=h.response:h.mozResponseArrayBuffer&&(a=h.mozResponseArrayBuffer),a?i||(i=!0,b(a)):c("Failed to load - status: "+h.status)))},e?(h.open("POST",a,!0),h.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),h.responseType="arraybuffer",h.send(e)):(h.open("GET",a,!0),h.responseType="arraybuffer",h.send(null))}function b(a){return n?q+a:q+a+"?v="+Human.VERSION}function c(a,b,c){n?d(a,function(a){b(e(l+a[0],a[1]))},c):$.ajax({dataType:"json",url:a,success:b}).fail(function(a,b){Human.log.error("Request failed: "+b)})}function d(a,b,c){var d=m[a];d?b(d):c("Could not find data in stream at key '"+a+"'")}function e(a,b){var c=new Uint8Array(k,a,b),d=new TextDecoder("utf-8").decode(c);return JSON.parse(d)}function f(b,c,e){n?d(b,function(a){try{var b=l+a[0],d=b+a[1];c(new Int32Array(k.slice(b,d)))}catch(f){e(f)}},e):a(b,function(a){c(new Int32Array(a))},e)}function g(b,c,e){n?d(b,function(a){try{var b=l+a[0],d=b+a[1];c(new Float32Array(k.slice(b,d)))}catch(f){e(f)}},e):a(b,function(a){c(new Float32Array(a))},e)}var h=Human.net={},i="content",j=null;h.mode="stream";var k,l,m,n=!0,o={},p="",q="",r="",s=function(a,b,c){Human.events.fire("net.error",{id:b,type:a,status:c.status,statusText:c.statusText})};h.setMode=function(a){if("mode"!==h.mode){switch(a){case"stream":n=!0,p="";break;case"file":n=!1,p="./"+i+"/";break;default:return void Human.log.error("Human.net.setMode","Mode not supported: '"+a+"'")}h.mode=a,Human.log.info("Human.net.setMode","Mode set to: "+a)}},Human.properties.subscribe({propId:"modules.contentSource",value:"stream",callback:function(a){h.setMode(a)}}),h.setActiveModel=function(a){var b=o[a];b&&(a!==j&&Human.log.info("Human.net.setActiveModel","Model set to: "+a),j=a,p=b.base,q=b.prefix,r=b.modelDir,k=b.streamBuffer,l=b.streamBaseIndex,m=b.streamIndex)},h.clearModelData=function(){o={},k=null,l=null,m=null},h.withModel=function(a,b,c){c||(c=b,b=h.mode);var d=h.mode,e=j;h.setMode(b),h.setActiveModel(a),c(),h.setMode(d),h.setActiveModel(e)},h.getModuleDb=function(a,b,c){$.ajax({dataType:"json",url:i+"/modules/db/"+a,success:b,error:function(b,d,e){s("modules",a,b),c(e)}})},h.getModuleManifest=function(a,b,c){$.ajax({dataType:"json",url:i+"/modules/"+a,success:b,error:function(b,d,e){s("modules",a,b),c(e)}})},h.getModuleDefinition=function(a,b,c){$.ajax({dataType:"json",url:i+"/modules/"+a,success:b,error:function(b,d,e){s("modules",a,b),c(e)}})},h.openModel=function(b,c,d,f){var g=o[b]=o[b]||{};if(!n)return g.prefix=i+"/states/"+b+"/",g.modelDir=i+"/states/"+b+"/",h.setActiveModel(b),void d();var j="./"+i+"/streams/"+b+".bin",l=null;c&&(l=$.param(c)),a(j,function(a){g=o[b],k=g.streamBuffer=a;var c=new Uint32Array(a,0,1),f=c[0];g.streamBaseIndex=4+f,g.streamIndex=e(4,f),g.modelDir=i+"/states/"+b+"/",g.prefix=i+"/states/"+b+"/",Human.processes.finishProcess({processId:j}),h.setActiveModel(b),d()},function(a){f(a)},function(a){Human.processes.updateProcess({processId:"modules.activate",progress:a})},l)},h.getOffset=function(){return 0},h.getAnatomyManifest=function(a,d,e){c(b("anatomy/"+a+"/manifest"),d,e)},h.getAnatomyToMedline=function(a,c,d){var e=b("anatomy/"+a+"/anatomy_to_medline");$.ajax({dataType:"json",url:e,success:c,error:function(){d&&d()}})},h.getAnimationManifest=function(a,d,e){c(b("animations/"+a+"/manifest"),d,e)},h.getGeometryManifest=function(a,d,e){c(b("geometry/"+a+"/manifest"),d,e)},h.getChapterSetManifest=function(a,d,e){c(b("chapters/"+a+"/manifest"),d,e)},h.getMaterialDir=function(a){return r+"materials/"+a+"/images/"},h.getMaterialLibrary=function(a,d,e){c(b("materials/"+a+"/outline"),d,e)},h.getAudioDir=function(a){return r+"audio/"+a+"/clips/"},h.getAudioLibrary=function(a,d,e){c(b("audio/"+a+"/manifest"),d,e)},h.getVideosLibrary=function(a,d,e){c(b("videos/"+a+"/manifest"),d,e)},h.getReflectionsDir=function(a){return r+"reflections/"+a+"/images/"},h.getReflectionsLibrary=function(a,d,e){c(b("reflections/"+a+"/outline"),d,e)},h.getSkyboxesDir=function(a){return r+"skyboxes/"+a+"/images/"},h.getSkyboxesLibrary=function(a,d,e){c(b("skyboxes/"+a+"/outline"),d,e)},h.getRegionsDir=function(a){return r+"regions/"+a+"/images/"},h.getRegionsLibrary=function(a,d,e){c(b("regions/"+a+"/outline"),d,e)},h.getLightsLibrary=function(a,d,e){c(b("lights/"+a+"/outline"),d,e)},h.getTransformsLibrary=function(a,d,e){c(b("transforms/"+a+"/outline"),d,e)},h.getAnatomyIndex=function(a,d,e,f){c(b("anatomy/"+a+"/b/"+d+"/idx.json"),e,f)},h.getAnatomyPositions=function(a,c,d,e){g(b("anatomy/"+a+"/b/"+c+"/positions.bds"),d,e)},h.getAnatomyNormals=function(a,c,d,e){g(b("anatomy/"+a+"/b/"+c+"/normals.bds"),d,e)},h.getAnatomyUVs=function(a,c,d,e){g(b("anatomy/"+a+"/b/"+c+"/uv.bds"),d,e)},h.getAnatomyIndices=function(a,c,d,e){f(b("anatomy/"+a+"/b/"+c+"/indices.bds"),d,e)},h.getStateIndex=function(a,d){c(b("index"),a,d)},h.getGeometryIndices=function(a,c,d){f(b("geometry/"+a+"/indices.bds"),c,d)},h.getGeometryUVs=function(a,c,d){g(b("geometry/"+a+"/uv.bds"),c,d)},h.getGeometryUV2s=function(a,c,d){g(b("geometry/"+a+"/uv2.bds"),c,d)},h.getGeometryPositions=function(a,c,d){g(b("geometry/"+a+"/positions.bds"),c,d)},h.getGeometryNormals=function(a,c,d){g(b("geometry/"+a+"/normals.bds"),c,d)},h.getGeometryMesh=function(a,d,e,f){c(b("geometry/"+a+"/"+d+"/geo"),e,f)},h.getMorphIndices=function(a,c,d){f(b("animations/"+a+"/indices.bds"),c,d)},h.getMorphUVs=function(a,c,d){g(b("animations/"+a+"/uv.bds"),c,d)},h.getMorphPositions=function(a,c,d){g(b("animations/"+a+"/positions.bds"),c,d)},h.getMorphNormals=function(a,c,d){g(b("animations/"+a+"/normals.bds"),c,d)}}(),function(){"use strict";var a=Human.renderer={};a.NULL_OBJECT_ID="null-object";var b;a.SSAA_MULTIPLIER=function(){var a=parseInt(Human.request.getSearchParam("forceSSAA"),10);if(a>=1)return a;var b=document.createElement("canvas"),c=b.getContext("webgl",{antialias:!0})||b.getContext("experimental-webgl",{antialias:!0});return c&&c.getContextAttributes().antialias?1:2}(),a.init=function(c){var d={type:"scene",id:Human.SCENE_ROOT_ID,canvasId:Human.CANVAS_ID,transparent:!0,contextAttr:{preserveDrawingBuffer:!1,antialias:!0},nodes:[{type:"library",id:"assetLibraryRoot"},{type:"camera",id:Human.CAMERA_ID,optics:{type:"perspective",fovy:60,near:.01,far:400},pan:{x:0,y:0,z:0},nodes:[{type:"lookAt",eye:{x:0,y:0,z:.05},look:{x:0,y:0,z:0},up:{y:1},nodes:[{type:"lights",lights:[{mode:"dir",color:{r:1,g:1,b:1},dir:{x:0,y:0,z:-1},diffuse:!0,specular:!0,space:"view"}],nodes:[{type:"node",id:"annotation-labels"}]}]},{type:"lookAt",id:Human.LOOKAT_ID,eye:{x:0,y:0,z:55},look:{x:0,y:0,z:0},up:{y:1},nodes:[{id:"skybox-container"},{type:"layer",priority:1e4,nodes:[{type:"flags",id:Human.CLIP_INDICATORS_ATTACH_ID,flags:{picking:!1}}]},{id:"clips",nodes:[{id:"occlusionIndicators"},{id:"lights",nodes:[{id:"lights.subtree",nodes:[{id:"effect",nodes:[{id:"effect.subtree",nodes:[{type:"material",id:Human.MATERIAL_ROOT_ID,emit:0,baseColor:{r:.9,g:.9,b:.9},specularColor:{r:.9,g:.9,b:.9},specular:.9,shine:100,nodes:[{type:"node",id:a.NULL_OBJECT_ID,nodes:[{type:"geometry",positions:[0,0,0,.1,.1,.1,.2,.2,.2],indices:[0,1,2],uv:[0,0,1,0,1,1],normals:[0,1,0,0,1,0,0,1,0],primitive:"triangles"}]},{type:"flags",id:Human.CONTENT_ROOT_ID,flags:{picking:!0,enabled:!0,specular:!0,backfaceLighting:!0,backfaceTexturing:!0,backfaces:!0,reflection:!1}}]},{type:"flags",id:"object-boundary-flags",flags:{enabled:!1,transparent:!0,clipping:!1},nodes:[{type:"material",baseColor:{r:0,g:1,b:0},specularColor:{r:0,g:1,b:0},emit:1,alpha:.4,nodes:[{type:"geometry",id:"object-boundary-geo",positions:[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],primitive:"lines",indices:[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]}]}]}]}]}]}]}]}]}]}]},e=Human.request.getSearchParam("testContextLost");if(b=SceneJS.createScene(d,{resolutionScaling:a.SSAA_MULTIPLIER,simulateWebGLContextLost:!!e}),e){var f=parseInt(e);window.setInterval(function(){b.loseWebGLContext()},1e3*f)}var g=Date.now(),h=g,i=0;b.on("tick",function(){var a=Date.now();Human.events.fire("tick",{timeStarted:g,timeLast:h,timeNow:a,tick:i}),h=a,i++}),b.on("sleep",function(){Human.events.fire("Scene.Sleep")}),c&&c()},a.setFPS=function(a){b.setFPS(a)},a.pushPause=function(){a._pauses=a._pauses?a._pauses+1:1,1===a._pauses&&b.pause(!0)},a.popPause=function(){a._pauses&&0===--a._pauses&&(b.pause(!1),b.renderFrame())},a.onTasksComplete=function(b){void 0!==a._pauses&&null!==a._pauses&&a._pauses>0&&Human.log.error("Human.renderer.onTaskComplete","Renderer deadlock: Human.renderer.pushPause has paused renderer. Renderer needs to be unpaused in order to complete pending tasks.");var c=Human.renderer.getScene().getStatus().numTasks;if(!c||0===c)return void b();if(a.__checkLoaded)throw"Human.renderer.onTasksComplete: already blocking";a.__checkLoaded=window.setInterval(function(){var c=Human.renderer.getScene().getStatus().numTasks;c&&0!==c||(window.clearInterval(a.__checkLoaded),a.__checkLoaded=null,b())},200)},a.forceRenderFrame=function(){b.renderFrame({force:!0})};var c=!1;a.enableRayPick=function(a){c=a},a.pick=function(a,c,d,e){return b?b.pick(a,c,{rayPick:d,regionPick:e}):(Human.log.error("Human.renderer.pick","Engine not started, ignoring pick"),null)},a.getScene=function(){return SceneJS.scene(Human.SCENE_ROOT_ID)},a.getContentRootNode=function(){return a.getNode(Human.CONTENT_ROOT_ID)},a.getNode=function(a){return b.findNode(a)},a.getLookAt=function(){return a.getNode(Human.LOOKAT_ID)},a.nodeExists=function(a){var c=b.findNode(a);return null!==c&&void 0!==c},a.getViewMat=function(){return a.getNode(Human.LOOKAT_ID).getMatrix()},a.getProjMat=function(){return a.getNode(Human.CAMERA_ID).getMatrix();

}}(),function(){"use strict";function a(a,b){var c=[];b="boolean"==typeof b?b:!0;for(var d=0;d<a.length;d++)c.push(Math.round(a[d]*(b?255:1)));return"rgb("+c.join(",")+")"}function b(a,b,c){var d,e=$("#container"),f=["-webkit-","-moz-","-ms-","-o-",""];c?(e.css("background-image","-gradient(radial, center center, 0px, center center, 100%, color-stop(0%,"+b+"), color-stop(100%,"+a+"))"),d="radial-gradient(ellipse at center, "+b+" 0%, "+a+" 100%)"):(e.css("background-image","-webkit-gradient(linear, left top, left bottom, color-stop(0, "+a+"), color-stop(1, "+b+")"),d="linear-gradient(top, "+a+" 0%, "+b+" 100%)");for(var g=0;g<f.length;g++){var h=f[g]+d;e.css("background-image",h)}}function c(a){var b=document.body.className;document.body.className=b=b.replace(/bg-([^\s]*)/,"");var c="bg-"+a;document.body.className=(b+" "+c).trim()}var d=Human.request.getSearchParam("bgstd")||Human.cookies.getCookie("background")||"standard",e=!0,f=!0,g=Human.renderer.bg={};g.bgColor=d,g.bgColors={black:[0,0,0,0,0,0,0,0,0,0,0,0],white:[1,1,1,1,1,1,1,1,1,1,1,1],standard:[.13,.15,.17,.13,.15,.17,.54,.58,.64,.54,.58,.64],quiz:[1,1,1,1,1,1,1,1,1,1,1,1]},g.getBGColor=function(){return g.bgColor},Human.properties.subscribe({propId:"backgrounds",subId:"background",value:g.bgColors,callback:function(a){g.bgColors=a,f=!0}}),Human.properties.subscribe({propId:"background.radial",callback:function(a){a=!!a,e!==a&&(e=a,f=!0)}}),Human.events.on("tick",function(){f&&(g.setBGColor(g.bgColor,e),f=!1)}),Human.events.on("highlight.toggled",function(a){if(a.enabled===!0){var b=Human.cookies.getCookie("background")||"standard";Human.properties.resubscribe("background","background."+b)}}),Human.renderer.setBGColor=g.setBGColor=function(e,f){f=f!==!1;var h,i,j=/^([\d\.]+,){2,15}[\d\.]+$/.test(e),k=function(a){for(var b=0;b<a.length;b++)if(parseFloat(a[b])>1)return!0;return!1};if(e||(e=d),"string"==typeof e){if(j){var l=e.split(","),m=l.length,n=!k(l);switch(m){case 16:h=a(l.slice(0,3)),i=a(l.slice(12,15));break;case 12:h=a(l.slice(0,3)),i=a(l.slice(9,12));break;case 6:h=a(l.slice(0,3),n),i=a(l.slice(3,6),n);break;case 3:h=i=a(l,!1);break;default:return}e="custom"}else"standard"===e?(h=a(g.bgColors[e].slice(0,3)),i=a(g.bgColors[e].slice(9,12))):h=i=e;g.bgColor=e,c(/rgb\([\d,]+\)/.test(g.bgColor)?"custom":g.bgColor),b(h,i,f),Human.renderer.shader.setBGColor(g.bgColor)}}}(),function(){"use strict";function a(a){q=a,r=!0}function b(a){p?p.setParams(a):o=!0,Human.utils.apply(a,n)}function c(){d();var a=[],b={};i&&(a.push("uniform bool  transparent;"),a.push("uniform bool  xray;"),a.push("uniform float glassFactor;"),a.push("uniform float murkiness;"),a.push("uniform float xrayGlassFactor;"),a.push("uniform float xrayMurkiness;"),a.push("uniform float opacity;")),(i||j)&&a.push("uniform vec3  xrayBGColor;"),(i||j)&&(a.push("uniform bool highlight;"),a.push("uniform bool desaturate;")),k&&(a.push("uniform float  fogDensity;"),a.push("uniform float  fogStart;"),a.push("uniform float  fogEnd;"),a.push("uniform float  fogMin;"),a.push("uniform float  fogMax;"),a.push("uniform vec3   fogColor;"),a.push("vec4 _std_viewPos;"),a.push("void _std_viewPosFunc(vec4 viewPos) {"),a.push("   _std_viewPos = viewPos;"),a.push("}"),b.viewPos="_std_viewPosFunc"),i&&(a.push("vec3 _std_viewNormal = vec3(0.0, 0.0,  -1.0);"),a.push("vec3 _std_viewEyeVec = vec3(0.0, 0.0, -1.0);"),a.push("void _std_ViewNormalFunc(vec3 vec) {"),a.push("   _std_viewNormal = vec;"),a.push("}"),a.push("float _std_MaterialAlphaFunc(float alpha) {"),a.push("   if (xray) {"),a.push("       alpha = (xrayGlassFactor  * (xrayMurkiness - abs(dot(_std_viewNormal, _std_viewEyeVec))));"),a.push("   }"),a.push("   else if (transparent) {"),a.push("       if (opacity < alpha) {"),a.push("           alpha = opacity;"),a.push("       }"),a.push("       float gf = (glassFactor  * (murkiness - abs(dot(_std_viewNormal, _std_viewEyeVec))));"),a.push("       if (gf > alpha) {"),a.push("           alpha = gf;"),a.push("       }"),a.push("   }"),a.push("   return alpha;"),a.push("}"),b.viewNormal="_std_ViewNormalFunc",b.materialAlpha="_std_MaterialAlphaFunc"),(i||j||k)&&(a.push("vec4 _std_PixelColorFunc(vec4 color) {"),a.push("   if (highlight) {"),j&&(a.push("       float intensity = 0.3 * color.r + 0.59 * color.g + 0.11 * color.b;"),a.push("       color = vec4((intensity * -0.1) + color.rgb * (1.0 + 0.1), color.a);"),a.push("       color.r = clamp(color.r * 1.5, 0.3, 1.0);"),a.push("       color.g = clamp(color.g * 1.5, 0.3, 1.0);"),a.push("       color.b = color.b * 0.5;")),a.push("   } else if (desaturate) {"),i&&a.push("       color.rgb = xrayBGColor;"),a.push("   } "),k&&("linear"===l?a.push("float fog = (length(_std_viewPos.xyz) - fogStart) / (fogEnd - fogStart);"):(a.push("float attenuation = fogDensity * max(length(_std_viewPos.xyz) - fogStart, 0.0);"),"exp2"===l&&a.push("attenuation = attenuation * attenuation;"),a.push("float fog = 1.0 - exp(-attenuation);")),a.push("fog = clamp(fog, fogMin, fogMax);"),a.push("color.rgb = mix(color.rgb, fogColor, fog);")),a.push("   return color;"),a.push("}"),b.pixelColor="_std_PixelColorFunc");var c={type:"shader",shaders:[{stage:"fragment",code:a,hooks:b}],params:s},e=Human.renderer.getContentRootNode(),f=e.parent,g=f.disconnectNodes();p=f.addNode(c),p.addNodes(g)}function d(){p&&(p.splice(),p.destroy(),p=null)}function e(){var a=f[q]||f["default"]||[.8,.8,1],c=g[q];(void 0===c||null===c)&&(c=g["default"]),(void 0===c||null===c)&&(c=1);var d=h[q];(void 0===d||null===d)&&(d=h["default"]),(void 0===d||null===d)&&(d=.8),b({xrayBGColor:a,xrayGlassFactor:c,xrayMurkiness:d})}Human.renderer.shader={setBGColor:a};var f={white:[0,0,.1],black:[.8,.8,.9],standard:[.8,.8,.9],"default":[.8,.8,.9]},g={white:1,black:1,standard:1,"default":1},h={white:.8,black:.8,standard:.8,"default":.8},i=!0,j=!0,k=!1,l="exp",m=!0,n={},o=!1,p=null,q=Human.request.getSearchParam("bgstd")||Human.cookies.getCookie("background")||"standard",r=!0,s={transparent:!1,xray:!1,glassFactor:.4,murkiness:.8,xrayGlassFactor:1,xrayMurkiness:.8,highlight:!1,opacity:1,desaturate:!1,xrayBGColor:[0,0,.1],fogDensity:.01,fogStart:0,fogEnd:1e3,fogMin:0,fogMax:1,fogColor:[1,1,1]};Human.properties.subscribe({subId:"colorsForBackgrounds",propId:"xray.colorsForBackgrounds",value:f,callback:function(a){f=a,r=!0}}),Human.properties.subscribe({subId:"glassFactorsForBackgrounds",propId:"xray.glassFactorsForBackgrounds",value:g,callback:function(a){g=a,r=!0}}),Human.properties.subscribe({subId:"murkinessForBackgrounds",propId:"xray.murkinessForBackgrounds",value:h,callback:function(a){h=a,r=!0}}),Human.properties.subscribe({subId:"glassFactor",propId:"xray.glassFactor",value:s.glassFactor,callback:function(a){b({glassFactor:a})}}),Human.properties.subscribe({subId:"murkiness",propId:"xray.murkiness",value:s.murkiness,callback:function(a){b({murkiness:a})}}),Human.properties.subscribe({propId:"xray.enabled",value:i,callback:function(a){i=a,m=!0}}),Human.properties.subscribe({propId:"highlight.enabled",value:j,callback:function(a){j=a,m=!0}}),Human.properties.subscribe({propId:"fog.enabled",value:k,callback:function(a){k=a,m=!0}}),Human.properties.subscribe({propId:"fog.mode",value:l,callback:function(a){l=a,m=!0}}),Human.properties.subscribe({propId:"fog.start",value:s.fogStart,callback:function(a){b({fogStart:a})}}),Human.properties.subscribe({propId:"fog.end",value:s.fogEnd,callback:function(a){b({fogEnd:a})}}),Human.properties.subscribe({propId:"fog.min",value:s.fogMin,callback:function(a){b({fogMin:a})}}),Human.properties.subscribe({propId:"fog.max",value:s.fogMax,callback:function(a){b({fogMax:a})}}),Human.properties.subscribe({propId:"fog.density",value:s.fogDensity,callback:function(a){b({fogDensity:a})}}),Human.properties.subscribe({propId:"fog.color",value:s.fogColor,callback:function(a){b({fogColor:a})}}),Human.events.on("tick",function(){m&&(i||j?(c(),o=!0):d(),m=!1),o&&p&&(p.setParams(n),o=!1),r&&(e(),r=!1)})}(),function(){"use strict";function a(){var a=b.parent(),c=a.width(),d=a.height(),e=Human.renderer.SSAA_MULTIPLIER;b.attr({width:c*e,height:d*e}),b.css({width:c,height:d});var f=$("#annotationCanvas");f.attr({width:c,height:d}),Human.events.fire("canvas.resized",{canvasWidth:c,canvasHeight:d})}var b=$("#"+Human.CANVAS_ID);Human.renderer.canvas={canvas:b,getCanvas:function(){return b}},Human.renderer.resize=a,$(window).resize(a),a()}(),function(){"use strict";Human.rpc.define("renderer.getBGColor",function(){this.setResult(Human.renderer.bg.getBGColor())}),Human.rpc.define("renderer.setBGColor",function(a){Human.renderer.bg.setBGColor(a.color)})}(),function(){"use strict";var a=Human.view={},b=["Highlight","Xray","Isolate"];a.currentMode=b[0],a.setModeEnabled=function(a){if(a=a.toLowerCase(),"isolate"===a&&!Human.scene.anySelected())return void alert("Please select an object before Isolating.");var c=b.map(function(a){return a.toLowerCase()}),d=c.indexOf(a);d>=0&&c.forEach(function(a,b){var c=d===b;Human.view[a].setEnabled(c)})}}(),function(){"use strict";function a(a,b){a&&Human.view.annotations.unsavedAnnotation?alert("Please save or cancel annotation first"):b()}Human.rpc.define("dissect.setEnabled",function(b){var c=b.enable;(void 0===c||null===c)&&(c=!Human.view.dissect.enabled),a(c,function(){Human.view.dissect.setEnabled(c),c?(Human.view.pick.setMultiPickEnabled(!1),Human.view.pick.setSinglePickEnabled(!1),Human.view.annotations.setEnabled(!1)):Human.view.pick.setSinglePickEnabled(!0)})}),Human.rpc.define("highlight.setEnabled",function(a){var b=a.enable;(void 0===b||null===b)&&(b=!Human.view.highlight.enabled),Human.view.highlight.setEnabled(b),b&&(Human.view.isolate.setEnabled(!1),Human.view.xray.setEnabled(!1))}),Human.rpc.define("isolate.setEnabled",function(a){var b=a.enable;if((void 0===b||null===b)&&(b=!Human.view.isolate.enabled),b){var c=Human.scene.anySelected();if(!c)return void alert("Please select an object before Isolating.")}Human.view.isolate.setEnabled(b),b&&(Human.view.highlight.setEnabled(!1),Human.view.xray.setEnabled(!1),Human.view.pick.setSinglePickEnabled(!0),Human.view.pick.setMultiPickEnabled(!1))}),Human.rpc.define("pick.single.setEnabled",function(b){var c=b.enable;(void 0===c||null===c)&&(c=!Human.view.pick.getSinglePickEnabled()),a(c,function(){Human.view.pick.setSinglePickEnabled(c),c&&(Human.view.pick.setMultiPickEnabled(!1),Human.view.dissect.setEnabled(!1),Human.view.annotations.setEnabled(!1))})}),Human.rpc.define("pick.multi.setEnabled",function(b){var c=b.enable;(void 0===c||null===c)&&(c=!Human.view.pick.getMultiPickEnabled()),a(c,function(){Human.view.pick.setMultiPickEnabled(c),c?(Human.view.pick.setSinglePickEnabled(!1),Human.view.dissect.setEnabled(!1),Human.view.annotations.setEnabled(!1)):Human.view.pick.setSinglePickEnabled(!0)})}),Human.rpc.define("pick.pick",function(a){Human.view.pick.pick({canvasX:a.canvasX,canvasY:a.canvasY})}),Human.rpc.define("pick.doublePick",function(a){Human.view.pick.doublePick({canvasX:a.canvasX,canvasY:a.canvasY})}),Human.rpc.define("pick.hoverPick",function(a){Human.view.pick.hoverPick({canvasX:a.canvasX,canvasY:a.canvasY})}),Human.rpc.define("pick.queryPick",function(a){this.setResult(Human.view.pick.queryPick({canvasX:a.canvasX,canvasY:a.canvasY,rayPick:a.rayPick})||{})}),Human.rpc.define("annotations.setEnabled",function(b){var c=b.enable;(void 0===c||null===c)&&(c=!Human.view.annotations.enabled),a(!c,function(){Human.view.annotations.setEnabled(c),c?(Human.view.pick.setSinglePickEnabled(!1),Human.view.pick.setMultiPickEnabled(!1),Human.view.dissect.setEnabled(!1)):Human.view.pick.setSinglePickEnabled(!0)})}),Human.rpc.define("xray.setEnabled",function(a){var b=a.enable;(void 0===b||null===b)&&(b=!Human.view.xray.enabled),Human.view.xray.setEnabled(b),b&&(Human.view.highlight.setEnabled(!1),Human.view.isolate.setEnabled(!1))}),Human.rpc.define("queryModes",function(){var a={xray:Human.view.xray.enabled,highlight:Human.view.highlight.enabled,annotation:Human.view.annotations.enabled,singlePick:Human.view.pick.singleEnabled,multipick:Human.view.pick.multiEnabled,dissect:Human.view.dissect.enabled};this.setResult(a)}),Human.rpc.define("jquery",function(a){"document"===a.selector&&(a.selector=document),$.fn[a.method].apply($(a.selector),a.args)}),Human.rpc.define("navigation.setEnabled",function(a){b("navigator_container",a.enable)}),Human.rpc.define("fullscreen.setEnabled",function(a){b("embed-full-screen",a.enable)}),Human.rpc.define("injectStyles",function(a){if(window!==top){var b=a.styles,c=document.head||document.getElementsByTagName("head")[0],d=document.getElementsByTagName("link"),e=d[d.length-1],f=document.createElement("style");f.type="text/css",f.styleSheet?f.styleSheet.cssText=b:f.appendChild(document.createTextNode(b)),c.insertBefore(f,e),Human.view.annotations.updateDimensions(),Human.view.annotations.layouts.redrawLayout()}});var b=function(a,b){var c="undefined"==typeof b?!0:b,d=document.getElementById(a);d.style.display=c?"block":"none"}}(),function(){"use strict";var a=Human.view.mouseCursor={},b={DEFAULT:0,PAN:1,PROGRESS:2,ROTATE:3,ZOOM_IN:4,ZOOM_OUT:5},c=b.PROGRESS,d="pointer",e=0;Human.events.on("processes.started",function(){1===++e&&a.gotoProgress()}),Human.events.on("processes.finished",function(){--e<=0&&(e=0,a.gotoDefault())}),Human.events.on("processes.failed",function(){--e<=0&&(e=0,a.gotoDefault())}),Human.events.on("dissect.toggled",function(){a.gotoDefault()}),a.setDefault=function(a){return"pointer"!==a&&"crosshair"!==a?void Human.log.error("Human.view.mouseCursor","Unsupported default cursor type: "+a):(d=a,void(c===b.DEFAULT&&$("body").css("cursor",a)))},a.gotoDefault=function(){$("body").css("cursor",Human.view.dissect.getEnabled()?"crosshair":d),c=b.DEFAULT},a.gotoPan=function(){c!==b.PROGRESS&&($("body").css("cursor","move"),c=b.PAN)},a.gotoProgress=function(){(c===b.DEFAULT||c===b.PROGRESS)&&($("body").css("cursor","progress"),c=b.PROGRESS)},a.gotoRotate=function(){c!==b.PROGRESS&&($("body").css("cursor","n-resize"),c=b.ROTATE)},a.gotoZoomIn=function(){c!==b.PROGRESS&&($("body").css("cursor","url(Images/zoom-in.png), auto"),c=b.ZOOM_IN)},a.gotoZoomOut=function(){c!==b.PROGRESS&&($("body").css("cursor","url(Images/zoom-out.png), auto"),c=b.ZOOM_OUT)}}(),function(){"use strict";var a=Human.view.camera={},b=null,c=null,d=Human.math.vec3(),e=Human.math.vec3(),f=Human.math.vec3(),g=Human.math.vec3(),h=Human.math.vec3(),i=Human.math.vec3(),j=Human.math.vec3(),k=Human.math.vec3(),l=Human.math.vec3(),m=Human.math.mat4();a.eye={x:0,y:0,z:-80},a.look={x:0,y:0,z:0},a.up={x:0,y:1,z:0},a._screenPan={x:0,y:0,z:0};var n=!1,o=!1,p=!1,q=[];a.lock=!1,a.aspect=1,Human.properties.subscribe({propId:"camera.optics.aspect",value:a.aspect,callback:function(b){a.aspect=b,o=!0}}),a.fovy=55,Human.properties.subscribe({propId:"camera.optics.fov",value:a.fovy,callback:function(b){a.fovy=b,o=!0}}),a.near=.1,Human.properties.subscribe({propId:"camera.optics.near",value:.1,callback:function(b){a.near=b,o=!0}}),a.far=5e3,Human.properties.subscribe({propId:"camera.optics.far",value:5e3,callback:function(b){a.far=b,o=!0}}),a.minZoom=.01,a.maxZoom=150,Human.properties.subscribe({propId:"camera.zoomLimits",value:{min:.01,max:150},callback:function(b){return b.min<.01?void Human.log.error("Human.view.camera","Property 'camera.zoomLimits.min' too small - should be >= 0.01"):b.min>=b.max?void Human.log.error("Human.view.camera","Property 'camera.zoomLimits.min' should be less than camera.zoomLimits.max"):(a.minZoom=b.min,a.maxZoom=b.max,void(n=!0))}});var r=!0;Human.properties.subscribe({propId:"camera.gimbalLockY",value:r,callback:function(a){r=a}});var s=!1;Human.properties.subscribe({propId:"camera.constrainRotateX",value:s,callback:function(a){s=a}});var t=!1;Human.properties.subscribe({propId:"camera.firstPerson",value:t,callback:function(a){t=a}}),Human.events.on("loaded",function(){a._lookatNode=b=Human.renderer.getNode(Human.LOOKAT_ID),a._cameraNode=c=Human.renderer.getNode(Human.CAMERA_ID);var d=c.get("optics");a.aspect=d.aspect,a.fovy=d.fovy,n=!0,o=!0,p=!1}),Human.events.on("canvas.resized",function(b){a.setAspect(b.canvasWidth/b.canvasHeight)}),Human.events.on("tick",function(){n?(b.setEye(a.eye),b.setLook(a.look),b.setUp(a.up),Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.subVec3(d,e,l),Human.events.fire("camera.updated",{eye:a.eye,look:a.look,up:a.up,dist:Math.abs(Human.math.lenVec3(l))}),p=!1,n=!1):p||(p=!0,Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.subVec3(d,e,l),Human.events.fire("camera.rested",{eye:a.eye,look:a.look,up:a.up,dist:Math.abs(Human.math.lenVec3(l))})),o&&(c.set({optics:{type:"perspective",fovy:a.fovy,near:a.near,far:a.far,aspect:a.aspect},pan:a._screenPan}),o=!1)}),a.addConstraint=function(a){q.push(a)},a.removeConstraint=function(a){for(var b=0,c=q.length;c>b;b++)if(q[b]===a)return void q.splice(b,1)},a.setLookAt=function(b){a._setConstrainedLookat(b.eye,b.look,b.up)},a._setConstrainedLookat=function(b,c,d){b=b||a.eye,c=c||a.look,d=d||a.up;for(var e=0,f=q.length;f>e;e++)if(!q[e](b,c,d))return Human.events.fire("camera.constrained"),!1;a.eye=b,a.look=c,a.up=d,n=!0},a._clampEye=function(b){e[0]=a.look.x,e[1]=a.look.y,e[2]=a.look.z,d[0]=b.x,d[1]=b.y,d[2]=b.z,Human.math.subVec3(d,e,l),Human.math.normalizeVec3(l,l);var c=Math.abs(Human.math.lenVec3(l));if(c<a.minZoom)Human.math.mulVec3Scalar(l,a.minZoom,l),Human.math.addVec3(e,l,l);else{if(!(c>a.maxZoom))return b;Human.math.mulVec3Scalar(l,a.maxZoom,l),Human.math.addVec3(e,l,l)}return{x:l[0],y:l[1],z:l[2]}},a.getLookAt=function(){return{eye:a.eye,look:a.look,up:a.up}},a.getEye=function(){return a.eye},a.getLook=function(){return a.look},a.getUp=function(){return a.up},a.setScreenPan=function(b){a._screenPan.x=b.x||0,a._screenPan.y=b.y||0,a._screenPan.z=b.z||0,o=!0},a.getScreenPan=function(){return a._screenPan},a._reset={eye:{x:a.eye.x,y:a.eye.y,z:a.eye.z},look:{x:a.look.x,y:a.look.y,z:a.look.z},up:{x:a.up.x,y:a.up.y,z:a.up.z}},a.reset=function(){a.yaw=0,a.pitch=90,a._eye={x:a._reset.eye.x,y:a._reset.eye.y,z:a._reset.eye.z},a._look={x:a._reset.look.x,y:a._reset.look.y,z:a._reset.look.z},a._up={x:a._reset.up.x,y:a._reset.up.y,z:a._reset.up.z},n=!0},a.rotateX=function(b){a.lock||(t?a.rotateLookX(-b):a.rotateEyeX(b))},a.rotateY=function(b){a.lock||(t?a.rotateLookY(-b):a.rotateEyeY(b))},a.rotateEyeY=function(b){a.lock||(Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.vec3ObjToArray(a.up,f),Human.math.subVec3(d,e,d),Human.math.rotationMat4v(.0174532925*b,r?[0,1,0]:f,m),Human.math.transformVector3(m,d,d),Human.math.addVec3(d,e,d),r&&Human.math.transformVector3(m,f,f),a.setLookAt({eye:{x:d[0],y:d[1],z:d[2]},up:{x:f[0],y:f[1],z:f[2]}}))},a.rotateEyeX=function(b){a.lock||(Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.vec3ObjToArray(a.up,f),Human.math.subVec3(d,e,d),Human.math.normalizeVec3(d,g),Human.math.normalizeVec3(f,i),Human.math.cross3Vec3(g,i,j),Human.math.rotationMat4v(.0174532925*b,j,m),Human.math.transformVector3(m,d,d),Human.math.addVec3(d,e,d),Human.math.transformVector3(m,f,f),a.setLookAt({eye:{x:d[0],y:d[1],z:d[2]},up:{x:f[0],y:f[1],z:f[2]}}))},a.rotateLookY=function(b){a.lock||(Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.vec3ObjToArray(a.up,f),Human.math.subVec3(e,d,e),Human.math.rotationMat4v(.0174532925*b,r?[0,1,0]:f,m),Human.math.transformVector3(m,e,e),Human.math.addVec3(e,d,e),a.setLookAt({look:{x:e[0],y:e[1],z:e[2]},up:{x:f[0],y:f[1],z:f[2]}}))},a.rotateLookX=function(b){a.lock||(Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.vec3ObjToArray(a.up,f),Human.math.subVec3(e,d,e),Human.math.normalizeVec3(e,h),Human.math.normalizeVec3(f,i),Human.math.cross3Vec3(h,i,j),Human.math.rotationMat4v(.0174532925*b,j,m),Human.math.transformVector3(m,e,e),Human.math.addVec3(e,d,e),Human.math.transformVector3(m,f,f),a.setLookAt({look:{x:e[0],y:e[1],z:e[2]},up:{x:f[0],y:f[1],z:f[2]}}))};var u=Human.math.vec3();a.pan=function(b){if(!a.lock){if(Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.vec3ObjToArray(a.up,f),Human.math.subVec3(d,e,u),Human.math.zeroVec(k),void 0!==b.x&&null!==b.x){Human.math.normalizeVec3(u,g),Human.math.normalizeVec3(f,i);var c=Human.math.cross3Vec3(u,f,j);Human.math.normalizeVec3(Human.math.cross3Vec3(u,f,j),c),Human.math.mulVec3Scalar(c,b.x,l),k[0]+=l[0],k[1]+=l[1],k[2]+=l[2]}void 0!==b.y&&null!==b.y&&(Human.math.normalizeVec3(f,i),Human.math.mulVec3Scalar(i,b.y,l),k[0]+=l[0],k[1]+=l[1],k[2]+=l[2]),void 0!==b.z&&null!==b.z&&(Human.math.normalizeVec3(d,g),Human.math.mulVec3Scalar(g,b.z,l),k[0]+=l[0],k[1]+=l[1],k[2]+=l[2]),Human.math.addVec3(d,k,d),Human.math.addVec3(e,k,e),a.setLookAt({eye:{x:d[0],y:d[1],z:d[2]},look:{x:e[0],y:e[1],z:e[2]}})}},a.setAspect=function(b){a.aspect=b,o=!0},a.viewRight=function(){if(!a.lock){var b=Human.init.bookmark.camera.eye,c=b.z,d=b.y;a.setLookAt({look:{x:0,y:d,z:0},eye:{x:-c,y:d,z:0},up:{x:0,y:1,z:0}})}},a.viewLeft=function(){if(!a.lock){var b=Human.init.bookmark.camera.eye,c=b.z,d=b.y;a.setLookAt({look:{x:0,y:d,z:0},eye:{x:c,y:d,z:0},up:{x:0,y:1,z:0}})}},a.viewPosterior=function(){if(!a.lock){var b=Human.init.bookmark.camera.eye,c=b.z,d=b.y;a.setLookAt({look:{x:0,y:d,z:0},eye:{x:0,y:d,z:-c},up:{x:0,y:1,z:0}})}},a.viewAnterior=function(){if(!a.lock){var b=Human.init.bookmark.camera.eye,c=b.z,d=b.y;a.setLookAt({look:{x:0,y:d,z:0},eye:{x:0,y:d,z:c},up:{x:0,y:1,z:0}})}},a.viewSuperior=function(){if(!a.lock){var b=Human.init.bookmark.camera.eye,c=b.z,d=b.y;a.setLookAt({look:{x:0,y:d,z:0},eye:{x:0,y:-c+d,z:0},up:{x:0,y:0,z:1}})}},a.viewInferior=function(){if(!a.lock){var b=Human.init.bookmark.camera.eye,c=b.z,d=b.y;a.setLookAt({look:{x:0,y:d,z:0},eye:{x:0,y:c+d,z:0},up:{x:0,y:0,z:-1}})}},a.zoom=function(b){if(!a.lock){Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.subVec3(d,e,d);var c=Math.abs(Human.math.lenVec3(d)),f=Math.abs(c+b);if(a.minZoom&&a.maxZoom){var h=c/a.maxZoom*.6;b=40*b*h,f=Math.abs(c+b),f<a.minZoom?f=a.minZoom:f>a.maxZoom&&(f=a.maxZoom)}Human.math.normalizeVec3(d,g),Human.math.mulVec3Scalar(g,f,d),Human.math.addVec3(e,d,d),a.setLookAt({eye:{x:d[0],y:d[1],z:d[2]}})}},a.setZoom=function(b){a.lock||(Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.subVec3(d,e,d),Human.math.normalizeVec3(d,g),Human.math.mulVec3Scalar(g,a.minZoom+(1-b)*(a.maxZoom-a.minZoom),d),Human.math.addVec3(e,d,d),a.setLookAt({eye:{x:d[0],y:d[1],z:d[2]}}))},a.getZoom=function(){Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.subVec3(d,e,d);var b=Math.abs(Human.math.lenVec3(d));return 1-(b-a.minZoom)/a.maxZoom},a.setZoomPercent=function(b){a.lock||(Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.subVec3(d,e,d),Human.math.normalizeVec3(d,g),Human.math.mulVec3Scalar(g,a.minZoom+.01*(100-b)*(a.maxZoom-a.minZoom),d),a.setLookAt({eye:{x:e[0]+d[0],y:e[1]+d[1],z:e[2]+d[2]}}))},a.getZoomPercent=function(){Human.math.vec3ObjToArray(a.eye,d),Human.math.vec3ObjToArray(a.look,e),Human.math.subVec3(d,e,d);var b=Math.abs(Human.math.lenVec3(d));return 100-(b-a.minZoom)/a.maxZoom*100}}(),function(){"use strict";Human.rpc.define("camera.flyTo",function(a){var b=this;Human.view.camera.fly.flyTo(a,function(){b.setResult(!0)})}),Human.rpc.define("camera.jumpTo",function(a){var b=this;Human.view.camera.fly.jumpTo(a,function(){b.setResult(!0)})}),Human.rpc.define("camera.orbit",function(a){var b=a.yaw,c=a.pitch;void 0!==b&&null!==b&&0!==b&&Human.view.camera.rotateY(b),void 0!==c&&null!==c&&0!==c&&Human.view.camera.rotateX(c)}),Human.rpc.define("camera.pan",function(a){Human.view.camera.pan({x:a.x||0,y:a.y||0,z:a.z||0})}),Human.rpc.define("camera.zoom",function(a){Human.view.camera.setZoom(a.factor||0)}),Human.rpc.define("camera.getZoom",function(){this.setResult(Human.view.camera.getZoom())}),Human.rpc.define("camera.query",function(){this.setResult(Human.view.camera.getLookAt())}),Human.rpc.define("camera.reset",function(){var a=this;Human.init.resetCamera(function(){a.setResult(!0)})})}(),function(){"use strict";function a(a,c){Human.view.camera.lock=!0,c&&f.push(c),a=a||{},g=new Human.view.camera.fly.Animation({target:a.target,arc:a.arc,backOff:a.backOff,velocity:a.velocity,constrainUp:a.constrainUp,onComplete:b})}function b(){for(g=null;f.length>0;)f.pop()();Human.view.camera.lock=!1}function c(a){var b=a.backOff||0;0>b?b=0:b>1&&(b=1),b=1-b;var c=Human.math.vec3ObjToArray(Human.view.camera.look),d=Human.math.vec3ObjToArray(Human.view.camera.eye),e=Human.math.vec3();Human.math.subVec3(d,c,e),Human.math.normalizeVec3(e,e);var f=a.boundary,g=Human.math.getBoundaryCenter(f),h=a.stopFOV,i=Human.math.lenVec3(e),j=Human.math.getBoundaryDiag(f),k=Math.abs(j/(1+.8*b)/Math.tan(h/2)),l=k/i;return Human.math.mulVec3Scalar(e,l,e),Human.math.addVec3(g,e,e),{target:{eye:{x:e[0],y:e[1],z:e[2]},look:{x:g[0],y:g[1],z:g[2]},up:{x:0,y:1,z:0}}}}var d,e=Human.view.camera.fly={};Human.properties.subscribe({propId:"camera.flyTo",value:{stopFOV:55},callback:function(a){d=a.stopFOV||55}});var f=[],g=null,h=Human.math.vec3(),i=Human.math.vec3(),j=Human.math.vec3(),k=Human.math.vec3();Human.events.on("tick",function(){g&&g.update(Date.now())}),e.flyTo=function(b,c,d){var e,f,g;if(c=c||function(){},d=d||function(a){Human.log.error("Human.view.camera.fly",a),c()},b.objectId){if(g=b.objectId,e=Human.scene.objects[g],!e)return void d("No scene object found for the given ID: '"+g+"'");f=Human.scene.getBoundary({objectId:g}),f?(Human.view.boundary.setBoundary(f,!0),a({target:{boundary:f},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){Human.view.boundary.setBoundary(f,!1),c()})):c()}else if(b.fmaId){var l=b.fmaId;if(e=Human.scene.objectsByFMAID[l],!e)return void d("no object found for the given FMA ID: '"+l+"'");f=Human.scene.getBoundary({objectId:e.objectId}),f?(Human.view.boundary.setBoundary(f,!0),a({target:{boundary:f},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){Human.view.boundary.setBoundary(f,!1),c()})):c()}else if(b.boundary)f=b.boundary,Human.view.boundary.setBoundary(f,!0),a({target:{boundary:f},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){Human.view.boundary.setBoundary(f,!1),c()});else if(b.lookVec){var m=b.lookVec,n=Human.view.camera.eye,o=Human.view.camera.look;j[0]=m.x,j[1]=m.y,j[2]=m.z,h[0]=n.x,h[1]=n.y,h[2]=n.z,i[0]=o.x,i[1]=o.y,i[2]=o.z,Human.math.subVec3(i,h,k);var p=Human.math.lenVec3(k);Human.math.subVec3(j,h,k);var q=Human.math.lenVec3(k),r=p/q;Human.math.lerpVec3(r,0,1,i,j,i),a({target:{look:{x:i[0],y:i[1],z:i[2]}},arc:b.arc,velocity:b.velocity},c)}else if(b.eye||b.look)a({target:{eye:b.eye,look:b.look,up:b.up},arc:b.arc,backOff:b.backOff,velocity:b.velocity,constrainUp:!1},c);else if(b.selectedObjects)f=Human.scene.getBoundary({objects:Human.scene.selectedObjects}),Human.view.boundary.setBoundary(f,!0),a({target:{boundary:f},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){Human.view.boundary.setBoundary(f,!1),c()});else if(b.selectedLeafObjects){var s=[],t=Human.scene.selectedObjects;for(g in t)t.hasOwnProperty(g)&&(e=t[g],0===e.objects.length&&s.push(g));f=Human.scene.getBoundary({objectIds:s}),Human.view.boundary.setBoundary(f,!0),a({target:{boundary:f},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){Human.view.boundary.setBoundary(f,!1),c()})}else b.enabledObjects?(f=Human.scene.getBoundary({objects:Human.scene.enabledObjects}),a({target:{boundary:f},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){Human.view.boundary.setBoundary(f,!1),c()})):b.objects?(f=Human.scene.getBoundary({objectIds:b.objects}),a({target:{boundary:f},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){Human.view.boundary.setBoundary(f,!1),c()})):a({target:{eye:{x:0,y:6,z:-70},look:{x:0,y:0,z:0},up:{x:0,y:1,z:0}},arc:b.arc,backOff:b.backOff,velocity:b.velocity},function(){c()})},e.jumpTo=function(a,e,f){var g,h,i;e=e||function(){},f=f||function(a){Human.log.error("Human.view.camera.fly",a),e()};var j;if(a.objectId){if(i=a.objectId,g=Human.scene.objects[i],!g)return void f("No scene object found for the given ID: '"+i+"'");h=Human.scene.getBoundary({objectId:i}),h&&(j={target:{boundary:h},backOff:a.backOff})}else if(a.fmaId){var k=a.fmaId;if(g=Human.scene.objectsByFMAID[k],!g)return void f("no object found for the given FMA ID: '"+k+"'");h=Human.scene.getBoundary({objectId:g.objectId}),h&&(j={target:{boundary:h},backOff:a.backOff})}else if(a.boundary)j=c(a);else if(a.eye||a.look){if(!a.eye&&!a.look)return void f("incomplete parameter configuration: both 'eye' and 'look' expected");j={target:{eye:a.eye,look:a.look,up:a.up}}}else if(a.selectedObjects)h=Human.scene.getBoundary({objects:Human.scene.selectedObjects}),Human.view.boundary.setBoundary(h,!0),j={target:{boundary:h},backOff:a.backOff};else if(a.enabledObjects)h=Human.scene.getBoundary({objects:Human.scene.enabledObjects}),j={target:{boundary:h},backOff:a.backOff};else if(a.lookVec){var l=a.lookVec,m=Human.view.camera.eye,n=Human.view.camera.look,o=Human.math.lenVec3(Human.math.subVec3([n.x,n.y,n.z],[m.x,m.y,m.z])),p=Human.math.lenVec3(Human.math.subVec3([l.x,l.y,l.z],[m.x,m.y,m.z])),q=o/p,r=Human.math.lerpVec3(q,0,1,[n.x,n.y,n.z],[l.x,l.y,l.z]);j={target:{look:{x:r[0],y:r[1],z:r[2]}}}}else j={target:{eye:{x:0,y:6,z:-70},look:{x:0,y:0,z:0},up:{x:0,y:1,z:0}},backOff:a.backOff};j&&(b(),j.target.boundary?(j.target.stopFOV=d||j.target.stopFOV,Human.view.camera.fly.jumpTo(j.target)):Human.view.camera.setLookAt(j.target)),e()}}(),function(){"use strict";var a,b,c=Human.math.vec3();Human.properties.subscribe({propId:"camera.flyTo",value:{velocity:1,stopFOV:55},callback:function(c){a=c.velocity||1,b=c.stopFOV||55}}),Human.view.camera.fly.Animation=function(d){var e=d.target;if(this.arc=void 0===d.arc?0:d.arc,this.easing=void 0===d.easing?!0:d.easing,this.constrainUp=d.constrainUp!==!1,!e)return Human.log.error("Human.view.camera.fly.Animation config missing: target"),void(d.onComplete&&d.onComplete());var f=Human.view.camera;this._look1=Human.math.vec3ObjToArray(f.look),this._eye1=Human.math.vec3ObjToArray(f.eye),this._up1=Human.math.vec3ObjToArray(f.up),Human.math.subVec3(this._eye1,this._look1,c),this._vec=Human.math.normalizeVec3(c);var g=d.backOff||0;if(0>g?g=0:g>1&&(g=1),g=1-g,e.boundary){var h=e.boundary,i=e.dist||2.5,j=Math.abs(Human.math.lenVec3(this._vec)),k=Human.math.getBoundaryDiag(h),l=Math.abs(k/(1+.8*g)/Math.tan(b/2)),m=l/j*i;this._look2=Human.math.getBoundaryCenter(h),e.offset&&(this._look2[0]+=e.offset[0],this._look2[1]+=e.offset[1],this._look2[2]+=e.offset[2]),Human.math.mulVec3Scalar(this._vec,m,c),this._eye2=Human.math.addVec3(this._look2,c),this._up2=Human.math.vec3(),this._up2[1]=1}else{var n=e.look,o=e.eye,p=e.up,q=Human.view.camera.eye,r=Human.view.camera.look,s=Human.view.camera.up;this._look2=Human.math.vec3(),this._eye2=Human.math.vec3(),this._up2=Human.math.vec3(),n?(this._look2[0]=n.x||0,this._look2[1]=n.y||0,this._look2[2]=n.z||0):(this._look2[0]=r.x,this._look2[1]=r.y,this._look2[2]=r.z),o?(this._eye2[0]=o.x||0,this._eye2[1]=o.y||0,this._eye2[2]=o.z||0):(this._eye2[0]=q.x,this._eye2[1]=q.y,this._eye2[2]=q.z),p?(this._up2[0]=p.x||0,this._up2[1]=p.y||0,this._up2[2]=p.z||0):(this._up2[0]=s.x,this._up2[1]=s.y,this._up2[2]=s.z)}Human.math.subVec3(this._look2,this._look1,c);var t=Math.abs(Human.math.lenVec3(c));Human.math.subVec3(this._eye2,this._eye1,c);var u=Math.abs(Human.math.lenVec3(c));this._dist=t>u?t:u,this._duration=1e3*(this._dist/(200*(d.velocity||a))+1),this._onComplete=d.onComplete};var d=Human.math.vec3(),e=Human.math.vec3();Human.view.camera.fly.Animation.prototype.update=function(a){if(void 0===this._time1&&(this._time1=a,this._time2=this._time1+this._duration),this._done||a>this._time2)return this._done||Human.view.camera.setLookAt({look:Human.math.vec3ArrayToObj(this._look2),eye:Human.math.vec3ArrayToObj(this._eye2),
up:Human.math.vec3ArrayToObj(this._up2)}),this._done=!0,void this._onComplete(this);var b=(a-this._time1)/this._duration,f=this.easing?this._easeOut(b,0,1,1):b;Human.math.lerpVec3(f,0,1,this._eye1,this._eye2,d);var g;if(this.arc>0){var h=1+Math.sin(2*Math.PI*f-.75*Math.PI);g=this._dist*h*.1*this.arc,Human.math.mulVec3Scalar(this._vec,g,c),Human.math.addVec3(d,c,d)}if(Human.math.lerpVec3(f,0,1,this._look1,this._look2,e),this.constrainUp)Human.view.camera.setLookAt({look:Human.math.vec3ArrayToObj(e),eye:Human.math.vec3ArrayToObj(d)});else{var i=Human.math.lerpVec3(f,0,1,this._up1,this._up2,[]);Human.view.camera.setLookAt({look:Human.math.vec3ArrayToObj(e),eye:Human.math.vec3ArrayToObj(d),up:Human.math.vec3ArrayToObj(i)})}},Human.view.camera.fly.Animation.prototype._easeOut=function(a,b,c,d){var e=(a/=d)*a,f=e*a;return b+c*(-1*e*e+4*f+-6*e+4*a)},Human.view.camera.fly.Animation.prototype._easeIn=function(a,b,c,d){var e=(a/=d)*a,f=e*a;return b+c*f*e},Human.view.camera.fly.Animation.prototype.stop=function(){}}(),function(){"use strict";function a(){Human.events.on("modules.activated",b),Human.events.on("modules.deactivated",b),Human.view.camera.addConstraint(c)}function b(){var a=Human.scene.getBoundary();i[0]=[a.xmin+(a.xmax-a.xmin)/2,a.ymin+(a.ymax-a.ymin)/2,a.zmin+(a.zmax-a.zmin)/2]}function c(a,b,c){Human.math.lookAtMat4c(a.x,a.y,a.z,b.x,b.y,b.z,c.x,c.y,c.z,f);for(var d=Human.renderer.getProjMat(),j=0,k=i.length;k>j;j++){Human.math.transformPoint3(f,i[j],g),g[3]=1,g[2]>-.1||g[2]<-1e4,Human.math.transformPoint4(d,g,h);var l=h[0],m=h[1],n=h[3],o=(1+l/n)*e.width/2;if(!(0>o||o>e.width)){var p=(1-m/n)*e.height/2;if(!(0>p||p>e.height))return!0}}return!1}function d(){Human.view.camera.removeConstraint(c),Human.events.off("modules.activated",b),Human.events.off("modules.deactivated",b)}var e,f=Human.math.mat4(),g=Human.math.vec4(),h=Human.math.vec4(),i=[[0,0,0]];Human.events.on("loaded",function(){e=document.getElementById(Human.CANVAS_ID)}),Human.properties.subscribe({propId:"camera.constrainSceneToCanvas",value:!1,callback:function(b){b?a():d()}})}(),function(){"use strict";function a(a,b,c){m[0]=a.x,m[1]=a.y,m[2]=a.z,n[0]=b.x,n[1]=b.y,n[2]=b.z,o[0]=c.x,o[1]=c.y,o[2]=c.z;var d=Human.view.camera._cameraNode._core.optics;h=d.near,i=d.far,f=d.fovy*Math.PI/180,g=d.aspect;var e=Math.tan(.5*f)*h,k=e*g;j.normalizeVec3(o,o),j.subVec3(n,m,q),j.normalizeVec3(q,q),j.cross3Vec3(q,o,p),j.normalizeVec3(p,p),j.mulVec3Scalar(q,h,r),j.addVec3(m,r,s),j.mulVec3Scalar(q,i,r),j.addVec3(m,r,t),j.mulVec3Scalar(p,k,r),j.addVec3(s,r,r),j.subVec3(r,m,r),j.normalizeVec3(r,r),j.cross3Vec3(o,r,r),B.update(m,r),j.mulVec3Scalar(p,-k,r),j.addVec3(s,r,r),j.subVec3(r,m,r),j.normalizeVec3(r,r),j.cross3Vec3(r,o,r),A.update(m,r),j.mulVec3Scalar(o,e,r),j.addVec3(s,r,r),j.subVec3(r,m,r),j.normalizeVec3(r,r),j.cross3Vec3(r,p,r),C.update(m,r),j.mulVec3Scalar(o,-e,r),j.addVec3(s,r,r),j.subVec3(r,m,r),j.normalizeVec3(r,r),j.cross3Vec3(p,r,r),D.update(m,r)}function b(){Human.view.camera.addConstraint(d)}function c(){var a=Human.scene.getBoundary(),b=.5*(1-k),c=(a.xmax-a.xmin)*b,d=(a.ymax-a.ymin)*b,e=(a.zmax-a.zmin)*b;u=a.xmin+c,v=a.ymin+d,w=a.zmin+e,x=a.xmax-c,y=a.ymax-d,z=a.zmax-e,l&&Human.view.boundary.setBoundary({xmin:u,ymin:v,zmin:w,xmax:x,ymax:y,zmax:z},!0)}function d(b,d,e){return c(),a(b,d,e),C.boundaryInside(u,x,v,y,w,z)&&D.boundaryInside(u,x,v,y,w,z)&&A.boundaryInside(u,x,v,y,w,z)&&B.boundaryInside(u,x,v,y,w,z)?!0:!1}function e(){Human.view.camera.removeConstraint(d)}var f,g,h,i,j=Human.math,k=1,l=!1,m=j.vec3(),n=j.vec3(),o=j.vec3(),p=j.vec3(),q=j.vec3(),r=j.vec3(),s=j.vec3(),t=j.vec3(),u=0,v=0,w=0,x=0,y=0,z=0,A=j.createPlane(),B=j.createPlane(),C=j.createPlane(),D=j.createPlane();Human.properties.subscribe({propId:"camera.constrainBoundaryToCanvas",value:!1,callback:function(a){a?b():e()}}),Human.properties.subscribe({propId:"camera.constrainBoundaryToCanvas.boundaryScale",value:k,callback:function(a){"number"==typeof a&&(k=a)}}),Human.properties.subscribe({propId:"camera.constrainBoundaryToCanvas.showBoundary",value:l,callback:function(a){l=a,l?c():Human.view.boundary&&Human.view.boundary.setBoundary({},!1)}})}(),function(){"use strict";var a,b,c=Human.view.boundary={},d=!1,e=!1;Human.events.on("loaded",function(){a=Human.renderer.getNode("object-boundary-flags"),b=Human.renderer.getNode("object-boundary-geo"),d=!0}),c.setBoundary=function(){if(d){if(0===arguments.length)return void c.reset();var a,b;1===arguments.length?"boolean"==typeof arguments[0]?(b=!!arguments[1],c._showBoundary(b)):(a=arguments[0],c._setBoundaryExtents(a)):(a=arguments[0],b=arguments[1],c._setBoundaryExtents(a),c._showBoundary(b))}},c._setBoundaryExtents=function(c){a.setEnabled(e);var d=c.xmin,f=c.ymin,g=c.zmin,h=c.xmax,i=c.ymax,j=c.zmax;b.setPositions({positions:[h,i,j,h,f,j,d,f,j,d,i,j,h,i,g,h,f,g,d,f,g,d,i,g]})},c._showBoundary=function(b){e!==b&&(a.setEnabled(b),e=b)},c.reset=function(){c._setBoundaryExtents({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0}),c._showBoundary(!1)}}(),function(){"use strict";var a,b=Human.view.tooltips={},c=!0,d=null,e={};Human.properties.subscribe({propId:"tooltips.enabled",value:!0,callback:function(a){c=!!a}}),Human.events.on("loaded",function(){var c="#"+Human.CONTAINER_ID;$(c).append('<div id="objectToolTip" style="display: none;" class="objectTooltip">XXXX</div>'),a=$("#objectToolTip"),b._hide()}),Human.events.on("scene.objectDestroyed",function(c){a&&d&&c.objectId===d&&b._hide()}),Human.events.on("scene.objectsShown",function(c){a&&d&&c.enabledObjectsUpdate[d]===!1&&b._hide()}),Human.events.on("labels.updated",function(a){e=a.enabledLabels,d&&e[d]}),Human.events.on("camera.updated",function(){a&&d&&b._hide()}),b.setTooltip=function(c){var e=c.objectId;e&&a&&(d&&b._hide(),b._show(c))},b.clearTooltip=function(){a&&d&&b._hide()},b._show=function(f){if(c){var g;if(f.objectId){if(d=f.objectId,e[d])return void b._hide();var h=Human.scene.objects[f.objectId];g=h.name}g=f.title||g,a.css({left:f.canvasX+10,top:f.canvasY+0}),a.text(g),a.show()}},b._hide=function(){d&&a&&(a.hide(),d=null)},b.getEnabled=function(){return c},b.setEnabled=function(a){c!==a&&(a||b._hide(),c=a),Human.events.fire("tooltips.toggled",{enabled:c})}}(),function(){"use strict";Human.rpc.define("tooltips.setEnabled",function(a){var b=a.enable;(void 0===b||null===b)&&(b=!Human.view.tooltips.getEnabled()),Human.view.tooltips.setEnabled(b)})}(),function(){"use strict";var a=Human.view.labels={};a.enabled=!0;var b={},c=0;Human.properties.subscribe({propId:"labels.enabled",value:!0,callback:function(b){a.enabled=!!b}}),Human.events.on("loaded",function(){a.clearLabels()}),Human.events.on("scene.objectDestroyed",function(d){if(a.enabled&&c>0){var e=d.objectId;if(b[e]){a._destroyLabel(e);var f={};f[e]=!1,Human.events.fire("labels.updated",{enabledLabels:b})}}}),Human.events.on("scene.objectsSelected",function(d){if(a.enabled&&c>0){var e=d.selectedObjectsUpdate,f=Human.scene.objects;for(var g in e)e.hasOwnProperty(g)&&0===f[g].objects.length&&e[g]===!1&&b[g]&&a._destroyLabel(g);Human.events.fire("labels.updated",{enabledLabels:b})}}),Human.events.on("scene.objectsShown",function(d){if(a.enabled&&c>0){var e=d.enabledObjectsUpdate;for(var f in e)e.hasOwnProperty(f)&&e[f]===!1&&b[f]&&a._destroyLabel(f);Human.events.fire("labels.updated",{enabledLabels:b})}}),a._destroyLabel=function(a){var d=b[a];d&&(d.destroy(),delete b[a],c--)},a.createLabel=function(d){var e=d.objectId,f=Human.scene.objects[e];if(!f)return void Human.log.warn("Human.view.labels.createLabel","Scene object not found: '"+e+"'");if(d.replace&&a.clearLabels(),!f.displayName)return void Human.log.warn("Human.view.labels.createLabel","Scene object has no displayName: '"+e+"'");var g=d.offset||f.getCenter();b[e]=new Human.view.labels.Label({labelId:e,text:f.displayName,style:null,offset:g,nodeId:e,objectId:e,enabled:a.enabled,onHide:function(){a._destroyLabel(e)}}),Human.events.fire("labels.updated",{enabledLabels:b}),c++},a.clearLabels=function(){c>0&&(a._clearLabels(),Human.events.fire("labels.updated",{enabledLabels:b}))},a._clearLabels=function(){for(var d in b)b.hasOwnProperty(d)&&a._destroyLabel(d);c=0},a.setEnabled=function(b){a.enabled!==b&&(a.enabled=b,b||a._clearLabels(),Human.events.fire("labels.toggled",{enabled:b}))},a.getEnabled=function(){return a.enabled}}(),function(){"use strict";function a(){var a="___labelNarration",b=document.getElementsByTagName("body")[0],c=document.createElement("div");c.innerHTML+=' <audio id="'+a+'" src=""></audio>',b.appendChild(c);var d=document.getElementById(a);return d?"probably"!==d.canPlayType('audio/ogg;codecs="vorbis"')?(Human.log.error("Scene.view.labels","Label audio init failed: Codec not supported"),null):d:(Human.log.error("Scene.view.labels","Label audio init failed: Failed to create audio element in DOM"),null)}var b,c,d,e,f={};Human.events.on("loaded",function(){b=$("#container"),c=a();var f=$(Human.renderer.canvas.getCanvas());d=f.width(),e=f.height()}),Human.events.on("loaded",function(){Human.renderer.getNode(Human.renderer.NULL_OBJECT_ID).on("rendered",function(a){for(var b in f)f.hasOwnProperty(b)&&f[b]._onRender(a)})}),Human.events.on("canvas.resized",function(a){d=a.canvasWidth,e=a.canvasHeight}),Human.view.labels.Label=function(a){this.nodeId=a.nodeId,this.objectId=a.objectId,this.animationId=a.animationId,this.offset=a.offset,this.shown=a.shown,this.enabled=a.enabled,this.audioText=a.text,this.audioText&&(this.audioText=this.audioText.toLowerCase().replace(/\s/g,"_")),this._style=a.style||"labelStyleDefault",this.labelId=a.labelId?a.labelId:this.animationId?"a."+this.objectId:this.objectId?"o."+this.objectId:"n."+this.nodeId,this._labelElement=jQuery(['<div id="',this.labelId,'" class="label-container right hidden">','<div class="label-container-header ',this.style,'">',"<span>",a.text,"</span>",'<img src="img/shim.gif" alt="Play" class="icon-speaker icon-inverse" />','<img src="img/shim.gif" alt="Close" class="icon-close icon-inverse" />','<div class="label-toggle-secondary icon-expand"></div>','<ul class="options"></ul>',"</div>","</div>"].join("")),b.append(this._labelElement),this._elementWidth=this._labelElement.width(),this._elementHeight=this._labelElement.height();var d=this;this._onRender=function(a){d.updatePos({canvasPos:a.getCanvasPos(d.offset),viewPos:a.getViewPos(d.offset)})},f[this.labelId]=this;var e=this._labelElement.find(".icon-close");e.click(function(){a.onHide()});var g=this._labelElement.find(".options"),h=this._labelElement.find(".label-toggle-secondary");g.hide(),h.hide();var i=Human.view.annotations.getAnnotations({objectId:this.objectId,type:"secondary"}),j=Object.keys(i).length>0;if(j){var k=0,l=function(a){p.text(a?"Hide Pins":"Show Pins")},m=function(a){a===!0?k++:k>0&&k--,l(0!==k)},n=!1,o=function(){if(n!==!0){k=0;for(var a in i)if(i.hasOwnProperty(a)){var b=i[a];b.label.on("shown",m),b.label.shown===!0&&k++}l(0!==k)}},p=$("<li />");p.click(function(){var a=0!==k,b={};b[d.objectId]=!a,Human.view.annotations.setLabelsShown({objects:b,type:"secondary",replace:!0})}),h.click(function(){n!==!0&&(o(),n=!0)}),g.append(p)}if(g.children().length>0){e.hide();var q=$("<li />");q.text("Hide Label"),q.click(function(){a.onHide()}),g.append(q),h.click(function(){g.is(":visible")?(g.hide(),h.attr("class","icon-expand")):(g.show(),h.attr("class","icon-collapse"))}),h.show()}var r=this._labelElement.find(".icon-speaker");if(r.hide(),this.objectId&&c){var s="content/sounds/labels/"+d.audioText+".ogg";Human.utils.fileExists.test(s,function(a){a&&(r.click(function(){c.setAttribute("src",s),c.currentTime?c.ended&&(c.pause(),c.src="",c.setAttribute("src",s),c.play()):c.play()}),d._hasAudioFile=!0,r.show())})}},Human.view.labels.Label.prototype.updatePos=function(a){var b=a.canvasPos.x,c=a.canvasPos.y+40,f=a.viewPos.z;return f>0?void(this.shown&&this.setShown(!1)):(b=Math.max(20,Math.min(b,d-this._elementWidth-10)),c=Math.max(10,Math.min(c,e-this._elementHeight-10)),this._labelElement.css({left:b,top:c}),void(this.shown||this.setShown(!0)))},Human.view.labels.Label.prototype.update=function(a){var b=a.canvasPos.x,c=a.canvasPos.y;0>=c?this.shown&&this.setShown(!1):(this._labelElement.css({left:b,top:c+40}),a.style&&(this._style&&this._labelElement.removeClass(this._style),this._labelElement.addClass(a.style),this._style=a.style),this.shown||this.setShown(!0))},Human.view.labels.Label.prototype.setShown=function(a){this.shown!==a&&(a&&this.enabled?this._labelElement.show():this._labelElement.hide(),this.shown=a)},Human.view.labels.Label.prototype.setEnabled=function(a){this.enabled!==a&&(this.shown&&a?this._labelElement.show():this._labelElement.hide(),this.enabled=a)},Human.view.labels.Label.prototype.destroy=function(){delete f[this.labelId],c&&this._hasAudioFile&&(c.pause(),c.src=""),this.shown&&this.setShown(!1),this._labelElement&&(this._labelElement.remove(),this._labelElement=null)}}(),function(){"use strict";Human.rpc.define("labels.setEnabled",function(a){var b=a.enable;(void 0===b||null===b)&&(b=!Human.view.labels.getEnabled()),Human.view.labels.setEnabled(b)}),Human.rpc.define("labels.create",function(a){return a.objectId?(a.replace&&Human.view.labels.clearLabels(),void Human.view.labels.createLabel(a)):void this.error("parameter expected: 'objectId'")}),Human.rpc.define("labels.clear",function(){Human.view.labels.clearLabels()})}(),function(){"use strict";function a(a){var b,c;if(a)for(c in Human.scene.objects)Human.scene.objects.hasOwnProperty(c)&&(b=Human.scene.objects[c],b&&(Human.scene.selectedObjects.hasOwnProperty(c)?b.highlight||b.setHighlight(!0):b.highlight&&b.setHighlight(!1)));else for(c in Human.scene.objects)Human.scene.objects.hasOwnProperty(c)&&(b=Human.scene.objects[c],b.highlight&&b.setHighlight(!1))}var b=Human.view.highlight={};b.enabled=!0;var c=!1;Human.events.on("loaded",function(){b.setEnabled(!0)}),Human.events.on("scene.objectsSelected",function(){b.enabled&&(c=!0)}),Human.events.on("tick",function(){c&&(a(b.enabled),c=!1)}),b.setEnabled=function(a){b.enabled!==a&&(b.enabled=a,c=!0),Human.events.fire("highlight.toggled",{enabled:b.enabled}),b.enabled&&(Human.view.currentMode="Highlight")},b.getEnabled=function(){return b.enabled}}(),function(){"use strict";var a=Human.view.isolate={};a.enabled=!1;var b=!0;Human.events.on("loaded",function(){a.enabled=!1,b=!1}),Human.events.on("tick",function(){b&&(Human.scene.setShowSelectedObjects(a.enabled),b=!1)}),Human.events.on("scene.objectsSelected",function(){a.enabled&&(b=!0)}),a.setEnabled=function(c){a.enabled!==c&&(a.enabled=c,b=!0),Human.events.fire("isolate.toggled",{enabled:a.enabled}),a.enabled&&(Human.view.currentMode="Isolate",Human.view.pick.setSinglePickEnabled(!0),Human.view.pick.setMultiPickEnabled(!1))},a.getEnabled=function(){return a.enabled}}(),function(){"use strict";var a=Human.view.dissect={};a.enabled=!1;var b=[],c=[];Human.events.on("loaded",function(){a.enabled=!1}),a.setEnabled=function(b){a.enabled!==b&&(a.enabled=b,Human.events.fire("dissect.toggled",{enabled:a.enabled}))},a.getEnabled=function(){return a.enabled},a.dissect=function(d){if(a.enabled){c.length=0,b.push(d);var e={};e[d]=!1,Human.scene.setEnabledObjects({objectIds:e})}},a.undo=function(){if(!a.enabled,b.length){var d=b.pop(),e={};e[d]=!0,Human.scene.setEnabledObjects({objectIds:e}),c.unshift(d)}},a.redo=function(){if(a.enabled){var d,e;c.length&&(d=c.shift(),e={},e[d]=!1,Human.scene.setEnabledObjects({objects:e}),b.push(d))}},a.reset=function(){c.length=0,b.length=0}}(),function(){"use strict";function a(a){if(a.object){var b=a.object,c=d.objectAnnotations[b.objectId];c||(c=d.objectAnnotations[b.objectId]={annotations:{},numAnnotations:0}),c.annotations[a.annotationId]=a,c.numAnnotations++}}function b(a){if(a.object){var b=a.object,c=d.objectAnnotations[b.objectId];if(c){var e=c.annotations[a.annotationId];e&&(delete c.annotations[a.annotationId],0===--c.numAnnotations&&delete d.objectAnnotations[b.objectId])}}}function c(a,b){Human.events.fire(a,{annotationId:b.id||b.annotationId,type:b.type,styleId:b.styleId,objectId:b.object?b.object.objectId:null,title:b.label.title,description:b.label.description,pos:b.pin.pos,pinVec:b.pin.dir})}var d=Human.view.annotations={},e="__a",f=new Human.utils.IDPool({prefix:e});d.enabled=!1,d.shown=!0,d.annotations={},d.objectAnnotations={},d.unsavedAnnotation=null,function(){var a=0;Human.events.on("processes.started",function(){a||d.setShown(!1),a++}),Human.events.on("processes.finished",function(){--a||d.setShown(!0)}),Human.events.on("processes.failed",function(){--a||d.setShown(!0)})}(),d.setEnabled=function(a){d.enabled!==a&&(d.enabled=a,Human.events.fire("annotations.toggled",{enabled:a}))},d.createAnnotation=function(g){function h(a,b){a.setHighlight(b);for(var c=0,d=a.objects.length;d>c;c++)h(a.objects[c],b)}var i;if(g.objectId&&(i=Human.scene.objects[g.objectId],i||Human.log.warn("Human.view.annotations.createAnnotation","Scene object not found: '"+g.objectId+"'")),d.unsavedAnnotation&&(g.title=d.unsavedAnnotation.label.$titleField.val(),g.description=d.unsavedAnnotation.label.$descriptionField.val(),g.objectId=d.unsavedAnnotation.object?d.unsavedAnnotation.object.objectId:null,d.unsavedAnnotation.destroy(),d.unsavedAnnotation=null),g.annotationId){if(g.annotationId.toString().slice(0,e.length)===e)g.annotationId=f.getId();else if(d.annotations[g.annotationId])return Human.log.error("Human.view.annotations.createAnnotation","Annotation with this ID already exists: '"+g.annotationId+"'"),null}else g.annotationId=f.getId();var j=new Human.view.annotations.Annotation(i,g);return d.annotations[g.annotationId]=j,a(j),d.unsavedAnnotation=g.saved?null:j,j.setAnnotationsShown(d.shown),j.on("picked",function(){Human.events.fire("annotations.picked",{annotationId:j.annotationId})}),j.label.on("mouseClick",function(){Human.events.fire("annotations.mouseClick",{annotationId:j.annotationId})}),j.label.on("mouseEnter",function(a){j.object&&h(j.object,!0),Human.events.fire("annotations.mouseEnter",a)}),j.label.on("mouseLeave",function(a){j.object&&h(j.object,!1),Human.events.fire("annotations.mouseLeave",a)}),j.label.on("mouseDown",function(a){Human.events.fire("annotations.mouseDown",a)}),j.label.on("mouseUp",function(a){Human.events.fire("annotations.mouseUp",a)}),j.on("saved",function(){d.unsavedAnnotation&&d.unsavedAnnotation.annotationId===j.annotationId?c("annotations.created",j):c("annotations.updated",j),d.unsavedAnnotation=null}),j.on("destroyed",function(){j.object&&h(j.object,!1),d.unsavedAnnotation=null,delete d.annotations[j.annotationId],b(j),Human.events.fire("annotations.destroyed",{annotationId:j.annotationId})}),g.saved?(c("annotations.created",j),d.unsavedAnnotation=null):Human.events.fire("annotations.creating",{annotationId:j.annotationId}),j},d.updateDimensions=function(){for(var a in d.annotations)d.annotations.hasOwnProperty(a)&&d.annotations[a].label.updateWidth()},d.setShown=function(a){if(d.shown!==a){for(var b in d.annotations)d.annotations.hasOwnProperty(b)&&d.annotations[b].setAnnotationsShown(a);d.shown=a,Human.events.fire("annotations.shown",{shown:a})}},d.clearAnnotations=function(a){a=a||{};var b=!!a.keepModuleAnnotations;d.unsavedAnnotation=null;var c;for(var e in d.annotations)d.annotations.hasOwnProperty(e)&&(c=d.annotations[e],b&&c.moduleId||c.destroy())},d.getAnnotations=function(a){var b={},c=d.annotations;a.objectId&&(c=d.objectAnnotations.hasOwnProperty(a.objectId)?d.objectAnnotations[a.objectId].annotations:{});var e=a.type;for(var f in c)if(c.hasOwnProperty(f)){var g=c[f];e&&e!==g.type||(b[f]=g)}return b},d.setLabelsShown=function(a){var b,c,e,f,g={},h=a.type;if(a.annotations){c=a.annotations;for(e in c)c.hasOwnProperty(e)&&(b=d.annotations[e],b&&(h&&h!==b.type||(g[e]=c[e])))}else if(a.objects){c=a.objects;for(var i in c)if(c.hasOwnProperty(i)){var j=Human.scene.objects[i];if(j){var k=d.objectAnnotations[i];if(k){f=c[i];for(e in k.annotations)k.annotations.hasOwnProperty(e)&&(b=k.annotations[e],h&&h!==b.type||(g[e]=f))}}}}else if(a.type){f=a.shown!==!1;for(e in d.annotations)d.annotations.hasOwnProperty(e)&&(b=d.annotations[e],b&&(h&&h!==b.type||(g[e]=f)))}if(a.replace)for(e in d.annotations)d.annotations.hasOwnProperty(e)&&(g[e]||(b=d.annotations[e],h&&h!==b.type||(b.pin.setShown(!1),b.label.setShown(!1))));for(e in g)if(g.hasOwnProperty(e)){var l=g[e];b=d.annotations[e],b.pin.setShown(l),b.label.setShown(l)}},d.updateAnnotation=function(a,b){var e=d.annotations[a];if(e){var f=e.label;b.title&&b.title!==f.title&&f.setTitle(b.title),b.description&&b.description!==f.description&&f.setDescription(b.description),c("annotations.updated",e)}}}(),function(){"use strict";Human.view.annotations.Annotation=function(a,b){var c=this;this._init(),this.moduleId=b.moduleId,this.type=b.type||"default",this.annotationId=b.annotationId,this.annotationsShown=Human.view.annotations.shown,this.draggable=!!b.labelOffset,this.occludable=b.occludable!==!1&&!!b.pos,this.followsObject=b.followsObject!==!1&&!!a,b.offset=b.labelOffset,this.label=new Human.view.annotations.Label(this,b),this.wire=$('<div class="annotationWire"></div>').appendTo("#container"),this.pin=new Human.view.annotations.Pin(this,b.annotationId,b),this.saved=void 0!==b.saved&&null!==b.saved?b.saved:!1,this.pin.on("picked",function(){return c.label.saved?(c.label.setShown(!c.label.shown),void c.publish("picked",!0,!0)):void alert("Please save or cancel annotation before hiding label")}),this.label.on("saved",function(){c.publish("saved",c.saved=!0)}),this.label.on("delete",function(){c.destroy()});var d=function(a){a?c.wire.show():c.wire.hide()};if(this.pin.on("enabled",function(a){d(c.annotationsShown&&a&&!c.label.culled&&c.label.shown&&c.pin.shown)}),this.label.on("shown",function(a){d(c.annotationsShown&&c.pin.enabled&&!c.label.culled&&a&&c.pin.shown)}),this.label.on("culled",function(a){d(c.annotationsShown&&c.pin.enabled&&!a&&c.label.shown&&c.pin.shown)}),this.label.on("annotationsShown",function(){d(c.annotationsShown&&c.pin.enabled&&!c.label.culled&&c.label.shown&&c.pin.shown)}),this.pin.on("occluded",function(a){a&&c.wire.css("opacity","0")}),this.object=null,a&&(this.setObject(a),b.pos||this.pin.setPos(a.getCenter())),b.on){var e=b.on;e.mouseClick&&this.label.on("mouseClick",function(){Human.rpc.call(null,e.mouseClick.call,e.mouseClick)})}},Human.utils.extend(Human.view.annotations.Annotation,Human.Component),Human.view.annotations.Annotation.prototype.setObject=function(a){this._objectShown&&this.object.off(this._objectShown);var b=this;this._objectShown=a.on("shown",function(a){b.pin.setEnabled(a),b.label.setEnabled(a)}),this._objectDestroyed=a.on("destroyed",function(){b.destroy()}),this.publish("object",this.object=a)},Human.view.annotations.Annotation.prototype.setAnnotationsShown=function(a){this.annotationsShown=a,this.pin.setAnnotationsShown(a),this.label.setAnnotationsShown(a)},Human.view.annotations.Annotation.prototype.setShown=function(a){this.pin.setShown(a),this.label.setShown(a)},Human.view.annotations.Annotation.prototype.destroy=function(){this.pin.destroy(),this.label.destroy(),this.wire.remove(),this._objectShown&&this.object.off(this._objectShown),this._objectDestroyed&&this.object.off(this._objectDestroyed),this.publish("destroyed",!0)}}(),function(){"use strict";Human.view.annotations.Pin=function(a,b,c){var d=$("#container");this._init(),this._id=b,this.annotation=a,this.annotationsShown=Human.view.annotations.shown,this.enabled=c.enabled!==!1,this.shown=c.shown!==!1,this.culled=!1,this.pos=Human.math.vec3(),c.pos&&(this.pos[0]=c.pos[0],this.pos[1]=c.pos[1],this.pos[2]=c.pos[2]),this.primitiveIndex=c.primitiveIndex,this.barycentric=Human.math.vec3(),c.barycentric?(this.barycentric[0]=c.barycentric[0],this.barycentric[1]=c.barycentric[1],this.barycentric[2]=c.barycentric[2]):this.barycentric[0]=this.barycentric[1]=this.barycentric[2]=1/3,this.viewPos=Human.math.vec4(),this.occluded=!1,this.dir=c.dir||[0,0,-1],this._element=$('<div class="annotationPin"></div>'),this.setPos(c.pos||[0,0,0]),this.setDir(c.dir||[0,0,0]),this.setAnnotationsShown(Human.view.annotations.shown),this.setEnabled(void 0!==c.enabled&&null!==c.enabled?c.enabled:!0),this.setShown(void 0!==c.shown&&null!==c.shown?c.shown:!0),this.setCulled(!!c.culled),this.setOpacity(1),d.append(this._element),this._element.click(this.pick.bind(this))},Human.utils.extend(Human.view.annotations.Pin,Human.Component),Human.view.annotations.Pin.prototype.setAnnotationsShown=function(a){this._showElement(a&&this.enabled&&this.shown&&!this.culled&&!this.occluded),this.publish("enabled",this.annotationsShown=a)},Human.view.annotations.Pin.prototype.setEnabled=function(a){this._showElement(this.annotationsShown&&a&&this.shown&&!this.culled&&!this.occluded),this.publish("enabled",this.enabled=a)},Human.view.annotations.Pin.prototype.setShown=function(a){this._showElement(this.annotationsShown&&this.enabled&&a&&!this.culled&&!this.occluded),this.publish("shown",this.shown=a)},Human.view.annotations.Pin.prototype._showElement=function(a){a?this._element.show():this._element.hide()},Human.view.annotations.Pin.prototype.cullToRectangle=function(a,b,c,d){var e=this.canvasPos;if(e)return this.setCulled(e[0]<a||e[0]>c||e[1]<b||e[1]>d),this.culled},Human.view.annotations.Pin.prototype.setCulled=function(a){this._showElement(this.annotationsShown&&this.enabled&&this.shown&&!a&&!this.occluded),this.publish("culled",this.culled=a)};var a=Human.math.vec4();Human.view.annotations.Pin.prototype.transform=function(b,c,d){Human.math.transformPoint3(b,this.pos,this.viewPos),this.viewPos[3]=1,Human.math.transformPoint4(c,this.viewPos,a);var e=a[0],f=a[1],g=a[3];this.canvasPos=[(1+e/g)*d.width/2,(1-f/g)*d.height/2],this._element.css({left:this.canvasPos[0],top:this.canvasPos[1]})},Human.view.annotations.Pin.prototype.setOccluded=function(a){this._showElement(this.annotationsShown&&this.enabled&&this.shown&&!this.culled&&!a),this.publish("occluded",this.occluded=a)},Human.view.annotations.Pin.prototype.setViewAngle=function(a){this.publish("angle",this.viewAngle=a)},Human.view.annotations.Pin.prototype.setOpacity=function(a){this._element.css({opacity:this.opacity=a}),this.publish("opacity",a)},Human.view.annotations.Pin.prototype.setPos=function(a){this.pos[0]=a[0],this.pos[1]=a[1],this.pos[2]=a[2],this.publish("pos",this.pos)},Human.view.annotations.Pin.prototype.setDir=function(a){this.publish("dir",this.dir=a)},Human.view.annotations.Pin.prototype.pick=function(){this.publish("picked",!0,!0)},Human.view.annotations.Pin.prototype.destroy=function(){Human.renderer.getNode(Human.NULL_OBJECT_ID).off(this._rendered),this._element.remove(),this.publish("destroyed",!0)}}(),function(a,b){"use strict";var c=a.view.annotations.Label=function(c,d){this._init(),this.annotation=c,this.saved=!!d.saved,this.offset=d.offset||[70,70],this.offset2=[this.offset[0],this.offset[1]],this.offset2=[this.offset[0],this.offset[1]];var f=!d.saved||d.saved&&d.isOwner,g=this.editing=f&&!this.saved,h=this.saved?"":"new",i=f?"editable":"",j=g?"editing":"",k=a.view.annotations.layouts.activeLayout,l=k?k:"",m=[h,i,j,l].join(" "),n=b("#container");this.$element=b(['<div class="annotationContainer">','<div class="annotationTitle clearfix">','<input type="text" placeholder="">',"<h1></h1>",'<button class="annotationSave"></button>','<button class="annotationDelete"></button>',"</div>",'<div class="annotationDescription">','<textarea placeholder=""></textarea>',"<p></p>","</div>",'<div class="embedContainer"></div>',"</div>"].join("")),this.$titleContainer=this.$element.find(".annotationTitle"),this.$title=this.$element.find("h1"),this.$description=this.$element.find("p"),this.$titleField=this.$element.find("input"),this.$descriptionField=this.$element.find("textarea"),this.$deleteBtn=this.$element.find(".annotationDelete"),this.$saveBtn=this.$element.find(".annotationSave"),e(this.$titleField,100),e(this.$descriptionField,300),this.setTitle(d.title||""),this.setDescription(d.description||""),this.$element.addClass(m).appendTo(n),this.bindHandlers(f),this.setAnnotationsShown(a.view.annotations.shown),this.setEnabled(d.enabled!==!1),this.setShown(d.labelShown!==!1),this.setCulled(!!d.culled),this.setOccluded(!!d.occluded),d.embed&&this.setEmbed(d.embed),this.setOffset(d.offset||[70,-70]),this.updateWidth()};a.utils.extend(a.view.annotations.Label,a.Component),c.prototype.bindHandlers=function(a){var c=this,d=b(document),e=function(a){var e=b(a.target),f=0===e.closest(".annotationContainer").length;f&&(c.$titleField.val()||c.$descriptionField.val()?(c.save(),d.off("click.set-annotation")):c.pos&&(c["delete"](),d.off("click.set-annotation")))},h=function(){var a=c.annotation;if(a.pin){var b=a.pin,d=a.label,e=b.canvasPos,f=d.offset[0]<0,g=[e[0]+d.offset[0],e[1]+d.offset[1]];f&&(g[0]-=d.getWidth()),c.setPos(g)}},i=g(c.$titleField),j=g(c.$descriptionField),k=f("Description",j),l=function(){var a=c.$titleField.val(),b=f(a,i);""!==a&&b>=k?c.$descriptionField.attr("placeholder","Description"):c.$descriptionField.attr("placeholder","")},m=function(){var a=c.$titleField.val(),b=c.$descriptionField.val(),d=b.split("\n"),e=f(d[0]+"X",j),g=parseInt(c.$element.css("max-width"),10),k=g+""=="NaN"?200:g,l=f(a+"X",i),m=Math.max(l,e);m=Math.min(m,k),c.$titleContainer.css("width",m+"px"),c.$titleField.css("width",m+"px"),c.$descriptionField.css("width",m+"px"),""===a&&""===b?c.$element.hasClass("empty")||c.$element.addClass("empty"):c.$element.removeClass("empty"),h()},n=function(){m(),l()};c.on("title",n),c.$titleField.on("keypress focus",n),c.$descriptionField.on("keypress focus",n),a&&this.editing&&(d.on("click.set-annotation",function(a){e(a)}),c.$titleField.focus()),c.on("mouseClick",function(f){var g=b(f.e.target),h=g.is(c.$titleContainer)||0!==c.$titleContainer.has(g).length;a&&!c.editing&&h&&(c.editing=!0,c.$descriptionField.height(c.$description[0].offsetHeight),c.$element.addClass("editing"),c.$titleField.focus(),c.publish("edit",!0,!0),c.publish("updateWidth",!0,!0),d.on("click.set-annotation",function(a){e(a)}))}),c.$descriptionField.blur(function(a){e(a)}),c.$deleteBtn.click(function(a){a.preventDefault(),c["delete"]()}),c.$saveBtn.click(function(a){a.preventDefault(),c.save()});var o=0,p=0,q=function(a){o=a.clientX,p=a.clientY};c.$element.mouseenter(function(a){c.publish("mouseEnter",{annotationId:c.annotation.annotationId,e:a},!0),q(a)}),c.$element.mouseleave(function(a){c.publish("mouseLeave",{annotationId:c.annotation.annotationId,e:a},!0),q(a)}),c.$element.mousedown(function(a){c.publish("mouseDown",{annotationId:c.annotation.annotationId,x:a.clientX,y:a.clientY,e:a},!0),q(a)}),c.$element.mouseup(function(a){var b=a.clientX,d=a.clientY;c.publish("mouseUp",{annotationId:c.annotation.annotationId,x:b,y:d,e:a},!0),o===b&&p===d&&c.publish("mouseClick",{annotationId:c.annotation.annotationId,x:b,y:d,e:a},!0),q(a)}),c.on("updateWidth",this._redrawWireConnection.bind(this))},c.prototype.save=function(){this.editing=!1,this.setTitle(this.$titleField.val()),this.setDescription(this.$descriptionField.val()),this.$element.removeClass("new editing"),this.publish("saved",this.saved=!0),this.publish("updateWidth",!0,!0)},c.prototype["delete"]=function(){this.publish("delete",!0,!0)},c.prototype.setOffset=function(a){this.offset[0]=a[0],this.offset[1]=a[1],this.offset2[0]=a[0],this.offset2[1]=a[1],this.publish("offset",this.offset)},c.prototype.setAnnotationsShown=function(a){this._showElement(a&&this.enabled&&this.shown&&!this.culled&&!this.occluded),this.publish("annotationsShown",this.annotationsShown=a)},c.prototype.setEnabled=function(a){this._showElement(this.annotationsShown&&a&&this.shown&&!this.culled&&!this.occluded),this.publish("enabled",this.enabled=a)},c.prototype.setShown=function(a){this._showElement(this.annotationsShown&&this.enabled&&a&&!this.culled&&!this.occluded),this.publish("shown",this.shown=a)},c.prototype.setCulled=function(a){this._showElement(this.annotationsShown&&this.enabled&&this.shown&&!a&&!this.occluded),
this.publish("culled",this.culled=a)},c.prototype.setOccluded=function(a){this._showElement(this.annotationsShown&&this.enabled&&this.shown&&!this.culled&&!a),this.publish("occluded",this.occluded=a)},c.prototype.setOpacity=function(a){this.$element.css({opacity:this.opacity=a}),this.publish("opacity",a)},c.prototype._showElement=function(a){a?this.$element.css("display","inline-block"):this.$element.hide()},c.prototype.setTitle=function(a){this.$titleField.val(a),this.$title.html(a),this.publish("title",this.title=a)},c.prototype.setDescription=function(a){this.$descriptionField.val(a),this.$description.html(a),this.publish("description",this.description=a)},c.prototype.setEmbed=function(a){var b=["ui-all=false"];for(var c in a)a.hasOwnProperty(c)&&b.push(c+"="+a[c]);var d="/embedded.html?"+b.join("&"),e='<iframe src="'+d+'" width="150" height="150" border="0"></iframe>';this.$element.addClass("annotationEmbed"),this.$element.find(".embedContainer").append(e).show(),this.publish("embed",this.embed=a)},c.prototype.setPos=function(a,b){b&&(a[1]=a[1]-this.$titleContainer[0].offsetHeight),this.$element.css({left:a[0]+"px",top:a[1]+"px"}),this.publish("pos",this.pos=a)},c.prototype.setSide=function(a){this.side=a,this.$element.removeClass("left right").addClass(a),this.connectionPoint=[this.pos[0]+("left"===a?this.getWidth():0),this.pos[1]+this.$titleContainer[0].offsetHeight]},c.prototype.getTop=function(){return this.$element[0].offsetTop},c.prototype.getBottom=function(){return this.$element[0].offsetTop+this.getHeight()},c.prototype.getHeight=function(){return this.$element[0].offsetHeight},c.prototype.getWidth=function(){return this.$element[0].offsetWidth},c.prototype.updateWidth=function(){this.width=this.getWidth()},c.prototype._redrawWireConnection=function(){this.updateWidth(),a.view.annotations.layouts.redrawLayout()},c.prototype.destroy=function(){this.$element.remove(),this.publish("destroyed",!0)};var d,e=function(a,b){b&&b>0&&(a.attr("maxlength",b),a.keyup(function(c){13!==c.keyCode&&a.val().length>=b&&alert("Maximum characters allowed ("+b+")")}))},f=function(a,b){d=d||document.createElement("canvas");var c=d.getContext("2d");c.font=b;var e=c.measureText(a);return e.width},g=function(a){return b(a).css("font")}}(Human,jQuery),function(){"use strict";var a=Human.view.annotations.placer={},b=Human.math.vec3();a.placeAnnotation=function(a){var c=Human.view.camera.eye;b[0]=c.x,b[1]=c.y,b[2]=c.z;var d=Human.math.subVec3(b,a.pos);Human.view.annotations.createAnnotation({objectId:a.objectId,title:a.title||"",description:a.description||"",pos:a.pos,mouseDownPos:a.mouseDownPos,dir:d,enabled:!0,shown:!0,labelShown:!0,labelOffset:a.labelOffset,saved:void 0!==a.saved&&null!==a.saved?a.saved:!1})}}(),function(){"use strict";var a=14,b=12,c="left",d=5,e=2,f=Human.view.annotations.renderer={};f.render=function(f){var g=f.annotation,h=f.canvasData,i=f.bgColor,j=h.context,k=g.label,l=g.pin,m=k.connectionPoint,n=h.scaleX,o=h.scaleY,p=l.canvasPos[0]*n,q=l.canvasPos[1]*o,r=k.enabled&&k.shown&&!k.occluded&&!k.culled;if(r){var s=k.pos[0]*n,t=m[0]*n,u=m[1]*o,v=Math.min(h.width-s-10,k.width*n);j.fillStyle="white"===i?"rgb(0, 0, 0)":"rgb(255, 255, 255)",j.textAlign=c;var w=Math.round(a*n),x=Math.round(b*n),y=function(a,b,c){for(var d=b.split(" "),e="",f=[],g=0;g<d.length;g++){var h=e+d[g],i=a.measureText(h);i.width>c&&g>0?(f.push(e),e=d[g]+" "):e=h+" "}return f.push(e),f},z=function(a,b,c,d){var e=1.25*b;j.font=(c?"bold ":"")+b+"px Arial";for(var f=y(j,a||"",v),g=u+d(f,e),h=0;h<f.length;h++)j.fillText(f[h],s,g+e*h)};z(k.title,w,!0,function(a,b){return-(a.length-1)*b-b/2}),z(k.description,x,!1,function(a,b){return b});var A=l.opacity;j.strokeStyle="rgba(204, 204, 204, "+A+")",j.beginPath(),j.moveTo(p,q),j.lineTo(t,u);var B="left"===k.side?-v:v;j.lineTo(t+B,u),j.stroke()}var C=function(a,b,c){j.fillStyle=b,j.beginPath(),j.arc(p,q,a,0,2*Math.PI),j.fill(),c&&c()},D=d*n,E=e*n;C(D,"rgb(255, 255, 255)",function(){j.lineWidth=1,j.strokeStyle="rgb(204, 204, 204)",j.stroke()}),C(E,"rgb(153,0,0)")}}(),function(){"use strict";function a(){b&&b.setDirty()}var b,c=Human.view.annotations.layouts={},d={};c.activeLayout=null,Human.events.on("loaded",function(){var a=document.getElementById("annotationCanvas");if(!a)return void Human.log.error("Human.view.annotations.layouts","DOM element not found: 'annotationCanvas'");var d=a.getContext("2d");return d?(Human.properties.subscribe({propId:"annotations.layout.type",value:"columns",callback:function(a){c._selectLayout(a)}}),void Human.events.on("tick",function(){b&&a&&d&&b.layout(a,d)})):void Human.log.error("Human.view.annotations.layouts","Failed to get 2D canvas context")}),Human.events.on("camera.updated",function(){a()}),Human.events.on("canvas.resized",function(){a()}),Human.events.on("annotations.creating",function(a){e(a)}),Human.events.on("clip.updated",function(){a()}),Human.events.on("scene.objectsShown",function(){a()}),Human.events.on("annotations.created",function(a){e(a)});var e=function(b){Human.events.onEvent("annotations.shown",a);var c=Human.view.annotations.annotations[b.annotationId];c.on("object",a),c.pin.on("enabled",a),c.pin.on("shown",a),c.label.on("shown",a),c.label.on("edit",a),c.label.on("saved",a),c.label.on("cancel",a),c.label.on("destroyed",a),a()};Human.events.on("snapshot.rendering",function(a){b&&b.snapshot&&b.snapshot(a.canvas,a.context,a.bgColor)}),c.addLayoutType=function(a,e){return d[a]?void Human.log.error("Human.view.annotations.layouts.addLayoutType","Layout already added: '"+a+"'"):e.setEnabled?e.setDirty?e.layout?(d[a]=e,void(b||c._selectLayout(a))):void Human.log.error("Human.view.annotations.layouts.addLayoutType","Layout strategy does not have a 'layout' method"):void Human.log.error("Human.view.annotations.layouts.addLayoutType","Layout strategy does not have a 'setDirty' method"):void Human.log.error("Human.view.annotations.layouts.addLayoutType","Layout strategy does not have a 'setEnabled' method")},c._selectLayout=function(a){return"columns-v2"===a&&(a="columns"),Human.log.info("Human.view.annotations.layouts._selectLayout","Selecting label type: '"+a+"'"),d[a]?void(b!==a&&(b&&b.setEnabled(!1),b=d[a],b.setEnabled(!0),b.setDirty(),c.activeLayout=a)):void Human.log.error("Human.view.annotations.layouts._selectLayout","Layout not found: '"+a+"'")},c.redrawLayout=a}(),Human.view.annotations.layouts.addLayoutType("columns",function(){"use strict";function a(a,b,c,d){var e,f,g,h,i,j,k=Human.scene.enabledObjects,l={xmin:Human.math.MAX_DOUBLE,ymin:Human.math.MAX_DOUBLE,xmax:Human.math.MIN_DOUBLE,ymax:Human.math.MIN_DOUBLE};for(var m in k)if(k.hasOwnProperty(m)){var n=k[m];if(0===n.numSubObjects){e=n.getBoundary(),f=[[e.xmin,e.ymin,e.zmin],[e.xmax,e.ymin,e.zmin],[e.xmax,e.ymax,e.zmin],[e.xmin,e.ymax,e.zmin],[e.xmin,e.ymin,e.zmax],[e.xmax,e.ymin,e.zmax],[e.xmax,e.ymax,e.zmax],[e.xmin,e.ymax,e.zmax]];for(var o=0;8>o;o++)g=f[o],Human.math.transformPoint3(c,f[o],t),t[2]>.1||(t[3]=1,Human.math.transformPoint4(d,t,t),h=t[0],i=t[1],j=t[3],h=(1+h/j)*a.width/2,i=(1-i/j)*a.height/2,0>h||0>i||h>a.width||i>a.height||(l.xmin>h&&(l.xmin=h),l.ymin>i&&(l.ymin=i),l.xmax<h&&(l.xmax=h),l.ymax<i&&(l.ymax=i)))}}return l}function b(a){var b=Human.view.camera.eye;u[0]=b.x,u[1]=b.y,u[2]=b.z,Human.math.subVec3(u,a.pos,u);var c=Human.math.dotVector3(u,a.dir),d=Human.math.lenVec3(u),e=Human.math.lenVec3(a.dir),f=57.2957795*Math.acos(c/(d*e));return f}function c(a,b){for(var c,d,e=0;b-1>e;e++){d=e;for(var f=e;b>f;f++)a[f].pin.canvasPos[1]<a[d].pin.canvasPos[1]&&(d=f);c=a[e],a[e]=a[d],a[d]=c}}function d(a,b,c,d,f,g){for(var j,k,l,m,n=0>g?Math.max(e.left,c.xmin-h-50):Math.min(a.width-e.right-h,c.xmax),o=Math.max(e.top,c.ymin),p=Math.min(e.bottom,c.ymax),q=o,r=a.height-o-p,s=r/f,t=0;f>t;t++){j=d[t],k=j.pin,l=j.label,m=j.wire;var u=k.canvasPos[0],v=k.canvasPos[1];l.setPos([n,i?v:q],i),l.setSide(0>g?"left":"right");var w,x=l.connectionPoint,y=Math.sqrt(Math.pow(x[0]-u,2)+Math.pow(x[1]-v,2));w=i?0>g?0:180:180*Math.atan2(v-x[1],u-x[0])/Math.PI,m.css({width:y+"px",left:x[0]+"px",top:x[1]+"px",opacity:k.opacity,"-webkit-transform":"rotate("+w+"deg)","-moz-transform":"rotate("+w+"deg)","-ms-transform":"rotate("+w+"deg)","-o-transform":"rotate("+w+"deg)",transform:"rotate("+w+"deg)"}),q+=s}}var e,f=Human.view.annotations,g={};Human.properties.subscribe({propId:"annotations.margins",value:{top:50,left:50,right:50,bottom:50},callback:function(a){e=a}});var h;Human.properties.subscribe({propId:"annotations.labelWidth",value:150,callback:function(a){h=a}});var i=!1;Human.properties.subscribe({propId:"annotations.horizontalLines",value:i,callback:function(a){i=a,o=!0}});var j=100;Human.properties.subscribe({propId:"annotations.occludedAngle",value:j,callback:function(a){j=a,o=!0}});var k=80;Human.properties.subscribe({propId:"annotations.fadeoutAngle",value:k,callback:function(a){k=a,o=!0}});var l,m,n=!1,o=!0,p=[],q=0,r=[],s=0;g.setEnabled=function(a){n=a,o=!0},g.setDirty=function(){o=!0},g.layout=function(g,i){if(o){if(i.clearRect(0,0,g.width,g.height),!f.shown)return void(o=!1);q=0,s=0;var n,t,u,v,w=f.annotations,x=Human.renderer.getViewMat(),y=Human.renderer.getProjMat(),z=a(g,i,x,y);Human.request.getSearchParam("showBoundary")&&(i.beginPath(),i.rect(z.xmin,z.ymin,z.xmax-z.xmin,z.ymax-z.ymin),i.lineWidth=2,i.strokeStyle="black",i.stroke());for(var A in w)if(w.hasOwnProperty(A)){if(n=w[A],t=n.pin,u=n.label,!t.shown||!t.enabled)continue;if(!u.shown&&!t.shown)continue;t.transform(x,y,g);var B=b(t);t.setViewAngle(B);var C=-j>B||B>j;t.setOccluded(C);var D;B>=k?(D=1-(B-k)/(j-k),0>D&&(D=0)):D=1,t.setOpacity(D),u.setOpacity(D),t.cullToRectangle(e.left,0,g.width-e.right-h,g.height),t.culled!==u.culled&&u.setCulled(t.culled),t.occluded!==u.occluded&&u.setOccluded(t.occluded),t.enabled&&t.shown&&!t.culled&&!t.occluded&&u.shown&&(v=n.pin.viewPos[0]<0,v?p[q++]=n:r[s++]=n)}c(p,q),c(r,s),d(g,i,z,p,q,-1),d(g,i,z,r,s,1),l=g.width,m=g.height,o=!1}};var t=Human.math.vec4(),u=Human.math.vec3();return g.snapshot=function(a,b,c){if(f.shown){var d,e,g=a.width,h=a.height,i=g/l,j=h/m,k=f.annotations,n={context:b,width:g,height:h,halfWidth:g/2,scaleX:i,scaleY:j};for(var o in k)k.hasOwnProperty(o)&&(d=k[o],d.pin.enabled&&!d.pin.occluded&&(e=d.label,e.shown&&f.renderer.render({annotation:d,canvasData:n,bgColor:c})))}},g}()),Human.view.annotations.layouts.addLayoutType("radial",function(){"use strict";function a(a,b){for(var c,d,e=0;b-1>e;e++){d=e;for(var f=e;b>f;f++)a[f].pin.pos[1]>a[d].pin.pos[1]&&(d=f);c=a[e],a[e]=a[d],a[d]=c}}function b(a,b,c,d,e){for(var f,g,h,i=a.width/2,j=a.height,k=j/d,l=50,m=0;d>m;m++)f=c[m],g=f.pin,h=f.label,h.setPos([e,l]),b.strokeStyle="rgb(0, 0, 100)",b.beginPath(),b.moveTo(g.canvasPos[0],g.canvasPos[1]),i>e?b.lineTo(e+h.getWidth(),l):b.lineTo(e,l),b.closePath(),b.stroke(),l+=k}var c=Human.view.annotations,d={},e=!0;Human.properties.subscribe({propId:"annotation.layout.wires",value:!0,callback:function(a){e=a}});var f=100;Human.properties.subscribe({propId:"annotation.layout.labelMargins",value:100,callback:function(a){f=a}});var g=200;Human.properties.subscribe({propId:"annotation.layout.labelWidth",value:100,callback:function(a){g=a}});var h,i,j=!1,k=!0,l=[],m=0,n=[],o=0;return d.setEnabled=function(a){j=a,k=!0},d.setDirty=function(){k=!0},d.layout=function(d,e){if(k){m=0,o=0;var j,p,q,r,s=c.annotations;for(var t in s)s.hasOwnProperty(t)&&(j=s[t],p=j.pin,q=j.label,p.cullToRectangle(0,0,d.width,d.height),p.culled!==q.culled&&q.setCulled(p.culled),p.enabled&&p.shown&&!p.culled&&q.shown&&j.pin.viewPos&&(r=j.pin.viewPos[0]<0,r?l[m++]=j:n[o++]=j));a(l,m),a(n,o),e.clearRect(0,0,d.width,d.height),b(d,e,l,m,f),b(d,e,n,o,d.width-f-g),h=d.width,i=d.height,k=!1}},d.snapshot=function(a,b){var d,e,f=a.width,g=a.height,j=f/h,k=g/i,l=c.annotations,m={context:b,width:f,height:g,halfWidth:f/2,scaleX:j,scaleY:k};for(var n in l)l.hasOwnProperty(n)&&(d=l[n],d.pin.enabled&&(e=d.label,e.shown&&c.renderer.render({annotation:d,canvasData:m})))},d}()),Human.view.annotations.layouts.addLayoutType("floating",function(){"use strict";function a(a){var b=Human.view.camera.eye;j[0]=b.x,j[1]=b.y,j[2]=b.z,Human.math.subVec3(j,a.pos,j);var c=Human.math.dotVector3(j,a.dir),d=Human.math.lenVec3(j),e=Human.math.lenVec3(a.dir),f=57.2957795*Math.acos(c/(d*e));return f}var b,c=Human.view.annotations,d={};Human.properties.subscribe({propId:"annotations.labelWidth",value:120,callback:function(a){b=a}});var e,f,g=!1,h=!0,i=90;d.setEnabled=function(a){g=a,h=!0},d.setDirty=function(){h=!0},d.layout=function(b){if(h){var d,g,j,k=c.annotations,l=Human.renderer.getViewMat(),m=Human.renderer.getProjMat();for(var n in k)if(k.hasOwnProperty(n)){d=k[n],g=d.pin,j=d.label,g.transform(l,m,b);var o=a(g);g.setViewAngle(o);var p=-90>o||o>90;g.setOccluded(p);var q=-1*(o-0)/(i-0)+1;0>q&&(q=0),g.setOpacity(q),j.setOpacity(q+.5),g.cullToRectangle(0,0,b.width,b.height),g.culled!==j.culled&&j.setCulled(g.culled),g.occluded!==j.occluded&&j.setOccluded(g.occluded),g.enabled&&g.shown&&!g.culled&&!g.occluded&&j.shown&&j.setPos(g.canvasPos)}e=b.width,f=b.height,h=!1}};var j=Human.math.vec3();return d.snapshot=function(a,b){var d,g,h=a.width,i=a.height,j=h/e,k=i/f,l=c.annotations,m={context:b,width:h,height:i,halfWidth:h/2,scaleX:j,scaleY:k};for(var n in l)l.hasOwnProperty(n)&&(d=l[n],d.pin.enabled&&!d.pin.occluded&&(g=d.label,g.shown&&c.renderer.render({annotation:d,canvasData:m})))},d}()),Human.view.annotations.layouts.addLayoutType("draggable",function(){"use strict";function a(a,c,e,f){var i=a.pin,j=a.label,k=f.height,l=f.width;if(i.shown&&i.enabled&&i.shown){i.transform(c,e,f);var m=b(i);i.setViewAngle(m);var n;return m>=h?(n=1-(m-h)/(g-h),0>n&&(n=0)):n=1,i.setOpacity(n),j.setOpacity(n),i.cullToRectangle(d.left,0,l-d.right,k),i.culled!==j.culled&&j.setCulled(i.culled),i.culled?!1:!0}}function b(a){var b=Human.view.camera.eye,c=Human.math.subVec3([b.x,b.y,b.z],a.pos),d=Human.math.dotVector3(c,a.dir),e=Human.math.lenVec3(c),f=Human.math.lenVec3(a.dir),g=57.2957795*Math.acos(d/(e*f));return g}function c(a){var b=a.pin,c=a.label,d=a.wire,e=b.canvasPos,f=c.offset[0]<0,g=[e[0]+c.offset[0],e[1]+c.offset[1]];f&&(g[0]-=c.getWidth()),c.setPos(g),c.setSide(f?"left":"right");var h,i=c.connectionPoint,j=Math.sqrt(Math.pow(i[0]-e[0],2)+Math.pow(i[1]-e[1],2));h=180*Math.atan2(i[1]-e[1],i[0]-e[0])/Math.PI,d.css({width:j+"px",left:e[0]+"px",top:e[1]+"px",opacity:b.opacity,"-webkit-transform":"rotate("+h+"deg)","-moz-transform":"rotate("+h+"deg)","-ms-transform":"rotate("+h+"deg)","-o-transform":"rotate("+h+"deg)",transform:"rotate("+h+"deg)"})}var d,e=Human.view.annotations,f={};Human.properties.subscribe({propId:"annotations.margins",value:{top:50,left:50,right:50,bottom:50},callback:function(a){d=a}});var g=100;Human.properties.subscribe({propId:"annotations.occludedAngle",value:g,callback:function(a){g=a,l=!0}});var h=80;Human.properties.subscribe({propId:"annotations.fadeoutAngle",value:h,callback:function(a){h=a,l=!0}});var i,j,k=!1,l=!0,m=null;f.setEnabled=function(a){k=a,l=!0},function(){var a,b=-1,c=-1;Human.events.on("annotations.mouseDown",function(d){k&&(a=e.annotations[d.annotationId],b=d.x,c=d.y)}),$("body").mousemove(function(d){if(k&&a){var e=d.clientX,f=d.clientY,g=a.label.offset;a.label.setOffset([g[0]+e-b,g[1]+f-c]),b=e,c=f,m=a}}),$("body").mouseup(function(){k&&(a=null)})}(),f.setDirty=function(){l=!0};var n=[];return f.layout=function(b){if(l||m){var d,f,g,h=Human.renderer.getViewMat(),k=Human.renderer.getProjMat();if(n.length=0,l){if(d=e.annotations,!e.shown)return void(l=!1);for(g in d)d.hasOwnProperty(g)&&(f=d[g],a(f,h,k,b)&&(f.occludable?n.push(f):c(f)));i=b.width,j=b.height,l=!1}else d={},d[m.annotationId]=m,a(m,h,k,b)&&(m.occludable?n.push(m):c(m)),m=null;Human.view.annotations.occlusionQuery.runQuery(n,c)}},f.snapshot=function(a,b,c){if(e.shown){var d,f,g=a.width,h=a.height,k=g/i,l=h/j,m=e.annotations,n={context:b,width:g,height:h,halfWidth:g/2,scaleX:k,scaleY:l};for(var o in m)m.hasOwnProperty(o)&&(d=m[o],f=d.pin,f.enabled&&f.shown&&!f.occluded&&e.renderer.render({annotation:d,canvasData:n,bgColor:c}))}},f}()),function(){"use strict";var a,b=!1,c=!1;Human.properties.subscribe({propId:"annotations.hideWhileCameraMoving",value:b,callback:function(a){b=a}}),Human.events.on("camera.updated",function(){c=!0}),Human.events.on("tick",function(){b&&(c?(a&&(clearTimeout(a),a=null),Human.view.annotations.setShown(!1),c=!1):a||(a=setTimeout(function(){clearTimeout(a),Human.view.annotations.setShown(!0)},200)))})}(),function(){"use strict";function a(a){if(!c(Human.modules.modules[a.moduleId])){var d=b()?"draggable":"columns-v2";Human.properties.set({"annotations.layout.type":d})}}function b(){var a,b=Human.view.annotations.annotations,c=Human.timeline.chapters;for(a in b)if(b.hasOwnProperty(a)&&!b[a].draggable)return!1;for(var d in c)if(c.hasOwnProperty(d)){b=c[d].annotations||{};for(a in b)if(b.hasOwnProperty(a)&&!b[a].draggable)return!1}return!0}function c(a){return a?a.annotationsLayout?!0:a.properties&&a.properties["annotations.layout.type"]?!0:!1:!1}Human.events.on("bookmarks.restored",a),Human.events.on("modules.activated",a),Human.events.on("modules.deactivated",a)}(),function(){"use strict";function a(a){this._annotation=a.annotation,this._object=a.object,this._pinPos=Human.math.vec3(),this._pinPos.set(this._annotation.pin.pos),Human.math.inverseMat4(this._object.getWorldMatrix(),k),Human.math.transformPoint3(k,this._pinPos,this._pinPos)}function b(a){var b=a.morph,d=a.geometry,e=a.annotation,f=e.pin;this._object=a.object,this._morph=b,this._annotation=e,this._times=b.getKeys(),this._targets=[],this._index1=0,this._index2=1,this._loop=!!a.loop,this._pickPos=Human.math.vec3(),this._pinPos=Human.math.vec3(),Human.math.inverseMat4(this._object.getWorldMatrix(),k),Human.math.transformPoint3(k,e.pin.pos,this._pinPos),this._offset=[e.label.offset[0],e.label.offset[1]];var g=this;e.label.on("offset",function(a){g._offset=a});var h,i,j,l,p=this._morph.getTargets(),q=f.primitiveIndex,r=d.getIndices(),s=r[q],t=r[q+1],u=r[q+2],v=f.barycentric;for(h=0,i=p.length;i>h;h++)j=p[h].positions,m[0]=j[3*s],m[1]=j[3*s+1],m[2]=j[3*s+2],n[0]=j[3*t],n[1]=j[3*t+1],n[2]=j[3*t+2],o[0]=j[3*u],o[1]=j[3*u+1],o[2]=j[3*u+2],l=c(v,m,n,o,Human.math.vec3()),this._targets.push(l);this._pickPos[0]=this._pinPos[0],this._pickPos[1]=this._pinPos[1],this._pickPos[2]=this._pinPos[2]}function c(a,b,c,d,e){var f=a[0],g=a[1],h=a[2];return e[0]=b[0]*f+c[0]*g+d[0]*h,e[1]=b[1]*f+c[1]*g+d[1]*h,e[2]=b[2]*f+c[2]*g+d[2]*h,e}function d(){Human.timeline.paused||(Human.timeline.pause(),t=!0),Human.timeline.pausedFreeAnimations||(Human.timeline.pauseFreeAnimations(),u=!0)}function e(){t&&(Human.timeline.unpause(),t=!1),u&&(Human.timeline.playFreeAnimations(),u=!1)}var f,g={},h=[],i=0,j=!1;Human.events.on("loaded",function(){f=document.getElementById("annotationCanvas")}),Human.events.on("annotations.pinning",d),Human.events.on("annotations.creating",d),Human.events.on("annotations.created",function(c){var d=c.annotationId,f=Human.view.annotations.annotations[d];if(!f.followsObject)return void e();var h=c.objectId,i=Human.scene.objects[h];if(!h||!i)return void e();var k=i.morph&&i.geometry&&f.pin.primitiveIndex;if(k){var l=f.label.offset;g[d]=new b({object:i,morph:i.morph,geometry:i.geometry,annotation:f,offset:[l[0],l[1]]})}else g[d]=new a({object:i,annotation:f});j=!0,e()}),Human.events.on("annotations.destroyed",function(a){var b=a.annotationId;g[b]&&(delete g[b],j=!0),e()}),Human.events.on("tick",function(){if(j){i=0;for(var a in g)g.hasOwnProperty(a)&&(h[i++]=g[a]);j=!1}if(i>0){for(var b=0;i>b;b++)h[b].update();Human.view.annotations.layouts.redrawLayout()}});var k=Human.math.mat4(),l=Human.math.vec3();a.prototype.update=function(){var a=this._annotation;a.pin.shown&&(Human.math.transformPoint3(this._object.getWorldMatrix(),this._pinPos,l),a.pin.setPos(l))};var m=Human.math.vec3(),n=Human.math.vec3(),o=Human.math.vec3(),p=Human.math.vec2(),q=Human.math.vec2();b.prototype.update=function(){var a=this._annotation;if(a.pin.shown){var b=this._morph.getFactor();if(!(this._targets.length<2)){void 0===b&&(b=this._times[0]);var c=this._times[0],d=this._times[this._times.length-1];if(this._loop)b=this._times[0]+b%(d-c);else{if(c>=b)return this._targets[0];if(b>=d)return this._targets[this._targets.length-1]}for(;this._times[this._index1]>b;)this._index1--,this._index2--;for(;this._times[this._index2]<b;)this._index1++,this._index2++;Human.math.lerpVec3(b,this._times[this._index1],this._times[this._index2],this._targets[this._index1],this._targets[this._index2],this._pinPos),Human.math.transformPoint3(this._object.getWorldMatrix(),this._pinPos,this._pinPos),a.pin.setPos(this._pinPos),this._transform(this._pickPos,p),this._transform(this._pinPos,q),a.label.offset2[0]=this._offset[0]-(q[0]-p[0]),a.label.offset2[1]=this._offset[1]-(q[1]-p[1])}}};var r=Human.math.vec4(),s=Human.math.vec4();b.prototype._transform=function(a,b){var c=Human.renderer.getViewMat(),d=Human.renderer.getProjMat();Human.math.transformPoint3(c,a,r),r[3]=1,Human.math.transformPoint4(d,r,s);var e=s[0],g=s[1],h=s[3];return b[0]=(1+e/h)*f.width/2,b[1]=(1-g/h)*f.height/2,b};var t=!1,u=!1}(),function(){"use strict";function a(){var a,b;for(g.clear(),a=0,b=r.length;b>a;a++)g.addAnnotation(r[a]);g.doQuery();var c,d,e,f,h=Human.view.annotations.annotations,i=g.result,j=g.lenResult;for(a=0;j>a;a++)f=i[a],c=h[f.annotationId],d=c.pin,e=c.label,f.occluded?(d.setOccluded(!0),e.setOccluded(!0)):(d.setOccluded(!1),e.setOccluded(!1),s&&s(c))}function b(a){var b=Human.view.camera.eye,c=Human.math.subVec3([b.x,b.y,b.z],a.pos),d=Human.math.dotVector3(c,a.dir),e=Human.math.lenVec3(c),f=Human.math.lenVec3(a.dir),g=57.2957795*Math.acos(d/(e*f));return g}function c(a,b,c,d,e,f){Human.math.transformPoint3(b,a,x),x[3]=1,Human.math.transformPoint4(c,x,x);var g=x[0],h=x[1],i=x[3];f[0]=(1+g/i)*d/2,f[1]=(1-h/i)*e/2}function d(){this._flags=e.addNode({type:"flags",flags:{enabled:!1,clipping:!0}}),this._material=this._flags.addNode({type:"material",color:{r:0,g:0,b:1},specularColor:{r:0,g:0,b:0},emitColor:{r:0,g:0,b:1},emit:1}),this._translate=this._material.addNode({type:"translate",x:0,y:0,z:0}),this._geometry=this._translate.addNode({type:"geometry",primitive:"points",coreId:"__occludePoint",positions:[0,0,0],indices:[0]})}var e,f,g=Human.view.annotations.occlusionQuery={},h=[],i=0;g.result=[],g.lenResult=0,Human.events.on("loaded",function(){e=Human.renderer.getNode("occlusionIndicators"),f=Human.renderer.canvas.canvas[0]});var j=100;Human.properties.subscribe({propId:"annotations.occludedAngle",value:j,callback:function(a){j=a,p=!0}});var k,l,m,n,o=6,p=!0,q=o,r=[],s=null;Human.events.on("tick",function(){q++,p&&q>=o&&r.length>0&&(k=Human.renderer.getViewMat(),l=Human.renderer.getProjMat(),m=f.width,n=f.height,a(),p=!1,q=0)}),g.runQuery=function(a,b){r=a||[],s=b||null,p=!0,r.forEach(function(a){a.pin.occluded||s(a)})},g.clear=function(){for(var a=0;i>a;a++)h[a].point.setShown(!1);i=0};var t=Human.math.vec3(),u=Human.math.vec3(),v=Human.math.vec3(),w=Human.math.vec2();g.addAnnotation=function(a){var e=a.pin,f=a.label,o=b(e);e.setViewAngle(o);var p=-j>o||o>j;if(e.setOccluded(p),e.occluded!==f.occluded&&f.setOccluded(p),!p){var q=a.object,r=Human.view.camera.eye,s=q&&!q.clippable?!1:!0;u.set(e.pos),t[0]=r.x,t[1]=r.y,t[2]=r.z,Human.math.subVec3(t,u,v);var x=Human.math.lenVec3(v);Human.math.divVec3s(v,x,v),Human.math.mulVec3Scalar(v,Math.min(.1*x,.5),v),Human.math.addVec3(u,v,u),c(u,k,l,m,n,w);var y=h[i]||(h[i]={x:0,y:0,r:0,g:0,b:0,a:0,point:new d,occluded:!1});y.annotation=a,y.x=w[0],y.y=w[1],y.point.setWorldPos(u),y.point.setShown(!0),y.point.setClipping(s);var z=g.result[i]||(g.result[i]={annotationId:null,occluded:!1});z.annotationId=a.annotationId,z.occluded=!1,i++}},g.doQuery=function(){if(0!==i){var a=!0;Human.renderer.getScene().readPixels(h,i,a);for(var b,c=0;i>c;c++)b=h[c],g.result[c].occluded=!(0===b.r&&0===b.g&&255===b.b),b.point.setShown(!1);g.lenResult=i,i=0}};var x=Human.math.vec4();d.prototype.setShown=function(a){this._flags.setEnabled(!!a)},d.prototype.setClipping=function(a){this._flags.setClipping(!!a)},d.prototype.setWorldPos=function(a){this._translate.setXYZ({x:a[0],y:a[1],z:a[2]})},d.destroy=function(){this._flags.destroy()}}(),function(){"use strict";function a(a){var b,c={};for(var d in a)a.hasOwnProperty(d)&&(b=a[d],Human.utils.isPrimitive(b)&&"_"!==d[0]&&(c[d]=b));return c.objectId=a.object?a.object.objectId:"",c.title=a.label.title,c.description=a.label.description,c.pos=a.pin.pos,c.pinVec=a.pin.dir,c.visible=a.pin.visible,c}Human.rpc.define("annotations.getAnnotations",function(){var b,c=Human.view.annotations.annotations,d={};for(var e in c)c.hasOwnProperty(e)&&(b=c[e],d[e]=a(b));this.setResult(d)}),Human.rpc.define("annotations.create",function(b){var c=Human.view.annotations.createAnnotation(b);this.setResult(a(c))}),Human.rpc.define("annotations.setTitle",function(a){var b=Human.view.annotations.annotations[a.annotationId];b&&b.label.setTitle(a.title),this.setResult(!0)}),Human.rpc.define("annotations.setDescription",function(a){var b=Human.view.annotations.annotations[a.annotationId];b&&b.label.setDescription(a.description),this.setResult(!0)}),Human.rpc.define("annotations.update",function(a){Human.view.annotations.updateAnnotation(a.annotationId,a),this.setResult(!0)}),Human.rpc.define("annotations.flyTo",function(){this.setResult(!0)}),Human.rpc.define("annotations.setLabelsShown",function(a){Human.view.annotations.setLabelsShown(a),this.setResult(!0)}),Human.rpc.define("annotations.setShown",function(a){Human.view.annotations.setShown(a.shown),this.setResult(!0)}),Human.rpc.define("annotations.destroy",function(a){var b=Human.view.annotations.annotations[a.annotationId];b&&b.destroy(),this.setResult(!0)}),Human.rpc.define("annotations.setLabelStyles",function(a){a.label&&$(".annotationContainer").css(a.label),a.title&&$(".annotationContainer > .title").css(a.title),a.description&&$(".annotationContainer > .description").css(a.description),Human.view.annotations.updateDimensions(),Human.view.annotations.layouts.redrawLayout(),this.setResult(!0)}),Human.rpc.define("annotations.setPinStyles",function(a){a.hasOwnProperty("pin")?($(".annotationPin").css(a.pin),a.hasOwnProperty("after")&&($(".annotationPin").html('<div class="after"></div>'),$(".annotationPin > .after").css(a.after))):$(".annotationPin").css(a),this.setResult(!0)}),Human.rpc.define("annotations.setWireStyles",function(a){$(".annotationWire").css(a),this.setResult(!0)})}(),function(){"use strict";function a(a){Human.view.labels.createLabel({objectId:a.objectId,afterDelay:!0}),Human.renderer.forceRenderFrame()}function b(a,b){var c=Human.scene.objects[a];c&&Human.events.fire("focus.objectFocused",{objectId:a,description:c.description,flyTo:b})}var c=Human.view.focus={},d=!0;Human.properties.subscribe({propId:"data.medline.enabled",value:!0,callback:function(a){d=a}});var e=!0;Human.properties.subscribe({propId:"data.wikipedia.enabled",value:!0,callback:function(a){e=a}}),c.focusObject=function(c,d){d=d||Human.utils.noop;var e=c.fmaId,f=c.objectId,g=c.objectIds;if(!f&&!e&&!g)return Human.log.error("Human.view.focusObject","Parameter expected: either 'objectId', 'objectIds' or 'fmaId'"),void d();var h,i=Human.scene;if(f){if(h=i.objects[f],!h)return Human.log.error("Human.view.focusObject","Scene object not found: '"+f+"'"),void d()}else if(e){if(h=i.objectsByFMAID[e],!h)return Human.log.error("Human.view.focusObject","Scene object not found for this FMAID: '"+e+"'"),void d();f=h.objectId}c.xray===!0?Human.rpc.call(null,"xray.setEnabled",{enable:!0}):c.xray===!1&&Human.rpc.call(null,"xray.setEnabled",{enable:!1});var j=c.select;j=void 0===j||null===j?c.replace||!i.selectedObjects[f]:c.select;var k,l=c.flyTo;if(c.replace)i.setSelectedObjects({objectId:f,select:j,replace:c.replace});else if(j){var m={};m[f]=j,i.setSelectedObjects({objects:m,replace:c.replace})}c.showLabel===!1&&j||Human.view.labels._clearLabels(),c.showLabel!==!1&&a(c),j&&"newSelected"===l?(k=h.getBoundary(),k&&(Human.view.boundary.setBoundary(k,!0),Human.view.camera.fly.flyTo({boundary:k,backOff:c.backOff,arc:0,easing:!0},function(){Human.view.boundary.setBoundary(!1),b(f,l),d()}))):l&&"allSelected"!==l?"selectedLeafObjects"===l?Human.view.camera.fly.flyTo({selectedLeafObjects:!0,backOff:c.backOff,arc:0,easing:!0},function(){Human.view.boundary.setBoundary(!1),j&&b(f,l),d()}):"object"===l?(k=h.getBoundary(),Human.view.boundary.setBoundary(k,!0),Human.view.camera.fly.flyTo({boundary:k,backOff:c.backOff,arc:0,easing:!0},function(){Human.view.boundary.setBoundary(!1),j&&b(f,l),d()})):(b(f,l),d()):(k=i.getBoundary({objects:i.selectedObjects}),k?(Human.view.boundary.setBoundary(k,!0),Human.view.camera.fly.flyTo({boundary:k,backOff:c.backOff,arc:0,easing:!0},function(){Human.view.boundary.setBoundary(!1),j&&b(f,l),d()})):(Human.view.boundary.setBoundary(!1),j&&b(f,l),d()))}}(),function(){"use strict";Human.rpc.define("focus.focusObject",function(a){var b=this;Human.view.focus.focusObject(a,function(){b.setResult(!0)})})}(),function(){"use strict";function a(a){var b,c=Human.scene,d=c.objects;for(var e in d)d.hasOwnProperty(e)&&(b=d[e],a?Human.scene.selectedObjects[b.objectId]?(b.setXRay(!1),b.setHighlight(!1)):b.setXRay(!0):b.setXRay(!1))}var b=Human.view.xray={};b.enabled=!1;var c=!0;Human.events.on("loaded",function(){b.enabled=!1,c=!1}),Human.events.on("scene.objectsSelected",function(){b.enabled&&(c=!0)}),Human.events.on("tick",function(){c&&(a(b.enabled),c=!1)}),b.setEnabled=function(a){b.enabled!==a&&(b.enabled=a,c=!0),Human.events.fire("xray.toggled",{enabled:a}),b.enabled&&(Human.view.currentMode="Xray")},b.getEnabled=function(){return b.enabled}}(),function(){"use strict";function a(a){for(var b=Human.scene.objects[a];b&&b.anonymous;)b=b.parent;return b}var b=Human.view.pick={};b.singleEnabled=!0,b.multiEnabled=!1;var c=!1;Human.properties.subscribe({propId:"pick.alwaysRayPick",value:c,callback:function(a){c=a}});var d=!1;Human.properties.subscribe({propId:"pick.regions.pickAll",value:d,callback:function(a){d=a}}),Human.events.on("loaded",function(){b.setSinglePickEnabled(!0),b.setMultiPickEnabled(!1)}),b.setSinglePickEnabled=function(a){b.singleEnabled!==a&&(b.singleEnabled=a),a&&(b.multiEnabled&&(b.multiEnabled=!1),Human.events.fire("pick.multi.toggled",{enabled:b.multiEnabled})),Human.events.fire("pick.single.toggled",{enabled:b.singleEnabled})},b.getSinglePickEnabled=function(){return b.singleEnabled},b.setMultiPickEnabled=function(a){b.multiEnabled!==a&&(b.multiEnabled=a),a&&(b.singleEnabled&&(b.singleEnabled=!1),Human.events.fire("pick.single.toggled",{enabled:b.singleEnabled})),Human.events.fire("pick.multi.toggled",{enabled:b.multiEnabled})},b.getMultiPickEnabled=function(){return b.multiEnabled},b.hoverPick=function(a){return b._pick(a,!0,!1,!1,c,a.regionPick)},b.hoverOff=function(){Human.view.tooltips.clearTooltip()},b.pick=function(a){return b._pick(a,!1,!1,!1,c,a.regionPick)},b.doublePick=function(a){return b._pick(a,!1,!0,!1,c,a.regionPick)},b.queryPick=function(a){return b._pick(a,!1,!1,!0,a.rayPick||c,a.regionPick)},b._pick=function(c,e,f,g,h,i){var j,k,l,m,n,o,p=c.canvasX,q=c.canvasY,r=c.mouseDownLeft,s=c.mouseDownRight,t=c.spaceDown,u=c.ctrlDown;if(Human.assets.regionMaps.highlightRegion(null),g){if(j=Human.renderer.pick(p,q,h)){if(l=a(j.name)){var v=Human.utils.apply(j,{mode:"query",objectId:l.objectId,mouseDownLeft:r,mouseDownRight:s});return l.regionMap&&(j=Human.renderer.pick(p,q,h,!0),j&&(v.regionMapId=l.regionMap.regionMapId,v=Human.utils.apply(v,j))),Human.events.fire("pick.picked",v),v}return}}else if((b.singleEnabled||b.multiEnabled||Human.view.dissect.enabled||Human.view.annotations.enabled||Human.view.highlight.enabled)&&!Human.scene.checkTestStarted)if(e){if(j=Human.renderer.pick(p,q,h),j&&(l=a(j.name))){var w=Human.utils.apply(j,{mode:"hover",objectId:l.objectId}),x=l.displayName;l.regionMap&&(j=Human.renderer.pick(p,q,h,!0),j&&(d?k=null:(k=l.regionMap.regionMapId,
w.regionMapId=k,w=Human.utils.apply(w,j)),o=j.color,Human.assets.regionMaps.highlightRegion({regionColor:o,regionMapId:k,highlight:!0}),j.regionData.name&&(x=j.regionData.name))),Human.view.tooltips.setTooltip({objectId:l.objectId,canvasX:p,canvasY:q,title:x}),Human.events.fire("pick.hoverPicked",w),Human.events.fire("pick.picked",w)}}else{if((Human.view.highlight.enabled||Human.view.xray.enabled)&&!Human.view.dissect.enabled&&!Human.view.annotations.enabled)if(j=Human.renderer.pick(p,q,h,i))if(l=a(j.name)){if(f)return void Human.view.focus.focusObject({objectId:l.objectId,replace:b.singleEnabled,showLabel:!0,select:!0,flyTo:"selectedLeafObjects"});if(Human.view.annotations.setLabelsShown({objects:{},type:"secondary",replace:!0}),t)return m={},m[l.objectId]=!0,void Human.view.annotations.setLabelsShown({objects:m,type:"secondary"});if(u)return m={},m[l.objectId]=!1,void Human.view.annotations.setLabelsShown({objects:m,type:"secondary"});Human.scene.selectedObjects[l.objectId]?Human.scene.setSelectedObjects({objectId:l.objectId,select:!Human.scene.selectedObjects[l.objectId],replace:!b.multiEnabled}):(Human.view.focus.focusObject({objectId:l.objectId,showLabel:!0,replace:!b.multiEnabled,flyTo:"none"}),Human.view.tooltips.setTooltip({objectId:l.objectId,canvasX:p,canvasY:q})),Human.events.fire("pick.picked",Human.utils.apply(j,{mode:Human.view.highlight.enabled?"highlight":"xray",objectId:l.objectId,mouseDownLeft:r,mouseDownRight:s}))}else n=Human.view.annotations.annotations[j.name],n&&n.pin.pick();else f&&(Human.view.xray.enabled||Human.scene.setSelectedObjects({select:!1,replace:!0}));if(Human.view.isolate.enabled&&!Human.view.dissect.enabled&&!Human.view.annotations.enabled&&(j=Human.renderer.pick(p,q,h),j&&(l=a(j.name)))){if(f)return void Human.view.focus.focusObject({objectId:l.objectId,showLabel:!0,select:!1,flyTo:"object"});Human.view.focus.focusObject({objectId:l.objectId,showLabel:!0,select:!1,flyTo:"none"}),Human.view.tooltips.setTooltip({objectId:l.objectId,canvasX:p,canvasY:q}),Human.events.fire("pick.picked",Human.utils.apply(j,{mode:"isolate",objectId:l.objectId}))}if(Human.view.dissect.enabled&&!Human.view.annotations.enabled){if(f)return;return j=Human.renderer.pick(p,q,h),void(j&&(l=a(j.name),l&&(Human.view.dissect.dissect(l.objectId),Human.events.fire("pick.picked",Human.utils.apply(j,{mode:"dissect",objectId:l.objectId})))))}if(Human.view.annotations.enabled){if(f)return;if(h=!0,j=Human.renderer.pick(p,q,h)){var y=j.name;l=Human.scene.objects[y],l||(n=Human.view.annotations.annotations[j.name],n&&n.pin.pick())}}else;}}}(),function(){"use strict";function a(){if(0!==k.length){var c=k.pop(),d=c.params,e=c.ok;b(d,function(b){d.openInTab&&window.open(b.src,"_blank"),e&&e(b),a()})}}function b(a,b){Human.events.fire("snapshot.started"),a=a||{};var f=document.getElementById(g),h=void 0!==a.copyright&&null!==a.copyright?a.copyright:!0,k=a.scale!==!1,l=d(f),m=l.width,n=l.height,o=a.width||m,p=a.height||n;o>=p?p=Math.floor(n/m*o):p>o&&(o=Math.floor(m/n*p));var q=!k&&o>m||p>n,r=a.color||Human.renderer.bg.bgColor,s=Human.renderer.bg.bgColor;q&&(f.width=o,f.height=p),r&&Human.renderer.bg.setBGColor(r),Human.timeline.pause(),Human.renderer.forceRenderFrame();var t=document.createElement("canvas"),u=t.getContext("2d");t.width=o,t.height=p;var v=d(f),w=v.width,x=v.height,y=Human.renderer.bg.bgColors[Human.renderer.bg.bgColor],z=y.slice(0,3),A=y.slice(9,12),B=u.createLinearGradient(0,0,0,t.height);if(B.addColorStop(0,c(z)),B.addColorStop(1,c(A)),u.fillStyle=B,u.fillRect(0,0,t.width,t.height),u.drawImage(f,0,0,w,x,0,0,o,p),h){var C=Math.max(15,o/2-j.width/2),D=Math.max(15,p-20-j.height);u.drawImage(i,C,D),u.font="12pt Arial";var E=(new Date).getFullYear(),F=String.fromCharCode(169),G=F+" "+E,H=o/2,I=D+j.height+10;u.fillStyle="#666666",u.textAlign="center",u.fillText(G,H,I)}Human.events.fire("snapshot.rendering",{canvas:t,context:u,bgColor:r}),q&&(f.width=m,f.height=n),r&&Human.renderer.bg.setBGColor(s),Human.renderer.forceRenderFrame(),Human.timeline.unpause(),Human.events.fire("snapshot.finished");var J=new Image;J.width=o,J.height=p,J.onload=function(){b(J)},J.src=t.toDataURL(e)}function c(a){return"rgb("+Math.round(255*a[0])+", "+Math.round(255*a[1])+", "+Math.round(255*a[2])+")"}function d(a){var b=10;return{width:parseInt(a.getAttribute("width"),b),height:parseInt(a.getAttribute("height"),b)}}var e,f=Human.view.snapshot={};Human.properties.subscribe({propId:"snapshot.mime",value:"image/jpeg",callback:function(a){e=a}});var g="theCanvas",h="img/bhuman-logo-powered.png",i=new Image,j={width:0,height:0};i.onload=function(){j.width=i.width,j.height=i.height};var k=[];i.src=h,f.getSnapshot=function(b,c,d){if(!(void 0===b.width&&void 0===b.height||void 0!==b.width&&void 0!==b.height)){var e="Snapshot failed: incomplete params: both 'width' and 'height' expected";d&&d(e)}k.unshift({params:b,ok:c}),a()}}(),function(){"use strict";Human.rpc.define("snapshot.get",function(a){var b=this;Human.view.snapshot.getSnapshot(a,function(a){b.setResult(a.src)})})}(),function(){"use strict";function a(a){a.onUpdate=function(a){e._onUpdate(a)},e.clips[a.clipId]=new Human.view.clip.Plane(a)}function b(){var a;for(var b in e.clips)if(e.clips.hasOwnProperty(b)&&(a=e.clips[b],a.state!==Human.view.clip.Plane.STATE_DORMANT&&0!==a.progress))return void c();d()}function c(){if(!l){var a=Human.renderer.getNode("clips"),b=a.parent,c=b.disconnectNodes();f.disconnect(),f.addNodes(c),b.addNode(f),l=!0,Human.events.fire("clips.activated")}}function d(){if(l){f.splice();var a=Human.renderer.getNode("assetLibraryRoot");if(!a)return void Human.log.error("Human.view.clip.deactivateClipsNode","Scene node not found: 'assetlibraryRoot'");a.addNode(f),l=!1,Human.events.fire("clips.deactivated")}}var e=Human.view.clip={};e.LEFT="left",e.RIGHT="right",e.TOP="top",e.BOTTOM="bottom",e.FRONT="front",e.BACK="back";var f,g,h,i=!1,j=!1,k=!0,l=!1;e.clips={},e.selectedClip=null,Human.events.on("loaded",function(){j=!1;var b=Human.renderer.getNode("assetLibraryRoot");return b?(f=b.addNode({type:"clips",clips:[{mode:"disabled",x:-1,y:0,z:0},{mode:"disabled",x:1,y:0,z:0},{mode:"disabled",x:0,y:-1,z:0},{mode:"disabled",x:0,y:1,z:0},{mode:"disabled",x:0,y:0,z:-1},{mode:"disabled",x:0,y:0,z:1}]}),a({index:0,type:e.LEFT,clipId:e.LEFT}),a({index:1,type:e.RIGHT,clipId:e.RIGHT}),a({index:2,type:e.TOP,clipId:e.TOP}),a({index:3,type:e.BOTTOM,clipId:e.BOTTOM}),a({index:4,type:e.FRONT,clipId:e.FRONT}),a({index:5,type:e.BACK,clipId:e.BACK}),void e.selectClip("front")):void Human.log.error("Human.view.clip.createClipsNode","Scene node not found: 'assetlibraryRoot'")}),e._onUpdate=function(a){var b={};b[""+a.index]={x:a.x,y:a.y,z:a.z,dist:a.dist,mode:a.clipping?"inside":"disabled"},f.setClips(b)},Human.events.on("tick",function(){g&&(e._updateClipForIsolatedObjects(),g=!1)}),e._updateClipForIsolatedObjects=function(){var a=Human.scene.objects,b=Human.scene.selectedObjects;for(var c in a)a.hasOwnProperty(c)&&a[c].setClippable(b[c]?!1:!0)},Human.events.on("Scene.Sleep",function(){var a;for(var b in e.clips)e.clips.hasOwnProperty(b)&&(a=e.clips[b],a.state===Human.view.clip.Plane.STATE_VISIBLE&&(a.framesUntilHide>0?a.framesUntilHide--:Human.view.clip.setClip({clipId:a.clipId,state:Human.view.clip.Plane.STATE_CLIPPING})))}),Human.events.on("scene.objectsSelected",function(){g=!0}),Human.events.on("scene.objectsShown",function(){k=!0;for(var a in e.clips)if(e.clips.hasOwnProperty(a)){var b=e.clips[a];b.state!==Human.view.clip.Plane.STATE_DORMANT&&e._configureClip(b)}}),e.setClip=function(a){var c;if(a.clipId){if(c=e.clips[a.clipId],!c)return void Human.log.error("Human.view.clip.setClip","Clip plane not found: '"+a.clipId+"'")}else{if(!e.selectedClip)return void Human.log.error("Human.view.clip.setClip","Parameter expected: 'clipId'");c=e.selectedClip}if(a.state&&a.state!==Human.view.clip.Plane.STATE_DORMANT&&a.state!==Human.view.clip.Plane.STATE_ACTIVE&&a.state!==Human.view.clip.Plane.STATE_CLIPPING&&a.state!==Human.view.clip.Plane.STATE_VISIBLE)return void Human.log.error("Human.view.clip.setClip","State not recognized: '"+a.state+"'");var d=c.state,f=a.state||d;switch(f){case Human.view.clip.Plane.STATE_DORMANT:c._setClipping(!1),c._setVisible(!1);break;case Human.view.clip.Plane.STATE_ACTIVE:e._configureClip(c,a),c._setClipping(!1),c._setVisible(!1);break;case Human.view.clip.Plane.STATE_CLIPPING:switch(c._setClipping(!0),c._setVisible(!1),d){case Human.view.clip.Plane.STATE_DORMANT:e._configureClip(c,a);break;default:a.progress&&c._setProgress(a.progress)}break;case Human.view.clip.Plane.STATE_VISIBLE:switch(c._setClipping(!0),c._setVisible(!0),d){case Human.view.clip.Plane.STATE_DORMANT:e._configureClip(c,a);break;default:a.progress&&c._setProgress(a.progress)}}c.state=f,Human.events.fire("clip.updated",{clipId:c.clipId,state:c.state,progress:c.progress}),b()},e._configureClip=function(a,b){b=b||{},k&&(h=Human.scene.getBoundary({objects:Human.scene.enabledObjects}),k=!1);var c,d,f,g,i=.5*(h.xmin+h.xmax),j=.5*(h.ymin+h.ymax),l=.5*(h.zmin+h.zmax);switch(a.type){case e.LEFT:c={x:h.xmax,y:j,z:l},d={y:1,angle:-90},f={x:h.zmax-h.zmin,y:h.ymax-h.ymin},g={min:h.xmin,max:h.xmax};break;case e.RIGHT:c={x:h.xmin,y:j,z:l},d={y:1,angle:90},f={x:h.zmax-h.zmin,y:h.ymax-h.ymin},g={min:h.xmin,max:h.xmax};break;case e.FRONT:c={x:i,y:j,z:h.zmin},d={y:1,angle:0},f={x:h.xmax-h.xmin,y:h.ymax-h.ymin},g={min:h.zmin,max:h.zmax};break;case e.BACK:c={x:-i,y:j,z:h.zmax},d={y:1,angle:180},f={x:h.xmax-h.xmin,y:h.ymax-h.ymin},g={min:h.zmin,max:h.zmax};break;case e.TOP:c={x:i,y:h.ymax,z:l},d={x:1,angle:90},f={x:h.xmax-h.xmin,y:h.zmax-h.zmin},g={min:h.ymin,max:h.ymax};break;case e.BOTTOM:c={x:i,y:h.ymin,z:l},d={x:1,angle:-90},f={x:h.xmax-h.xmin,y:h.zmax-h.zmin},g={min:h.ymin,max:h.ymax};break;default:c=b.pos,d=b.dir,f=b.size,g=b.range}a._setPos(c),a._setDir(d),a._setRange(g),a._setSize(f),void 0!==b.progress&&a._setProgress(b.progress)},e.selectClip=function(a){var b;return a&&(b=e.clips[a],!b)?void Human.log.error("Human.view.clip.selectClip","Clip plane not found: '"+a+"'"):void(e.selectedClip=b)},e.reset=function(){var a;for(var b in e.clips)e.clips.hasOwnProperty(b)&&(a=e.clips[b],e.setClip({clipId:a.clipId,state:Human.view.clip.Plane.STATE_DORMANT}),e._configureClip(a));i&&e.selectClip("front"),Human.events.fire("CrossSections.Reset")}}(),function(){"use strict";var a=Human.math.mat4(),b=Human.math.mat4();Human.view.clip.Plane=function(a){this.index=a.index,this.clipId=a.clipId,this.type=a.type,this.state=Human.view.clip.Plane.STATE_DORMANT,this.framesUntilHide=1;var b=a.pos||{};this.pos={x:b.x||0,y:b.y||0,z:b.z||0};var c=a.dir||{};this.dir={x:c.x||0,y:c.y||0,z:c.z||0,angle:c.angle||0};var d=a.size||{};this.size={x:d.x||10,y:d.y||10};var e=a.range||{};this.range={min:e.min||0,max:e.max||0},this.progress=0;var f=a.clipId+".indicator.flags",g=a.clipId+".indicator.xf";this.visible=a.visible||!1,this.clipping=a.clipping||!1,this._onUpdate=a.onUpdate,Human.renderer.getNode(Human.CLIP_INDICATORS_ATTACH_ID).addNode({type:"flags",id:f,flags:{enabled:this.visible,transparent:!0,backfaces:!0,clipping:!1,picking:!1},nodes:[{type:"xform",id:g,nodes:[{type:"material",emit:.9,baseColor:{r:.3,g:.3,b:.8},specularColor:{r:.3,g:.3,b:.8},specular:0,shine:100,alpha:.2,nodes:[{type:"geometry/plane",width:2,height:2}]},{type:"material",emit:.9,baseColor:{r:.3,g:.3,b:.8},specularColor:{r:.3,g:.3,b:.8},specular:0,shine:100,alpha:.9,nodes:[{type:"geometry",primitive:"lines",positions:[1,1,1,1,-1,1,-1,-1,1,-1,1,1,1,1,-1,1,-1,-1,-1,-1,-1,-1,1,-1],indices:[0,1,1,2,2,3,3,0]}]}]}]}),this.indicatorFlagsNode=Human.renderer.getNode(f),this.indicatorXFormNode=Human.renderer.getNode(g),this._updatePosition()},Human.view.clip.Plane.prototype._updatePosition=function(){Human.math.identityMat4(a);var c=this.progress*(this.range.max-this.range.min),d=[this.pos.x,this.pos.y,this.pos.z];switch(this.type){case Human.view.clip.BACK:d[2]=this.range.max-c;break;case Human.view.clip.FRONT:d[2]=this.range.min+c;break;case Human.view.clip.LEFT:d[0]=this.range.max-c;break;case Human.view.clip.RIGHT:d[0]=this.range.min+c;break;case Human.view.clip.TOP:d[1]=this.range.max-c;break;case Human.view.clip.BOTTOM:d[1]=this.range.min+c}Human.math.mulMat4(a,Human.math.translationMat4v(d),a),Human.math.mulMat4(a,Human.math.rotationMat4v(this.dir.angle*Math.PI/180,[this.dir.x,this.dir.y,this.dir.z]),a),Human.math.mulMat4(a,Human.math.scalingMat4v([.5*this.size.x,.5*this.size.y,0]),a),this.indicatorXFormNode.setElements(a),Human.math.identityMat4(b),Human.math.mulMat4(b,Human.math.translationMat4v(d),b),Human.math.mulMat4(b,Human.math.rotationMat4v(this.dir.angle*Math.PI/180,[this.dir.x,this.dir.y,this.dir.z]),b),Human.math.mulMat4(b,Human.math.scalingMat4v([.5*this.size.x,.5*this.size.y,0]),b);var e=SceneJS_math_transformPoint3(b,[-1,-1,0]),f=SceneJS_math_transformPoint3(b,[1,-1,0]),g=SceneJS_math_transformPoint3(b,[1,1,0]),h=SceneJS_math_normalizeVec3(SceneJS_math_cross3Vec4(SceneJS_math_normalizeVec3(SceneJS_math_subVec3(f,e,[0,0,0]),[0,0,0]),SceneJS_math_normalizeVec3(SceneJS_math_subVec3(f,g,[0,0,0]),[0,0,0]))),i=SceneJS_math_dotVector3(h,e);this.x=h[0],this.y=h[1],this.z=h[2],this.dist=i,this._onUpdate(this)},Human.view.clip.Plane.STATE_DORMANT="dormant",Human.view.clip.Plane.STATE_ACTIVE="active",Human.view.clip.Plane.STATE_CLIPPING="clipping",Human.view.clip.Plane.STATE_VISIBLE="visible",Human.view.clip.Plane.prototype._setPos=function(a){a=a||{},this.pos={x:a.x||0,y:a.y||0,z:a.z||0},this._updatePosition()},Human.view.clip.Plane.prototype._setDir=function(a){a=a||{},this.dir={x:a.x||0,y:a.y||0,z:a.z||0,angle:a.angle||0},this._updatePosition()},Human.view.clip.Plane.prototype._setRange=function(a){a=a||{},this.range={min:a.min||0,max:a.max||0},this._updatePosition()},Human.view.clip.Plane.prototype._setProgress=function(a){this.progress!==a&&(0>a?(a=0,this._setClipping(!1)):a>1?(a=1,this._setClipping(!1)):this._setClipping(!0),this.progress=a,this._updatePosition())},Human.view.clip.Plane.prototype._setSize=function(a){a=a||{},this.size={x:a.x||10,y:a.y||10},this._updatePosition()},Human.view.clip.Plane.prototype._setVisible=function(a){if(this.framesUntilHide=a?1:0,this.visible!==a){var b=this.indicatorFlagsNode.get("flags");b.enabled=a,this.indicatorFlagsNode.set("flags",b),this.visible=a}},Human.view.clip.Plane.prototype._setMode=function(a){this.mode!==a&&(this.mode=a,this._onUpdate(this))},Human.view.clip.Plane.prototype._setClipping=function(a){this.clipping!==a&&(this.clipping=a,this._onUpdate(this))}}(),function(){"use strict";Human.rpc.define("clip.set",function(a){if(a.clips){var b,c=a.clips;for(var d in c)c.hasOwnProperty(d)&&(b=c[d],b.clipId=d,Human.view.clip.setClip(b))}else a.clip&&Human.view.clip.setClip(a.clip)}),Human.rpc.define("clip.reset",function(){Human.view.clip.reset()})}(),function(){"use strict";var a,b=Human.view.spinner={};b.shown=!1,Human.events.on("loaded",function(){var b="human-embed-progress",c="Images/large-loader.gif";if(a=document.getElementById(b),null===a||void 0===a){a=new Image,a.id=b,a.src=c,a.alt="Loading...";var d={display:"none",position:"absolute",top:"50%",left:"50%",zIndex:"1001",width:"64px",height:"64px",marginLeft:"-32px",marginTop:"-32px"};for(var e in d)d.hasOwnProperty(e)&&(a.style[e]=d[e]);document.body.appendChild(a)}}),b.setShown=function(c){b.shown!==c&&a&&(a.style.display=c?"inline-block":"none")}}(),function(){"use strict";function a(){var a=Human.renderer.getScene();a.getNode("lights",function(c){a.getNode("lights.subtree",function(d){d.disconnect(),c.removeNodes();var e,f,g=[];for(f in b.lights)b.lights.hasOwnProperty(f)&&(e=b.lights[f],e.enabled&&e.params&&g.push(e.params||{}));var h=c.addNode({type:"lights",lights:g.slice(0),nodes:[{id:"lightsSubTree"}]}),i=0;for(f in b.lights)b.lights.hasOwnProperty(f)&&(e=b.lights[f],e.node=h,e.index=i++);a.getNode("lightsSubTree",function(a){a.addNode(d),Human.renderer.forceRenderFrame()})})}),c=!1}var b=Human.view.lights={};b.lights={};var c=!1;Human.events.on("loaded",function(){b.addLight({lightId:"light0",enabled:!0,displayName:"Default ambient",description:"Default ambient light source",params:{mode:"ambient",color:{r:.15,g:.15,b:.15},diffuse:!0}}),b.addLight({lightId:"light2",enabled:!0,displayName:"Default directional",description:"Default directional light source",params:{mode:"dir",color:{r:1.3,g:1.3,b:1.2},dir:{x:-1,y:0,z:1},diffuse:!0,specular:!0,space:"view"}}),b.addLight({lightId:"light3",enabled:!0,displayName:"Default directional",description:"Default directional light source",params:{mode:"dir",color:{r:.5,g:.5,b:.5},dir:{x:1.1,y:0,z:1},diffuse:!0,specular:!0,space:"view"}}),b.addLight({lightId:"light4",enabled:!0,displayName:"Default directional",description:"Default directional light source",params:{mode:"dir",color:{r:1.1,g:1.1,b:1.05},dir:{x:-.05,y:0,z:-1},diffuse:!0,specular:!0,space:"view"}})}),Human.events.on("tick",function(){c&&a()}),b.addLight=function(a){var d=new Human.view.lights.Light(a);b.lights[a.lightId]=d,d.on("enabled",function(){c=!0}),c=!0},b.removeLight=function(a){b.lights[a]&&(delete b.lights[a],c=!0)},b.removeAllLights=function(){b.lights={},c=!0},b.setEnabled=function(a){a.replace&&b.clearEnabled();var d,e;if(a.lightId){if(d=a.lightId,e=b.lights[d],!e)return void Human.log.error("Human.view.lights.setEnabled","Light not found: "+d);e.enabled=!!a.enable}else if(a.lights){var f,g=a.lights;for(d in g)if(g.hasOwnProperty(d)){if(e=b.lights[d],!e){Human.log.error("Human.view.lights.setEnabled","Light not found: "+d);continue}f=g[d],e.enabled=!!f,f&&"boolean"!=typeof f&&e.setParams(f)}}c=!0},b.clearEnabled=function(){for(var a in b.lights)b.lights.hasOwnProperty(a)&&b.lights[a].setEnabled(!1);c=!0},b.setParams=function(a){var c;for(var d in a)if(a.hasOwnProperty(d)){if(c=b.lights[d],!c){Human.log.error("Human.view.lights.setParams","Light not found: "+d);continue}c.setParams(a[d])}}}(),function(){"use strict";Human.view.lights.Light=function(a){this._init(),this.displayName=a.displayName,this.description=a.description,this.lightId=a.lightId,this.enabled=!!a.enabled,this.params=a.params||{},this.node=null,this.index=0},Human.utils.extend(Human.view.lights.Light,Human.Component),Human.view.lights.Light.prototype.setEnabled=function(a){this.publish("enabled",this.enabled=a)},Human.view.lights.Light.prototype.setParams=function(a){if(Human.utils.apply(a,this.params),this.node){var b={};b[""+this.index]=a,this.node.setLights(b)}}}(),function(){"use strict";Human.view.lights.loader=new Human.utils.Loader,Human.view.lights.loader._loadedStack=[],Human.view.lights.loader.load=function(a,b,c,d,e,f){var g,h=c,i=b+"."+c,j=this;Human.net.getLightsLibrary(h,function(a){var c=a.lights;if(!c)return Human.log.error("Human.view.lights.loader.load","'lights' section expected in lights library"),void e();Human.view.lights.clearEnabled();for(var d={modelId:b,lights:[]},f=0,h=c.length;h>f;f++)g=c[f],g.lightId?(g.lightId=i+"."+g.lightId,g.enabled=!0,d.lights.push(g),Human.view.lights.addLight(g)):Human.log.error("Human.view.lights.loader.load","'lightId' missing on light");j._loadedStack.push(d),e()},function(a){f("failed to load manifest file for lights module '"+h+"': "+a.errorText+" - status: "+a.request.status)})},Human.view.lights.loader.unload=function(a){var b,c,d,e,f;for(e=0,f=this._loadedStack.length;f>e;e++)this._loadedStack[e].modelId===a&&(b=this._loadedStack[e].lights,this._loadedStack.splice(e));if(!b)return void Human.log.warn("Human.view.lights.loader.unload","Failed to unload lights for model: "+a+" - not found");for(e=0,f=b.length;f>e;e++)Human.view.lights.removeLight(b[e].lightId);if(this._loadedStack.length>0){for(c=this._loadedStack[this._loadedStack.length-1].lights,d={},e=0,f=c.length;f>e;e++)d[c[e].lightId]=!0;Human.view.lights.setEnabled({lights:d,replace:!0})}else{c=Human.view.lights.lights,d={};for(var g in c)c.hasOwnProperty(g)&&(d[g]=!0);Human.view.lights.setEnabled({lights:d,replace:!0})}}}(),function(){"use strict";Human.rpc.define("lights.getLights",function(){var a,b=[],c=Human.view.lights.lights;for(var d in c)c.hasOwnProperty(d)&&(a=c[d],b.push({lightId:d,displayName:a.displayName,description:a.description,enabled:a.enabled,params:a.params}));this.setResult(b)}),Human.rpc.define("lights.setEnabled",function(a){Human.view.lights.setEnabled(a)}),Human.rpc.define("lights.setParams",function(a){Human.view.lights.setParams(a)})}(),function(){"use strict";function a(){var a=Human.renderer.getScene();a.getNode("effect",function(d){a.getNode("effect.subtree",function(e){e.disconnect(),d.removeNodes();for(var f,g={nodes:[]},h=g,i=0,j=c.pipeline.length;j>i;i++)if(f=c.pipeline[i],f.enabled){var k=Human.utils.applyIf(f.params,{type:f.type,id:"__effects."+f.effectId,nodes:[]});h.nodes.push(k),h=k,a.getNode("__effects."+f.effectId,b(f))}else f.node=null;h.nodes.push({id:"effectsSubTree"}),d.addNode(g),a.getNode("effectsSubTree",function(a){a.addNode(e),Human.renderer.forceRenderFrame()})})}),d=!1}function b(a){return function(b){a.node=b}}var c=Human.view.effects={};c.pipeline=[],c.effects={};var d=!1;Human.events.on("loaded",function(){c.addEffect({effectId:"dof",type:"postprocess/dof",displayName:"Depth-of-field",description:"Simulates photographic depth-of-field",params:{texelSize:22e-5,blurCoeff:.0084,ppm:1e4,autofocus:!0}}),c.addEffect({effectId:"sepia",type:"postprocess/sepia",displayName:"Sepia",description:"Sepia color filter"}),c.addEffect({effectId:"scanlines",type:"postprocess/scanlines",displayName:"Scanlines",description:"Scan lines pattern"}),c.addEffect({effectId:"filmGrain",type:"postprocess/filmGrain",displayName:"Film Grain",description:"Film grain noise"}),c.addEffect({effectId:"technicolor",type:"postprocess/technicolor",displayName:"Technicolor",description:"Technicolor color filter"}),c.addEffect({effectId:"oculusRift",type:"effects/oculusRift",displayName:"Oculus Rift",description:"View using Oculus Rift",params:{eyeSep:20.6,focalLength:27}}),c.addEffect({effectId:"stereo",type:"effects/stereo",displayName:"Stereo",description:"View in stereo"}),c.addEffect({effectId:"anaglyph",type:"effects/anaglyph",displayName:"Anaglyph 3D",description:"View in Anaglyph 3D"})}),Human.events.on("tick",function(){d&&a()}),c.addEffect=function(a){var b=new Human.view.effects.Effect(a);c.effects[a.effectId]=b,c.pipeline.unshift(b),b.on("enabled",function(){d=!0}),d=!0},c.setEnabled=function(a){var b;if(a.replace)for(var e=0,f=c.pipeline.length;f>e;e++)c.pipeline[e].enabled=!1;var g;if(a.effectId){if(b=a.effectId,g=c.effects[b],!g)return void Human.log.error("Human.view.effects.setEnabled","Effect not found: "+b);g.enabled=!!a.enable}else if(a.effectIds){var h,i=a.effectIds;for(b in i)if(i.hasOwnProperty(b)){if(g=c.effects[b],!g){Human.log.error("Human.view.effects.setEnabled","Effect not found: "+b);continue}h=i[b],g.enabled=!!h,h&&"boolean"!=typeof h&&g.setParams(h)}}d=!0},c.clearEnabled=function(){for(var a=0,b=c.pipeline.length;b>a;a++)c.pipeline[a].enabled=!1;d=!0},c.setParams=function(a){var b;for(var d in a)if(a.hasOwnProperty(d)){if(b=c.effects[d],!b){Human.log.error("Human.view.effects.setParams","Effect not found: "+d);continue}b.setParams(a[d])}}}(),function(){"use strict";Human.view.effects.Effect=function(a){this._init(),this.effectId=a.effectId,this.type=a.type,this.displayName=a.displayName,this.description=a.description,this.enabled=!1,this.params=a.params||{},this.node=null},Human.utils.extend(Human.view.effects.Effect,Human.Component),Human.view.effects.Effect.prototype.setEnabled=function(a){this.publish("enabled",this.enabled=a)},Human.view.effects.Effect.prototype.setParams=function(a){Human.utils.apply(a,this.params),this.node&&this.node.set(a)}}(),function(){"use strict";Human.rpc.define("effects.getEffects",function(){var a,b=[],c=Human.view.effects.effects;for(var d in c)c.hasOwnProperty(d)&&(a=c[d],b.push({effectId:d,displayName:a.displayName,description:a.description,enabled:a.enabled,params:a.params}));this.setResult(b)}),Human.rpc.define("effects.setEnabled",function(a){Human.view.effects.setEnabled(a)}),Human.rpc.define("effects.setParams",function(a){Human.view.effects.setParams(a)})}(),function(){"use strict";function a(){k=0;var a,b,c,d,e,f={x:!1,y:!1,z:!1};l=0,m=0,n=0;for(a in Human.scene.enabledObjects)Human.scene.enabledObjects.hasOwnProperty(a)&&(b=Human.scene.enabledObjects[a],0===b.objects.length&&(g[k]=b,c=h[k],c?(c.x=b.translate.x,c.y=b.translate.y,c.z=b.translate.z):c=h[k]={x:b.translate.x,y:b.translate.y,z:b.translate.z},d=b.getCenter(),l+=d[0],m+=d[1],n+=d[2],i[k]=d,k++));if(k>0){l/=k,m/=k,n/=k;for(var o=0;k>o;o++)d=i[o],b=g[o],b.parent.getNegatedAxes(f),e=Human.math.normalizeVec3([d[0]-l,d[1]-m,d[2]-n],j[o]),f.x&&(e[0]*=-1),f.y&&(e[1]*=-1),f.z&&(e[2]*=-1),j[o]=e}r=!1}var b,c,d,e=Human.view.explode={},f=.5,g=[],h=[],i=[],j=[],k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=!0,s=0,t=1,u=2,v=s,w=!1;Human.events.on("scene.objectsShown",function(){e.reset()}),Human.events.on("timeline.played",function(){(v===t||v===u)&&e.reset()}),Human.events.on("timeline.scrubbed",function(){(v===t||v===u)&&e.reset()}),Human.events.on("tick",function(e){if(w){r&&a();var i=.001*(e.timeNow-e.timeLast),l=i*f,m=0>b-o?-1:1,n=0>c-p?-1:1,t=0>d-q?-1:1;o+=l*m,p+=l*n,q+=l*t;var x=0,y=0;m>0&&o>b&&(o=b,x++),0>m&&0>o&&(o=0,y++),n>0&&p>c&&(p=c,x++),0>n&&0>p&&(p=0,y++),t>0&&q>d&&(q=d,x++),0>t&&0>q&&(q=0,y++),3===x?(v=u,w=!1):3===y&&(v=s,w=!1);for(var z,A,B=0;k>B;B++)z=h[B],A=j[B],g[B].setTransform({translate:{x:z.x+A[0]*o,y:z.y+A[1]*p,z:z.z+A[2]*q}});Human.events.fire("explode.updated",{scale:Math.round((o+p+q)/3),speed:f})}}),e.explode=function(a){a=a||{};var e=a.scale;Human.utils.isArray(e)?(b=e[0],c=e[1],d=e[2]):(e=e||0,0>e&&(e=0),b=e,c=e,d=e),0>b&&(b=0),0>c&&(c=0),0>d&&(d=0),f=a.speed||1,0>f&&(f=1),Human.timeline.stop(),v=t,w=!0},e.reset=function(){o=0,p=0,q=0,b=0,c=0,d=0,k&&this._resetPositions(),v=s,k=0,r=!0,w=!1,Human.events.fire("explode.reseted",{scale:0,speed:f})},e._resetPositions=function(){for(var a,b=0;k>b;b++)a=h[b],g[b].setTransform({translate:a})}}(),function(){"use strict";var a=Human.view.skyboxes={},b=a.skyboxes={},c=a.libraries={};a.exportedSkyboxIds={};var d,e=null;Human.events.on("loaded",function(){d=Human.renderer.getNode("skybox-container")}),Human.properties.subscribe({propId:"skyboxes.initialSkybox",callback:function(b){if(b&&Human.utils.isString(b)){var c=b;a.activateSkybox(c)}}}),a.exportSkyboxes=function(b){a.exportedSkyboxIds=b||{}},a.createLibrary=function(a){return c[a]?void Human.log.warn("Human.assets.skyboxes.createLibrary","Skybox library already exists: "+a):void(c[a]={skyboxes:{}})},a.createSkybox=function(a,d,e){var f=c[a];if(!f)return void Human.log.error("Human.assets.skyboxes.createSkybox","Skybox library not found: "+a);if(b[d])return void Human.log.warn("Human.assets.skyboxes.createSkybox","Skybox already exists: "+d);var g={node:{type:"skybox",src:e.src,size:e.size||5e3}};b[d]=g,f.skyboxes[d]=g},a.activateSkybox=function(a){if(!a)return void this.deactivateSkybox();if(a=this.exportedSkyboxIds[a]||a,!e||e.skyboxId!==a){var b=this.skyboxes[a];if(!b)return void Human.log.warn("Human.view.skyboxes.activateSkybox","Skybox not found: "+a);this.deactivateSkybox();var c=b.node;b._node=d.addNode(c),e=b}},a.deactivateSkybox=function(){e&&(e._node&&(e._node.destroy(),e._node=null),e=null)},a.destroyLibrary=function(b){if(!b)return void a.reset();var d=c[b];if(!d)return void Human.log.warn("Human.assets.skyboxes.destroyLibrary","Skybox library not found: "+b);for(var f in d.skyboxes)d.skyboxes.hasOwnProperty(f)&&(e&&e.skyboxId===f&&a.deactivateSkybox(),d.skyboxes[f].node.destroy());delete c[b]},a.reset=function(){for(var b in c)c.hasOwnProperty(b)&&a.destroyLibrary(b)}}(),function(){"use strict";Human.view.skyboxes.loader=new Human.utils.Loader,Human.view.skyboxes.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c;Human.net.getSkyboxesLibrary(g,function(a){Human.view.skyboxes.createLibrary(h);var b,c,d=Human.net.getSkyboxesDir(g);for(var f in a)if(a.hasOwnProperty(f)){if(b=a[f],c=b.src,!c){Human.log.error("Human.view.skyboxes.loader","Skybox property missing: src");continue}b.src=d+c.substring(c.lastIndexOf("/")+1)+"?v="+Human.VERSION,Human.view.skyboxes.createSkybox(h,h+"."+f,b)}e()},function(a){f("failed to load manifest file for skyboxes library '"+g+"': "+a)})},Human.view.skyboxes.loader._unload=function(a){Human.view.skyboxes.destroyLibrary(a)}}(),function(){"use strict";function a(a){$(a.target).is("canvas")&&(a.stopPropagation(),a.preventDefault())}function b(a){var b={x:0,y:0};if(a){for(var c=a.target,d=0,e=0;c.offsetParent;)d+=c.offsetLeft,e+=c.offsetTop,c=c.offsetParent;b.x=a.pageX-d,b.y=a.pageY-e}else a=window.event,b.x=a.x,b.y=a.y;return b}function c(a){a.preventDefault(),a.stopPropagation();var b=[],c=!1,d=!1,e=0,f=0,g=0,h=0,i=0,j=a.touches,k=a.changedTouches,l=I.getCoordiantes(j);N=l;var m,n=Date.now(),o=function(){return{touches:l,xDelta:e,yDelta:f,distanceX:T,distanceY:U,elapse:g,xSpeed:h,ySpeed:i}},p=function(a,b){b=b||o();for(var c=0;c<a.length;c++)a[c](b)};if("touchmove"===a.type&&P){var q=n-P;if(25>=q)return}switch(a.type){case"touchstart":W=1===a.touches.length&&1===k.length,W?(G=n,P=null):G=null,H=n,P=2===j.length?n:null,M.length=0,M=M.concat(l),Q=l[0],R=l[0];var B=l.length>1;B?S=l:(b.push(r),S=[]);break;case"touchmove":var C=2===l.length&&2===S.length;if(C){P=n;var D=Math.abs(S[0].x-S[1].x),E=Math.abs(S[0].y-S[1].y),F=Math.abs(l[0].x-l[1].x),J=Math.abs(l[0].y-l[1].y),K=l[0].x-S[0].x,L=l[0].y-S[0].y,X=l[1].x-S[1].x,Y=l[1].y-S[1].y;e=(K+X)/2,f=(L+Y)/2,T=Math.abs(l[0].x-l[1].x),U=Math.abs(l[0].y-l[1].y);var Z=Math.sqrt(Math.pow(D,2)+Math.pow(E,2)),$=Math.sqrt(Math.pow(F,2)+Math.pow(J,2)),_=Math.abs(Z-$);V=5>=_;var aa=0>K&&X>0||K>0&&0>X,ba=0>L&&Y>0||L>0&&0>Y;V?(e=(K+X)/2,f=(L+Y)/2,b.push(v)):(aa||ba)&&(D>F&&E>J?b.push(t):F>D&&J>E&&b.push(u)),S=l.concat([])}else{if(e=l[0].x-R.x,f=l[0].y-R.y,P){var ca=n-P;ca>250&&b.push(s)}else b.push(s);S=[],P=null}R=l[0];break;case"touchend":W=W&&0===a.touches.length&&1===k.length,c=!1,d=!1,W?(c=z>n-G,c&&(O&&(d=A>G-O),d||(O=n))):(c=!1,d=!1,G=null,O=null),g=n-H,S.length<=1&&b.push(w),e=R.x-Q.x,f=R.y-Q.y,h=Math.abs(e)/g,i=Math.abs(f)/g}for(m=0;m<b.length;m++)for(var da=b[m],ea=0;ea<da.length;ea++)p(da);if(c||d){var fa=o();fa.touches=M,c&&p(x,fa),d&&p(y,fa)}}var d=Human.input={},e=$("#annotationCanvas"),f=[],g=[],h={},i={},j=[],k=[],l=[],m=[],n=[],o=[],p=[],q=!0,r=[],s=[],t=[],u=[],v=[],w=[],x=[],y=[],z=250,A=325,B=jQuery(document);B.ready(function(){B.bind("contextmenu",function(a){return"snapshotPanelImage"!==a.target.id&&"input"!==a.target.type&&"email"!==a.target.type&&"text"!==a.target.type&&"textarea"!==a.target.type?!1:void 0})});var C={altDown:!1,ctrlDown:!1,keyDown:[],onTick:function(a){g.push(a)},onKeyDown:function(a,b){for(var c,d=0,e=a.length;e>d;d++)c=a[d],(h[c]||(h[c]=[])).push(b)},onKeyUp:function(a,b){for(var c,d=0,e=a.length;e>d;d++)c=a[d],(i[c]||(i[c]=[])).push(b)},onMouseDown:function(a){j.push(a)},onMouseUp:function(a){k.push(a)},onMouseClick:function(a){l.push(a)},onMouseDoubleClick:function(a){m.push(a)},onMouseMove:function(a){n.push(a)},onMouseWheel:function(a){o.push(a)},onReset:function(a){p.push(a)},onTouchStart:function(a){r.push(a)},onTouchMove:function(a){s.push(a)},onTouchEnd:function(a){w.push(a)},onTouchTap:function(a){x.push(a)},onTouchDoubleTap:function(a){y.push(a)},onTouchPinch:function(a){t.push(a)},onTouchZoom:function(a){u.push(a)},onTouchPan:function(a){v.push(a)}},D=null;Human.events.on("tick",function(){if(!q)return void(D=null);var a=Date.now()/1e3;if(null!==D)for(var b=a-D,c=0,d=g.length;d>c;c++)g[c](a,b);D=a});var E=0;Human.events.on("processes.started",function(){1===++E&&d.setEnabled(!1)}),Human.events.on("processes.finished",function(){0===--E&&d.setEnabled(!0)}),Human.events.on("processes.failed",function(){0===--E&&d.setEnabled(!0)}),document.addEventListener("keydown",function(a){if(q&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName){C.ctrlDown=a.ctrlKey||17===a.keyCode||a.metaKey,
C.altDown=a.altKey||18===a.keyCode,C.keyDown[a.keyCode]=!0;var b=a.keyCode,c=h[b];if(c)for(var d=0,e=c.length;e>d;d++)c[d](b)}},!0),document.addEventListener("keyup",function(a){if(q&&"INPUT"!==a.target.tagName&&"TEXTAREA"!==a.target.tagName){(a.ctrlKey||17===a.keyCode)&&(C.ctrlDown=!1),(a.altKey||18===a.keyCode)&&(C.altDown=!1),C.keyDown[a.keyCode]=!1;var b=a.keyCode,c=i[b];if(c)for(var d=0,e=c.length;e>d;d++)c[d](b)}}),e.mousedown(function(a){switch(a.which){case 1:C.mouseDownLeft=!0;break;case 2:C.mouseDownMiddle=!0;break;case 3:C.mouseDownRight=!0}var c=b(a);C.mouseDownX=c.x,C.mouseDownY=c.y;for(var d=c.x,e=c.y,f=0,g=j.length;g>f;f++)j[f](d,e)}),e.mouseup(function(a){switch(a.which){case 1:C.mouseDownLeft=!1;break;case 2:C.mouseDownMiddle=!1;break;case 3:C.mouseDownRight=!1}for(var c=b(a),d=c.x,e=c.y,f=0,g=k.length;g>f;f++)k[f](d,e)}),e.click(function(a){for(var c=b(a),d=c.x,e=c.y,f=0,g=l.length;g>f;f++)l[f](d,e)}),e.dblclick(function(a){switch(a.which){case 1:C.mouseDownLeft=!1,C.mouseDownRight=!1;break;case 2:C.mouseDownMiddle=!1;break;case 3:C.mouseDownLeft=!1,C.mouseDownRight=!1}for(var c=b(a),d=c.x,e=c.y,f=0,g=m.length;g>f;f++)m[f](d,e)}),e.mousemove(function(a){for(var c=b(a),d=c.x,e=c.y,f=0,g=n.length;g>f;f++)n[f](d,e)}),e.bind("mousewheel",function(a,b){for(var c=0,d=o.length;d>c;c++)o[c](a,b)}),Human.properties.subscribe({propId:"ui.mouseWheel.capture",value:!0,callback:function(b){B[b?"on":"off"]("mousewheel.capture",a)}});var F={EVENTS:"mousedown mouseup keydown keypress",handler:function(){return!1},block:function(){$('<div class="block-ui"></div>').css({position:"absolute",top:0,left:0,width:"100%",height:"100%","z-index":1e3}).appendTo("body"),B.on(this.EVENTS,this.handler)},unblock:function(){$("body > .block-ui").remove(),B.off(this.EVENTS,this.handler)}};d.addHandler=function(a){f.push(new a(C))},d.setEnabled=function(a){q!==a&&(a?F.unblock():F.block(),q=a,Human.events.fire(a?"inputEnabled":"inputDisabled",{}))};var G,H,I=Human.input.touch={},J=!1,K=["touchstart","touchmove","touchend"],L="container",M=[],N=[],O=null,P=null,Q=null,R=null,S=[],T=0,U=0,V=!1;I.isSupported=function(){return"ontouchstart"in window},I.setEnabled=function(a){a===!0?J!==!0&&I._bindHandlers():J===!0&&I._unbindHandlers(),J=a===!0},I._getTouchContainer=function(){return document.getElementById(L)};var W=!1;I._bindHandlers=function(){var a=I._getTouchContainer();if(a){I._unbindHandlers();for(var b=0;b<K.length;b++)a.addEventListener(K[b],c,!1)}},I._unbindHandlers=function(){var a=I._getTouchContainer();if(a)for(var b=0;b<K.length;b++)a.removeEventListener(K[b],c,!1)},I.getCoordiantes=function(a){for(var b=[],c=0,d=a.length;d>c;c++){var e=a[c];b.push({x:e.pageX,y:e.pageY})}return b};var X=I.isSupported();I.setEnabled(X),d.KEY_BACKSPACE=8,d.KEY_TAB=9,d.KEY_ENTER=13,d.KEY_SHIFT=16,d.KEY_CTRL=17,d.KEY_ALT=18,d.KEY_PAUSE_BREAK=19,d.KEY_CAPS_LOCK=20,d.KEY_ESCAPE=27,d.KEY_PAGE_UP=33,d.KEY_PAGE_DOWN=34,d.KEY_END=35,d.KEY_HOME=36,d.KEY_LEFT_ARROW=37,d.KEY_UP_ARROW=38,d.KEY_RIGHT_ARROW=39,d.KEY_DOWN_ARROW=40,d.KEY_INSERT=45,d.KEY_DELETE=46,d.KEY_NUM_0=48,d.KEY_NUM_1=49,d.KEY_NUM_2=50,d.KEY_NUM_3=51,d.KEY_NUM_4=52,d.KEY_NUM_5=53,d.KEY_NUM_6=54,d.KEY_NUM_7=55,d.KEY_NUM_8=56,d.KEY_NUM_9=57,d.KEY_A=65,d.KEY_B=66,d.KEY_C=67,d.KEY_D=68,d.KEY_E=69,d.KEY_F=70,d.KEY_G=71,d.KEY_H=72,d.KEY_I=73,d.KEY_J=74,d.KEY_K=75,d.KEY_L=76,d.KEY_M=77,d.KEY_N=78,d.KEY_O=79,d.KEY_P=80,d.KEY_Q=81,d.KEY_R=82,d.KEY_S=83,d.KEY_T=84,d.KEY_U=85,d.KEY_V=86,d.KEY_W=87,d.KEY_X=88,d.KEY_Y=89,d.KEY_Z=90,d.KEY_LEFT_WINDOW=91,d.KEY_RIGHT_WINDOW=92,d.KEY_SELECT_KEY=93,d.KEY_NUMPAD_0=96,d.KEY_NUMPAD_1=97,d.KEY_NUMPAD_2=98,d.KEY_NUMPAD_3=99,d.KEY_NUMPAD_4=100,d.KEY_NUMPAD_5=101,d.KEY_NUMPAD_6=102,d.KEY_NUMPAD_7=103,d.KEY_NUMPAD_8=104,d.KEY_NUMPAD_9=105,d.KEY_MULTIPLY=106,d.KEY_ADD=107,d.KEY_SUBTRACT=109,d.KEY_DECIMAL_POINT=110,d.KEY_DIVIDE=111,d.KEY_F1=112,d.KEY_F2=113,d.KEY_F3=114,d.KEY_F4=115,d.KEY_F5=116,d.KEY_F6=117,d.KEY_F7=118,d.KEY_F8=119,d.KEY_F9=120,d.KEY_F10=121,d.KEY_F11=122,d.KEY_F12=123,d.KEY_NUM_LOCK=144,d.KEY_SCROLL_LOCK=145,d.KEY_SEMI_COLON=186,d.KEY_EQUAL_SIGN=187,d.KEY_COMMA=188,d.KEY_DASH=189,d.KEY_PERIOD=190,d.KEY_FORWARD_SLASH=191,d.KEY_GRAVE_ACCENT=192,d.KEY_OPEN_BRACKET=219,d.KEY_BACK_SLASH=220,d.KEY_CLOSE_BRAKET=221,d.KEY_SINGLE_QUOTE=222,d.KEY_SPACE=32}(),function(){"use strict";Human.rpc.define("input.disable",function(){Human.input.setEnabled()}),Human.rpc.define("input.enable",function(){Human.input.setEnabled(!0)})}(),Human.input.addHandler(function(a){"use strict";function b(a,b,c,d){g&&(void 0!==l&&g.clearRect(l,m,n,o),g.clearRect(0,0,f.width,f.height),p(a,b,5,"rgb(255, 255, 255)"),p(a,b,2,"rgb(153,0,0)"),a!==c&&b!==d&&(g.beginPath(),g.moveTo(a,b),g.lineTo(c,d),g.lineWidth=1,g.strokeStyle="#ffffff",g.stroke(),l=a,m=b,n=c,o=d))}var c,d,e,f,g,h=!1,i=null,j=null,k=Human.view.annotations;Human.events.on("loaded",function(){return(f=document.getElementById("annotationCanvas"))?(g=f.getContext("2d"),g?void 0:void Human.log.warn("mouseDragging.js","Failed to get 2D canvas context")):void Human.log.warn("mouseDragging.js","DOM element not found: 'annotationCanvas'")}),a.onMouseClick(function(a,l){h?(d=e.name,c=Human.scene.objects[d],c&&Human.view.annotations.createAnnotation({objectId:d,title:"",description:"",pos:e.worldPos,dir:e.normal,primitiveIndex:e.primitiveIndex,barycentric:e.barycentric,enabled:!0,shown:!0,labelShown:!0,labelOffset:[a-e.canvasPos[0],l-e.canvasPos[1]-30],saved:!1}),g.clearRect(0,0,f.width,f.height),e=!1,h=!1):(i=a,j=l,k.enabled&&(e=Human.view.pick.queryPick({canvasX:a,canvasY:l,rayPick:!0}),e&&(d=e.name,c=Human.scene.objects[d],c&&(h=!0,b(a,l,a,l),e.objectId=d,e.pos=e.worldPos,Human.events.fire("annotations.pinning",e)))))}),a.onMouseMove(function(a,c){h&&b(i,j,a,c)});var l,m,n,o,p=function(a,b,c,d){g.fillStyle=d,g.beginPath(),g.arc(a,b,c,0,2*Math.PI),g.fill()}}),Human.input.addHandler(function(a){"use strict";var b=50,c=50;a.onTick(function(d,e){if(!a.ctrlDown&&!a.altDown){var f=a.keyDown[Human.input.KEY_LEFT_ARROW],g=a.keyDown[Human.input.KEY_RIGHT_ARROW],h=a.keyDown[Human.input.KEY_UP_ARROW],i=a.keyDown[Human.input.KEY_DOWN_ARROW];if(f||g||h||i){var j=0,k=0;g?j=-e*b:f&&(j=e*b),i?k=-(e*c):h&&(k=e*c),Math.abs(j)>Math.abs(k)?k=null:j=null,Human.view.camera.rotateY(j),Human.view.camera.rotateX(k),Human.view.mouseCursor.gotoRotate()}}}),a.onKeyUp([Human.input.KEY_UP_ARROW,Human.input.KEY_RIGHT_ARROW,Human.input.KEY_DOWN_ARROW,Human.input.KEY_LEFT_ARROW],function(){a.ctrlDown||a.altDown||Human.view.mouseCursor.gotoDefault()})}),Human.input.addHandler(function(a){"use strict";a.onKeyDown([Human.input.KEY_NUM_1,Human.input.KEY_NUM_2,Human.input.KEY_NUM_3,Human.input.KEY_NUM_4,Human.input.KEY_NUM_5,Human.input.KEY_NUM_6],function(b){if(!a.ctrlDown&&!a.altDown){var c=Human.view.camera;b===Human.input.KEY_NUM_1?c.viewAnterior():b===Human.input.KEY_NUM_2?c.viewPosterior():b===Human.input.KEY_NUM_3?c.viewRight():b===Human.input.KEY_NUM_4?c.viewLeft():b===Human.input.KEY_NUM_5?c.viewSuperior():b===Human.input.KEY_NUM_6&&c.viewInferior()}})}),Human.input.addHandler(function(a){"use strict";var b=10;a.onTick(function(c,d){if(!a.ctrlDown&&!a.altDown){var e=a.keyDown[Human.input.KEY_W],f=a.keyDown[Human.input.KEY_S],g=a.keyDown[Human.input.KEY_A],h=a.keyDown[Human.input.KEY_D];if(e||f||g||h){var i=0,j=0,k=0;f?j=d*b:e&&(j=-d*b),h?i=d*b:g&&(i=-d*b),Human.view.camera.pan({x:i,y:j,z:k})}}})}),Human.input.addHandler(function(a){"use strict";var b=3;a.onTick(function(c,d){if(!a.ctrlDown&&!a.altDown){var e=a.keyDown[Human.input.KEY_ADD]||a.keyDown[Human.input.KEY_EQUAL_SIGN],f=a.keyDown[Human.input.KEY_SUBTRACT]||a.keyDown[Human.input.KEY_DASH];if(e||f){var g=e?-(d*b):d*b;Human.view.camera.zoom(g)}}})}),function(){"use strict";var a=!0;Human.properties.subscribe({propId:"ui.zoom.mouseWheel.enabled",value:a,callback:function(b){a=!!b}}),Human.input.addHandler(function(b){var c,d=0,e=0,f=!1,g=!1,h=0,i=.2,j=Human.math.vec3(),k=Human.math.vec3(),l=Human.math.vec3(),m=!1;b.onKeyDown([Human.input.KEY_ALT],function(){m=!0}),b.onKeyUp([Human.input.KEY_ALT],function(){m=!1}),b.onMouseWheel(function(b,c){a&&(m||(d=-c,0===d?(g=!1,f=!1):f=!0))}),b.onTick(function(b){if(a){var m=Human.view.camera,n=m.eye,o=m.look;j[0]=n.x,j[1]=n.y,j[2]=n.z,k[0]=o.x,k[1]=o.y,k[2]=o.z,Human.math.subVec3(j,k,l);var p=Math.abs(Human.math.lenVec3(l)),q=m.maxZoom-m.minZoom,r=i*(2+p/q);f&&(e=d*r,h=0,f=!1,g=!0),g&&(d>0?(h+=.2*r,h>e&&(g=!1)):0>d&&(h-=.2*r,e>h&&(g=!1)),g&&Human.view.camera.zoom(h)),c=b}})})}(),Human.input.addHandler(function(a){"use strict";var b,c,d=.2,e=0,f=0,g=!1,h=Human.math.vec3(),i=Human.math.vec3(),j=Human.math.vec3();a.onMouseDown(function(d,e){!a.mouseDownLeft||a.mouseDownRight||a.keyDown[Human.input.KEY_SHIFT]?g=!1:(g=!0,b=d,c=e)}),a.onMouseUp(function(){g=a.mouseDownLeft&&!a.mouseDownRight}),a.onMouseMove(function(a,h){g&&(e+=(a-b)*d,f+=(h-c)*d,b=a,c=h)}),a.onTick(function(){if(Math.abs(e)>0||Math.abs(f)>0){var a=Human.view.camera,b=a.eye,c=a.look;h[0]=b.x,h[1]=b.y,h[2]=b.z,i[0]=c.x,i[1]=c.y,i[2]=c.z,Human.math.subVec3(h,i,j);var d=Math.abs(Human.math.lenVec3(j)),g=a.maxZoom-a.minZoom,k=1+d/g;Human.view.camera.rotateY(-e*k),Human.view.camera.rotateX(f*k),e=0,f=0}})}),Human.input.addHandler(function(a){"use strict";var b;Human.properties.subscribe({propId:"camera.zoomLimits",value:{min:.01,max:150},callback:function(a){b=a}});var c,d,e=.16,f=1,g=0,h=0,i=!1,j=Human.math.vec3(),k=Human.math.vec3(),l=Human.math.vec3();a.onMouseDown(function(b,e){a.mouseDownLeft&&a.mouseDownRight||a.mouseDownLeft&&a.keyDown[Human.input.KEY_SHIFT]||a.mouseDownMiddle?(i=!0,c=b,d=e):i=!1}),a.onMouseUp(function(){i=!1}),a.onMouseMove(function(a,b){if(i){var f=Human.view.camera,m=f.eye,n=f.look;j[0]=m.x,j[1]=m.y,j[2]=m.z,k[0]=n.x,k[1]=n.y,k[2]=n.z,Human.math.subVec3(j,k,l);var o=Math.abs(Human.math.lenVec3(l)),p=f.maxZoom-f.minZoom,q=e*(o/p);g+=(a-c)*q,h+=(b-d)*q,c=a,d=b}}),a.onTick(function(){(Math.abs(g)>0||Math.abs(h)>0)&&(Human.view.camera.pan({x:g*f,y:h*f}),g=0,h=0)})}),Human.input.addHandler(function(a){"use strict";function b(){f&&(clearTimeout(f),f=null),c=null,d=null,Human.view.pick.hoverOff()}var c=null,d=null,e=4,f=null,g=!1,h=500;Human.properties.subscribe({propId:"pick.hover.delay",value:h,callback:function(a){h=a}}),a.onReset(function(){b()}),a.onMouseMove(function(a,i){g||(null!==c&&(Math.abs(a-c)>e||Math.abs(i-d)>e?b():(f&&(clearTimeout(f),f=null),Human.view.pick.hoverOff(),f=setTimeout(function(){Human.view.pick.hoverPick({canvasX:a,canvasY:i}),clearTimeout(f),f=null,c=null,d=null},h))),c=a,d=i)}),a.onMouseDown(function(){b(),g=!0}),a.onMouseUp(function(a,b){c=a,d=b,g=!1})}),Human.input.addHandler(function(a){"use strict";var b,c,d=null,e=null,f=4,g=!1,h=!1,i=!1,j=!1,k=!1,l=!1,m=!1;a.onKeyDown([Human.input.KEY_SHIFT],function(b){if(!a.ctrlDown&&!a.CTRL)switch(b){case Human.input.KEY_SHIFT:Human.view.pick.setMultiPickEnabled(!0)}}),a.onKeyUp([Human.input.KEY_SHIFT],function(b){if(!a.ctrlDown&&!a.CTRL)switch(b){case Human.input.KEY_SHIFT:Human.view.pick.setSinglePickEnabled(!0)}}),a.onKeyDown([Human.input.KEY_SPACE],function(){k=!0}),a.onKeyUp([Human.input.KEY_SPACE],function(){k=!1}),a.onKeyDown([Human.input.KEY_CTRL],function(){l=!0}),a.onKeyUp([Human.input.KEY_CTRL],function(){l=!1}),a.onKeyDown([Human.input.KEY_R],function(){m=!0}),a.onKeyUp([Human.input.KEY_R],function(){m=!1}),a.onMouseDown(function(b,c){d=b,e=c,i=a.mouseDownLeft,j=a.mouseDownRight}),a.onMouseUp(function(a,h){Math.abs(d-a)<f&&Math.abs(e-h)<f&&(b=a,c=h,g=!0)}),a.onMouseDoubleClick(function(k,l){Math.abs(d-k)<f&&Math.abs(e-l)<f&&(b=k,c=l,g=!0,h=!0,i=a.mouseDownLeft,j=a.mouseDownRight)}),a.onTick(function(){if(g){var a={canvasX:b,canvasY:c,mouseDownLeft:i,mouseDownRight:j,spaceDown:k,ctrlDown:l,regionPick:m};h?Human.view.pick.doublePick(a):Human.view.pick.pick(a),g=!1,h=!1,d=null,e=null}})}),Human.input.addHandler(function(a){"use strict";a.onKeyDown([Human.input.KEY_R,Human.input.KEY_T,Human.input.KEY_I,Human.input.KEY_Y,Human.input.KEY_Z,Human.input.KEY_C],function(b){if(!a.ctrlDown&&!a.altDown)switch(b){case Human.input.KEY_R:Human.rpc.call(null,"highlight.setEnabled",{enable:!0});break;case Human.input.KEY_T:Human.rpc.call(null,"xray.setEnabled",{enable:!0});break;case Human.input.KEY_I:Human.rpc.call(null,"isolate.setEnabled",{enable:!0})}if(a.ctrlDown&&!a.altDown)switch(b){case Human.input.KEY_Y:Human.view.dissect.redo();break;case Human.input.KEY_Z:Human.view.dissect.undo();break;case Human.input.KEY_R:Human.init.reset();break;case Human.input.KEY_C:Human.rpc.call(null,"dissect.setEnabled",{enable:!0})}})}),Human.input.addHandler(function(a){"use strict";var b,c=10,d=null;a.onTick(function(e){if(!a.ctrlDown&&!a.altDown){var f=a.keyDown[Human.input.KEY_M],g=a.keyDown[Human.input.KEY_N];if(f||g){if(!Human.view.clip.selectedClip)return;if(b){var h,i=(e-b)/1e3;g?h=i*c:f&&(h=-i*c);var j=Human.view.clip.selectedClip;return j.shown||(d=j.clipId),Human.view.clip.setClip({state:Human.view.clip.Plane.STATE_VISIBLE,progress:j.progress+h}),!0}b=e}else b=null,d&&(Human.view.clip.setClip({clipId:d,state:Human.view.clip.Plane.STATE_CLIPPING}),d=null)}})}),Human.input.addHandler(function(a){"use strict";var b=!1;a.onKeyDown([Human.input.KEY_X],function(){!a.ctrlDown||a.altDown||b||(Human.view.dissect.setEnabled(!0),b=!0)}),a.onKeyUp([Human.input.KEY_X],function(){b&&(Human.view.dissect.setEnabled(!1),b=!1)})}),Human.input.addHandler(function(a){"use strict";a.onKeyDown([Human.input.KEY_R],function(){if(a.keyDown[Human.input.KEY_SHIFT]){var b="This will reset to the initial view. Are you sure you want to continue?";confirm(b)&&Human.init.reset()}})}),function(){"use strict";var a="true"===Human.request.getSearchParam("explode"),b=!1,c=0,d=0;Human.input.addHandler(function(e){e.onKeyDown([Human.input.KEY_ALT],function(){b=!0}),e.onKeyUp([Human.input.KEY_ALT],function(){b=!1}),e.onMouseWheel(function(e,f){if(a&&b){var g=.001*e.timeStamp;d=g,c+=1*f,0>c&&(c=0),Human.view.explode.explode({scale:c,speed:10})}})})}(),Human.input.addHandler(function(a){"use strict";var b=.2,c=.16,d=1,e=.1,f=Human.view.camera,g=Human.math.vec3(),h=Human.math.vec3(),i=Human.math.vec3();a.onTouchTap(function(a){var b=a.touches;Human.view.pick.pick({canvasX:b[0].x,canvasY:b[0].y})}),a.onTouchDoubleTap(function(a){var b=a.touches;Human.view.pick.doublePick({canvasX:b[0].x,canvasY:b[0].y})});var j=function(a,b){var c=Math.sqrt(Math.pow(a,2)+Math.pow(b,2));return c*e};a.onTouchPinch(function(a){var b=j(a.xDelta,a.yDelta);f.zoom(b)}),a.onTouchZoom(function(a){var b=j(a.xDelta,a.yDelta);f.zoom(-b)}),a.onTouchPan(function(a){var b=f.eye,e=f.look;g[0]=b.x,g[1]=b.y,g[2]=b.z,h[0]=e.x,h[1]=e.y,h[2]=e.z,Human.math.subVec3(g,h,i);var j=Math.abs(Human.math.lenVec3(i)),k=f.maxZoom-f.minZoom,l=c*(j/k),m=a.xDelta*l,n=a.yDelta*l;f.pan({x:m*d,y:n*d})}),a.onTouchMove(function(a){var c=a.xDelta*b,d=a.yDelta*b,e=a.touches.length>1;e||(f.rotateX(d),f.rotateY(-c))})}),function(){"use strict";var a=Human.scene={};a.checkTestStarted=!1,a.rootObjects=[],a.modelObjects={},a.objects={},a.objectsByFMAID={},a.objectsForTags={},a.numObjects=0,a._boundary=null,a.center=[0,0,0],a.enabledObjects={},a.selectedObjects={},a.transparentObjects={},a.pickThroughObjects={},a.desaturatedObjects={},a.backfaceObjects={},a.showSelectedObjects=!1,a.alwaysEnabledObjects={},a._leavesCache={},a.__createObject=function(b){if(!b.moduleId)return void Human.log.error("Scene.__createObject","Param expected: moduleId");if(!b.objectId)return void Human.log.error("Scene.__createObject","Param expected: objectId");if(a.objects[b.objectId])return void Human.log.error("Scene.__createObject","Param: objectId already in use");var c=b.parentObjectId?a.objects[b.parentObjectId]:null,d=b.modelId;b.tags=b.tags||[];var e=c?a._inheritTags(b.tags,c):b.tags;b.modelId=d,b.parent=c,b.attachNodeId=Human.CONTENT_ROOT_ID,b.level=c?c.level+1:0,b.tags=e;var f=new Human.scene.Object(b);return a.objects[b.objectId]=f,f.fmaId&&(a.objectsByFMAID[f.fmaId]=f),c?c.__addObject(f):a.rootObjects.push(f),(a.modelObjects[d]=a.modelObjects[d]||{})[b.objectId]=f,a._registerObjectForTags(f),a.numObjects++,a._boundary=null,Human.events.fire("scene.objectCreated",{moduleId:b.moduleId,modelId:d,objectId:f.objectId,name:f.displayName,description:f.description,displayName:f.displayName,fmaId:f.fmaId,tags:f.tags,parentObjectId:c?c.objectId:null}),f},a._inheritTags=function(a,b){var c,d,e=a||[],f=b.tags,g=[];if(e){for(var h=0,i=f.length;i>h;h++){d=f[h];for(var j=!0,k=0,l=e.length;l>k;k++)c=e[k],c===d&&(j=!1);j&&g.push(d)}return e.concat(g)}return e},a._registerObjectForTags=function(b){for(var c,d,e=b.tags,f=0,g=e.length;g>f;f++)c=e[f],d=a.objectsForTags[c],d||(d=a.objectsForTags[c]={}),d[b.objectId]=b},a._deregisterObjectForTags=function(b){for(var c,d,e=b.tags,f=0,g=e.length;g>f;f++)c=e[f],d=a.objectsForTags[c],d&&delete d[b.objectId]},a.getObject=function(b){var c=a.objects[b];return c||Human.log.error("Human.scene.getObject","Scene object not found: '"+b+"'"),c},a.setEnabledObjects=function(b){var c,d=b.objects||b.objectIds,e={},f={};if(b.replace)for(c in a.enabledObjects)a.enabledObjects.hasOwnProperty(c)&&(a.enabledObjects[c]._enabledSubObjects=0,delete a.enabledObjects[c],e[c]=!1,a.selectedObjects.hasOwnProperty(c)&&(a.selectedObjects[c]._selectedSubObjects=0,delete a.selectedObjects[c],f[c]=!1),a._updateObjectVisibility(c));a._getEnabledFlagsinSubtreeForObjectMap(d,e);for(c in e)e.hasOwnProperty(c)&&(e[c]?a.enabledObjects[c]||(a.enabledObjects[c]=a.objects[c],a._updateObjectVisibility(c),e[c]=!0):a.enabledObjects[c]&&(delete a.enabledObjects[c],a.selectedObjects[c]&&(f||(f={}),delete a.selectedObjects[c],f[c]=!1),a._updateObjectVisibility(c),e[c]=!1));Human.events.fire("scene.objectsShown",{enabledObjectsUpdate:e,showSelectedObjects:a.showSelectedObjects}),f&&Human.events.fire("scene.objectsSelected",{selectedObjectsUpdate:f,showSelectedObjects:a.showSelectedObjects})},a._getEnabledFlagsinSubtreeForObjectMap=function(b,c){for(var d,e,f=a._sortObjectIDsIntoLevelBuckets(b),g=0,h=f.length;h>g;g++)if(d=f[g])for(var i=0,j=d.length;j>i;i++)e=d[i],a._getEnabledFlags(e,!!b[e],c)},a._sortObjectIDsIntoLevelBuckets=function(b){var c,d,e,f,g=[];for(c in b)b.hasOwnProperty(c)&&(e=a.objects[c],e&&(f=e.level,d=g[f]||(g[f]=[]),d.push(c)));return g},a._getEnabledFlags=function(b,c,d){d=d||{};var e=a.objects[b];if(!e||e._destroyed)return d;for(var f=a._getEnabledFlagsInSubtreeForObject(b,c,d),g=e.parent;g;e=e.parent,g=g.parent)if(g&&c){if(g.parent){e._enabledSubObjects=e._enabledSubObjects||0;for(var h=0,i=0;i<g.objects.length;i++)g.objects[i].objectId!==e.objectId&&d[g.objects[i].objectId]&&h++;if(g._enabledSubObjects+h!==e._enabledSubObjects+1)break;a._updateAncestorSubObjects(g.parent,c)}}else g&&!c&&g.parent&&(e._enabledSubObjects=e._enabledSubObjects||0,g._enabledSubObjects===e._enabledSubObjects&&a._updateAncestorSubObjects(g.parent,c,f));return f},a._getEnabledFlagsInSubtreeForObject=function(b,c,d){var e=a.objects[b];if(!e||e._destroyed)return d;d[b]=c;for(var f=e.objects,g=0,h=f.length;h>g;g++)a._getEnabledFlagsInSubtreeForObject(f[g].objectId,c,d);var i=a.enabledObjects[b];if(e.parent)for(var j=e.parent;j;j=j.parent)(void 0===j._enabledSubObjects||null===j._enabledSubObjects)&&(j._enabledSubObjects=0),c?i||1===++j._enabledSubObjects&&(d[j.objectId]=!0):i&&0===--j._enabledSubObjects&&(d[j.objectId]=!1);return d},a._updateAncestorSubObjects=function(b,c,d){b&&c?(b._enabledSubObjects++,a._updateAncestorSubObjects(b.parent,c,d)):b&&!c&&(a.enabledObjects[b.objectId]&&0===--b._enabledSubObjects&&(d[b.objectId]=!1),a._updateAncestorSubObjects(b.parent,c,d))},a.setSelectedObjects=function(b){var c,d,e=b.objects||b.objectIds||{},f={};if(b.objectId){if(d=a.objects[b.objectId],!d)return void Human.log.error("Human.scene.setSelectedObjects","Scene object not found: '"+b.objectId+"'");var g=!!b.select;if(b.replace)for(c in a.selectedObjects)a.selectedObjects.hasOwnProperty(c)&&(d=a.selectedObjects[c],d._selectedSubObjects=0,delete a.selectedObjects[c],a.showSelectedObjects&&d.shown&&d.show(!1),f[c]=!1);a._getObjectSelectedFlagsInSubtree(b.objectId,g,f)}else{if(b.replace)for(c in a.selectedObjects)a.selectedObjects.hasOwnProperty(c)&&(d=a.selectedObjects[c],d._selectedSubObjects=0,d.selected&&d.select(!1),delete a.selectedObjects[c],f[c]=!1,a._updateObjectVisibility(c));a._getSelectedFlagsInSubtreeForObjectMap(e,f)}var h;for(c in f)if(f.hasOwnProperty(c))if(d=a.objects[c],f[c]){if(!a.selectedObjects[c]){a.selectedObjects[c]=d,a.enabledObjects[c]||(h||(h={}),h[c]=!0,a.enabledObjects[c]=d);var i=!!(a.showSelectedObjects?a.selectedObjects[c]:a.enabledObjects[c]);d.shown!==i&&d.show(i),d.selected||d.select(!0),f[c]=!0}}else a.selectedObjects[c]&&(delete a.selectedObjects[c],a._updateObjectVisibility(c),d.selected&&d.select(!1),f[c]=!1);h&&Human.events.fire("scene.objectsShown",{enabledObjectsUpdate:h,showSelectedObjects:a.showSelectedObjects}),Human.events.fire("scene.objectsSelected",{selectedObjectsUpdate:f,showSelectedObjects:a.showSelectedObjects})},a._getSelectedFlagsInSubtreeForObjectMap=function(b,c){for(var d,e,f=a._sortObjectIDsIntoLevelBuckets(b),g=0,h=f.length;h>g;g++)if(d=f[g])for(var i=0,j=d.length;j>i;i++)e=d[i],a._getObjectSelectedFlagsInSubtree(e,!!b[e],c)},a._getObjectSelectedFlagsInSubtree=function(b,c,d){d=d||{};var e=a.objects[b];if(!e||e._destroyed)return d;d[b]=c;var f=a.selectedObjects[b],g=a.enabledObjects[b];if(e.parent)for(var h=e.parent;h;h=h.parent)(void 0===h._enabledSubObjects||null===h._enabledSubObjects)&&(h._enabledSubObjects=0),(void 0===h._selectedSubObjects||null===h._selectedSubObjects)&&(h._selectedSubObjects=0),c?(f||1===++h._selectedSubObjects&&(d[h.objectId]=!0),g||h._enabledSubObjects++):f&&--h._selectedSubObjects<=0&&(h._selectedSubObjects=0,d[h.objectId]=!1);for(var i=e.objects,j=0,k=i.length;k>j;j++)a._getObjectSelectedFlagsInSubtree(i[j].objectId,c,d);return d},a.anySelected=function(b){var c;for(var d in a.selectedObjects)if(a.selectedObjects.hasOwnProperty(d)){if(c=a.selectedObjects[d],!b)return!0;if(0===c.numSubObjects)return!0}return!1},a.setShowSelectedObjects=function(b){a.showSelectedObjects=b;var c,d;for(var e in a.objects)a.objects.hasOwnProperty(e)&&(c=a.objects[e],d=!!(a.showSelectedObjects?a.selectedObjects[e]:a.enabledObjects[e]),c.shown!==d&&c.show(d))},a._updateObjectVisibility=function(b){var c=a.objects[b],d=!!(a.showSelectedObjects?a.selectedObjects[b]:a.enabledObjects[b]);c.shown!==d&&c.show(d)},a.setPickThroughObjects=function(b){var c,d=b.objects||b.objectIds||{};if(b.replace)for(c in a.pickThroughObjects)a.pickThroughObjects.hasOwnProperty(c)&&a.pickThroughObjects[c]&&(a.objects[c].setPickable(!0),delete a.pickThroughObjects[c]);for(c in d)d.hasOwnProperty(c)&&d[c]===!0&&a.objects[c]&&a._setPickThroughObjects(a.objects[c],d[c])},a._setPickThroughObjects=function(b,c){a.pickThroughObjects[b.objectId]=c,b.setPickable(!c);for(var d=b.objects,e=0,f=d.length;f>e;e++)a._setPickThroughObjects(d[e],c)},a.setTransparentObjects=function(b){var c,d=b.objectIds||{};if(b.replace)for(c in a.transparentObjects)a.transparentObjects.hasOwnProperty(c)&&a.transparentObjects[c]&&(a.objects[c].setTransparent(!1,!0,!0),delete a.transparentObjects[c]);for(c in d)d.hasOwnProperty(c)&&d[c]===!0&&a.objects[c]&&a._setTransparentObjects(a.objects[c],d[c])},a._setTransparentObjects=function(b,c){a.transparentObjects[b.objectId]=c,b.setTransparent(c,!0);for(var d=b.objects,e=0,f=d.length;f>e;e++)a._setTransparentObjects(d[e],c)},a.setDesaturatedObjects=function(b){var c,d=b.objects||b.objectIds||{};if(b.replace)for(c in a.desaturatedObjects)a.desaturatedObjects.hasOwnProperty(c)&&a.desaturatedObjects[c]&&(a.objects[c].setDesaturate(!1),delete a.desaturatedObjects[c]);for(c in d)d.hasOwnProperty(c)&&d[c]===!0&&a.objects[c]&&a._setDesaturatedObjects(a.objects[c],d[c])},a._setDesaturatedObjects=function(b,c){a.desaturatedObjects[b.objectId]=c,b.setDesaturate(c);for(var d=b.objects,e=0,f=d.length;f>e;e++)a._setDesaturatedObjects(d[e],c)},a.setBackfaceObjects=function(b){var c,d=b.objects||b.objectIds||{};if(b.replace)for(c in a.backfaceObjects)a.backfaceObjects.hasOwnProperty(c)&&a.backfaceObjects[c]&&(a.objects[c].setBackfaces(!1),delete a.backfaceObjects[c]);for(c in d)d.hasOwnProperty(c)&&d[c]===!0&&a.objects[c]&&a._setBackfaceObjects(a.objects[c],d[c])},a._setBackfaceObjects=function(b,c){a.backfaceObjects[b.objectId]=c,b.setTransparentBackfaces(c);for(var d=b.objects,e=0,f=d.length;f>e;e++)a._setBackfaceObjects(d[e],c)},a.setObjectGlassFactors=function(b){var c,d=b.objectIds||{};for(c in d)d.hasOwnProperty(c)&&a.objects[c]&&a._setObjectGlassFactors(a.objects[c],d[c])},a._setObjectGlassFactors=function(b,c){b.setGlassFactor(c,!0);for(var d=b.objects,e=0,f=d.length;f>e;e++)a._setObjectGlassFactors(d[e],c)},a.setObjectMurkiness=function(b){var c,d=b.objectIds||{};for(c in d)d.hasOwnProperty(c)&&a.objects[c]&&a._setObjectMurkiness(a.objects[c],d[c])},a._setObjectMurkiness=function(b,c){b.setMurkiness(c,!0);for(var d=b.objects,e=0,f=d.length;f>e;e++)a._setObjectMurkiness(d[e],c)},a.setObjectOpacities=function(b){var c,d=b.objectIds||{};for(c in d)d.hasOwnProperty(c)&&a.objects[c]&&a._setObjectOpacities(a.objects[c],d[c])},a._setObjectOpacities=function(b,c){b.setOpacity(c,!0);for(var d=b.objects,e=0,f=d.length;f>e;e++)a._setObjectOpacities(d[e],c)},a.getLeaves=function(b){var c=a._leavesCache[b];if(!c){c=[];var d=a.objects[b];d&&a._getLeaves([d],c),a._leavesCache[b]=c}return c},a._getLeaves=function(b,c){for(var d,e=0,f=b.length;f>e;e++)d=b[e],0===d.objects.length?c.push(d.objectId):a._getLeaves(d.objects,c)},a.getEnabledLeaves=function(b){var c=[],d=a.objects[b];return d&&a._getEnabledLeaves([d],c),c},a._getEnabledLeaves=function(b,c){for(var d,e=0,f=b.length;f>e;e++)d=b[e],0===d.objects.length?a.enabledObjects.hasOwnProperty(d.objectId)&&c.push(d.objectId):a._getEnabledLeaves(d.objects,c)},a._getKeys=function(a,b){var c={};for(var d in a)a.hasOwnProperty(d)&&(d[d]=b);return c},a._destroyObject=function(b){var c=a.objects[b];if(c&&!c._destroyed){var d,e,f;for(e=0,f=a.rootObjects.length;f>e;e++)if(a.rootObjects[e].objectId===b){a.rootObjects.splice(e,1);break}if(delete a.objects[b],c.fmaId&&delete a.objectsByFMAID[c.fmaId],a.enabledObjects[b])for(d=c.parent;d;d=d.parent)void 0!==d._enabledSubObjects&&null!==d._enabledSubObjects&&d._enabledSubObjects--;if(a.selectedObjects[b])for(d=c.parent;d;d=d.parent)void 0!==d._selectedSubObjects&&null!==d._selectedSubObjects&&d._selectedSubObjects--;delete a.selectedObjects[b],delete a.enabledObjects[b],delete a.transparentObjects[b],delete a.pickThroughObjects[b],delete a.desaturatedObjects[b],delete a.backfaceObjects[b],a.numObjects--,c.parent&&c.parent._removeObject(b);var g=c.objects.slice(0);for(e=0,f=g.length;f>e;e++)a._destroyObject(g[e].objectId);c._destroy(),c._destroyed=!0,delete a.modelObjects[c.modelId][c.objectId],a._deregisterObjectForTags(c),a._leavesCache={},a._boundary=null,Human.events.fire("scene.objectDestroyed",{objectId:b})}},a.getBoundary=function(b){b=b||{};var c;if(b.objectId)return c=Human.scene.objects[b.objectId],c?c.getBoundary():(Human.log.warn("Human.scene.getBoundary","Scene object not found: '"+b.objectId+"'"),this.getBoundary());a._boundary?(a._boundary.xmin=1e5,a._boundary.ymin=1e5,a._boundary.zmin=1e5,a._boundary.xmax=-1e5,a._boundary.ymax=-1e5,a._boundary.zmax=-1e5):a._boundary={xmin:1e5,ymin:1e5,zmin:1e5,xmax:-1e5,ymax:-1e5,zmax:-1e5};var d,e,f=a._boundary,g=!1;if(b.objectIds)for(var h=b.objectIds,i=0,j=h.length;j>i;i++)c=a.objects[h[i]],c&&0===c.objects.length&&(e=c.getBoundary(),e.xmin<f.xmin&&(f.xmin=e.xmin),e.ymin<f.ymin&&(f.ymin=e.ymin),e.zmin<f.zmin&&(f.zmin=e.zmin),e.xmax>f.xmax&&(f.xmax=e.xmax),e.ymax>f.ymax&&(f.ymax=e.ymax),e.zmax>f.zmax&&(f.zmax=e.zmax),g=!0);else if(b.objects){var k=b.objects;for(d in k)k.hasOwnProperty(d)&&a.objects[d]&&(c=a.objects[d],0===c.objects.length&&(e=c.getBoundary(),e.xmin<f.xmin&&(f.xmin=e.xmin),e.ymin<f.ymin&&(f.ymin=e.ymin),e.zmin<f.zmin&&(f.zmin=e.zmin),e.xmax>f.xmax&&(f.xmax=e.xmax),e.ymax>f.ymax&&(f.ymax=e.ymax),e.zmax>f.zmax&&(f.zmax=e.zmax),g=!0))}else{k=a.objects;for(d in k)k.hasOwnProperty(d)&&(c=k[d],0===c.objects.length&&(e=c.getBoundary(),e.xmin<f.xmin&&(f.xmin=e.xmin),e.ymin<f.ymin&&(f.ymin=e.ymin),e.zmin<f.zmin&&(f.zmin=e.zmin),e.xmax>f.xmax&&(f.xmax=e.xmax),e.ymax>f.ymax&&(f.ymax=e.ymax),e.zmax>f.zmax&&(f.zmax=e.zmax),g=!0))}return g?f:{xmin:-100,ymin:-100,zmin:-100,xmax:100,ymax:100,zmax:100}}}(),function(){"use strict";function a(){var a={},b=Human.renderer.getContentRootNode().addNode({type:"flags",flags:{enabled:!1}}),c=b.addNode({type:"material",color:{r:0,g:0,b:1},emit:1}),d=c.addNode({type:"geometry",source:{type:"boundary"}});return a.setShown=function(a){b.setEnabled(a)},a.setBoundary=function(a){d.setSource(a)},a.destroy=function(){b.destroy()},a}var b,c;Human.properties.subscribe({propId:"hacks.neverBackfaces",value:!1,callback:function(a){b=a}}),Human.properties.subscribe({propId:"hacks.alwaysBackfaces",value:!1,callback:function(a){c=a}}),Human.scene.Object=function(b){function d(){e.pivot=l.pivot,e.translate=l.translate,e.scale=l.scale,e.rotate=l.rotate,e._buildMatrix()}var e=this;this._init(),this.moduleId=b.moduleId,this.modelId=b.modelId,this.objectId=b.objectId,this.anonymous=b.anonymous,this.fmaId=b.fmaId,this.layer=b.layer,this.displayName=b.displayName,this.name=b.displayName,this.description=b.description,this.parent=b.parent,this.shown=!1,this.selected=!1,this.level=b.level,this.pickable=!0,this.clippable=!0,this.transparent=!1,this.xray=!1,this.glassFactor=void 0!==b.glassFactor?b.glassFactor:1,this.murkiness=void 0!==b.murkiness?b.murkiness:1,this.desaturate=!!b.desaturate,this.highlight=!1,this.skybox=b.skybox,this.backfaces=c,this.transparentBackfaces=!1,this.flip=!!b.flip,this.tags=b.tags,this.numSubObjects=0,this.numSubObjectsLoaded=0,this.objects=[],this._boundedAsset=null,this._boundaryDirty=!0;var f,g,h;if(this._rootNode=f=b.parent?b.parent._childNodeContainer.addNode():Human.renderer.getNode(b.attachNodeId).addNode(),this._transformNode=f=f.addNode({type:"xform"}),this._childNodeContainer=this._transformNode,this.material=null,this.region=null,b.geometry||b.morph){if(b.material&&(this.material=b.material,g=b.material,g.texture&&(f=f.addNode({type:"_texture",coreId:g.texture.getCoreId()})),g.material&&(f=f.addNode({type:"material",coreId:g.material.getCoreId()}),this.glassFactor=g.glassFactor,this.murkiness=g.murkiness),g.reflection&&(f=f.addNode({type:"reflect",coreId:g.reflection.getCoreId()})),g.fresnels)){var i=g.fresnels;for(var j in i)i.hasOwnProperty(j)&&(f=f.addNode({type:"fresnel",coreId:i[j].getCoreId()}))}b.regionMap&&(this.regionMap=b.regionMap,f=f.addNode({type:"regionMap",coreId:b.regionMap.node.getCoreId()})),h={picking:this.pickable,enabled:!1,specular:!0,backfaces:c,reflection:!0,solid:!0,skybox:!!b.skybox},this._xrayBackfaces=!1,g&&g.flags&&(h=Human.utils.apply(g.flags.get("flags"),h)),h.enabled=!1,h.pickable=!0,this._flagsNode=f=f.addNode({type:"flags",flags:h}),this._nameNode=f=f.addNode({type:"name",name:b.objectId||"noname"});var k=0;b.layer&&(k=b.layer),this._layerNode=f=f.addNode({type:"layer",priority:k}),this._shaderNode=f=f.addNode({type:"shader",coreId:"standard-shaders-xray"}),this._shaderParamsNode=f=f.addNode({type:"shaderParams",params:{transparent:!1,xray:!1,highlight:!1,desaturate:this.desaturate,opacity:1,glassFactor:this.glassFactor,skybox:this.skybox,murkiness:this.murkiness}}),b.morph&&(f=f.addNode({type:"morphGeometry",coreId:b.morph.morphGeometry.getCoreId()}),this.morph=b.morph.morphGeometry,b.morph.morphGeometry.on("frameUpdate",function(){e._boundaryDirty=!0})),b.geometry&&(this.geometry=f.addNode({type:"geometry",coreId:b.geometry.geometry.getCoreId()})),this._boundedAsset=b.morph?b.morph:b.geometry}if(this._bbox=a(),this.parent&&this.parent._subObjectReady(this),b.transform){var l=b.transform;this._transform=l,d(),l.on("updated",d)}else this.pivot=b.pivot?Human.utils.apply(b.pivot,{
x:0,y:0,z:0}):{x:0,y:0,z:0},this.translate=b.translate?Human.utils.apply(b.translate,{x:0,y:0,z:0}):{x:0,y:0,z:0},this.scale=b.scale?Human.utils.apply(b.scale,{x:1,y:1,z:1}):{x:1,y:1,z:1},this.rotate=b.rotate?Human.utils.apply(b.rotate,{x:0,y:0,z:0}):{x:0,y:0,z:0},this._buildMatrix();b.material&&(g=b.material.material,h=b.material.flags,g&&h&&h.getTransparent()&&(this.setOpacity(g.getAlpha()),this.setTransparent(!0))),this.capColor=b.capColor?b.capColor:{r:.7,g:.7,b:.7},this._flagsNode&&this._flagsNode.setSolidColor(this.capColor)},Human.utils.extend(Human.scene.Object,Human.Component),Human.scene.Object.prototype._subObjectReady=function(a){this.numSubObjectsLoaded++,this._boundaryDirty=!0,this.numSubObjects>0&&this.numSubObjects===this.numSubObjectsLoaded&&this.parent&&this.parent._subObjectReady(this),this.parent&&this.parent._subObjectReady(a)},Human.scene.Object.prototype.setTransform=function(a){return this._transform?void this._transform.set(a):(a.pivot&&(void 0!==a.pivot.x&&null!==a.pivot.x&&(this.pivot.x=a.pivot.x),void 0!==a.pivot.y&&null!==a.pivot.y&&(this.pivot.y=a.pivot.y),void 0!==a.pivot.z&&null!==a.pivot.z&&(this.pivot.z=a.pivot.z)),a.translate&&(void 0!==a.translate.x&&null!==a.translate.x&&(this.translate.x=a.translate.x),void 0!==a.translate.y&&null!==a.translate.y&&(this.translate.y=a.translate.y),void 0!==a.translate.z&&null!==a.translate.z&&(this.translate.z=a.translate.z)),a.scale&&(void 0!==a.scale.x&&null!==a.scale.x&&(this.scale.x=a.scale.x),void 0!==a.scale.y&&null!==a.scale.y&&(this.scale.y=a.scale.y),void 0!==a.scale.z&&null!==a.scale.z&&(this.scale.z=a.scale.z)),a.rotate&&(void 0!==a.rotate.x&&null!==a.rotate.x&&(this.rotate.x=a.rotate.x),void 0!==a.rotate.y&&null!==a.rotate.y&&(this.rotate.y=a.rotate.y),void 0!==a.rotate.z&&null!==a.rotate.z&&(this.rotate.z=a.rotate.z)),void this._buildMatrix())};var d=Human.math.mat4(),e=Human.math.mat4(),f=Human.math.mat4(),g=Human.math.mat4(),h=Human.math.mat4(),i=Human.math.mat4(),j=Human.math.mat4();Human.scene.Object.prototype._buildMatrix=function(){var a=this.pivot,b=this.translate;Human.math.translationMat4v([-a.x,-a.y,-a.z],d);var c=this.scale;Human.math.scalingMat4v([c.x,c.y,c.z],e),Human.math.translationMat4v([b.x+a.x,b.y+a.y,b.z+a.z],f);var k=this.rotate;Human.math.rotationMat4v(k.z*Math.PI/180,[0,0,1],g),Human.math.rotationMat4v(k.y*Math.PI/180,[0,1,0],h),Human.math.rotationMat4v(k.x*Math.PI/180,[1,0,0],i),Human.math.identityMat4(j),Human.math.mulMat4(d,j,j),Human.math.mulMat4(e,j,j),Human.math.mulMat4(i,j,j),Human.math.mulMat4(h,j,j),Human.math.mulMat4(g,j,j),Human.math.mulMat4(f,j,j),this.matrix=j,this._transformNode.setElements(this.matrix),this._setBoundaryDirty(),this._updateFaceWinding()},Human.scene.Object.prototype._setBoundaryDirty=function(){this._boundaryDirty=!0,this._setSubBoundaryDirty(),this._setAncestorBoundaryDirty()},Human.scene.Object.prototype._inNegativeCoordSpace=function(a){if(a.scale&&(a.scale.x<0||a.scale.y<0||a.scale.z<0))return!0;var b=a.parent;return b?this._inNegativeCoordSpace(b):!1};var k={x:0,y:0,z:0};Human.scene.Object.prototype.getNegatedAxes=function(a){return a=a||{},k.x=0,k.y=0,k.z=0,this._getAxisInversionCounts(k),a.x=k.x%2===1,a.y=k.y%2===1,a.z=k.z%2===1,a},Human.scene.Object.prototype._getAxisInversionCounts=function(a){this.scale&&(this.scale.x<0&&a.x++,this.scale.y<0&&a.y++,this.scale.z<0&&a.z++);var b=this.parent;b&&b._getAxisInversionCounts(a)},Human.scene.Object.prototype._setAncestorBoundaryDirty=function(){for(var a=this.parent;a&&!a._boundaryDirty;a=a.parent)a._boundaryDirty=!0},Human.scene.Object.prototype._setSubBoundaryDirty=function(){for(var a,b=0,c=this.objects.length;c>b;b++)a=this.objects[b],a._boundaryDirty||(a._boundaryDirty=!0,a._setSubBoundaryDirty())},Human.scene.Object.prototype._updateFaceWinding=function(){var a=this.flip,b=this._inNegativeCoordSpace(this);this._flagsNode&&this._flagsNode.setFrontface(a||b?"cw":"ccw");for(var c=0,d=this.objects.length;d>c;c++)this.objects[c]._updateFaceWinding2(b)},Human.scene.Object.prototype._inNegativeCoordSpace=function(a){if(a.scale&&(a.scale.x<0||a.scale.y<0||a.scale.z<0))return!0;var b=a.parent;return b?this._inNegativeCoordSpace(b):!1},Human.scene.Object.prototype._updateFaceWinding2=function(a){this.scale&&(this.scale.x<0||this.scale.y<0||this.scale.z<0)&&(a=!0),this._flagsNode&&this._flagsNode.setFrontface(this.flip||a?"cw":"ccw");for(var b=0,c=this.objects.length;c>b;b++)this.objects[b]._updateFaceWinding2(a)},Human.scene.Object.prototype.getBoundary=function(){return this._boundaryDirty&&this._rebuildBoundary(),this._boundary},Human.scene.Object.prototype.getWorldMatrix=function(){return this._transformNode.getWorldMatrix()},Human.scene.Object.prototype.getCenter=function(){return this._boundaryDirty&&this._rebuildBoundary(),this._center},Human.scene.Object.prototype._rebuildBoundary=function(){if(this._boundaryDirty){var a,b;if(this._boundary={xmin:1e6,ymin:1e6,zmin:1e6,xmax:-1e6,ymax:-1e6,zmax:-1e6},this._boundedAsset){var c,d,e=this.getWorldMatrix(),f=this._boundedAsset;"function"==typeof f.updateBoundary&&f.updateBoundary(),c=f.axisBoundary,c&&(d=this._getBoundary(Human.math.transformPoints3(e,c.verts)),this._expandBoundary(this._boundary,d))}var g;for(a=0,b=this.objects.length;b>a;a++)g=this.objects[a],g._boundaryDirty&&g._rebuildBoundary(),this._expandBoundary(this._boundary,g._boundary);this._center=[.5*(this._boundary.xmax+this._boundary.xmin),.5*(this._boundary.ymax+this._boundary.ymin),.5*(this._boundary.zmax+this._boundary.zmin)],this._boundaryDirty=!1,this._bbox.setBoundary(this._boundary)}},Human.scene.Object.prototype._getBoundary=function(a){for(var b,c,d,e=1e5,f=1e5,g=1e5,h=-1e5,i=-1e5,j=-1e5,k=0,l=a.length;l>k;k++)b=a[k][0],c=a[k][1],d=a[k][2],void 0!==b&&null!==b&&void 0!==c&&null!==c&&void 0!==d&&null!==d&&(e>b&&(e=b),f>c&&(f=c),g>d&&(g=d),b>h&&(h=b),c>i&&(i=c),d>j&&(j=d));return{xmin:e,ymin:f,zmin:g,xmax:h,ymax:i,zmax:j}},Human.scene.Object.prototype._expandBoundary=function(a,b){a.xmin>b.xmin&&(a.xmin=b.xmin),a.ymin>b.ymin&&(a.ymin=b.ymin),a.zmin>b.zmin&&(a.zmin=b.zmin),a.xmax<b.xmax&&(a.xmax=b.xmax),a.ymax<b.ymax&&(a.ymax=b.ymax),a.zmax<b.zmax&&(a.zmax=b.zmax)},Human.scene.Object.prototype.__addObject=function(a){this.objects.push(a),this._subObjectAdded(a)},Human.scene.Object.prototype._subObjectAdded=function(a){this.numSubObjects++,this._boundaryDirty=!0,this.parent&&this.parent._subObjectAdded(a)},Human.scene.Object.prototype.show=function(a){this.shown!==a&&(this._flagsNode&&this._flagsNode.setEnabled(a),this.shown=a,this.publish("shown",this.shown))},Human.scene.Object.prototype.select=function(a){this.selected=a},Human.scene.Object.prototype.setOpacity=function(a){this._shaderParamsNode&&this._shaderParamsNode.setParams({opacity:a})},Human.scene.Object.prototype.setTransparent=function(a){if(this.transparent!==a){if(this._shaderParamsNode){this._shaderParamsNode.setParams({transparent:a});var b=a||this.xray;this._flagsNode.setTransparent(b),this._flagsNode.setBackfaces(!b&&this.backfaces)}this.transparent=a}},Human.scene.Object.prototype.setXRay=function(a){if(this.xray!==a){if(this._shaderParamsNode){this._shaderParamsNode.setParams({xray:a});var b=a||this.transparent;this._flagsNode.setTransparent(b),this._flagsNode.setBackfaces(!b&&this.backfaces),this._shaderParamsNode.setParams({desaturate:a||this.desaturate})}this.xray=a}},Human.scene.Object.prototype.setDesaturate=function(a){this.desaturate!==a&&(this._shaderParamsNode&&this._shaderParamsNode.setParams({desaturate:a||this.xray}),this.desaturate=a)},Human.scene.Object.prototype.setGlassFactor=function(a){this.glassFactor=a,this._shaderParamsNode&&this._shaderParamsNode.setParams({glassFactor:a})},Human.scene.Object.prototype.setMurkiness=function(a){this.murkiness=a,this._shaderParamsNode&&this._shaderParamsNode.setParams({murkiness:a})},Human.scene.Object.prototype.setPickable=function(a){this.pickable!==a&&(this._flagsNode&&this._flagsNode.setPicking(a),this.pickable=a)},Human.scene.Object.prototype.setClippable=function(a){this.clippable!==a&&(this._flagsNode&&this._flagsNode.setClipping(a),this.clippable=a)},Human.scene.Object.prototype.setHighlight=function(a){this.highlight!==a&&(this._shaderParamsNode&&this._shaderParamsNode.setParams({highlight:a}),this.highlight=a)},Human.scene.Object.prototype.setTransparentBackfaces=function(){},Human.scene.Object.prototype.setBackfaces=function(a){if(this.backfaces!==a){if(this._flagsNode){var b=this.xray||this.transparent;this._flagsNode.setBackfaces(!b&&a)}this.backfaces=a}},Human.scene.Object.prototype._destroy=function(){this._destroyed||(this._rootNode&&this._rootNode.destroy(),this._bbox&&this._bbox.destroy(),this.publish("destroyed"))},Human.scene.Object.prototype._removeObject=function(a){for(var b=0,c=this.objects.length;c>b;b++){if(this.objects[b].objectId===a)return this.objects.splice(b,1),void this._subObjectRemoved();this._setBoundaryDirty()}},Human.scene.Object.prototype._subObjectRemoved=function(){this.numSubObjects--}}(),function(){"use strict";function a(a,c,d,e){var f=l.objects,h=[];for(var i in f)f.hasOwnProperty(i)&&h.push(i);m=h.length,Human.utils.ArrayIteration.call({},h,function(a,d,e){var h=f[a],i=h.displayname,j=null,l={systemId:a};p=0,b(a,i,function(){var a=g(c,h,j,l);q[c][k].objects.push(a.objectId),d()},e)},function(){d()},e)}function b(a,b,e,f){Human.net.getAnatomyIndex(j,a,function(g){c(a,b,g,function(b){d(a,g,b),e()},f)},f)}function c(a,b,c,d,e){function f(){h||d(i)}function g(a){h||(h=!0,e(a))}var h=!1,i={},k=4,l=0;Human.net.getAnatomyPositions(j,a,function(a){i.positions=a,++l===k&&f()},g),Human.net.getAnatomyNormals(j,a,function(a){i.normals=a,++l===k&&f()},g),Human.net.getAnatomyUVs(j,a,function(a){i.uv=a,++l===k&&f()},g),Human.net.getAnatomyIndices(j,a,function(a){i.indices=a,++l===k&&f()},g)}function d(a,b,c){for(var d in b)if(b.hasOwnProperty(d)){var g=b[d],h=e(c.positions,g.positions,Human.net.getOffset(a,d,"positions")),i=f(h);Human.assets.geometries.createGeometry(k,k+"."+d,{geometry:{primitive:"triangles",positions:h,normals:e(c.normals,g.normals,Human.net.getOffset(a,d,"normals")),uv:e(c.uv,g.uv,Human.net.getOffset(a,d,"uv")),indices:e(c.indices,g.indices,Human.net.getOffset(a,d,"indices"))},boundary:i})}}function e(a,b,c){var d=b[0]-c,e=d+b[1]-c;return a.subarray?a.subarray(d,e):a.slice(d,e)}function f(a){for(var b,c,d,e=1e5,f=1e5,g=1e5,h=-1e5,i=-1e5,j=-1e5,k=0,l=a.length-2;l>k;k+=3)b=a[k],c=a[k+1],d=a[k+2],void 0!==b&&null!==b&&void 0!==c&&null!==c&&void 0!==d&&null!==d&&(e>b&&(e=b),f>c&&(f=c),g>d&&(g=d),b>h&&(h=b),c>i&&(i=c),d>j&&(j=d));return{xmin:e,ymin:f,zmin:g,xmax:h,ymax:i,zmax:j}}function g(a,b,c,d){function e(a,b,c){return c?void 0!==b[a]&&null!==b[a]?b[a]:c[a]:b[a]}var f=p>=0?o[p-1]:null,i=b.priority,j=b.subLayer;void 0!==j&&null!==j?p>0&&(f=o[p-1],i=.001*j*(1+p)):(void 0===i||null===i)&&(i=p>0?o[p-1]:0),o[p++]=i;var l,m=b.nodeId,n=a+"-"+m,q=b.fmaid||b.fmaId?a+"-"+(b.fmaId||b.fmaid):null,r=c?a+"-"+c.nodeId:null;if(b.materialId){l=Human.assets.materials.materials[b.materialId];var s;l||(s=a+"."+b.materialId,l=Human.assets.materials.materials[s]),l||Human.log.error("Human.scene.loader","Material asset not found: "+b.materialId+" - (global ID == "+s+")")}var t;b.transformId&&(t=Human.assets.transforms.transforms[b.transformId],t||(t=Human.assets.transforms.transforms[a+"."+b.transformId]),t||Human.log.error("Human.scene.loader","Transform asset not found: "+b.transformId));var u;b.geometryId&&(u=Human.assets.geometries.geometries[b.geometryId],u||(u=Human.assets.geometries.geometries[a+"."+b.geometryId]),u||(u=Human.assets.geometries.geometries[k+"."+b.geometryId]),u||(u=Human.assets.geometries.geometries[k+"."+m]),u||Human.log.error("Human.scene.loader","Geometry asset not found: "+b.geometryId));var v;b.regionMapId&&(v=Human.assets.regionMaps.maps[b.regionMapId],v||(v=Human.assets.regionMaps.maps[a+"."+b.regionMapId]),v||Human.log.error("Human.scene.fileLoader","Region asset not found: "+b.regionMapId));var w,x=Human.scene.__createObject({moduleId:h,modelId:a,objectId:n,localObjectId:m,objectName:b.nodeId,fmaId:q,displayName:b.displayname,parentObjectId:r,layer:i,geometry:u,material:l,transform:t,flip:e("flip",b,c),desaturate:e("desaturate",b,c),glassFactor:e("glassFactor",b,c),tags:b.tags||[],capColor:e("capColor",b,c),regionMap:v});if(b.objects)for(var y in b.objects)b.objects.hasOwnProperty(y)&&(w=b.objects[y],g(a,w,b,d));return p--,x}var h,i,j,k,l,m,n=Human.scene.loader={},o=[],p=0,q={};n.load=function(b,c,d,e,f,g){if(h=b,i=c,j=d,k=i+"."+j,q[i]=q[i]||{},q[i][k])return Human.log.warn("Human.scene.Loader.load","Library '"+d+"' already loaded for model '"+i+"' - not reloading"),void f();var m=g;g=function(a){Human.log.error("Human.scene.loader","Load failed: '"+k+"': "+a),delete q[i][k],m(a)},Human.assets.geometries.createLibrary(k),q[i][k]={geometryLibId:k,objects:[]},Human.net.getAnatomyManifest(j,function(b){l=b.manifest,a(h,i,f,g)},function(a){a("Human.scene.loader: failed to load anatomy manifest '"+j+"': "+a.errorText+" - status: "+a.request.status)})},n.unload=function(a){var b=q[a];if(b){delete q[a];var c;for(k in b)if(b.hasOwnProperty(k)){c=b[k],Human.assets.geometries.destroyLibrary(c.geometryLibId);for(var d,e=0,f=c.objects.length;f>e;e++)d=c.objects[e],Human.scene._destroyObject(d)}}}}(),function(){"use strict";Human.scene.objectLoader={_countAnonObjects:0,_transparentObjects:null,_objectOpacities:null,_shownObjects:null,_loaded:{}},Human.scene.objectLoader.load=function(a,b,c){if(!c)return this;this._countAnonObjects=0,this._transparentObjects=null,this._objectOpacities=null,this._shownObjects=null;for(var d,e,f,g=0,h=c.length;h>g;g++){d=c[g];var i={};if(f=null,e=d.objects)for(var j,k=0,l=e.length;l>k;k++)j=e[k],j.objectId?(this._attachObject(a,b,f,j),i[j.objectId]=!0):Human.log.error("Human.scene.objectLoader","Param expected on object: objectId")}this._transparentObjects&&Human.scene.setTransparentObjects({objectIds:this._transparentObjects,replace:!1}),this._objectOpacities&&Human.scene.setObjectOpacities({objectIds:this._objectOpacities,replace:!1}),this._shownObjects&&Human.scene.setEnabledObjects({objectIds:this._shownObjects,replace:!1}),this._loaded[b]={createObjects:c}},Human.scene.objectLoader._attachObject=function(a,b,c,d){if(!d.objectId){if(!c)return void Human.log.error("Human.scene.objectLoader","Root object is missing an objectId");d.objectId=c.objectId+this._countAnonObjects++,d.anonymous=!0}c=this._createObject(a,b,c,d);var e=d.objects;if(e)for(var f=0,g=e.length;g>f;f++)this._attachObject(a,b,c,e[f])},Human.scene.objectLoader._createObject=function(a,b,c,d){function e(a,b,c){return c?void 0!==b[a]&&null!==b[a]?b[a]:c[a]:b[a]}var f,g=d.objectId,h=b+"-"+g,i=d.fmaid||d.fmaId?b+"-"+(d.fmaid||d.fmaId):null,j=c?c.systemId:null;f=c?void 0!==d.layer&&null!==d.layer?c.layer+.001*d.layer:c.layer:d.layer||0;var k,l,m,n,o,p;if(d.assets)for(var q,r=0,s=d.assets.length;s>r;r++){q=d.assets[r];var t,u=b+"."+q;t=Human.assets.geometries.geometries[u],t?(m=t,t.materialId&&(t=Human.assets.materials.findMaterial(t.materialId),t&&(k=t))):(t=Human.assets.materials.materials[u],t?k=t:(t=Human.assets.morphs.morphs[u],t?(n=t,t.materialId&&(t=Human.assets.materials.findMaterial(t.materialId),t&&(k=t))):Human.log.error("Human.scene.objectLoader","Error in createObjects for '"+b+"' object '"+g+"': asset '"+q+"' not found")))}d.geometryId&&(m=Human.assets.geometries.geometries[d.geometryId],m||(m=Human.assets.geometries.geometries[b+"."+d.geometryId]),m||Human.log.error("Human.scene.objectLoader","Geometry asset not found: "+d.geometryId)),d.morphId&&(n=Human.assets.morphs.morphs[d.morphId],n||(n=Human.assets.morphs.morphs[b+"."+d.morphId]),n||Human.log.error("Human.scene.objectLoader","Morph asset not found: "+d.morphId)),d.materialId&&(k=Human.assets.materials.materials[d.materialId],k||(k=Human.assets.materials.materials[b+"."+d.materialId]),k||Human.log.error("Human.scene.objectLoader","Material asset not found: "+d.materialId)),d.transformId&&(o=Human.assets.transforms.transforms[d.transformId],o||(o=Human.assets.transforms.transforms[b+"."+d.transformId]),o||Human.log.error("Human.scene.objectLoader","Transform asset not found: "+d.transformId)),m||n||k||l||d.assets&&0!==d.assets.length||d.objects&&0!==d.objects.length||Human.log.warn("Human.scene.objectLoader","Scene object with neither assets nor child objects: "+g),d.regionMapId&&(p=Human.assets.regionMaps.maps[d.regionMapId],p||(p=Human.assets.regionMaps.maps[b+"."+d.regionMapId]),p||Human.log.error("Human.scene.objectLoader","Region asset not found: "+d.regionMapId));var v=Human.scene.__createObject({moduleId:a,modelId:b,objectId:h,anonymous:!!d.anonymous,localObjectId:g,objectName:g,fmaId:i,systemId:j,displayName:d.displayName,description:d.description,parentObjectId:c?c.objectId:null,layer:f,shown:!0,material:k,geometry:m,morph:n,transform:o,translate:d.translate,scale:d.scale,rotate:d.rotate,flip:e("flip",d,c),desaturate:e("desaturate",d,c),glassFactor:e("glassFactor",d,c),tags:d.tags||[],capColor:e("capColor",d,c),regionMap:p,skybox:d.skybox});return void 0!==d.transparent&&(this._transparentObjects||(this._transparentObjects={}),this._transparentObjects[h]=d.transparent),void 0!==d.opacity&&(this._objectOpacities||(this._objectOpacities={}),this._objectOpacities[h]=d.opacity),void 0!==d.shown&&(this._shownObjects||(this._shownObjects={}),this._shownObjects[h]=d.shown),v},Human.scene.objectLoader.unload=function(a){var b=this._loaded[a];if(b){var c=b.createObjects;delete this._loaded[a];for(var d,e,f,g,h=0,i=c.length;i>h;h++){d=c[h],e=d.objects;for(var j=0,k=e.length;k>j;j++)f=a+"-"+e[j].objectId,f&&(g=Human.scene.objects[f],g?Human.scene._destroyObject(g.objectId):Human.log.error("Human.scene.objectLoader.unload","Scene object not found: '"+f+"'"))}}}}(),function(){"use strict";function a(a){var b,c,d=Human.scene.objects;for(b in d)d.hasOwnProperty(b)&&(c=d[b],c.setBackfaces(a))}var b=!1;Human.properties.subscribe({propId:"hacks.alwaysBackfaces",value:!1,callback:function(a){b=a}}),Human.events.on("clips.activated",function(){b||a(!0)}),Human.events.on("clips.deactivated",function(){b||a(!1)})}(),function(){"use strict";function a(a){var b,c={},d=Human.scene.objectsByFMAID;for(var e in a)if(a.hasOwnProperty(e)){if(b=d[e],!b){Human.log.error("Object not found for FMA ID: '"+e+"'");continue}c[b.objectId]=a[e]}return c}Human.rpc.define("scene.queryBoundary",function(a){var b,c,d;if(a.objectId)b=Human.scene.getBoundary({objectId:a.objectId});else if(a.fmaId){if(d=a.fmaId,c=Human.scene.objectsByFMAID[d],!c)return void this.error("No scene object found for the given FMA ID: '"+d+"'");b=c.getBoundary()}else if(a.objectIds)b=Human.scene.getBoundary({objectIds:a.objectIds});else if(a.fmaIds){for(var e=a.fmaIds,f=[],g=0,h=e.length;h>g;g++){if(d=e[g],c=Human.scene.objectsByFMAID[d],!c)return void this.error("No scene object found for the given FMA ID: '"+d+"'");f.push(c.objectId)}b=Human.scene.getBoundary({objectIds:f})}else b=a.selectedObjects?Human.scene.getBoundary({objects:Human.scene.selectedObjects}):a.enabledObjects?Human.scene.getBoundary({objects:Human.scene.enabledObjects}):Human.scene.getBoundary();this.setResult(b)}),Human.rpc.define("scene.setTransparentObjects",function(b){var c;if(b.fmaIds)c=a(b.fmaIds);else if(Human.utils.isArray(b.objectIds)){c={};for(var d=0,e=b.objectIds.length;e>d;d++)c[b.objectIds[d]]=!0}else c=b.objectIds;b.objectIds=c,Human.scene.setTransparentObjects(b)}),Human.rpc.define("scene.setEnabledObjects",function(b){var c;if(b.fmaIds)c=a(b.fmaIds);else if(Human.utils.isArray(b.objectIds)){c={};for(var d=0,e=b.objectIds.length;e>d;d++)c[b.objectIds[d]]=!0}else c=b.objectIds;Human.scene.setEnabledObjects({objects:c,replace:b.replace})}),Human.rpc.define("scene.setSelectedObjects",function(b){var c;if(b.fmaIds)c=a(b.fmaIds);else if(Human.utils.isArray(b.objectIds)){c={};for(var d=0,e=b.objectIds.length;e>d;d++)c[b.objectIds[d]]=!0}else c=b.objectIds;b.objectIds=c,Human.scene.setSelectedObjects(b)}),function(){function a(c,d){if(c){d.push(b(c));for(var e=0,f=c.objects.length;f>e;e++)a(c.objects[e],d)}}function b(a){var b={};for(var c in a)if(a.hasOwnProperty(c)&&"_"!==c[0]){var d=a[c];Human.utils.isPrimitive(d)&&(b[c]=d)}return b.parentObjectId=a.parent?a.parent.objectId:null,b}Human.rpc.define("scene.getObjects",function(c){var d,e=[];if(c.objectId){var f=c.objectId;d=Human.scene.objects[f],d&&e.push(b(d))}else for(var g=0,h=Human.scene.rootObjects.length;h>g;g++)a(Human.scene.rootObjects[g],e);this.setResult(e)})}(),Human.rpc.define("scene.showBoundary",function(a){var b;a.objectId?(b=Human.scene.getBoundary({objectId:a.objectId}),b&&Human.view.boundary.setBoundary(b,!0)):Human.view.boundary.setBoundary(!1)}),Human.rpc.define("scene.setObjectTransform",function(a){var b,c=a.objectId,d=a.fmaId;if(c){if(b=Human.scene.objects[c],!b)return void this.error("Scene object not found: '"+c+"'")}else if(d&&(b=Human.scene.objectsByFMAID[d],!b))return void this.error("scene object not found for the given FMA ID: '"+d+"'");b.setTransform(a)}),function(){var a=document.getElementById("theCanvas"),b=function(b,c){c&&Human.math.addVec3(b,c,b);var d=Human.renderer.getViewMat(),e=Human.renderer.getProjMat(),f=Human.math.vec4();Human.math.transformPoint3(d,b,f),f[3]=1,Human.math.transformPoint4(e,f,f);var g=f[0],h=f[1],i=f[3];return[Math.round((1+g/i)*a.width/2),Math.round((1-h/i)*a.height/2)]};Human.rpc.define("scene.getCanvasPos",function(a){this.setResult(b(a.worldPos,a.offset))}),Human.rpc.define("scene.getObjectCanvasPos",function(a){var c=Human.scene.objects[a.objectId];if(c){var d=c.getCenter();this.setResult(b(d,a.offset))}})}()}(),function(){"use strict";var a=Human.scene.sets={},b=function(a,b){return b?b:a},c=function(a,b){return b===a?!0:!1};a.keys=function(a){return Object.keys(a)},a.keysWhere=function(a,b){var c=[];for(var d in a)a.hasOwnProperty(d)&&b(a[d])&&c.push(d);return c},a.hasKey=function(b,c){var d=a.keys(b);return d.indexOf(c)>=0?!0:!1},a.getSetIterator=function(b){var c=0,d=a.keys(b),e=d.length;return{next:function(){var a;if(!this.hasNext())return null;var e=d[c];return a={key:e,value:b[e]},c++,a},hasNext:function(){return e>c},rewind:function(){return c=0,b[d[0]]},current:function(){return b[d[c]]}}},a.values=function(b){var c=a.keys(b),d=[];return c.forEach(function(a){d.push(b[a])}),d},a.jointKeys=function(b,c){var d={},e=function(a){d[a]=!0},f=a.keys(b),g=a.keys(c);return f.forEach(e),g.forEach(e),a.keys(d)},a.commonKeys=function(b,c){var d={},e=a.keys(b),f=a.keys(c);return e.forEach(function(a){d[a]=1}),f.forEach(function(a){d[a]=(d[a]||0)+1}),a.keysWhere(d,function(a){return a>1?!0:!1})},a.uniqueKeys=function(b,c){var d={},e=function(a){d[a]=1},f=function(a){d[a]=0},g=a.keys(b),h=a.keys(c);return g.forEach(e),h.forEach(f),a.keysWhere(d,function(a){return a>0?!0:!1})},a.union=function(c,d,e){var f,g={},h=null;return e||(e=b),f=a.jointKeys(c,d),f.forEach(function(a){h=e(c[a],d[a]),h&&(g[a]=h)}),g},a.intersection=function(c,d,e){var f,g={},h=null;return e||(e=b),f=a.commonKeys(c,d),f.forEach(function(a){h=e(c[a],d[a]),h&&(g[a]=h)}),g},a.difference=function(c,d,e){var f=a.uniqueKeys(c,d),g=null;e||(e=b);var h={};return f.forEach(function(a){g=e(c[a]),g&&(h[a]=g)}),h},a.isin=function(b,d,e){e||(e=c);for(var f,g=!1,h=a.getSetIterator(d);h.hasNext()&&!g;)f=h.next(),g=e(b,f.key,f.value);return g}}(),function(){"use strict";function a(a){if(a.annotations)for(var b,c,d=a.annotations,e=0,f=d.length;f>e;e++)b="___"+a.chapterId+"."+e,c=Human.view.annotations.annotations[b],c&&c.destroy()}var b=Human.timeline={};b.animations={},b.timelineAnimations={},b.freeAnimations={},b._lastTime=null,b._lastActiveChapter=null,b._lastCameraChapter=null,b.chapterSets={},b.chapters={},b.FRAME_LENGTH=.033,b.chapterList=[],b.playQueue=[],b.showObjects={},b.playing=!1,b.paused=!1,b.pausedFreeAnimations=!1,b.time=0,b.direction=1,b.animationCtx={cameraEnabled:!0};var c=!0;Human.properties.subscribe({propId:"timeline.cameraAnimationEnabled",value:c,callback:function(a){c=!!a,b.animationCtx.cameraEnabled=c}}),b._time1=null,b._time2=null,b._scrubbing=!1,b._scrubCamera=!0,Human.events.on("tick",function(){var a=Date.now();if(b._timeFrame||b.getTimeFrame(),b.pausedFreeAnimations||b._updateFreeAnimations(),!b._scrubbing&&!b.playing)return void(b._lastTime=a);if(b._scrubbing)return b._update(b._scrubCamera),b._scrubCamera=!0,b._scrubbing=!1,void(b._lastTime=null);if(b.playing&&!b.paused){if(b._time1===b._time2)return;b._lastTime&&(b.time+=b.direction*((a-b._lastTime)/1e3));var c=b.direction>0&&b.time>b._time2||b.direction<0&&b.time<b._time2;if(!c)return Human.events.fire("timeline.playing",{time:b.time}),b._update(),void(b._lastTime=a);if(b._loop)return b.time=b._time1+b._fmod(b.time,b._time2-b._time1),Human.events.fire("timeline.playing",{time:b.time}),b._update(),void(b._lastTime=a);var d=b._time1<b._time2?b._time1:b._time2,e=b._time1>b._time2?b._time1:b._time2;b.time=b.time<d?d:b.time>e?e:b.time,b._update(),b.playQueue.length>0?b._play(b.playQueue.pop()):b.stop()}}),Human.events.on("snapshot.started",function(){b.pause()}),Human.events.on("snapshot.finished",function(){b.unpause()});var d=!0;Human.properties.subscribe({propId:"timeline.prevNextMode",value:d?"scrub":"play",callback:function(a){d="scrub"===a}}),b._fmod=function(a,b){if(b>a)return Human.log.error("Human.timeline._fmod","Attempting to find modulus within negative range - would be infinite loop - ignoring"),a;for(;a>=b;)a-=b;return a},b._update=function(a){var c=b._findChapter(b.time);c&&b._activateChapter(c);var d={cameraEnabled:a===!1?a:b.animationCtx.cameraEnabled};for(var e in b.timelineAnimations)b.timelineAnimations.hasOwnProperty(e)&&b.timelineAnimations[e].update(d,b.time)},b._updateFreeAnimations=function(){var a=Date.now()/1e3;for(var c in b.freeAnimations)b.freeAnimations.hasOwnProperty(c)&&b.freeAnimations[c].update(b.animationCtx,a)},b.scrub=function(a){var c=function(c,d){b.time=c,b._scrubbing=!0,b.playing=!1,b._looping=!1,b._lastTime=null,b._nextChapter=null,b.playQueue=[],b._scrubParams=a,b._playParams=null,b._scrubCamera=d,Human.events.fire("timeline.scrubbed",{time:b.time})};b._timeFrame||b.getTimeFrame(),a=a||{};var d=a.time;if(void 0!==d&&null!==d)a.clamp&&(d<b._timeFrame.firstTime?d=b._timeFrame.firstTime:d>b._timeFrame.lastTime&&(d=b._timeFrame.lastTime)),c.call(this,d,!0);else if(a.chapterId){var e=a.chapterId,f=b.chapters[e];if(!f)return void Human.log.error("Human.timeline.scrub","Chapter not found: '"+e+"'");f.flyTo?(Human.view.camera.fly.flyTo(f.flyTo),c.call(this,f.time,!1)):c.call(this,f.time,!0)}else c.call(this,b._timeFrame.firstTime,!0)},b._findChapter=function(a){for(var c,d=b.chapterList.length-1;d>=0;d--)if(c=b.chapterList[d],c.time<=a)return c},b._activateChapter=function(a){b._lastActiveChapter&&a.chapterId===b._lastActiveChapter.chapterId||(Human.events.fire("timeline.chapters.activating",{chapterId:a.chapterId}),a.showObjects?(b.showObjects=a.showObjects,Human.scene.setEnabledObjects({objects:a.showObjects,replace:!0})):(b.showObjects={},Human.scene.setEnabledObjects({replace:!0})),Human.scene.setSelectedObjects(a.selectObjects?{objects:a.selectObjects,replace:!0}:{replace:!0}),a.xray===!0?Human.rpc.call(null,"xray.setEnabled",{enable:!0}):Human.rpc.call(null,"highlight.setEnabled",{enable:!0}),a.screenPan&&Human.view.camera.setScreenPan(a.screenPan),b._activateAnnotations(a),b._activateSkyboxes(a),b._lastCameraChapter&&a.chapterId===b._lastCameraChapter.chapterId||(c&&a.flyTo?b._lastCameraChapter=a:c&&a.jumpTo?b._lastCameraChapter=a:b.animationCtx.cameraEnabled=c),Human.events.fire("timeline.chapters.activated",{oldChapterIndex:b._lastActiveChapter?b._lastActiveChapter.index:null,newChapterIndex:a.index,time:b.time,loop:b._loop}),b._lastActiveChapter=a)},b._activateAnnotations=function(a){var c,d,e,f,g;if(b._lastLabelsChapter&&b._lastLabelsChapter.annotations&&b._lastLabelsChapter.chapterId!==a.chapterId)for(c=b._lastLabelsChapter.annotations,f=0,g=c.length;g>f;f++)d="___"+b._lastLabelsChapter.chapterId+"."+f,e=Human.view.annotations.annotations[d],e&&e.destroy();if(a.annotations&&(!b._lastLabelsChapter||b._lastLabelsChapter.chapterId!==a.chapterId))for(c=a.annotations,f=0,g=c.length;g>f;f++){d="___"+a.chapterId+"."+f;var h=Human.view.annotations.annotations[d];if(h)h.pin.setEnabled(!0);else{e=c[f];var i;if(!e.pos&&e.objectId){var j=Human.scene.objects[e.objectId];i=j.getCenter()}Human.view.annotations.createAnnotation({annotationId:d,objectId:e.objectId,title:e.title||"",description:e.description||"",pos:e.pos||i,dir:e.pinVec||e.dir,enabled:!0,shown:"secondary"===e.type?!1:e.shown,labelShown:"secondary"===e.type?!1:e.labelShown!==!1,saved:!0,labelOffset:e.labelOffset,embed:e.embed,occludable:e.occludable,followsObject:e.followsObject})}}b._lastLabelsChapter=a},b._activateSkyboxes=function(a){if(a.skybox&&(!b._lastSkyboxChapter||b._lastSkyboxChapter.chapterId!==a.chapterId)){var c=Human.view.skyboxes,d=a.skybox;if(!d)return void c.deactivateSkybox();d=Human.view.skyboxes.exportedSkyboxIds[d]||d,c.activateSkybox(d)}b._lastSkyboxChapter=a},b.play=function(a){a=a||{},a.queue&&b.playing?b.playQueue.unshift(a):(b.playQueue=[],b._play(a))},b._play=function(a){if(b._timeFrame||b.getTimeFrame(),!b.paused||(b.paused=!1,void 0!==a.startTime&&null!==a.startTime||a.startChapterId||void 0!==a.finishTime&&null!==a.finishTime||a.finishChapterId||a.numChapters)){var c,d,e,f=b._timeFrame.firstTime,g=b._timeFrame.lastTime;if(a.prevChapter){if(0===b.chapterList.length)return;e=0,b._lastActiveChapter&&(e=0===b._lastActiveChapter.index?b.chapterList.length-1:b._lastActiveChapter.index-1),d=b.chapterList[e],f=d.time,e<b.chapterList.length-1&&(g=b.chapterList[e+1].time),(d.flyTo||d.jumpTo||d.showObjects||d.selectObjects)&&b._activateChapter(d)}else if(a.nextChapter){if(0===b.chapterList.length)return;e=0,e=b._lastActiveChapter?b._lastActiveChapter.index+1>=b.chapterList.length?0:b._lastActiveChapter.index+1:0,d=b.chapterList[e],f=d.time,e<b.chapterList.length-1&&(g=b.chapterList[e+1].time),(d.flyTo||d.jumpTo||d.showObjects||d.selectObjects)&&b._activateChapter(d)}else if(void 0!==a.startTime&&null!==a.startTime){f=a.startTime<b._timeFrame.firstTime?b._timeFrame.firstTime:a.startTime>b._timeFrame.lastTime?b._timeFrame.lastTime:a.startTime;var h=b._findChapter(f);if(h){var i=b.chapterList[h.index+1];if(i){var j=Math.round(1e3*(i.time-f))/1e3;j<=b.FRAME_LENGTH&&(f=i.time)}}}else if(a.startChapterId){if(c=a.startChapterId,d=b.chapters[c],!d)return void Human.log.error("Human.timeline.play","Param 'startChapterId' does not match any chapters: '"+c+"'");f=d.time,(d.flyTo||d.jumpTo||d.showObjects||d.selectObjects)&&b._activateChapter(d)}else b._lastCameraChapter=null;if(void 0!==a.finishTime&&null!==a.finishTime)g=a.finishTime<b._timeFrame.firstTime?b._timeFrame.firstTime:a.finishTime>b._timeFrame.lastTime?b._timeFrame.lastTime:a.finishTime;else if(a.finishChapterId){if(c=a.finishChapterId,d=b.chapters[c],!d)return void Human.log.error("Human.timeline.play","Param 'finishChapterId' does not match any chapters: '"+c+"'");g=d.time-b.FRAME_LENGTH}else if(a.numChapters){for(var k,l=-1,m=b.chapterList.length-1;m>=0;m--)if(b.chapterList[m].time<=f){k=b.chapterList[m],l=m;break}var n=l+a.numChapters;n<b.chapterList.length?g=b.chapterList[n].time-b.FRAME_LENGTH:void 0===k.duration||null===k.duration?Human.log.error("Human.timeline.play","Last chapter in chapters sequence does not have a 'duration'"):g=k.time+k.duration}b.playing=!0,b._time1=f,b._time2=g,b.direction=b._time1<b._time2?1:-1,b._lastTime=null,b._loop=a.loop,b.time=void 0!==a.time&&null!==a.time?a.time:f,b._playParams=a,b._scrubParams=null,Human.events.fire("timeline.played",{time:b.time})}},b.playFreeAnimations=function(){b.pausedFreeAnimations=!1},b.prev=function(){if(b._lastActiveChapter&&0!==b._lastActiveChapter.index)if(d)b.scrub({chapterId:b.chapterList[b._lastActiveChapter.index-1].chapterId});else{var a=b.chapterList[b._lastActiveChapter.index],c=b._lastActiveChapter.index>0?b.chapterList[b._lastActiveChapter.index-1]:null;

if(c&&c.loop)b.play({startTime:c.time,finishTime:a.time,loop:!0});else if(b.time-a.time>.1)b.play({startTime:b.time,finishTime:a.time,direction:-1});else{var e=b.chapterList[b._lastActiveChapter.index-1].chapterId,f=b.chapters[e];b.play({startTime:b.time,finishTime:f.time,direction:-1})}}},b.next=function(){if(!b._lastActiveChapter)return void b.scrub({time:0});if(!(b._lastActiveChapter.index+1>=b.chapterList.length)){var a=b.chapterList[b._lastActiveChapter.index+1].chapterId;if(d)b.scrub({chapterId:a});else{var c=b.chapters[a];c&&b.play(c.loop?{startTime:c.time,numChapters:1,loop:c.loop}:{startTime:b.time,finishTime:c.time})}}},b.mute=function(){},b.pause=function(){return b.playing?(b.paused=!0,Human.events.fire("timeline.paused",{time:b.time}),!0):void 0},b.pauseFreeAnimations=function(){b.pausedFreeAnimations=!0},b.unpause=function(){b.paused&&(b.paused=!1,b._lastTime=Date.now(),Human.events.fire("timeline.unpaused",{time:b.time}))},b.stop=function(){var a;for(var c in b.timelineAnimations)b.timelineAnimations.hasOwnProperty(c)&&(a=b.timelineAnimations[c],a.stop&&a.stop());b._scrubbing=!1,b.playing=!1,b._loop=!1,b._lastTime=null,b.playQueue=[],Human.events.fire("timeline.stopped",{time:b.time})},b.addAnimation=function(a,c){return c.update?(b.animations[a]&&b.removeAnimation(a),b.animations[a]=c,c.timeline===!1?b.freeAnimations[a]=c:(b.timelineAnimations[a]=c,b._timeFrame=null),void Human.events.fire("Timeline.Loaded")):void Human.log.error("Human.timeline.addAnimation","Param expected: update")},b.removeAnimation=function(a){var c=b.animations[a];return c?(delete b.animations[a],c.timeline===!1?(delete b.freeAnimations[a],b._timeFrame=null):delete b.timelineAnimations[a],c.destroy&&c.destroy(),void Human.events.fire("Timeline.Empty")):void Human.log.warn("Human.timeline.removeAnimation","Animation not found: "+a)},b.addChapterSet=function(a,c){for(var d,e,f,g=0,h=c.length;h>g;g++)if(e=c[g],d=e.chapterId)if(b.chapters[d])Human.log.error("Human.timeline.addChapterSet","Chapter '"+d+"' already defined");else if(e.displayName||(Human.log.warn("Human.timeline.addChapterSet","Chapter '"+d+"' attribute missing: 'displayName' - substituting empty string"),e.displayName=""),void 0!==e.time&&null!==e.time)if(b.chapters[d]=e,0===b.chapterList.length)b.chapterList.push(e),e.index=0;else{var i,j,k=!1;for(i=b.chapterList.length-1;i>=0;i--)if(f=b.chapterList[i],f.time<e.time){b.chapterList.splice(i+1,0,e),k=!0;break}for(k||b.chapterList.splice(0,0,e),i=0,j=b.chapterList.length;j>i;i++)b.chapterList[i].index=i}else Human.log.error("Human.timeline.addChapterSet","Chapter '"+d+"' attribute missing: 'time'");else Human.log.error("Human.timeline.addChapterSet","Chapter property missing: chapterId");b.chapterSets[a]=c,b._lastActiveChapter=null,b._lastCameraChapter=null,b._timeFrame=null,Human.events.fire("timeline.chapters.updated",b.chapterList)},b.destroyChapterSet=function(c){var d,e;if(c){var f=b.chapterSets[c];if(!f)return void Human.log.warn("Human.timeline.destroyChapterSet"," Chapter set not found: "+c);for(d=0,e=f.length;e>d;d++){var g=f[d].chapterId;delete b.chapters[g];for(var h,i=b.chapterList.length-1;i>=0;i--){if(h=b.chapterList[i],h.chapterId===g){b.chapterList.splice(i,1);break}h.annotations&&a(h)}}delete b.chapterSets[c]}else b.chapterSets={},b.chapters={},b.chapterList=[];for(d=0,e=b.chapterList.length;e>d;d++)b.chapterList[d].index=d;b._lastActiveChapter=null,b._lastCameraChapter=null,b._timeFrame=null,Human.events.fire("timeline.chapters.updated",b.chapterList)},b.getTimeFrame=function(){if(b._timeFrame)return b._timeFrame;var a,c=!1,d=0,e=0;for(var f in b.timelineAnimations)b.timelineAnimations.hasOwnProperty(f)&&(c=!0,a=b.timelineAnimations[f],a.firstTime<d&&(d=a.firstTime),a.lastTime>e&&(e=a.lastTime));for(var g,h=0,i=b.chapterList.length;i>h;h++)g=b.chapterList[h],g.time<d&&(d=g.time),g.time>e&&(e=g.time),void 0!==g.duration&&null!==g.duration&&(g.duration<d&&(d=g.duration),g.duration>e&&(e=g.duration));return b._timeFrame={firstTime:d,lastTime:e},Human.events.fire("timeline.timeFrame.updated",b._timeFrame),b._timeFrame},b.getBookmark=function(){return b._scrubParams?{scrub:Human.utils.shallowClone(b._scrubParams)}:b._playParams?{play:Human.utils.apply(b._playParams,{time:b.time})}:b.time?{scrub:{time:b.time}}:{}},b.setBookmark=function(a){a.scrub?b.scrub(a.scrub):a.play&&b.play(a.play)},b.query=function(){for(var a,c=[],d=0,e=b.chapterList.length;e>d;d++)a=b.chapterList[d],c.push({chapterId:a.chapterId,type:a.type,displayName:a.displayName,description:a.description,tags:a.tags,annotations:a.annotations||null,hotspots:a.hotspots||null,flyTo:a.flyTo,active:a.active,time:a.time,sounds:a.sounds,translations:a.translations});return{chapters:c,time:b.time,timeFrame:b._timeFrame,playing:b.playing,paused:b.paused}},b.getCurrentChapterCamera=function(){var a=b._findChapter(b.time);return a?a.flyTo||a.jumpTo:void 0}}(),function(){"use strict";Human.timeline.chapterLoader=new Human.utils.Loader,Human.timeline.chapterLoader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+g,i=this;Human.net.getChapterSetManifest(g,function(a){i._preprocessManifest(b,h,a),Human.utils.isArray(a.chapters)&&Human.timeline.addChapterSet(h,a.chapters),e()},function(a){f("failed to load chapters module '"+g+"': "+a.errorText+" - status: "+a.request.status)})},Human.timeline.chapterLoader._preprocessManifest=function(a,b,c){var d,e,f,g=c.chapters;if(Human.utils.isArray(g))for(e=0,f=g.length;f>e;e++)d=g[e],d.chapterId=b+e,this._preprocessChapter(a,d);else{e=0;for(var h in g)g.hasOwnProperty(h)&&(d=g[h],d.chapterId=b+e++,this._preprocessChapter(a,d))}},Human.timeline.chapterLoader._preprocessChapter=function(a,b){var c,d,e=b.sounds;if(e)for(c=0,d=e.length;d>c;c++){var f=e[c];f.soundId=a+"."+f.soundId}var g,h,i=b.showObjects;if(i)for(h in i)i.hasOwnProperty(h)&&h.indexOf("-")<0&&(g=a+"-"+h,i[g]=i[h],delete i[h]);var j=b.selectObjects;if(j)for(h in j)j.hasOwnProperty(h)&&h.indexOf("-")<0&&(g=a+"-"+h,j[g]=j[h],delete j[h]);var k=b.annotations;if(k){var l;for(c=0,d=k.length;d>c;c++)l=k[c],l.objectId&&l.objectId.indexOf("-")<0&&(l.objectId=a+"-"+l.objectId)}return{sounds:e,i:c,len:d,sound:f}},Human.timeline.chapterLoader._unload=function(a){Human.timeline.destroyChapterSet(a)}}(),function(){"use strict";Human.timeline.animationLoader=new Human.utils.Loader,Human.timeline.animationLoader.configure=function(a){return this._embedded=a.embedded,this},Human.timeline.animationLoader._animations={},Human.timeline.animationLoader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c,i=this;Human.net.getAnimationManifest(g,function(a){var c;if(!a.format)return c="'format' attribute expected in manifest for animation library '"+g+"'",Human.log.error("Human.timeline.animationLoader",c),void f(c);var j;switch(a.format){case"binary":j=Human.assets.morphs.loader;break;case"tween":j=Human.timeline.tweenAnimationLoader;break;default:return c="Unsupported value '"+a.format+"' for 'format' in manifest for animation library '"+g+"' - supported values are 'binary' and 'tween'",Human.log.error("Human.timeline.animationLoader",c),void f(c)}j.load(b,g,h,a,d,function(){i._animations[h]={loader:j},e()},f)},function(a){var b="Failed to load animation library '"+g+"': "+a;Human.log.error("Human.timeline.animationLoader",b),f(b)})},Human.timeline.animationLoader._unload=function(a){var b=this._animations[a];b&&(b.loader.unload(a),delete this._animations[a])}}(),function(){"use strict";function a(a,b){return b.indexOf(".")<0?a+"-"+b:b}var b=Human.timeline.tweenAnimationLoader={};b.load=function(b,c,d,e,f,g){var h,i,j,k,l,m,n,o=e.tweens||{},p=[];for(var q in o)if(o.hasOwnProperty(q)){if(h=o[q],!h.keys){Human.log.error("Human.timeline.tweenAnimationLoader","Tween attribute missing: 'keys'");continue}if(!h.targets){Human.log.error("Human.timeline.tweenAnimationLoader","Tween attribute missing: 'targets'");continue}if(h.keys.length<2||h.targets.length<2){Human.log.error("Human.timeline.tweenAnimationLoader","tween has insufficient keys or targets - minimum of two required");continue}if(h.keys.length!==h.targets.length){Human.log.error("Human.timeline.tweenAnimationLoader","tween has mismatching numbers of keys and targets");continue}if(h.options=Human.utils.applyIf(this.options,h.options||{}),i=h.type,!i){Human.log.error("Human.timeline.tweenAnimationLoader","Tween attribute missing: 'type'");continue}if(l=i.split(":"),j=l[0],k=l[1],"lerp"===j&&(j="tween"),!j||!k){Human.log.error("Human.timeline.tweenAnimationLoader","Tween attribute invalid: 'type'");continue}switch(k){case"objectAttr":m=new Human.timeline.ObjectControl({modelId:b,objectId:a(b,h.objectId||h.targetId)});break;case"objectXForm":m=new Human.timeline.ObjectTransformControl({modelId:b,objectId:a(b,h.objectId||h.targetId),initial:h.targets[0]});break;case"transform":m=new Human.timeline.TransformControl({modelId:b,transformId:a(b,h.transformId||h.targetId),initial:h.targets[0]});break;case"material":m=new Human.timeline.MaterialControl({modelId:b,materialId:a(b,h.materialId||h.targetId)});break;case"texture":m=new Human.timeline.TextureControl({modelId:b,materialId:a(b,h.materialId||h.targetId),targetLayer:h.targetLayer});break;case"camera":m=new Human.timeline.CameraControl;break;default:Human.log.error("Human.timeline.tweenAnimationLoader","Unsupported tween type: "+i);continue}switch(j){case"tween":n=new Human.timeline.Tween({keys:h.keys,targets:h.targets,control:m});break;case"switch":n=new Human.timeline.Switch({keys:h.keys,targets:h.targets,control:m});break;default:Human.log.error("Human.timeline.tweenAnimationLoader","Unsupported tween type: "+i);continue}p.push(n)}if(p.length>0){var r=new Human.timeline.TweenAnimation({tweens:p});Human.timeline.addAnimation(d,r)}g()},b.unload=function(a){Human.timeline.removeAnimation(a)}}(),function(){"use strict";Human.timeline.TweenAnimation=function(a){this._options=a.options||{},this._tweens=a.tweens,this.firstTime=1e6,this.lastTime=-1e6;for(var b,c=0,d=this._tweens.length;d>c;c++)b=this._tweens[c],b.firstTime<this.firstTime&&(this.firstTime=b.firstTime),b.lastTime>this.lastTime&&(this.lastTime=b.lastTime)},Human.timeline.TweenAnimation.prototype.update=function(a,b){for(var c=0,d=this._tweens.length;d>c;c++)this._tweens[c].update(a,b)},Human.timeline.TweenAnimation.prototype.destroy=function(){for(var a,b=0,c=this._tweens.length;c>b;b++)a=this._tweens[b],a.destroy&&a.destroy()}}(),function(){"use strict";function a(a){for(var b in a)if(a.hasOwnProperty(b)&&!Human.utils.isObject(a[b]))return!1;return!0}Human.timeline.Tween=function(b){this._control=b.control,this._tweenList=[];for(var c,d,e,f,g,h,i={},j=0,k=b.targets.length;k>j;j++){c=b.targets[j],d=b.keys[j],Human.utils.isObject(c.attr)&&a(c.attr)&&(c=c.attr),e=c;for(var l in e)e.hasOwnProperty(l)&&(f=e[l],g=i[l],g||(h=this._control.attr[l],g=new Human.timeline.TweenAttr(h,b.options),i[l]=g,this._tweenList.push(g)),g.addTarget(d,f))}this.firstTime=b.keys[0],this.lastTime=b.keys[b.keys.length-1]},Human.timeline.Tween.prototype.update=function(a,b){for(var c=0,d=this._tweenList,e=0,f=d.length;f>e;e++)d[e].update(a,b)&&c++;c>0&&this._control.update(a)}}(),function(){"use strict";function a(a,c,d,e){"number"!=typeof d&&(d=d.value),b(a,c,d,e)}function b(a,b,d,e){for(var f=Math.floor(50*(b-e)),g=0,h=1/f,i=new Array(f+1),j=0;f>=j;j++)i[j]=c(a,b,d,e,g),g+=h;a.lookUp=i}function c(a,b,c,d,e){var f=Math.pow,g=1-e,h=a.controlPoints,i=[d,h.x[0],h.x[1],b],j=[c,h.y[0],h.y[1],a.value];return 0>=e?{x:i[0],y:j[0]}:e>=1?{x:i[3],y:j[3]}:{x:i[0]*f(g,3)+3*i[1]*f(g,2)*f(e,1)+3*i[2]*f(g,1)*f(e,2)+i[3]*f(e,3),y:j[0]*f(g,3)+3*j[1]*f(g,2)*f(e,1)+3*j[2]*f(g,1)*f(e,2)+j[3]*f(e,3)}}function d(a,b,c,d,e){var f=(a-b)/(c-b),g=e-d,h=f*g;return d+h}function e(a,b){var c,e,f,g=b.lookUp,h=0,i=g.length-1;if(a<=g[h].x)return g[h].y;if(a>=g[i].x)return g[i].y;for(;i>=h;){if(c=Math.floor((h+i)/2),e=g[c],f=g[c+1],e.x<=a&&f.x>=a)return d(a,e.x,f.x,e.y,f.y);e.x>a?i=c-1:h=c+1}}Human.timeline.TweenAttr=function(a,b){this.attr=a,this.attrNames=null,b=b||{},this.keys=[],this.attrTargetLists={},this._tweens=[],this._key1=0,this._key2=1,this._firstKey=null,this._lastKey=null,this._keyDiff=null,this._loop=!!b.loop,this._timeOffset=b.timeOffset||0,this._paddingDirty=!0},Human.timeline.TweenAttr.prototype.addTarget=function(b,c){b+=this._timeOffset,this.keys.push(b);var d,e,f,g,h,i=this.keys.length-1;for(var j in c)if(c.hasOwnProperty(j)){if(d=this.attrTargetLists[j],!d){if(this.keys.length>1)throw"First target in tween must contain a value for each animated attribute on target";d=this.attrTargetLists[j]=[]}if(f=c[j],d[i]=f,"number"!=typeof f&&a(f,b,d[i-1],this.keys[i-1]),i>0)for(e=!1,g=i-1;!e&&g>=0;)h=d[g],void 0===h&&null===h?(d[g]=f,g--):e=!0}(null===this._firstKey||this._firstKey>b)&&(this._firstKey=b),(null===this._lastKey||this._lastKey<b)&&(this._lastKey=b),this._keyDiff=this._lastKey-this._firstKey,this._paddingDirty=!1},Human.timeline.TweenAttr.prototype._padTargets=function(){var a,b,c,d=this.attrTargetLists,e=this.keys.length;for(a in d)if(d.hasOwnProperty(a)){if(b=d[a],b.length===e)continue;for(c=b[b.length-1];b.length<e;)b.push(c)}this._paddingDirty=!1},Human.timeline.TweenAttr.prototype.update=function(a,b){this._paddingDirty&&this._padTargets();var c=this.keys,f=this.attrNames?this.attrNames:this.attrNames=Object.keys(this.attrTargetLists);if(this._loop)b=this._firstKey+b%this._keyDiff;else{if(b<c[0])return this._key1=0,this._key2=1,this._clampToTarget(f,0),!0;if(b>c[c.length-1])return this._key1=c.length-2,this._key2=this._key1+1,this._clampToTarget(f,this.keys.length-1),!0}for(;c[this._key1]>b;)this._key1--,this._key2--;for(;c[this._key2]<b;)this._key1++,this._key2++;var g,h,i,j,k,l,m=this.attrTargetLists,n=this._key1,o=this._key2,p=this.attr,q=!1;for(j=0,k=f.length;k>j;j++)l=f[j],g=m[l],h=g[n],"number"!=typeof h&&(h=h.value),i="number"==typeof g[o]?d(b,c[n],c[o],h,g[o]):e(b,g[o]),p[l]!==i&&(p[l]=i,q=!0);return q},Human.timeline.TweenAttr.prototype._clampToTarget=function(a,b){var c,d,e,f,g=this.attr,h=this.attrTargetLists;for(d=0,e=a.length;e>d;d++)f=a[d],c=h[f][b],"number"!=typeof c&&(c=c.value),g[f]=c}}(),function(){"use strict";var a=1,b=2,c=3,d=4;Human.timeline.Switch=function(a){this._keys=a.keys,this._targets=a.targets,this._control=a.control,this._options=a.options||{},this._key=0,this._lastKey=null,this.firstTime=a.keys[0],this.lastTime=a.keys[a.keys.length-1]},Human.timeline.Switch.prototype.update=function(d,e){var f=this._findTarget(e);switch(f){case a:return;case b:break;case c:}this._lastKey!==this._key&&(this._control.attr=this._targets[this._key],this._control.update(d),this._lastKey=this._key)},Human.timeline.Switch.prototype._findTarget=function(e){if(e<this._keys[0])return this._key=0,a;if(e===this._keys[0])return this._key=0,b;if(e>this._keys[this._keys.length-1])return this._key=this._keys.length-1,c;for(;this._keys[this._key]>e;)this._key--;for(;void 0!==this._keys[this._key+1]&&null!==this._keys[this._key+1]&&this._keys[this._key+1]<e;)this._key++;return d}}(),function(){"use strict";Human.timeline.CameraControl=function(){this.attr={up:{x:0,y:1,z:0},eye:{x:0,y:0,z:0},look:{x:0,y:0,z:0}}},Human.timeline.CameraControl.prototype.update=function(a){return a.cameraEnabled!==!1?(Human.view.camera.setLookAt(this.attr),!0):void 0}}(),function(){"use strict";Human.timeline.MaterialControl=function(a){this._materialId=a.modelId+"."+a.materialId,this.attr={baseColor:{r:0,g:0,b:0,a:1},specularColor:{r:1,g:1,b:1}}},Human.timeline.MaterialControl.prototype.update=function(){var a=Human.assets.materials.materials[this._materialId];return a?a.material?(a.material.set(this.attr),!0):void 0:void(this._targetMissing||(Human.log.error("Human.timeline.TweenAnimation","'material' tween can't find material: "+this._materialId),this._targetMissing=!0))}}(),function(){"use strict";function a(b,c){if(void 0!==c.opacity&&null!==c.opacity&&b.setOpacity(c.opacity),void 0!==c.pickable&&null!==c.pickable&&b.setPickable(c.pickable),void 0!==c.shown&&null!==c.shown&&b.show(c.shown),void 0!==c.transparent&&null!==c.transparent&&b.setTransparent(c.transparent),b.objects.length>0)for(var d=b.objects,e=0,f=d.length;f>e;e++)a(d[e],c)}Human.timeline.ObjectControl=function(a){var b=a.objectId;b.indexOf(".")<0&&b.indexOf("-")<0&&(b=a.modelId+"-"+a.objectId),this._objectId=b,this.attr={attr:{}}},Human.timeline.ObjectControl.prototype.update=function(){var b=Human.scene.objects[this._objectId];if(!b)return void(this._targetMissing||(Human.log.warn("Human.timeline.TweenAnimation","'lerp:objectAttr' tween can't find object: "+this._objectId),this._targetMissing=!0));var c=Human.timeline.showObjects[this._objectId];(void 0===c||null===c||c===!0)&&a(b,this.attr.attr)}}(),function(){"use strict";Human.timeline.ObjectTransformControl=function(a){var b=a.objectId,c=a.initial;b.indexOf(".")<0&&b.indexOf("-")<0&&(b=a.modelId+"-"+a.objectId),this._objectId=b;var d=this.attr={};["translate","rotate","scale","pivot"].forEach(function(a){var b="scale"===a?1:0;void 0!==c[a]&&(d[a]={},void 0!==c[a].x&&(d[a].x=b),void 0!==c[a].y&&(d[a].y=b),void 0!==c[a].z&&(d[a].z=b))})},Human.timeline.ObjectTransformControl.prototype.update=function(){var a=Human.scene.objects[this._objectId];if(!a)return void(this._targetMissing||(Human.log.warn("Human.timeline.ObjectTransformControl","Can't find object: "+this._objectId),this._targetMissing=!0));var b=Human.timeline.showObjects[this._objectId];(void 0===b||null===b||b===!0)&&a.setTransform(this.attr)}}(),function(){"use strict";Human.timeline.TextureControl=function(a){return this._material=a.modelId+"."+a.materialId,void 0===a.targetLayer||null===a.targetLayer?void Human.log.error("Human.timeline.TweenAnimation","'texture' tween attribute expected: 'targetLayer'"):(this._targetLayer=a.targetLayer,void(this.attr={rotate:{z:0},translate:{x:0,y:0},scale:{x:1,y:1},blend:{factor:1}}))},Human.timeline.TextureControl.prototype.update=function(){var a=Human.assets.materials.materials[this._material];if(!a)return void(this._targetMissing||(Human.log.error("Human.timeline.TweenAnimation","'material' tween can't find material: "+this._material),this._targetMissing=!0));var b=a.texture;if(b){var c={};c[""+this._targetLayer]={scale:this.attr.scale,translate:this.attr.translate,rotate:this.attr.rotate,blendFactor:this.attr.blend.factor},b.setLayers(c)}}}(),function(){"use strict";Human.timeline.TransformControl=function(a){var b=a.initial;this.transformId=a.modelId+"."+a.transformId;var c=this.attr={};["translate","rotate","scale","pivot"].forEach(function(a){var d="scale"===a?1:0;void 0!==b[a]&&(c[a]={},void 0!==b[a].x&&(c[a].x=d),void 0!==b[a].y&&(c[a].y=d),void 0!==b[a].z&&(c[a].z=d))})},Human.timeline.TransformControl.prototype.update=function(){var a=Human.assets.transforms.transforms[this.transformId];return a?void a.set(this.attr):void(this._targetMissing||(Human.log.error("Human.timeline.TransformControl","Can't find transform: "+this.transformId),this._targetMissing=!0))}}(),function(){"use strict";function a(){j=[],k=[],l=0}function b(a){0===j.length&&(l=0),k.push(a.time),j.push(a)}function c(a){l=a,e()}function d(){return k.length>0?k[k.length-1]:0}function e(){if(0!==j.length){if(l<=k[0])return void Human.view.camera.setLookAt(j[0]);if(l>=d()||1===j.length)return void Human.view.camera.setLookAt(j[j.length-1]);for(var a=0;k[a]<l;)++a;f(l,a-1)}}function f(a,b){var c=k[b],d=k[b+1],e=j[b],f=j[b+1];Human.view.camera.setLookAt({eye:g(a,c,d,e.eye,f.eye),look:g(a,c,d,e.look,f.look),up:g(a,c,d,e.up,f.up)})}function g(a,b,c,d,e){var f=(a-b)/(c-b),g=1-f;return{x:d.x*g+e.x*f,y:d.y*g+e.y*f,z:d.z*g+e.z*f}}var h=Human.timeline.chapterCameras={};h.pathMode=!1;var i=[],j=[],k=[],l=0,m=!0;Human.properties.subscribe({propId:"timeline.chapterCamerasEnabled",value:m,callback:function(a){m=!!a}}),Human.events.on("timeline.chapters.updated",function(c){a();for(var d,e,f=0,g=c.length;g>f;f++)d=c[f],e=d.flyTo||d.jumpTo,e&&(e.time=d.time,b(e));i=c}),Human.events.on("timeline.playing",function(a){m&&h.pathMode&&c(a.time)}),Human.events.on("timeline.scrubbed",function(a){m&&h.pathMode&&c(a.time)}),Human.events.on("timeline.chapters.activated",function(a){if(m&&!h.pathMode){var b=i[a.newChapterIndex];b&&(b.flyTo?Human.view.camera.fly.flyTo(b.flyTo):b.jumpTo&&Human.view.camera.fly.jumpTo(b.jumpTo))}})}(),function(){"use strict";function a(a){$(document).bind(a,i[a]=function(){e=!1,b()})}function b(){c&&(clearTimeout(c),c=null),d&&(c=setTimeout(function(){if(d&&!Human.timeline.playing&&!e){e=!0;var a=h[g]||h.play;a()}},1e3*f))}var c=null,d=!1,e=!1;Human.properties.subscribe({propId:"timeline.autoPlay.enabled",value:d,callback:function(a){d=!!a,d?b():e=!1}});var f=10;Human.properties.subscribe({propId:"timeline.autoPlay.timeoutSecs",value:f,callback:function(a){f=a}});var g="play",h={play:function(){Human.timeline.play({startTime:Human.timeline.time})},"chapter-rotate":function(){var a=5e3,b=function(){if(e)var b=Human.view.camera.eye.x,d=0,f=20,g=setInterval(function(){e||clearInterval(g),Human.view.camera.rotateY(.5);var h=Math.abs(b-Human.view.camera.eye.x);(.005>=h&&d>5*f||d>40*f)&&(clearInterval(g),setTimeout(c,a)),d++},f)},c=function(){e&&(Human.timeline.time===Human.timeline.getTimeFrame().lastTime?(Human.timeline.scrub({time:0}),setTimeout(b,a)):Human.timeline.next(),Human.events.once("timeline.stopped",function(){setTimeout(b,a)}))};c()}};Human.properties.subscribe({propId:"timeline.autoPlay.type",value:g,callback:function(a){g=a}}),Human.events.on("started",function(){b()}),Human.events.on("timeline.stopped",function(){b()});var i={};a("mousedown"),a("keydown"),a("mousewheel")}(),function(){"use strict";Human.rpc.define("timeline.query",function(){this.setResult(Human.timeline.query())}),Human.rpc.define("timeline.scrub",function(a){Human.timeline.scrub(a)}),Human.rpc.define("timeline.play",function(a){Human.timeline.play(a)}),Human.rpc.define("timeline.stop",function(){Human.timeline.stop()}),Human.rpc.define("timeline.prev",function(){Human.timeline.prev()}),Human.rpc.define("timeline.next",function(){Human.timeline.next()}),Human.rpc.define("timeline.pause",function(){Human.timeline.pause()}),Human.rpc.define("timeline.unpause",function(){Human.timeline.unpause()}),Human.rpc.define("timeline.getBookmark",function(){this.setResult(Human.timeline.getBookmark())}),Human.rpc.define("timeline.setBookmark",function(a){Human.timeline.setBookmark(a)})}(),Human.assets=Human.assets||{},function(){"use strict";var a=Human.assets.geometries={};a.geometries={},a.libraries={};var b;Human.events.on("loaded",function(){b=Human.renderer.getNode("assetLibraryRoot").addNode({type:"library",data:"Geometry library"})}),a.createLibrary=function(c){return a.libraries[c]?void Human.log.error("Human.assets.geometries.createLibrary","Geometry library already loaded: "+c):void(a.libraries[c]={node:b.addNode({type:"library",data:"libraryId = "+c}),libraryId:c,geometries:{}})},a.createGeometry=function(b,c,d){var e=a.libraries[b];if(!e)return void Human.log.error("Human.assets.geometries.createGeometry","Geometry library not found: "+b);if(a.geometries[c])return void Human.log.error("Human.assets.geometries.createGeometry","Geometry already loaded: "+c);if(!d.geometry)return void Human.log.error("Human.assets.geometries.createGeometry","Mandatory attribute 'geometryId' expected on geometry: "+c);d.geometry.type="geometry";var f={geometry:e.node.addNode(d.geometry),type:"geometry"};if(d.boundary){var g=d.boundary;f.boundary=g,f.center=[.5*(g.xmax+g.xmin),.5*(g.ymax+g.ymin),.5*(g.zmax+g.zmin)],f.axisBoundary=new Human.math.AxisBox3([g.xmin,g.ymin,g.zmin],[g.xmax,g.ymax,g.zmax])}a.geometries[c]=f,e.geometries[c]=f},a.destroyLibrary=function(b){if(b||""===b){var c=a.libraries[b];if(!c)return void Human.log.warn("Human.assets.geometries.destroyLibrary","Geometry library not found: "+b);c.node.destroy();for(var d in c.geometries)c.geometries.hasOwnProperty(d)&&delete a.geometries[d];delete a.libraries[b]}else a.reset()},a.reset=function(){for(var b in a.libraries)a.libraries.hasOwnProperty(b)&&a.destroyLibrary(b)}}(),function(){"use strict";function a(a){var b,c,d={numGeos:0,numArrays:0,positions:!1,indices:!1,uv:!1,uv2:!1,normals:!1};for(var e in a)a.hasOwnProperty(e)&&a[e]&&(d.numGeos++,b=a[e],b.geometry&&(c=b.geometry,c.positions&&!d.positions&&(d.positions=!0,d.numArrays++),c.indices&&!d.indices&&(d.indices=!0,d.numArrays++),c.normals&&!d.normals&&(d.normals=!0,d.numArrays++),c.uv&&!d.uv&&(d.uv=!0,d.numArrays++),c.uv2&&!d.uv2&&(d.uv2=!0,d.numArrays++),c.tangents&&(d.tangents=c.tangents)));return d}function b(a,b,c,d){function e(){g||c(h)}function f(a){g||(g=!0,d(a))}var g=!1,h={},i=b.numArrays,j=0;b.positions&&Human.net.getGeometryPositions(a,function(a){h.positions=a,++j===i&&e()},f),b.normals&&Human.net.getGeometryNormals(a,function(a){h.normals=a,++j===i&&e()},f),b.uv&&Human.net.getGeometryUVs(a,function(a){h.uv=a,++j===i&&e()},f),b.uv2&&Human.net.getGeometryUV2s(a,function(a){h.uv2=a,++j===i&&e()},f),b.indices&&Human.net.getGeometryIndices(a,function(a){h.indices=a,++j===i&&e()},f)}function c(a,b,c){c=c||0;var d=b[0]-c,e=d+b[1]-c;return a.subarray?a.subarray(d,e):a.slice(d,e)}function d(a){for(var b,c,d,e=1e5,f=1e5,g=1e5,h=-1e5,i=-1e5,j=-1e5,k=0,l=a.length-2;l>k;k+=3)b=a[k],c=a[k+1],d=a[k+2],void 0!==b&&null!==b&&void 0!==c&&null!==c&&void 0!==d&&null!==d&&(e>b&&(e=b),f>c&&(f=c),g>d&&(g=d),b>h&&(h=b),c>i&&(i=c),d>j&&(j=d));return{xmin:e,ymin:f,zmin:g,xmax:h,ymax:i,zmax:j}}var e=window.HumanGeometryLoaderBinary={};e.load=function(e,f,g,h,i){var j=a(g.geo);b(e,j,function(a){var b,e,i,j,k;Human.assets.geometries.createLibrary(f);for(var l in g.geo)g.geo.hasOwnProperty(l)&&(b=g.geo[l],e=b.geometry,i=f+"."+l,j=e.positions?c(a.positions,e.positions):null,k=e.indices?c(a.indices,e.indices):null,Human.assets.geometries.createGeometry(f,i,{materialId:b.materialId,geometry:{primitive:"triangles",positions:e.positions?j:null,normals:e.normals?c(a.normals,e.normals):null,uv:e.uv?c(a.uv,e.uv):null,uv2:e.uv2?c(a.uv2,e.uv2):null,indices:k,tangents:e.tangents},boundary:e.positions?d(j):null}));h()},i)}}(),function(){"use strict";function a(a,d,e,f,g){function h(){l||(k++,k>=j&&f())}Human.assets.geometries.createLibrary(d);var i=e.meshes;if(!i)return void g("Geometry manifest 'meshes' property expected");var j,k=0;j="number"==typeof i.length?i.length:b(i);var l=!1,m=g;if(g=function(a){l||(l=!0,m&&m(a))},Human.utils.isArray(i))for(var n=0;j>n;n++)c(d,a,i[n],h,g)}function b(a){var b=0;for(var c in a)a.hasOwnProperty(c)&&a[c]&&b++;return b}function c(a,b,c,e,f){var g,h="string"!=typeof c;if(h){if(!c.geo)return void f("failed to load 'geo' file for geometry module '"+b+"' a mesh is missing a 'geo' element");g=c.geo}else g=c;Human.net.getGeometryMesh(b,g,function(b){var c=a+"."+g;b.boundary=d(b.positions),Human.assets.geometries.createGeometry(a,c,{materialId:b.materialId,geometry:b}),e()},function(a){f("failed to load 'geo' file for geometry module '"+b+"' mesh '"+g+"': "+a.errorText+" - status: "+a.request.status)})}function d(a){for(var b,c,d,e=1e5,f=1e5,g=1e5,h=-1e5,i=-1e5,j=-1e5,k=0,l=a.length-2;l>k;k+=3)b=a[k],c=a[k+1],d=a[k+2],void 0!==b&&null!==b&&void 0!==c&&null!==c&&void 0!==d&&null!==d&&(e>b&&(e=b),f>c&&(f=c),g>d&&(g=d),b>h&&(h=b),c>i&&(i=c),d>j&&(j=d));return{xmin:e,ymin:f,zmin:g,xmax:h,ymax:i,zmax:j}}var e=window.HumanGeometryLoaderJSON={};e.load=function(b,c,d,e,f){a(b,c,d,e,function(){var a=!1;return function(b){a||(a=!0,f(b))}})}}(),function(){"use strict";Human.assets.geometries.loader=new Human.utils.Loader,Human.assets.geometries.loader.configure=function(a){return this._embedded=a.embedded,this},Human.assets.geometries.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c;Human.net.getGeometryManifest(g,function(a){if(!a.format)return void f("'format' expected in manifest for geometry module '"+g+"'");switch(a.format){case"json":HumanGeometryLoaderJSON.load(g,h,a,e,f);break;case"binary":HumanGeometryLoaderBinary.load(g,h,a,e,f);break;default:var b="Human.assets.geometries.loader - Unsupported value '"+a.format+"' for 'format' in manifest for geometry module '"+g+"' - supported values are 'json', 'binary' and 'tween'";Human.log.error(b),f(b)}},function(a){f("failed to load 'manifest' file for geometry module '"+g+"': "+a)})},Human.assets.geometries.loader._unload=function(a){Human.assets.geometries.destroyLibrary(a)}}(),function(){"use strict";var a=Human.assets.materials={};a.materials={},a.libraries={};var b;Human.events.on("loaded",function(){b=Human.renderer.getNode("assetLibraryRoot").addNode({type:"library",data:"Materials library"})}),a.findMaterial=function(b){var c=a.materials[b];return c?c:null},a.createLibrary=function(c){return a.libraries[c]?void Human.log.warn("Human.assets.materials.createLibrary","Material library already loaded: "+c):void(a.libraries[c]={node:b.addNode({type:"library",data:"libraryId = "+c}),libraryId:c,materials:{}})},a.createMaterial=function(b,c,d){var e=a.libraries[b];if(!e)return void Human.log.error("Human.assets.materials.createMaterial","Material library not found: "+b);if(a.materials[c])return void Human.log.warn("Human.assets.materials.createMaterial","Material already loaded: "+c);var f={};if(d.material){f.material=e.node.addNode(d.material),f.glassFactor=void 0!==d.material.glassFactor&&null!==d.material.glassFactor?d.material.glassFactor:1,f.murkiness=void 0!==d.material.murkiness&&null!==d.material.murkiness?d.material.murkiness:1;var g,h,i;d.material.baseFresnel&&(g=d.material.baseFresnel,f.fresnels=f.fresnels||{},h=void 0!==g.edge?g.edge:{r:1,g:1,b:1},i=void 0!==g.center?g.center:{r:0,g:0,b:0},f.fresnels.color=e.node.addNode({type:"fresnel",applyTo:"color",edgeBias:g.biasEdge,centerBias:g.biasCenter,power:g.power||1,edgeColor:h,centerColor:i})),d.material.alphaFresnel&&(g=d.material.alphaFresnel,f.fresnels=f.fresnels||{},h=void 0!==g.edge?g.edge:0,i=void 0!==g.center?g.center:1,f.fresnels.alpha=e.node.addNode({type:"fresnel",applyTo:"alpha",edgeBias:g.biasEdge,centerBias:g.biasCenter,power:g.power||1,edgeColor:{r:h,g:h,b:h},centerColor:{r:i,g:i,b:i}})),d.material.reflectionFresnel&&(g=d.material.reflectionFresnel,f.fresnels=f.fresnels||{},h=void 0!==g.edge?g.edge:1,i=void 0!==g.center?g.center:0,f.fresnels.reflect=e.node.addNode({type:"fresnel",applyTo:"reflect",centerBias:g.biasCenter,edgeBias:g.biasEdge,power:g.power||1,edgeColor:{r:h,g:h,b:h},centerColor:{r:i,g:i,b:i}})),d.material.specularFresnel&&(g=d.material.specularFresnel,f.fresnels=f.fresnels||{},h=void 0!==g.edge?g.edge:{r:0,g:0,b:0},i=void 0!==g.center?g.center:{r:1,g:1,b:1},f.fresnels.specular=e.node.addNode({type:"fresnel",applyTo:"specular",centerBias:g.biasCenter,edgeBias:g.biasEdge,power:g.power||1,edgeColor:h,centerColor:i})),d.material.emitFresnel&&(g=d.material.emitFresnel,f.fresnels=f.fresnels||{},h=void 0!==g.edge?g.edge:{r:0,g:0,b:0},i=void 0!==g.center?g.center:{r:1,g:1,b:1},f.fresnels.emit=e.node.addNode({type:"fresnel",applyTo:"emit",centerBias:g.biasCenter,edgeBias:g.biasEdge,power:g.power||1,edgeColor:h,centerColor:i})),d.material.fragmentFresnel&&(g=d.material.fragmentFresnel,f.fresnels=f.fresnels||{},h=void 0!==g.edge?g.edge:{r:0,g:0,b:0},i=void 0!==g.center?g.center:{r:1,g:1,b:1},f.fresnels.fragment=e.node.addNode({type:"fresnel",applyTo:"fragment",centerBias:g.biasCenter,edgeBias:g.biasEdge,power:g.power||1,edgeColor:h,centerColor:i}))}else f.glassFactor=1,f.murkiness=1;d.reflection&&(f.reflection=e.node.addNode({type:"reflect",coreId:d.reflection.getCoreId()})),d.texture&&(d.texture.type="_texture",f.texture=e.node.addNode(d.texture)),d.flags&&(f.flags=e.node.addNode(d.flags)),a.materials[c]=f,e.materials[c]=f},a.destroyLibrary=function(b){if(b||""===b){var c=a.libraries[b];if(!c)return void Human.log.warn("Human.assets.materials.destroyLibrary","Material library not found: "+b);c.node.destroy();for(var d in c.materials)c.materials.hasOwnProperty(d)&&delete a.materials[d];delete a.libraries[b]}else a.reset()},a.reset=function(){for(var b in a.libraries)a.libraries.hasOwnProperty(b)&&a.destroyLibrary(b);

}}(),function(){"use strict";Human.assets.materials.loader=new Human.utils.Loader,Human.assets.materials.loader.configure=function(a){return this._embedded=a.embedded,this},Human.assets.materials.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c,i=this;if(d&&d.manifest){var j=i._parseManifest(b,d.manifest,Human.net.getMaterialDir(g),null,null);Human.assets.materials.createLibrary(h);for(var k in j)j.hasOwnProperty(k)&&Human.assets.materials.createMaterial(h,h+"."+k,j[k]);e()}else Human.net.getMaterialLibrary(g,function(a){var c=i._parseManifest(b,a,Human.net.getMaterialDir(g),null,null);Human.assets.materials.createLibrary(h);for(var d in c)c.hasOwnProperty(d)&&Human.assets.materials.createMaterial(h,h+"."+d,c[d]);e()},function(a){f("failed to load manifest file for material module '"+g+"': "+a)})},Human.assets.materials.loader._parseManifest=function(a,b,c,d,e){d=d||{};var f,g;switch(b.id&&(e={},d[b.id]=e,b.id=null),b.type){case"texture":var h;for(f=0,g=b.layers.length;g>f;f++)h=b.layers[f],h.uri=h.uri||h.src,h.uri?this._embedded?h.uri+="?v="+Human.VERSION:h.uri=c+h.uri.substring(h.uri.lastIndexOf("/")+1)+"?v="+Human.VERSION:(h.uri=".",Human.log.error("Human.assets.materials.loader._parseManifest","Texture layer with no 'uri' or 'src' property")),h.preloadURI=h.preloadURI||h.preloadSrc,h.preloadURI&&(this._embedded?h.preloadURI+="?v="+Human.VERSION:h.preloadURI=c+h.preloadURI.substring(h.preloadURI.lastIndexOf("/")+1)+"?v="+Human.VERSION),h.blendMode=h.blendMode||"add";e&&(e.texture=b);break;case"material":if(e&&(e.material=b,b.reflectionId)){var i=b.reflectionId,j=Human.assets.reflections.findReflection(i);j?e.reflection=j.reflection:Human.log.error("Human.assets.materials.loader._parseManifest","Reflection not found: "+i)}break;case"flags":e&&(e.flags=b)}if(b.nodes)for(f=0,g=b.nodes.length;g>f;f++)this._parseManifest(a,b.nodes[f],c,d,e);return d},Human.assets.materials.loader._unload=function(a){Human.assets.materials.destroyLibrary(a)}}(),function(){"use strict";var a=Human.assets.transforms={};a.transforms={},a.libraries={},a.findTransform=function(b){var c=a.transforms[b];return c?c:null},a.createLibrary=function(b){return a.libraries[b]?void Human.log.warn("Human.assets.transforms.createLibrary","Transform library already loaded: "+b):void(a.libraries[b]={libraryId:b,transforms:{}})},a.createTransform=function(b,c,d){var e=a.libraries[b];if(!e)return void Human.log.error("Human.assets.transforms.createTransform","Transform library not found: "+b+", wont create transform");if(a.transforms[c])return void Human.log.warn("Human.assets.transforms.createTransform","Transform already loaded, not reloading: "+c);var f=new Human.assets.transforms.Transform(d);a.transforms[c]=f,e.transforms[c]=f},a.destroyLibrary=function(b){if(b||""===b){var c=a.libraries[b];if(!c)return void Human.log.warn("Human.assets.transforms.destroyLibrary","Transform library not found: "+b);for(var d in c.transforms)c.transforms.hasOwnProperty(d)&&delete a.transforms[d];delete a.libraries[b]}else a.reset()},a.reset=function(){for(var b in a.libraries)a.libraries.hasOwnProperty(b)&&a.destroyLibrary(b)}}(),function(){"use strict";Human.assets.transforms.Transform=function(a){this._init(),this.pivot={x:0,y:0,z:0},this.translate={x:0,y:0,z:0},this.scale={x:1,y:1,z:1},this.rotate={x:0,y:0,z:0},this.set(a)},Human.utils.extend(Human.assets.transforms.Transform,Human.Component),Human.assets.transforms.Transform.prototype.set=function(a){a.pivot&&(void 0!==a.pivot.x&&null!==a.pivot.x&&(this.pivot.x=a.pivot.x),void 0!==a.pivot.y&&null!==a.pivot.y&&(this.pivot.y=a.pivot.y),void 0!==a.pivot.z&&null!==a.pivot.z&&(this.pivot.z=a.pivot.z)),a.translate&&(void 0!==a.translate.x&&null!==a.translate.x&&(this.translate.x=a.translate.x),void 0!==a.translate.y&&null!==a.translate.y&&(this.translate.y=a.translate.y),void 0!==a.translate.z&&null!==a.translate.z&&(this.translate.z=a.translate.z)),a.scale&&(void 0!==a.scale.x&&null!==a.scale.x&&(this.scale.x=a.scale.x),void 0!==a.scale.y&&null!==a.scale.y&&(this.scale.y=a.scale.y),void 0!==a.scale.z&&null!==a.scale.z&&(this.scale.z=a.scale.z)),a.rotate&&(void 0!==a.rotate.x&&null!==a.rotate.x&&(this.rotate.x=a.rotate.x),void 0!==a.rotate.y&&null!==a.rotate.y&&(this.rotate.y=a.rotate.y),void 0!==a.rotate.z&&null!==a.rotate.z&&(this.rotate.z=a.rotate.z)),this.publish("updated")}}(),function(){"use strict";Human.assets.transforms.loader=new Human.utils.Loader,Human.assets.transforms.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c;Human.net.getTransformsLibrary(g,function(a){var b=a.transforms;if(!b)return void f("failed to load manifest file for transform module '"+g+"': 'transforms' element missing in manifest");Human.assets.transforms.createLibrary(h);for(var c in b)b.hasOwnProperty(c)&&Human.assets.transforms.createTransform(h,h+"."+c,b[c]);e()},function(a){f("failed to load manifest file for transform module '"+g+"': "+a)})},Human.assets.transforms.loader._unload=function(a){Human.assets.transforms.destroyLibrary(a)}}(),Human.media=Human.media||{},Human.media.Clips=function(a){"use strict";var b=this;this._streamType=a,this.clips={},this.clipsList=[],this.libraries={},this.suggestedClips=[],Human.events.fire(this._streamType+".clips",b.clipsList,!0),Human.events.fire(this._streamType+".suggestedClips",b.suggestedClips,!0);var c=function(a){var c,d,e=a.time,f=!1;b.suggestedClips.length=0;for(var g=0,h=b.clipsList.length;h>g;g++)d=b.clipsList[g],c=void 0!==d.time1&&null!==d.time1&&void 0!==d.time2&&null!==d.time2&&d.time1<=e&&e<=d.time2,f=f||c!==d.suggested,d.suggested=c,c&&b.suggestedClips.push(d.clipId);f&&Human.events.fire(b._streamType+".suggestedClips",b.suggestedClips,!0)};Human.events.on("timeline.scrubbed",c),Human.events.on("timeline.played",c),Human.events.on("timeline.stopped",c);var d=0;Human.events.on("timeline.playing",function(a){d%30===0&&(c(a),d=0),d+=1}),this.createLibrary=function(a,b){if(this.libraries[a])return void Human.log.warn("Human.media."+this._streamType+".createLibrary","Library already loaded: "+a);for(var c,d,e=this.libraries[a]={libraryId:a,clips:{}},f=0,g=b.length;g>f;f++)c=b[f],c.clipId?c.displayName?c.type?c.src?((void 0===c.time1||null===c.time1)&&(Human.log.error("Human.media."+this._streamType+".createLibrary","Clip property missing: time1 - defaulting to 0 seconds"),c.time1=0),(void 0===c.time2||null===c.time2)&&(Human.log.error("Human.media."+this._streamType+".createLibrary","Clip property missing: time2 - defaulting to 0 seconds"),c.time2=0),this.clips[c.clipId]&&Human.log.error("Human.media."+this._streamType+".createLibrary","Clip 'clipId' clashes with another clip: '"+c.clipId+"' - replacing existing clip"),d={clipId:c.clipId,displayName:c.displayName,description:c.description||"",time1:c.time1,time2:c.time2,type:c.type||"",src:c.src,alternatives:c.alternatives||[],length:c.length||0,suggested:!1,status:"closed"},e.clips[c.clipId]=d,this.clips[c.clipId]=d):Human.log.error("Human.media."+this._streamType+".createLibrary","Clip property missing: src"):Human.log.error("Human.media."+this._streamType+".createLibrary","Clip property missing: type"):Human.log.error("Human.media."+this._streamType+".createLibrary","Clip property missing: displayName"):Human.log.error("Human.media."+this._streamType+".createLibrary","Clip property missing: clipId");this._rebuildClipList()},this._rebuildClipList=function(){this.clipsList=[];for(var a in this.clips)this.clips.hasOwnProperty(a)&&this._insertClipIntoList(this.clipsList,this.clips[a]);Human.events.fire(this._streamType+".clips",this.clipsList,!0)},this._insertClipIntoList=function(a,b){if(0===a.length)a.push(b);else{for(var c,d=a.length-1;d>=0;d--)if(c=a[d],c.time1<b.time1)return void a.splice(d+1,0,b);a.splice(0,0,b)}},this.destroyLibrary=function(a){var b=this.libraries[a];if(!b)return void Human.log.warn("Human.media."+this._streamType+".destroyLibrary","Library not found: "+a);for(var c in b.clips)b.clips.hasOwnProperty(c)&&(delete this.clips[c],Human.events.fire(this._streamType+".status",{clipId:c,status:"destroyed"}));delete this.libraries[a],this._rebuildClipList()},this.open=function(a,b){Human.events.fire(this._streamType+".status",{clipId:a,status:"open"},!0),b()},this.play=function(a){Human.events.fire(this._streamType+".status",{clipId:a,status:"playing"},!0)},this.scrub=function(a,b){Human.events.fire(this._streamType+".scrubbed",{clipId:a,time:b})},this.pause=function(a){Human.events.fire(this._streamType+".status",{clipId:a,status:"paused"},!0)},this.stop=function(a){Human.events.fire(this._streamType+".status",{clipId:a,status:"stopped"},!0)},this.close=function(a){Human.events.fire(this._streamType+".status",{clipId:a,status:"closed"},!0)},this.reset=function(){for(var a in this.libraries)this.libraries.hasOwnProperty(a)&&this.destroyLibrary(a)}},Human.media.audio=new Human.media.Clips("audio"),function(){"use strict";Human.media.audio.loader=new Human.utils.Loader,Human.media.audio.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c,i=this;Human.net.getAudioLibrary(g,function(a){return i._preprocessManifest(g,a,Human.net.getAudioDir(g))?(Human.media.audio.createLibrary(h,a),void e()):void e()},function(a){f("failed to load manifest file for audio library '"+g+"': "+a)})},Human.media.audio.loader._preprocessManifest=function(){return!0},Human.media.audio.loader._unload=function(a){Human.media.audio.destroyLibrary(a)}}(),function(){"use strict";Human.rpc.define("audio.getClips",function(){this.setResult(Human.media.audio.clipsList)}),Human.rpc.define("audio.open",function(a){var b=this;Human.media.audio.open(a.clipId,function(){b.setResult(!0)})}),Human.rpc.define("audio.play",function(a){Human.media.audio.play(a.clipId)}),Human.rpc.define("audio.scrub",function(a){Human.media.audio.scrub(a.clipId,a.time)}),Human.rpc.define("audio.pause",function(a){Human.media.audio.pause(a.clipId)}),Human.rpc.define("audio.stop",function(a){Human.media.audio.stop(a.clipId)}),Human.rpc.define("audio.close",function(a){Human.media.videos.close(a.clipId)})}(),Human.media.videos=new Human.media.Clips("videos"),function(){"use strict";Human.media.videos.loader=new Human.utils.Loader,Human.media.videos.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c;Human.net.getVideosLibrary(g,function(a){Human.media.videos.createLibrary(h,a),e()},function(a){f("failed to load manifest file for video library '"+g+"': "+a)})},Human.media.videos.loader._unload=function(a){Human.media.videos.destroyLibrary(a)}}(),function(){"use strict";Human.rpc.define("videos.getClips",function(){this.setResult(Human.media.videos.clipsList)}),Human.rpc.define("videos.open",function(a){var b=this;Human.media.videos.open(a.clipId,function(){b.setResult(!0)})}),Human.rpc.define("videos.play",function(a){Human.media.videos.play(a.clipId)}),Human.rpc.define("videos.scrub",function(a){Human.media.videos.scrub(a.clipId,a.time)}),Human.rpc.define("videos.pause",function(a){Human.media.videos.pause(a.clipId)}),Human.rpc.define("videos.stop",function(a){Human.media.videos.stop(a.clipId)}),Human.rpc.define("videos.close",function(a){Human.media.videos.close(a.clipId)})}(),function(){"use strict";var a=Human.assets.morphs={};a.morphs={},a.libraries={};var b;Human.events.on("loaded",function(){b=Human.renderer.getNode("assetLibraryRoot").addNode({type:"library",data:"Morphs library"})}),a.findMorph=function(b){var c=a.morphs[b];return c?c:null},a.createLibrary=function(c){return a.libraries[c]?void Human.log.warn("Human.assets.morphs","Morph library already loaded: "+c):(a.libraries[c]={node:b.addNode({type:"library",data:"libraryId = "+c}),libraryId:c,morphs:{}},a.libraries[c])},a.createMorph=function(b,c,d){var e=a.libraries[b];if(!e)return void Human.log.error("morph library not found: "+b);var f=a.morphs[c];return f?(Human.log.warn("Human.assets.morphs.createMorph","Morph already loaded: "+c),f):(f={type:"morph",boundary:null,center:null,axisBoundary:null,_frameDirty:!0,updateBoundary:function(){if(this._frameDirty){for(var a,b,c,d,e,f,g,h,i,j={xmin:1e5,ymin:1e5,zmin:1e5,xmax:-1e5,ymax:-1e5,zmax:-1e5},k=this.morphGeometry.getCurrentFrame(),l=k.target1.positions,m=k.target2.positions,n=k.factor,o=0,p=l.length-2;p>o;o+=3)a=l[o],b=l[o+1],c=l[o+2],d=m[o],e=m[o+1],f=m[o+2],"number"==typeof a&&"number"==typeof b&&"number"==typeof c&&"number"==typeof d&&"number"==typeof e&&"number"==typeof f&&(g=a+n*(d-a),h=b+n*(e-b),i=c+n*(f-c),j.xmin=Math.min(j.xmin,g),j.ymin=Math.min(j.ymin,h),j.zmin=Math.min(j.zmin,i),j.xmax=Math.max(j.xmax,g),j.ymax=Math.max(j.ymax,h),j.zmax=Math.max(j.zmax,i));this.boundary=j,this.axisBoundary=new Human.math.AxisBox3([j.xmin,j.ymin,j.zmin],[j.xmax,j.ymax,j.zmax]),this.center=[.5*(j.xmax+j.xmin),.5*(j.ymax+j.ymin),.5*(j.zmax+j.zmin)],this._frameDirty=!1}}},d.morphGeometry&&(d.morphGeometry.type="morphGeometry",f.morphGeometry=e.node.addNode(d.morphGeometry),f.morphGeometry.on("update",function(){f._frameDirty=!0})),f.updateBoundary(),a.morphs[c]=f,e.morphs[c]=f,f)},a.destroyLibrary=function(b){if(b||""===b){var c=a.libraries[b];if(!c)return void Human.log.warn("Human.assets.morphs.destroyLibrary","Morph library not found: "+b);c.node.destroy();for(var d in c.morphs)c.morphs.hasOwnProperty(d)&&delete a.morphs[d];delete a.libraries[b]}else a.reset()},a.reset=function(){for(var b in a.libraries)a.libraries.hasOwnProperty(b)&&a.destroyLibrary(b)}}(),function(){"use strict";Human.assets.morphs.Animation=function(a){this.type="morph-animation",this._loop=a.loop!==!1,this._morphList=[],this.timeline=a.timeline,this.firstTime=null,this.lastTime=null},Human.assets.morphs.Animation.prototype.addMorph=function(a,b,c){this._morphList.push({firstTime:a,lastTime:b,update:c})},Human.assets.morphs.Animation.prototype.calculateTimeFrame=function(){for(var a,b=1e6,c=-1e6,d=this._morphList,e=0,f=this._morphList.length;f>e;e++)a=d[e],a.firstTime<b&&(b=a.firstTime),a.lastTime>c&&(c=a.lastTime);this.firstTime=b,this.lastTime=c},Human.assets.morphs.Animation.prototype.update=function(a,b){for(var c,d,e=0,f=this._morphList.length;f>e;e++)c=this._morphList[e],this._loop?d=b===c.lastTime?b:c.firstTime+b%(c.lastTime-c.firstTime):(d<c.firstTime&&(d=c.firstTime),d>c.lastTime&&(d=c.lastTime)),c.update(d)},Human.assets.morphs.Animation.prototype.destroy=function(){this.destroyed=!0}}(),function(){"use strict";function a(a){var b,c,d={numMorphs:0,numArrays:0,positions:!1,uv:!1,uv2:!1,normals:!1};for(var e in a)a.hasOwnProperty(e)&&a[e]&&(d.numMorphs++,b=a[e],b.targets&&(c=b.targets,c.positions&&!d.positions&&(d.positions=!0,d.numArrays++),c.normals&&!d.normals&&(d.normals=!0,d.numArrays++),c.uv&&d.uv&&(d.uv=!0,d.numArrays++),c.uv2&&d.uv2&&(d.uv2=!0,d.numArrays++)));return d}function b(a,b,c,d){function e(){g||c(h)}function f(a){g||(g=!0,d(a))}var g=!1,h={},i=b.numArrays,j=0;b.positions&&Human.net.getMorphPositions(a,function(a){h.positions=a,++j===i&&e()},f),b.normals&&Human.net.getMorphNormals(a,function(a){h.normals=a,++j===i&&e()},f),b.uv&&Human.net.getMorphUVs(a,function(a){h.uv=a,++j===i&&e()},f),b.uv2&&Human.net.getMorphUV2s(a,function(a){h.uv2=a,++j===i&&e()},f)}function c(a,b){var c=b[0],d=c+b[1];return a.subarray?a.subarray(c,d):a.slice(c,d)}function d(a,b,c){var d=b.morphGeometry;a.addMorph(c[0],c[c.length-1],function(a){d.setFactor(a)})}var e=Human.assets.morphs.loader={};e.load=function(e,f,g,h,i,j,k){var l=a(h.morphs);b(f,l,function(a){Human.assets.morphs.createLibrary(g),i.timeline=void 0!==i.timeline&&null!==i.timeline?i.timeline:h.timeline;var b,e,f,k,l,m,n,o,p=new Human.assets.morphs.Animation(i);for(var q in h.morphs)if(h.morphs.hasOwnProperty(q)){e=h.morphs[q],b=g+"."+q,f=e.targets,k=e.keys.length,l=f.positions[1]/k,m=f.normals[1]/k;var r=e.keys,s=[];n=f.positions[0],o=f.normals[0];for(var t=0;k>t;t++){var u=c(a.positions,[n,l]);s.push({positions:u,normals:c(a.normals,[o,m])}),n+=l,o+=m}var v=Human.assets.morphs.createMorph(g,b,{morphGeometry:{targets:s,keys:r}});d(p,v,r)}p.calculateTimeFrame(),Human.timeline.addAnimation(g,p),j()},k)},e.unload=function(a){Human.assets.morphs.destroyLibrary(a),Human.timeline.removeAnimation(a)}}(),function(){"use strict";var a=Human.assets.reflections={};a.reflections={},a.libraries={},a.active={};var b;Human.events.on("loaded",function(){b=Human.renderer.getNode("assetLibraryRoot").addNode({type:"library",data:"Reflections library"})}),a.exportReflections=function(b){a.active=b||{}},a.findReflection=function(b){var c=a.active[b];return c?a.reflections[c]:null},a.createLibrary=function(c){return a.libraries[c]?void Human.log.warn("Human.assets.reflections.createLibrary","Reflection library already loaded: "+c):void(a.libraries[c]={node:b.addNode({type:"library",data:"libraryId = "+c}),libraryId:c,reflections:{}})},a.createReflection=function(b,c,d){var e=a.libraries[b];if(!e)return void Human.log.error("Human.assets.reflections.createReflection","Reflection library not found: "+b);if(a.reflections[c])return void Human.log.warn("Human.assets.reflections.createReflection","Reflection already loaded: "+c);d.type="reflect",d.blendMode=d.blendMode||"add";var f={reflection:e.node.addNode(d)};a.reflections[c]=f,e.reflections[c]=f},a.destroyLibrary=function(b){if(b||""===b){var c=a.libraries[b];if(!c)return void Human.log.warn("Human.assets.reflections.destroyLibrary","Reflection library not found: "+b);c.node.destroy();for(var d in c.reflections)c.reflections.hasOwnProperty(d)&&delete a.reflections[d];delete a.libraries[b]}else a.reset()},a.reset=function(){for(var b in a.libraries)a.libraries.hasOwnProperty(b)&&a.destroyLibrary(b)}}(),function(){"use strict";Human.assets.reflections.loader=new Human.utils.Loader,Human.assets.reflections.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c;Human.net.getReflectionsLibrary(g,function(a){Human.assets.reflections.createLibrary(h);var b,c,d=Human.net.getReflectionsDir(g);for(var f in a)if(a.hasOwnProperty(f)){if(b=a[f],c=b.src,!c){Human.log.error("Human.assets.reflections.loader","Reflection property missing: src");continue}if(!Human.utils.isArray(c)){Human.log.error("Human.assets.reflections.loader","Reflection property should be array: src");continue}for(var i=0,j=c.length;j>i;i++){var k=c[i];c[i]=d+k.substring(k.lastIndexOf("/")+1)+"?v="+Human.VERSION}Human.assets.reflections.createReflection(h,h+"."+f,b)}Human.renderer.forceRenderFrame(),e()},function(a){f("failed to load manifest file for reflections library '"+g+"': "+a)})},Human.assets.reflections.loader._unload=function(a){Human.assets.reflections.destroyLibrary(a)}}(),function(){"use strict";var a=Human.assets.regionMaps={};a.maps={},a.libraries={};var b;Human.events.on("loaded",function(){b=Human.renderer.getNode("assetLibraryRoot").addNode({type:"library",data:"Region Map library"})}),a.createLibrary=function(c){return a.libraries[c]?void Human.log.warn("Human.assets.regionMaps.createLibrary","Region map library already loaded: "+c):void(a.libraries[c]={node:b.addNode({type:"library",data:"libraryId = "+c}),libraryId:c,maps:{}})},a.createRegion=function(b,c,d){var e=a.libraries[b];if(!e)return void Human.log.error("Human.assets.regions.createRegion","Region library not found: "+b);if(a.maps[c])return void Human.log.warn("Human.assets.regions.createRegion","Region already loaded: "+c);var f={node:e.node.addNode({type:"regionMap",src:d.src,mode:d.mode||"highlight",regionData:d.regions,highlightFactor:d.highlightFactor||{r:1.2,g:1.2,b:1.2},hideAlpha:d.hideAlpha||0}),regionMapId:c};a.maps[c]=f,e.maps[c]=f},a.highlightRegion=function(b){b=b||{};var c,d=b.regionColor,e=b.regionMapId,f=b.highlight,g=a.maps;if(e)c=g[e],c.node.setRegionColor(f?d:{r:-1,g:-1,b:-1});else for(e in g)g.hasOwnProperty(e)&&(c=g[e],c.node.setRegionColor(f?d:{r:-1,g:-1,b:-1}))},a.destroyLibrary=function(b){if(b||""===b){var c=a.libraries[b];if(!c)return void Human.log.warn("Human.assets.regions.destroyLibrary","Region library not found: "+b);c.node.destroy();for(var d in c.maps)c.maps.hasOwnProperty(d)&&delete a.maps[d];delete a.libraries[b]}else a.reset()},a.reset=function(){for(var b in a.libraries)a.libraries.hasOwnProperty(b)&&a.destroyLibrary(b)}}(),function(){"use strict";Human.assets.regionMaps.loader=new Human.utils.Loader,Human.assets.regionMaps.loader._load=function(a,b,c,d,e,f){var g=c,h=b+"."+c;Human.net.getRegionsLibrary(g,function(a){Human.assets.regionMaps.createLibrary(h);var b,c,d=Human.net.getRegionsDir(g);for(var f in a)if(a.hasOwnProperty(f)){if(b=a[f],c=b.src,!c){Human.log.error("Human.assets.regionMaps.loader","Region property missing: src");continue}b.src=d+c.substring(c.lastIndexOf("/")+1)+"?v="+Human.VERSION,Human.assets.regionMaps.createRegion(h,h+"."+f,b)}Human.renderer.forceRenderFrame(),e()},function(a){f("failed to load manifest file for regions library '"+g+"': "+a)})},Human.assets.regionMaps.loader._unload=function(a){Human.assets.regionMaps.destroyLibrary(a)}}(),function(){"use strict";function a(c,d,e){return 0===d.length?void e():void b(c,d.shift(),function(){a(c,d,e)})}function b(a,b,d){Human.net.setActiveModel(b),Human.net.getStateIndex(function(e){c(a,b,e,d)},function(a){Human.renderer.popPause(),Human.log.error("[Human.models.loadModel] Failed to load index for model '"+b+"': "+a)})}function c(a,b,c,f){var i=c.data||{};Human.view.dissect.reset();var j=[];i.reflections&&d(a,b,j,i.reflections,Human.assets.reflections.loader),i.skyboxes&&d(a,b,j,i.skyboxes,Human.view.skyboxes.loader),i.regionMaps&&d(a,b,j,i.regionMaps,Human.assets.regionMaps.loader),(i.material||i.materials)&&d(a,b,j,i.material||i.materials,Human.assets.materials.loader),i.transforms&&d(a,b,j,i.transforms,Human.assets.transforms.loader),i.sounds&&d(a,b,j,i.sounds,Human.media.audio.loader),i.videos&&d(a,b,j,i.sounds,Human.media.videos.loader),i.geometries&&d(a,b,j,i.geometries,Human.assets.geometries.loader),i.animations&&d(a,b,j,i.animations,Human.timeline.animationLoader),i.chapters&&d(a,b,j,i.chapters,Human.timeline.chapterLoader),i.anatomies&&d(a,b,j,i.anatomies,Human.scene.loader),i.lights&&d(a,b,j,i.lights,Human.view.lights.loader),i.videos&&d(a,b,j,i.videos,Human.media.videos.loader),i.audio&&d(a,b,j,i.audio,Human.media.audio.loader),e(j,function(){Human.scene.objectLoader.load(a,b,i.createObjects),b&&(g.models.push({modelId:b}),h[b]=!0),f()})}function d(a,b,c,d,e){for(var g in d)d.hasOwnProperty(g)&&c.unshift(f(g,a,b,c,d,e))}function e(a,b){return 0===a.length?void b():void a.pop()(function(){e(a,b)})}function f(a,b,c,d,e,f){var g=a,h=e[a];return function(a){try{f.load(b,c,g,h,function(){a()},function(b){Human.log.error("Human.models.loadModel","Failed to load model '"+c+"' library '"+g+"': "+b),a()})}catch(d){Human.log.error("Human.models.loadModel","Failed to load model '"+c+"' library '"+g+"': "+d),a()}}}var g=Human.models={};g.models=[];var h={};g.loadModels=function(b,c,d){var e=b.moduleId;if(!e)return void d("[Human.models.loadModel] Param missing: 'moduleId'");var f=b.modelIds,g=f.length;return f=f.filter(function(a){return!h[a]}),0===f.length?void(c&&c()):(Human.renderer.pushPause(),void f.forEach(function(d){Human.net.openModel(d,b.streamObjects,function(){0===--g&&a(e,Array.prototype.slice.call(f),function(){Human.renderer.popPause(),Human.renderer.onTasksComplete(function(){Human.net.clearModelData(),c()})})},function(a){Human.renderer.popPause(),Human.log.error("[Human.models.loadModel] Failed to open source stream/directory for model '"+d+"': "+a)})}))},g.unloadAllModels=function(){for(;g.models.length;)g.unloadModel(g.models.pop().modelId)},g.unloadModel=function(a){for(var b,c=0,d=g.models.length;d>c;c++)if(b=g.models[c],b.modelId===a)return Human.assets.materials.loader.unload(a),Human.assets.geometries.loader.unload(a),Human.assets.transforms.loader.unload(a),Human.assets.reflections.loader.unload(a),Human.view.skyboxes.loader.unload(a),Human.assets.regionMaps.loader.unload(a),Human.timeline.animationLoader.unload(a),Human.timeline.chapterLoader.unload(a),Human.scene.loader.unload(a),Human.scene.objectLoader.unload(a),Human.view.lights.loader.unload(a),Human.media.videos.loader.unload(a),Human.media.audio.loader.unload(a),g.models.splice(c,1),delete h[a],void Human.renderer.forceRenderFrame()}}(),function(){"use strict";function a(a,b){return a?a[b]===!0?!0:a[b]===!1?!1:!1:!0}function b(){var a=Human.modules.db.moduleLibs,b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(c);return b}function c(){var a=[];if(Human.modules.numActiveModules>0){var b=Human.modules.activeModules;for(var c in b)b.hasOwnProperty(c)&&a.push(c)}return a}function d(){return Human.view.camera.getLookAt()}function e(){return{dissect:Human.view.dissect.getEnabled(),highlight:Human.view.highlight.getEnabled(),isolate:Human.view.isolate.getEnabled(),labels:Human.view.labels.getEnabled(),xray:Human.view.xray.getEnabled(),singlePick:Human.view.pick.getSinglePickEnabled(),multiPick:Human.view.pick.getMultiPickEnabled()}}function f(){var a,b=Human.view.clip.clips,c={};for(var d in b)b.hasOwnProperty(d)&&(a=b[d],c[d]={clipId:a.clipId,type:a.type,progress:a.progress,state:a.state});return c}function g(){var a,b,c,d={},e=Human.scene,f=e.objects,g=e.enabledObjects,i=e.selectedObjects;for(var j in f)f.hasOwnProperty(j)&&(a=f[j],c=null,b=h(a),b&&(c={transform:b}),0===a.objects.length&&(c=c||{},c.enabled=!!g[j],c.selected=!!i[j]),c&&(d[j]=c));return d}function h(a){var b={};return 0!==a.pivot.x&&(b.pivot=b.pivot||{},b.pivot.x=a.pivot.x),0!==a.pivot.y&&(b.pivot=b.pivot||{},b.pivot.y=a.pivot.y),0!==a.pivot.z&&(b.pivot=b.pivot||{},b.pivot.z=a.pivot.z),0!==a.translate.x&&(b.translate=b.translate||{},b.translate.x=a.translate.x),0!==a.translate.y&&(b.translate=b.translate||{},b.translate.y=a.translate.y),0!==a.translate.z&&(b.translate=b.translate||{},b.translate.z=a.translate.z),1!==a.scale.x&&(b.scale=b.scale||{},b.scale.x=a.scale.x),1!==a.scale.y&&(b.scale=b.scale||{},b.scale.y=a.scale.y),1!==a.scale.z&&(b.scale=b.scale||{},b.scale.z=a.scale.z),0!==a.rotate.x&&(b.rotate=b.rotate||{},b.rotate.x=a.rotate.x),0!==a.rotate.y&&(b.rotate=b.rotate||{},b.rotate.y=a.rotate.y),0!==a.rotate.z&&(b.rotate=b.rotate||{},b.rotate.z=a.rotate.z),Object.keys(b).length>0?b:null}function i(){var a,b,c=[],d=Human.view.annotations.annotations,e=Array.prototype.slice;for(var f in d)d.hasOwnProperty(f)&&(a=d[f],a.saved&&(b={annotationId:f,title:a.label.title,description:a.label.description,pos:e.call(a.pin.pos),pinVec:e.call(a.pin.dir),shown:a.pin.shown,labelShown:a.label.shown,labelOffset:e.call(a.label.offset),occludable:a.occludable},a.object&&(b.objectId=a.object.objectId),c.push(b)));return c}function j(a){var b;if(a.params||a.states){var c,d=[],e=!1,f=!1;if(a.params&&(c=a.params.stateId,"maleAdult"===c?(c="production/maleAdult/maleAdult.json",e=!0):"femaleAdult"===c&&(c="production/femaleAdult/femaleAdult.json",f=!0),d.push(c),b=!0),a.states){for(var g=0,h=a.states.length;h>g;g++)c=a.states[g].stateId,"maleAdult"===c?(c="production/maleAdult/maleAdult.json",e=!0):"femaleAdult"===c?(c="production/femaleAdult/femaleAdult.json",f=!0):e?c="production/maleAdult/"+c+".json":f&&(c="production/femaleAdult/"+c+".json"),d.push(c);b=!0}a.modules={moduleLibs:["anatomies.json","production.json"],activeModules:d}}return b}function k(a){for(var b={},c=0,d=a.length;d>c;c++)b[a[c]]=!0;for(var e in Human.modules.activeModules)Human.modules.activeModules.hasOwnProperty(e)&&(b[e]||Human.modules.deactivateModules({moduleId:e}))}function l(a){for(var b,c=[],d=0,e=a.length;e>d;d++)b=a[d],Human.modules.activeModules[b]||c.push(b);return c}function m(a,b){Human.modules.db.loadModuleLibs(a,b)}function n(a,b){if(a.length>0){var c=a.shift();Human.modules.activeModules[c]?n(a,b):Human.modules.activateModules({moduleId:c},function(){n(a,b)})}else b()}function o(a,b){a.annotations&&y(a.annotations,a.is_owner),a.clips&&r(a.clips),a.objects&&s(a.objects,b),a.modes&&q(a.modes),a.camera&&p(a.camera),a.timeline?Human.timeline.setBookmark(a.timeline):Human.timeline.stop()}function p(a){a=a||{},Human.view.camera.fly.jumpTo({up:Human.utils.apply(a.up,{x:0,y:1,z:0}),eye:Human.utils.apply(a.eye,{x:0,y:0,z:-100}),look:Human.utils.apply(a.look,{x:0,y:0,z:0})})}function q(a){void 0!==a.dissect&&null!==a.dissect,void 0!==a.highlight&&null!==a.highlight&&Human.rpc.call(null,"highlight.setEnabled",{enable:a.highlight}),Human.scene.anySelected()&&a.isolate?void 0!==a.isolate&&null!==a.isolate&&Human.rpc.call(null,"isolate.setEnabled",{enable:a.isolate}):void 0!==a.isolate&&null!==a.isolate&&Human.rpc.call(null,"isolate.setEnabled",{enable:!1}),void 0!==a.labels&&null!==a.labels&&Human.rpc.call(null,"labels.setEnabled",{enable:a.labels}),void 0!==a.singlePick&&null!==a.singlePick&&Human.rpc.call(null,"pick.single.setEnabled",{enable:a.singlePick}),void 0!==a.multiPick&&null!==a.multiPick&&Human.rpc.call(null,"pick.multi.setEnabled",{enable:a.multiPick}),void 0!==a.xray&&null!==a.xray&&Human.rpc.call(null,"xray.setEnabled",{enable:a.xray})}function r(a){Human.view.clip.reset();for(var b in a)a.hasOwnProperty(b)&&Human.view.clip.setClip(a[b])}function s(a,b){t(a,b),u(a,b),v(a)}function t(a,b){Human.scene.setEnabledObjects({objectIds:x(a,"enabled"),replace:!b})}function u(a,b){Human.scene.setSelectedObjects({objectIds:x(a,"selected"),replace:!b})}function v(a){a=a||{};var b,c,d;for(c in a)a.hasOwnProperty(c)&&(b=Human.scene.objects[c],d=a[c].transform,b&&d&&b.setTransform(w(b,d)))}function w(a,b){return b.pivot=b.pivot||{},b.translate=b.translate||{},b.scale=b.scale||{},b.rotate=b.rotate||{},b.pivot.x=void 0===b.pivot.x?a.pivot.x:b.pivot.x,b.pivot.y=void 0===b.pivot.y?a.pivot.y:b.pivot.y,b.pivot.z=void 0===b.pivot.z?a.pivot.z:b.pivot.z,b.translate.x=void 0===b.translate.x?a.translate.x:b.translate.x,b.translate.y=void 0===b.translate.y?a.translate.y:b.translate.y,b.translate.z=void 0===b.translate.z?a.translate.z:b.translate.z,b.scale.x=void 0===b.scale.x?a.scale.x:b.scale.x,b.scale.y=void 0===b.scale.y?a.scale.y:b.scale.y,b.scale.z=void 0===b.scale.z?a.scale.z:b.scale.z,b.rotate.x=void 0===b.rotate.x?a.rotate.x:b.rotate.x,b.rotate.y=void 0===b.rotate.y?a.rotate.y:b.rotate.y,b.rotate.z=void 0===b.rotate.z?a.rotate.z:b.rotate.z,b}function x(a,b){var c,d={};a=a||{};var e;for(var f in a)if(a.hasOwnProperty(f)){if(e=Human.scene.objects[f],!e)continue;c=a[f][b],(c===!0||c===!1)&&(d[f]=c)}return d}function y(a,b){var c;b="undefined"==typeof b?!1:b;for(var d=0,e=a.length;e>d;d++)c=a[d],Human.view.annotations.createAnnotation({annotationId:c.annotationId,objectId:c.objectId,title:c.title||"",description:c.description||"",pos:c.offset||c.pos,dir:c.pinVec,shown:c.shown,type:c.type,labelShown:c.labelShown,labelOffset:c.labelOffset,saved:!0,isOwner:b,occludable:c.occludable})}var z=Human.bookmarks={};z.capture=function(h){var j={};return a(h,"modules")&&(j.modules={moduleLibs:b(),activeModules:c()}),a(h,"camera")&&(j.camera=d()),a(h,"modes")&&(j.modes=e()),a(h,"clips")&&(j.clips=f()),a(h,"objects")&&(j.objects=g()),a(h,"annotations")&&(j.annotations=i()),a(h,"timeline")&&(j.timeline=Human.timeline.getBookmark()),j},z.restore=function(a,b,c){b=b||function(){},Human.events.fire("bookmarks.restoring");var d;if(c||(d=j(a)),Human.view.annotations.clearAnnotations(),a.modules){var e=a.modules.activeModules;e&&(k(e),e=l(e)),Human.rpc.call(null,"highlight.setEnabled",{enable:!0}),Human.rpc.call(null,"pick.single.setEnabled",{enable:!0}),Human.view.camera.fly.jumpTo({up:{x:0,y:1,z:0},eye:{x:0,y:0,z:-100},look:{x:0,y:0,z:0}});var f=a.modules.moduleLibs||[];m(f.slice(0),function(){e?n(e.slice(0),function(){o(a,d),Human.events.fire("bookmarks.restored",a),b()}):(o(a,d),Human.events.fire("bookmarks.restored",a),b())})}else o(a,d),Human.events.fire("bookmarks.restored",a),b()}}(),function(){"use strict";var a=Human.bookmarks.db={},b={enterprise:{catalog:{path:"/ws/user/bookmark/enterprise"},bookmarks:{path:"/ws/user/bookmark/enterprise"}},featured:{catalog:{path:"/ws/user/bookmark/public",data:{featured:1}},bookmarks:{path:"/ws/user/bookmark/public",data:{featured:1}}},"private":{catalog:{path:"/ws/user/bookmark/private"},bookmarks:{path:"/ws/user/bookmark/private"
}},"public":{catalog:{path:"/ws/user/bookmark/public"},bookmarks:{path:"/ws/user/bookmark/public"}},static_conditions:{catalog:{path:"/ws/user/bookmark/public",data:{static_conditions:1}},bookmarks:{path:"/ws/user/bookmark/public",data:{static_conditions:1}}},shared:{catalog:{path:"/ws/user/bookmark/shared"},bookmarks:{path:"/ws/user/bookmark/shared"}},test:{catalog:{path:"content/testData/bookmarking/catalog.json"},bookmarks:{path:"content/testData/bookmarking/bookmarks"}}};a.getCategories=function(){return Object.keys(b)},a.loadBookmark=function(b,c,d,e){var f={category:b,id:c};Human.events.fire("bookmarks.db.loading",f);var g=function(a){e&&(Human.events.fire("bookmarks.db.loadFailed",Human.utils.apply({error:a},f)),e(a))};a.getBookmark(b,c,function(a){Human.bookmarks.restore(a,function(a){d&&(Human.events.fire("bookmarks.db.loaded",f),d(a))},g)},g)},a.getBookmark=function(a,c,d,e){var f=b[a];if(!f)return void e("Unsupported bookmark category: "+a);var g={eid:c},h="test"===a?f.bookmarks.path+"/"+c:f.bookmarks.path;jQuery.ajax({dataType:"json",url:h,data:g,success:function(a){d(a)},error:e})},a._testLoadBookmark=function(a){jQuery.ajax({dataType:"json",url:"https://dev.biodigitalhuman.com/search/bookmarks/data",data:{b:a},success:function(a){Human.bookmarks.restore(a.bookmark,function(){Human.log.info("Done!")})},error:function(a){Human.log.info(a)}})},a.saveBookmark=function(a,c,d,e,f,g,h,i){var j=b[a];if(!j)return void h("Unsupported bookmark category: "+a);var k={name:d||"",description:e||"",tags:JSON.stringify(f),index:JSON.stringify(Human.bookmarks.capture())};c&&(k.eid=c),jQuery.post(j.bookmarks.path,k,g).error(h).complete(i)},a.deleteBookmark=function(a,c,d,e){var f=b[a];if(!f)return void e("Unsupported bookmark category: "+a);var g={eid:c};jQuery.ajax({url:f.bookmarks.path,type:"DELETE",data:g,success:d,error:e})},a.listBookmarks=function(c,d,e,f){var g=b[c];if(!g)return void f("Unsupported bookmark category: '"+c+"' - supported values are "+JSON.stringify(a.getCategories()));var h={tags:d};jQuery.ajax({dataType:"json",url:g.catalog.path,data:h,success:e,error:f})},a.searchBookmarks=function(a,b,c,d){var e={term:a||"",tags:(b||[]).join(",")};jQuery.ajax({dataType:"json",url:"/ws/user/bookmark/search",data:e,success:c,error:d})}}(),function(){"use strict";function a(){var a;for(var b in Human.modules.activeModules)if(Human.modules.activeModules.hasOwnProperty(b)&&(a=Human.modules.activeModules[b],a.tags.indexOf("base")))return a;return null}var b=Human.bookmarks.medline={};b.load=function(b,c){var d=a();return d&&0!==d.modelIds.length?void Human.bookmarks.db.getBookmark("public",b,function(a){var b,e,f={},g=[],h="Integumentary_System",i=d.modelIds[0];for(var j in a.objects)a.objects.hasOwnProperty(j)&&-1===j.indexOf("maleAdult")&&-1===j.indexOf("femaleAdult")&&(b=a.objects[j],e=i+"-"+j,f[e]=b,b.enabled&&-1===j.indexOf(h,j.length-h.length)&&g.push(e));Human.modules.deactivateModules({tags:["condition","expo","bookmark","tour"]}),Human.bookmarks.restore({objects:f,modes:a.modes},function(){Human.view.camera.fly.flyTo({objects:g},function(){c&&c()})})}):(Human.log.error("Human.bookmarks.medline","Failed to load medline bookmark - no base anatomy module is active"),void c())}}(),function(){"use strict";Human.rpc.define("bookmarks.capture",function(){this.setResult(Human.bookmarks.capture())}),Human.rpc.define("bookmarks.restore",function(a){var b=this;Human.bookmarks.restore(a,function(){b.setResult(!0)})}),Human.rpc.define("bookmarks.db.load",function(a){var b=this;Human.bookmarks.db.loadBookmark(a.category,a.id,function(){b.setResult(!0)},function(c){b.error("Failed to load bookmark (category='"+a.category+"', id='"+a.id+"') : "+c)})}),Human.rpc.define("bookmarks.db.get",function(a){var b=this;Human.bookmarks.db.getBookmark(a.category,a.id,function(a){b.setResult(a)},function(c){b.error("Failed to get bookmark (category='"+a.category+"', id='"+a.id+"') : "+c)})}),Human.rpc.define("bookmarks.db.save",function(a){var b=this;Human.bookmarks.db.saveBookmark(a.category,a.id,a.name,a.description,a.tags,function(){b.setResult(!0)},function(c){b.error("Failed to save bookmark (category='"+a.category+"', id='"+a.id+"') : "+c)})}),Human.rpc.define("bookmarks.db.delete",function(a){var b=this;Human.bookmarks.db.deleteBookmark(a.category,a.id,function(){b.setResult(!0)},function(c){b.error("Failed to delete bookmark (category='"+a.category+"', id='"+a.id+"') : "+c)})}),Human.rpc.define("bookmarks.db.list",function(a){var b=this;Human.bookmarks.db.listBookmarks(a.category,a.tags,function(a){b.setResult(a)},function(c){b.error("Failed to list bookmarks (category='"+a.category+"') : "+c)})}),Human.rpc.define("bookmarks.db.search",function(a){var b=this;Human.bookmarks.db.searchBookmarks(a.term,a.tags,function(a){b.setResult(a)},function(c){b.error("Failed to search bookmarks (term='"+a.term+"') : "+c)})})}(),function(){"use strict";function a(a,c,e){return r?void p.unshift({moduleId:a,options:c,ok:e}):void b(a,c,function(){e&&e(),d()})}function b(a,b,d){var e=m.modules[a];return e?(c(e),r=!0,Human.events.fire("modules.activating",{moduleId:a}),Human.processes.startProcess({processId:"modules.activate",statusText:"Loading "+e.displayName}),void e.activate(b,function(){e.active=!0,e.timeActivated=Date.now(),m.activeModules[a]=e,m.numActiveModules++,Human.processes.finishProcess({processId:"modules.activate"}),Human.events.fire("modules.activated",{moduleId:a,timeActivated:e.timeActivated}),r=!1,d()})):(Human.log.error("Human.modules.activateModules","Module not found: "+a),void d())}function c(a){for(var b,c,d,e=a.tags,f={},g=0,j=e.length;j>g;g++)if(b=e[g],c=q[b])if(c.replaces){d=c.replaces;for(var k=0,l=d.length;l>k;k++)f[d[k]]=!0}else if(c.replacesAll)return void i();var m=[];for(b in f)f.hasOwnProperty(b)&&m.push(b);h({tags:m,matching:"any"})}function d(){if(p.length>0){var a=p.pop();b(a.moduleId,a.options,function(){a.ok(),d()})}}function e(a,b,c){f(a.slice(0),a.length,b,function(){c()})}function f(b,c,d,e){if(0===b.length)return void e();var g=b.shift();a(g,d,function(){b.length>0,f(b,c,d,e)})}function g(b,c,d){for(var e=o.findItems({matching:"atLeast",tags:b}),f=0,g=e.length;g>f;f++)return void a(e[f].moduleId,c,d);Human.log.warn("Human.modules.activateModules","Failed to activate module - no module found with these tags: "+JSON.stringify(b)),d()}function h(a){for(var b=o.findItems({matching:a.matching||"atLeast",tags:a.tags}),c=0,d=b.length;d>c;c++)i(b[c].moduleId)}function i(a){if(!r)if(a){var b=m.activeModules[a];b&&(Human.events.fire("modules.deactivating",{moduleId:a}),b.deactivate(b),b.active=!1,b.timeActivated=-1,delete m.activeModules[a],m.numActiveModules--,Human.events.fire("modules.deactivated",a))}else for(a in m.modules)m.modules.hasOwnProperty(a)&&m.activeModules[a]&&i(a)}function j(a){for(var b=o.findItems({matching:"atLeast",tags:a}),c=0,d=b.length;d>c;c++)k(b[c].moduleId)}function k(a){if(a){var b=m.modules[a];if(!b)return void Human.log.warn("Human.modules.destroyModules","Failed to destroy module - module not found: + "+a);if(i(a),delete m.modules[a],o.removeItem(a),m.namesToModuleIds.hasOwnProperty(b.displayName)){var c=m.namesToModuleIds[b.displayName].indexOf(a);c&&m.namesToModuleIds[b.displayName].splice(c,1)}return n.putId(a),void Human.events.fire("modules.destroyed",a)}for(a in m.modules)m.modules.hasOwnProperty(a)&&k(a)}var l,m=Human.modules={},n=new Human.utils.IDPool;m.modules={};var o=new Human.utils.TagMapList;m.activeModules={},m.numActiveModules=0;var p=[];m.namesToModuleIds={};var q,r=!1;Human.properties.subscribe({propId:"modules.activationRules",value:{base:{replacesAll:!0},standalone:{replaces:["standalone"]},condition:{replaces:["condition","expo","bookmark","medline","tour"]},tour:{replaces:["condition","expo","bookmark","medline","tour"]},bookmark:{replaces:["condition","expo","bookmark","medline"]},medline:{replaces:["condition","expo","bookmark","medline"]},expo:{replaces:["expo"]}},callback:function(a){q=a}});var s={};m.addModuleType=function(a,b){s[a]=b},Human.events.on("loaded",function(){l=!0}),m.createModule=function(a){if(!a.type)return void Human.log.error("Human.modules.createModule","Parameter expected: type");var b=s[a.type];if(!b)return void Human.log.error("Human.modules.createModel","Unsupported module type: '"+a.type+"'");var c;if(a.moduleId){if(c=a.moduleId,m.modules[c])return void Human.log.warn("Human.modules.createModule","Module already created, won't create again: + "+c)}else c=n.getId();a.moduleId=c,a.displayName=a.displayName||"",a.description=a.description||"",a.translations=a.translations,a.tags=a.tags||[],a.active=!1,a.timeActivated=-1;var d=new b(a);return m.modules[c]=d,o.addItem(c,a.tags||["untagged"],d),m.namesToModuleIds[a.displayName]=m.namesToModuleIds[a.displayName]||[],m.namesToModuleIds[a.displayName].push(c),Human.events.fire("modules.created",a),c},m.activateModules=function(b,c){if(!l)return Human.log.error("Human.modules.activateModules","Human not loaded - modules can only be activated when Human loaded"),void(c&&c());var d=c;c=function(){d&&d()};var f=b;if(b.moduleId){var h=b.moduleId;if(!m.modules[h])return Human.log.info("Human.modules.activateModules","Module not found: '"+h+"' - attempting to load definition"),void Human.net.getModuleDefinition(h,function(b){b.type=b.type||"content",b.moduleId=h,m.createModule(b),a(h,f,c)},function(a){Human.log.info("Human.modules.activateModules","Failed to activate module: '"+h+"' - "+a),c()});a(h,f,c)}else b.moduleIds?e(b.moduleIds.slice(0),f,c):b.tags&&g(b.tags,f,c)},m.deactivateModules=function(a){a=a||{},a.tags?h(a):a.moduleId?i(a.moduleId):i(),Human.renderer.forceRenderFrame()},m.destroyModules=function(a){a.tags?j(a.tags):k(a.moduleId)},m.query=function(a){var b,c,d;if(a){if(a.tags)return o.findItems(a);if(a.moduleId)return b=m.modules[a.moduleId],b?[b.module]:[];if(a.names){var e=[];for(var f in a.names)if(a.names.hasOwnProperty(f)){var g=a.names[f];if(m.namesToModuleIds.hasOwnProperty(g)){var h=m.namesToModuleIds[g];for(var i in h)h.hasOwnProperty(i)&&(c=h[i],m.modules.hasOwnProperty(c)&&(b=m.modules[c],e.push({moduleId:c,type:b.type,displayName:b.displayName,description:b.description,translations:b.translations,tags:b.tags,animation:b.animation,active:b.active,timeActivated:b.timeActivated})))}}return e}if(a.active){d=[];for(c in m.activeModules)m.activeModules.hasOwnProperty(c)&&(b=m.activeModules[c],d.push({moduleId:c,type:b.type,displayName:b.displayName,description:b.description,translations:b.translations,tags:b.tags,animation:b.animation,active:b.active,timeActivated:b.timeActivated}));return d}}d=[];for(c in m.modules)m.modules.hasOwnProperty(c)&&(b=m.modules[c],d.push({moduleId:c,type:b.type,displayName:b.displayName,description:b.description,translations:b.translations,tags:b.tags,animation:b.animation,active:b.active,timeActivated:b.timeActivated}));return d}}(),function(){"use strict";function a(b,d){if(b.length>0){var e=b.shift();c.loadModuleDb(e,function(){a(b,d)})}else d()}function b(a,d){if(a.length>0){var e=a.shift();c.loadModuleLib(e,function(){b(a,d)},function(c){Human.log.error("Human.modules.db.loadModuleLibs","Failed to load module lib '"+e+"': "+c),b(a,d)})}else d()}var c=Human.modules.db={};c.moduleLibs={},c.loadModuleDbs=function(b,c){return c=c||Human.utils.noop,0===b.length?void c():void a(b.slice(0),c)},c.loadModuleDb=function(a,b){return b=b||Human.utils.noop,Human.log.info("Human.modules.db.loadModuleDb","Loading module db: "+a+"..."),c.moduleLibs[a]?(Human.log.warn("Human.modules.db.loadModuleDb","Module db already loaded - won't reload: "+a+"..."),void b()):void Human.net.getModuleDb(a,function(d){if(!d.modules||0===d.modules.length)return void b();for(var e=[],f=0;f<d.modules.length;f++){var g=d.modules[f],h=g.id,i=g.module;i.type=i.type||"content",i.moduleId=h,Human.modules.createModule(i),e.push(h)}c.moduleLibs[a]=e,b()},function(c){Human.log.error("Human.modules.db.loadModuleDb","Failed to load module db '"+a+"': "+c),b()})},c.loadModuleLibs=function(a,c){return c=c||Human.utils.noop,0===a.length?void c():void b(a.slice(0),c)},c.loadModuleLib=function(a,b){return b=b||Human.utils.noop,Human.log.info("Human.modules.db.loadModuleLib","Loading module library: "+a+"..."),c.moduleLibs[a]?(Human.log.warn("Human.modules.db.loadModuleLib","Module library already loaded - won't reload: "+a+"..."),void b()):void Human.net.getModuleManifest(a,function(d){return d.modules&&0!==d.modules.length?void c.loadModuleDefinitions(a,d.modules.slice(0),function(){c.moduleLibs[a]=d.modules,b()}):void b()},function(c){Human.log.error("Human.modules.db.loadModuleLib","Failed to load module library manifest: "+a+"': "+c),b()})},c.loadModuleDefinitions=function(a,b,d){if(d=d||Human.utils.noop,0===b.length)d();else{var e=b.shift();Human.log.info("Human.modules.db.loadModuleLib","Loading module definition: "+e+"..."),Human.net.getModuleDefinition(e,function(f){f.type=f.type||"content",f.moduleId=e,Human.modules.createModule(f),c.loadModuleDefinitions(a,b,d)},function(f){Human.log.error("Human.modules.db.loadModuleLib","Failed to load module definition: "+e+"':"+f),c.loadModuleDefinitions(a,b,d)})}},c.destroyModuleLib=function(a){var b=c.moduleLibs[a];if(b){for(var d=b.modules,e=0,f=d.length;f>e;e++)Human.modules.destroyModulesModule(d[e]);delete c.moduleLibs[a]}}}(),function(){"use strict";function a(a,b){for(var c,d=0,e=b.length,f=0,g=a.length;g>f;f++){c=a[f];for(var h=0,i=b.length;i>h;h++)if(c===b[h]&&++d===e)return!0}return!1}function b(a,b){Human.events.fire("modules.gender.activating",{moduleId:a,gender:b})}function c(a,b){Human.events.fire("modules.gender.activated",{moduleId:a,gender:b})}var d=Human.modules.gender={},e=[],f=[];Human.properties.subscribe({propId:"modules.genderTags",value:{male:["anatomy","male","base"],female:["anatomy","female","base"]},callback:function(a){e=a.male||[],f=a.female||[]}}),Human.events.on("modules.activating",function(c){var d=c.moduleId,g=Human.modules.modules[d];a(g.tags,e)?b(d,"male"):a(g.tags,f)&&b(d,"female")}),Human.events.on("modules.activated",function(b){var d=b.moduleId,g=Human.modules.modules[d];a(g.tags,e)?c(d,"male"):a(g.tags,f)&&c(d,"female")}),d.selectGender=function(a,b){return 0===e.length||0===f.length?(Human.log.error("Human.modules.selectGender","No tags configured to identify male/female gender modules"),void(b&&b())):void 0!==a&&null!==a&&"male"!==a&&"female"!==a?(Human.log.error("Human.modules.gender.selectGender","Unsupported value for 'gender' - supported values are 'male' and 'female'"),void(b&&b())):(a||(a=Human.cookies.getCookie("gender")||"male"),void Human.modules.activateModules({tags:"male"===a?e:f},function(){Human.cookies.setCookie("gender",a),b&&b()}))}}(),function(){"use strict";var a=!1,b=!1,c=!1,d={},e={},f=0;Human.events.on("modules.activating",function(){a=!0}),Human.events.on("modules.activated",function(b){for(var c=b.moduleId,g=Human.modules.modules[c],h=g.tags,i=0,j=h.length;j>i;i++)if("standalone"===h[i])return d[c]=g,void f++;e[c]=g,a=!1}),Human.events.on("modules.deactivated",function(a){d[a]?(delete d[a],f--):delete e[a]}),Human.events.on("bookmarks.restoring",function(){b=!0}),Human.events.on("bookmarks.restored",function(){b=!1}),Human.events.on("timeline.chapters.activating",function(){c=!0}),Human.events.on("timeline.chapters.activated",function(){c=!1}),Human.events.on("scene.objectsShown",function(d){if(!(a||b||c)&&Human.modules.numActiveModules>0){var g,h,i=d.enabledObjectsUpdate;for(var j in i)if(i[j]===!0&&(g=Human.scene.objects[j],h=e[g.moduleId],h&&f>0))return Human.log.info("Human.modules.standalone","Module "+g.moduleId+" object focused: "+d.objectId+" - deactivating all standalone modules"),void Human.modules.deactivateModules({tags:["standalone"]})}})}(),function(){"use strict";function a(a){var b={};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}function b(){var a,b=Human.view.effects.effects,c={};for(var d in b)b.hasOwnProperty(d)&&(a=b[d],c[d]=a.enabled?Human.utils.apply(a.params,{}):!1);return c}function c(a,b){for(var c,d,e=0,f=b.length;f>e;e++)c=b[e],d=Human.view.annotations.createAnnotation({moduleId:a,annotationId:c.annotationId,type:c.type,objectId:c.objectId,title:c.title||"",description:c.description||"",pos:c.offset||c.pos,dir:c.pinVec||c.dir,shown:"secondary"===c.type?!1:c.shown,labelShown:"secondary"===c.type?!1:c.labelShown!==!1,labelOffset:c.labelOffset,saved:!0,on:c.on,embed:c.embed,occludable:c.occludable,followsObject:c.followsObject}),c.annotationId=d.annotationId}function d(a){for(var b,c,d=0,e=a.length;e>d;d++)b=a[d],c=Human.view.annotations.annotations[b.annotationId],c&&c.destroy()}var e=function(a){this.moduleId=a.moduleId,this.displayName=a.displayName||"",this.description=a.description||"",this.translations=a.translations||{},this.tags=a.tags||[],this.ui=a.ui||{},this.active=!1,this.hacks=a.hacks,this.animation=a.animation,this.camera=a.camera,this.jumpTo=a.jumpTo,this.flyTo=a.flyTo;var b=a.modelIds||a.stateId;this.modelIds=b?Human.utils.isArray(b)?b:[b]:[],this.showObjects=a.showObjects,this.selectObjects=a.selectObjects,this.pickThroughObjects=a.pickThroughObjects,this.transparentObjects=a.transparentObjects,this.desaturatedObjects=a.desaturatedObjects,this.backfaceObjects=a.backfaceObjects,this.objectGlassFactors=a.objectGlassFactors,this.objectOpacities=a.objectOpacities,this.animation=a.animation,this.xray=a.xray,this.annotations=a.annotations,this.annotationsLayout=a.annotationsLayout,this.environment=a.environment,this.chapterCameraPath=!!a.chapterCameraPath,this.effects=a.effects,this.properties=a.properties,this.reflections=a.reflections,this.skyboxes=a.skyboxes,this.swapped=!1,this.swappedObjectId=null,this.cache=!1,this.restoreReflections=null,this.restoreProperties=null,this.restoreEffects=null,this.restorePickThroughObjects=null,this.restoreObjectGlassFactors=null,this.restoreObjectOpacities=null,this.restoreCamera=null};e.prototype.activate=function(d,e){var f=this,g=!!d.swap;this.swapped=g,g&&(this.swappedObjectId=d.objectId);var h=d.camera!==!1;this.cache=!!d.cache,f.hacks&&(Human.properties.set({"hacks.neverBackfaces":!!f.hacks.neverBackfaces}),Human.properties.set({"hacks.alwaysBackfaces":!!f.hacks.alwaysBackfaces})),this.reflections&&(this.restoreReflections=Human.assets.reflections.active,Human.assets.reflections.exportReflections(this.reflections)),this.skyboxes&&(this.restoreSkyboxes=Human.view.skyboxes.active,Human.view.skyboxes.exportSkyboxes(this.skyboxes)),Human.view.annotations.clearAnnotations(),this._loadModels(this.modelIds.slice(0),function(){var i,j,k;if(Human.properties.set({"hacks.neverBackfaces":!1}),Human.properties.set({"hacks.alwaysBackfaces":!1}),f.properties&&(f.restoreProperties=a(f.properties),Human.properties.set(f.properties)),f.effects&&(f.restoreEffects=b(),Human.view.effects.clearEnabled(),Human.view.effects.setEnabled({effectIds:f.effects})),f.showObjects&&Human.scene.setEnabledObjects({objectIds:f._parseObjectIds(f.showObjects,g),replace:d.swap!==!0}),f.selectObjects&&Human.scene.setSelectedObjects({objects:f._parseObjectIds(f.selectObjects,g),replace:d.swap!==!0}),f.pickThroughObjects){f.restorePickThroughObjects={},i=f._parseObjectIds(f.pickThroughObjects,g);for(k in i)i.hasOwnProperty(k)&&(j=Human.scene.objects[k],j&&(f.restorePickThroughObjects[k]=j.pickable));Human.scene.setPickThroughObjects({objectIds:i,replace:!1})}if(f.transparentObjects&&Human.scene.setTransparentObjects({objectIds:f._parseObjectIds(f.transparentObjects,g)}),f.desaturatedObjects&&Human.scene.setDesaturatedObjects({objectIds:f._parseObjectIds(f.desaturatedObjects,g)}),f.backfaceObjects&&Human.scene.setBackfaceObjects({objectIds:f._parseObjectIds(f.backfaceObjects,g)}),f.objectGlassFactors){f.restoreObjectGlassFactors={},i=f._parseObjectIds(f.objectGlassFactors,g);for(k in i)i.hasOwnProperty(k)&&(j=Human.scene.objects[k],j&&(f.restoreObjectGlassFactors[k]=j.glassFactor));Human.scene.setObjectGlassFactors({objectIds:i})}if(f.objectMurkiness){f.restoreObjectMurkiness={},i=f._parseObjectIds(f.objectMurkiness,g);for(k in i)i.hasOwnProperty(k)&&(j=Human.scene.objects[k],j&&(f.restoreObjectMurkiness[k]=j.murkiness));Human.scene.setObjectMurkiness({objectIds:i})}if(f.objectOpacities){f.restoreObjectOpacities={},i=f._parseObjectIds(f.objectOpacities,g);for(k in i)i.hasOwnProperty(k)&&(j=Human.scene.objects[k],j&&(f.restoreObjectOpacities[k]=j.glassFactor));Human.scene.setObjectOpacities({objectIds:i})}if(f.annotations&&c(f.moduleId,f.annotations),Human.view.clip.reset(),f.xray===!0?Human.rpc.call(null,"xray.setEnabled",{enable:!0}):Human.rpc.call(null,"highlight.setEnabled",{enable:!0}),Human.timeline.chapterCameras.pathMode=f.chapterCameraPath,f.animation?Human.timeline.play(f.animation):g||Human.timeline.scrub({time:0}),f.annotationsLayout&&Human.properties.set({"annotations.layout.type":f.annotationsLayout}),h&&!g){if(f.camera||f.flyTo||f.jumpTo){var l=Human.view.camera;f.restoreCamera={lookat:l.getLookAt(),screenPan:l.getScreenPan()}}f.camera?Human.utils.async(function(){Human.view.camera.fly.flyTo({eye:f.camera.eye,look:f.camera.look,up:f.camera.up,arc:0},e),f.camera.screenPan&&Human.view.camera.setScreenPan(f.camera.screenPan)}):f.flyTo?(Human.utils.async(function(){Human.view.camera.fly.flyTo({eye:f.flyTo.eye,look:f.flyTo.look,up:f.flyTo.up,arc:0},e)}),f.flyTo.screenPan&&Human.view.camera.setScreenPan(f.flyTo.screenPan)):f.jumpTo?(Human.utils.async(function(){Human.view.camera.fly.jumpTo({eye:f.jumpTo.eye,look:f.jumpTo.look,up:f.jumpTo.up}),e()}),f.jumpTo.screenPan&&Human.view.camera.setScreenPan(f.jumpTo.screenPan)):(Human.renderer.forceRenderFrame(),e())}else Human.renderer.forceRenderFrame(),e()})},e.prototype.deactivate=function(){if(Human.timeline.stop(),this.annotations&&d(this.annotations),!this.cache&&this.modelIds){this._hideObjects();for(var a=this.modelIds,b=0,c=a.length;c>b;b++)Human.models.unloadModel(a[b])}if(this.restoreReflections&&(Human.assets.reflections.exportReflections(this.restoreReflections),this.restoreReflections=null),this.restoreSkyboxes&&(Human.view.skyboxes.exportSkyboxes(this.restoreSkyboxes),this.restoreSkyboxes=null),this.restoreProperties&&(Human.properties.set(this.restoreProperties),this.restoreProperties=null),this.restoreEffects&&(Human.view.effects.clearEnabled(),Human.view.effects.setEnabled(this.restoreEffects),this.restoreEffects=null),this.restorePickThroughObjects&&(Human.scene.setPickThroughObjects({objectIds:this.restorePickThroughObjects,replace:!1}),this.restorePickThroughObjects=null),this.restoreObjectGlassFactors&&(Human.scene.setObjectGlassFactors({objectIds:this.restoreObjectGlassFactors}),this.restoreObjectGlassFactors=null),this.restoreObjectOpacities&&(Human.scene.setObjectOpacities({objectIds:this.restoreObjectOpacities}),this.restoreObjectOpacities=null),this.restoreCamera){var e=Human.view.camera;e.setLookAt(this.restoreCamera.lookat),e.setScreenPan(this.restoreCamera.screenPan),this.restoreCamera=null}},e.prototype._hideObjects=function(){for(var a,b={},c=this.modelIds,d=0,e=c.length;e>d;d++){a=Human.scene.modelObjects[c[d]];for(var f in a)a.hasOwnProperty(f)&&(b[f]=!1)}Human.scene.setEnabledObjects({objects:b,replace:!1})},e.prototype._loadModels=function(a,b){Human.models.loadModels({moduleId:this.moduleId,modelIds:a,streamObjects:this.streamObjects},b)},e.prototype._parseObjectIds=function(a,b){var c;if(!a)return{};if(b){var d={};for(c in a)a.hasOwnProperty(c)&&this._hasObject(c)&&(d[c]=a[c]);void 0!==a["*"]&&null!==a["*"]&&(d["*"]=a["*"]),a=d}var e=a["*"];if(void 0===e||null===e)return a;var f=this.modelIds;if(f)for(var g=0,h=f.length;h>g;g++){var i=Human.scene.modelObjects[f[g]];for(c in i)i.hasOwnProperty(c)&&(a[c]=e)}return a},e.prototype._hasObject=function(a){var b=this.modelIds;if(!b)return!1;for(var c=0,d=this.modelIds.length;d>c;c++)if(0===a.indexOf(this.modelIds[c]))return!0;return!1},Human.modules.addModuleType("content",e)}(),function(){"use strict";function a(a){this.moduleId=a.moduleId,this.displayName=a.displayName||"",this.description=a.description||"",this.tags=a.tags||[],this.active=!1,this.spinRate=a.spinRate||.02,this.delay=a.delay||5,this.mode=a.mode||"visible",this.objects=a.objects,this.active=!1}a.prototype.activate=function(a,b){var c,d,e,f=1e3*this.delay,g=[];switch(this.mode){case"visible":d=Human.scene.enabledObjects;for(e in d)d.hasOwnProperty(e)&&(c=d[e],0===c.objects.length&&g.push(c));break;case"objects":d=Human.scene.rootObjects;for(e in d)d.hasOwnProperty(e)&&this._listObjects(d[e],g);break;default:Human.log.error("ObjectExpo","Mode not supported: "+this.mode)}Human.rpc.call(null,"xray.setEnabled",{enable:!0});var h,i,j=this;Human.events.on("tick",this._tick=function(){var a=Date.now(),b=a-(void 0===h||null===h?a:h),c=a-(void 0===i||null===i?a:i);if(Human.view.camera.rotateY(b*j.spinRate),void 0===i||null===i||c>f){var d=g[Math.round(Math.random()*g.length)];d&&(Human.view.focus.focusObject({objectId:d.objectId,showLabel:!0,replace:!0,flyTo:"newSelected"}),i=a)}h=a}),b()},a.prototype._listObjects=function(a,b){for(var c,d=a.objects,e=0,f=d.length;f>e;e++)c=d[e],this.objects?this._selectedObject(this.objects,c)&&b.push(c):b.push(c),this._listObjects(c,b)},a.prototype._selectedObject=function(a,b){for(var c,d=b;void 0!==d&&null!==d;d=d.parent){if(c=a[d.objectId],c===!0)return!0;if(c===!1)return!1}return!1},a.prototype.deactivate=function(){Human.events.off("tick",this._tick),this.active=!1},Human.modules.addModuleType("objectExpo",a)}(),function(){"use strict";function a(a){this.moduleId=a.moduleId,this.displayName=a.displayName||"",this.description=a.description||"",this.tags=a.tags||[],this.active=!1,this.delay=a.delay||1e4,this.expoModules=a.expoModules}a.prototype.activate=function(a,b){function c(){var a=d[e++%d.length];Human.modules.activateModules({moduleId:a.moduleId},function(){f.active&&setTimeout(c,f.delay)})}var d=Human.modules.query(this.expoModules),e=0,f=this;d.length>0?c():Human.log.warn("moduleExpo","No modules found"),b()},a.prototype.deactivate=function(){},Human.modules.addModuleType("moduleExpo",a)}(),function(){"use strict";function a(a){this.moduleId=a.moduleId,this.displayName=a.displayName||"",this.description=a.description||"",this.tags=a.tags||[],this.active=!1,this.category=a.category,this.bookmarkId=a.bookmarkId}a.prototype.activate=function(a,b,c){Human.log.info("Human.modules","Activating bookmark: "+this.bookmarkId),Human.bookmarks.db.loadBookmark(this.category,this.bookmarkId,a,function(a){c("[Human.modules] Failed to load bookmark: "+a)}),a()},a.prototype.deactivate=function(){Human.log.info("Human.modules","Deactivating bookmark: "+this.bookmarkId)},Human.modules.addModuleType("bookmark",a)}(),function(){"use strict";function a(a){this.moduleId=a.moduleId,this.displayName=a.displayName||"Exploded view",this.description=a.description||"Exploded view",this.tags=a.tags||[],this.active=!1,this.distance=a.distance||20,this.objects=a.objects,this.factor=0,this.dir=1}a.prototype.activate=function(a,b){var c,d,e=[],f=Human.scene.enabledObjects,g=[0,0,0];for(var h in f)f.hasOwnProperty(h)&&(c=f[h],0===c.objects.length&&(d=c.getCenter(),e.push({pos:d,pos2:null,dir:Human.math.vec3(),object:c}),g[0]+=d[0],g[1]+=d[1],g[2]+=d[2]));g[0]/=e.length,g[1]/=e.length,g[2]/=e.length;for(var i=0,j=e.length;j>i;i++){var k=e[i],l=k.pos;Human.math.subVec3(l,g,k.dir)}var m,n=this;Human.events.on("tick",this._tick=function(){if(n.factor>1)return n.factor=1,void(n.dir=0);if(n.factor<0)return n.factor=0,void(n.dir=0);for(var a=Date.now(),b=0,c=e.length;c>b;b++){var d=e[b],f=Human.math.addVec3(d.pos,Human.math.mulVec3Scalar(d.dir,n.factor));d.object.setTransform({translate:{x:f[0],y:f[1],z:f[2]}})}n.factor+=.01*n.dir,m=a}),this.factor=0,this.dir=1,b()},a.prototype.deactivate=function(){Human.events.off("tick",this._tick),this.active=!1},Human.modules.addModuleType("explode",a)}(),function(){"use strict";Human.rpc.define("modules.getModules",function(a){this.setResult(Human.modules.query(a))}),Human.rpc.define("modules.activate",function(a){var b=this;Human.modules.activateModules(a,function(){b.setResult(!0)})}),Human.rpc.define("modules.deactivate",function(a){Human.modules.deactivateModules(a)})}(),function(){"use strict";var a=Human.clients={};a.numConnections=0,a.addClient=function(b){b({connected:function(){a.numConnections++,Human.events.fire("clients.connected",{})},disconnected:function(){a.numConnections--,Human.events.fire("clients.disconnected",{})}})}}(),function(){"use strict";function a(a){var b=g+":"+h+"/socket.io/socket.io.js";Human.log.info("[Socket] Loading Socket.IO library from "+b),require([b],function(b){a(b)})}function b(a){try{j.emit("sendreply",i,a)}catch(b){Human.log.error("Human.clients.webSocketClient#sendResponse","Error sending response: "+b)}}function c(a){var b=a.call;return"camera.pan"===b||"camera.orbit"===b||"camera.flyTo"===b||"camera.jumpTo"===b||"camera.zoom"===b||"camera.getZoom"===b||a.params&&a.params.connected?void d(a):void(0===k?d(a):(l.push(a),f||(f=setInterval(function(){l.length>0&&0===k&&d(l.shift()),0===l.length&&(clearInterval(f),f=null)},20))))}function d(a){try{Human.rpc.call(a.id,a.call,a.params)}catch(b){Human.log.error("Human.clients.webSocketClient","Error executing RPC call [callId: "+a.id+", procedure: "+a.call+"]: "+b)}}var e="true"===Human.request.getSearchParam("socketEnabled");if(!e)return void Human.log.info("Human.clients.webSocketClient","WebSocket enabled: NO - socketEnabled=true was not found on URL.");Human.log.info("Human.clients.webSocketClient","WebSocket enabled: YES - socketEnabled=true was found on URL.");var f,g=Human.request.getSearchParam("socketURL")||"https://api.biodigitalhuman.com",h=Human.request.getSearchParam("socketPort")||443,i=Human.request.getSearchParam("socketChannel")||"human",j=null,k=0,l=[],m=!1,n=null,o=!1;Human.onError(function(a){m&&b({error:a}),n=a}),Human.events.on("started",function(){m&&b({message:"ready"}),o=!0}),Human.events.on("loaded",function(){Human.clients.numConnections++,Human.events.fire("clients.connected",{}),Human.log.info("Human.clients.webSocketClient","WebSocket server enabled."),Human.log.info("Human.clients.webSocketClient","Loading Socket.IO Library..."),a(function(a){Human.log.info("Human.clients.webSocketClient","Socket.IO library loaded."),Human.events.on("processes.started",function(){k++}),Human.events.on("processes.finished",function(){k>0&&k--}),Human.events.on("processes.failed",function(){k--}),Human.rpc.onResult(function(a,c){var d={};d[a]=c,b({results:d})});try{j=a.connect(g+":"+h);var d=!1;j.on("connect",function(){d||(d=!0,Human.log.info("Human.clients.webSocketClient","Connected."),Human.log.info("Human.clients.webSocketClient","Subscribing"),j.emit("subscribe",i))}),j.on("status",function(a){Human.log.info("[client "+g+"] received status:"+a)}),j.on("message",function(a){Human.log.info("Human.clients.webSocketClient",JSON.stringify(a)),"connect"===a.action?(Human.log.info("Human.clients.webSocketClient","Client connected"),j.emit("sendreply",i,{message:"connected"}),n?j.emit("sendreply",i,{message:"error",error:n}):o&&j.emit("sendreply",i,{message:"ready"})):a.call&&c(a)})}catch(e){Human.log.error("Human.clients.webSocketClient#start","Error initializing socket: "+e)}})})}(),Human.clients.addClient(function(a){"use strict";function b(a){var b=JSON.stringify(a);return f?void f.postMessage(b,g):void i.push(b)}function c(){for(;i.length>0;)f.postMessage(i.pop(),g)}function d(a){var b=a.call;return"camera.pan"===b||"camera.orbit"===b||"camera.flyTo"===b||"camera.jumpTo"===b||"camera.zoom"===b||a.params&&a.params.connected?void e(a):void(0===k?e(a):(j.push(a),h||(h=setInterval(function(){j.length>0&&0===k&&e(j.shift()),0===j.length&&clearInterval(h)},20))))}function e(a){try{Human.rpc.call(a.id,a.call,a.params)}catch(b){Human.log.error("Human.clients.windowClient","Error executing RPC call [callId: "+a.id+", procedure: "+a.call+"]: "+b)}}var f,g,h,i=[],j=[],k=0;Human.events.on("started",function(){
b({message:"status",status:"ready"})}),Human.events.on("processes.started",function(){k++}),Human.events.on("processes.finished",function(){k--,0>k&&(k=0,Human.log.warn("Human.clients.windowClient","Extra Process.Finished event caught"))}),Human.events.on("processes.failed",function(){k--}),window.addEventListener?(Human.onError(function(a){b({error:a})}),Human.rpc.onResult(function(a,c){var d={};d[a]=Human.rpc.filterUnsafeProperties(c),b({results:d})}),addEventListener("message",function(e){var h;try{h=JSON.parse(e.data)}catch(i){return void Human.log.error("Human.clients.windowClient","JSON parse failed on an incoming Web message: "+i.message||i)}"connect"===h.action?f||(Human.log.info("Human.clients.windowClient","Client connected"),a.connected(),f=e.source,g=e.origin,b({message:"connected"}),c()):h.call&&d(h)},!1)):Human.log.error("Human.clients.windowClient","Browser does not support cross-window messaging")}),function(){"use strict";var a=Human.actions={};a._actions={},Human.events.on("loaded",function(){$(document).on("click","[data-human-action]",function(){var b=$(this),c=b.attr("data-human-action"),d=b.attr("data-arguments");c&&a._doAction([c,d])})}),a.addAction=function(b,c){a._actions[b]=c},a._doAction=function(b){var c;if("string"==typeof b){if(c=b.split("?"),0===c.length)return void Human.log.error("Human.actions._parse","Parsed invalid action link: "+b+"(ignoring)")}else c=b;var d=c[0],e=a._actions[d];if(!e)return void Human.log.error("Human.actions._doAction","Parsed invalid action link - action not found: "+d+" (ignoring)");var f={},g=c[1];if(g)for(var h,i=g.split("&"),j=0,k=i.length;k>j;j++)h=i[j].split("="),f[h[0]]=h[1];try{e(f)}catch(l){Human.log.error("Human.actions._doAction","Action '"+d+"' threw an exception: "+l)}},a.parse=function(a){return a.replace(/\[\[([^|]*?)\|(.*?)\]\]/g,"<a href=\"javascript:Human.actions._doAction('$1')\">$2</a>")}}(),function(){"use strict";Human.rpc.define("actions.doAction",function(a){Human.actions._doAction([a.action,a.arguments])})}();