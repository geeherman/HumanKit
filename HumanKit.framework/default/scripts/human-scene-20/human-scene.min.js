/*
 * Human Scene Loader v-20
 * Built on 08.15.2018 05:24:31 PM
 * (c) 2018 BioDigital, Inc.
 */

!function(a){var b=a.HumanScene={};b.isObject=function(a){return null!==a&&"object"==typeof a},b.extend=function(){var a,b,c,d=Array.prototype.slice.call(arguments,0),e=d[0],f=d.slice(1);for(c=0;c<f.length;c++){a=f[c];for(b in a)a.hasOwnProperty(b)&&(e[b]=a[b])}return e},b.isBase=function(b){if("isBase"in a.Human.modules)return a.Human.modules.isBase(b);var c=b.match(/^(femaleAdult|maleAdult)/);return c&&c[0]},b.isBaseModule=function(c){if("isBaseModule"in a.Human.modules)return a.Human.modules.isBaseModule(c);var d=c.split("/");return b.isBase(d[d.length-1])?c:!1},b.getGenderModule=function(a){var c,d=null;for(var e in a)if(a.hasOwnProperty(e)&&(c=b.isBase(e))){d=["production",c,c+".json"].join("/");break}return d},b.getUrlParams=function(){var b={},c=/[?&]+([^=&]+)=([^&]*)/gi;return a.location.href.replace(c,function(c,d,e){b[d]=a.decodeURIComponent(e)}),b},b.load=function(a,c,d){b.sceneGraph.load(a,function(){b.sceneGraph.stage(a),c()},d)},b.initEngine=function(b){a.Human.init.init(b)},b.startEngine=function(){a.Human.init.start()}}(window),function(a){var b=a.HumanScene,c=b.bookmark={},d=function(a){return a.indexOf("/femaleAdult/")>=0?"female":"male"},e=function(b){var c=b.modules.activeModules||[];if(c.length>1){var d,e;for(e=0;e<c.length;e++)if(!a.Human.modules.isBaseModule(c[e])){d=c[e];break}c=[d]}b.modules.moduleLibs&&(b.modules.moduleLibs=[])};c.normalizeLegacy=function(a){a.modules={},a.modules.activeModules=[],a.modules.moduleLibs=[],b.isObject(a.objects)||(a.objects={});var c=b.getGenderModule(a.objects);c&&a.modules.activeModules.unshift(c)},c.normalizeTour=function(a){for(var b,c=0;c<a.length;c++)b=a[c],e(b)},c.normalize=function(a){var f=a.bookmark||null,g=null;if(f){b.isObject(f.modules)||c.normalizeLegacy(f);var h=Array.isArray(f.tour)&&f.tour.length>0;if(h){var i=[f].concat(f.tour);c.normalizeTour(i)}else e(f);g=f.modules.activeModules.length>0?d(f.modules.activeModules[0]):"male"}return{bookmark:f,streamObjects:{},gender:g}}}(window),function(a){var b=a.HumanScene,c=b.content={},d="male",e="production/{0}Adult",f={},g=function(a,b,c){return c=c||e,c=c.replace("{0}",b||d),[c,a+".json"].join("/")},h=function(a,b){var c={};if(a.length)for(var d=0;d<a.length;d++)if(a[d].groups.length){c.id=a[d].id;var e=[b,a[d].groups[0].replace(/\s/g,"_")].join("-");/system$/i.test(e)||(e+="_System"),/ligaments/i.test(e)&&(e=e.replace(/ligaments/i,"Ligament"),c.id=e),c.system=e;break}return c};c.setModule=function(a,b){var c=a.indexOf("/")>=0;return{id:c?a:g(a,b)}},c.setAnatomy=function(a,b){a=a||"",b=b||d;for(var c,e=a.split(","),f=b+"Adult",h={},i=0;i<e.length;i++){c=e[i];var j=c.indexOf("-")>=0?c:[f,c].join("-");h[j]=!0}return{id:g(f,b),baseAnatomyObjects:h}},c.setPrettyAnatomy=function(a,b,c){for(var e=a.input||"",f=a.gender||d,i=a.generations||null,j=e.split("-"),k=[],l=f+"Adult",m={},n=0;n<j.length;n++)j[n].length>2&&k.push(j[n]);var o=[l,"Integumentary_System"].join("-");m[o]=!0;var p="/search/anatomy?q="+f+"+"+k.join("+"),q=new XMLHttpRequest;q.onreadystatechange=function(){if(q.readyState===XMLHttpRequest.DONE)if(200===q.status){var a=JSON.parse(q.responseText),d=h(a.results,l);m[d.system]=!0,b({id:g(l,f),baseAnatomyObjects:m,selectedObject:d.id,generations:i})}else c({message:"Error searching anatomy",type:"search"})},q.open("GET",p),q.send()},c.setBookmark=function(a,c,d,e){var f="/search/bookmarks/data?"+a+"="+c,g=new XMLHttpRequest;g.onreadystatechange=function(){if(g.readyState===XMLHttpRequest.DONE)if(200===g.status){var a=JSON.parse(g.responseText);if(a&&a.bookmark&&a.bookmark.sceneGraph)return b.extend(i,{id:c,moduleData:a.bookmark}),void d(i);if(a=b.bookmark.normalize(a),a.bookmark){var f=a.bookmark.modules.activeModules;d({id:f[f.length-1],gender:a.gender,baseAnatomyObjects:a.streamObjects,bookmark:a.bookmark})}else e({message:"Bookmark was empty.",type:"bookmark"})}else e({message:"Bookmark does not exist",type:"bookmark"})},g.open("GET",f),g.send()},c.setCamera=function(b){var c=null;if(b=b.split(","),Array.isArray(b)&&b.length%3===0){var d={0:"eye",3:"look",6:"up"};c={};for(var e=0;e<b.length;e+=3)d.hasOwnProperty(e)&&(c[d[e]]={x:a.parseFloat(b[e]),y:a.parseFloat(b[e+1]),z:a.parseFloat(b[e+2])})}return{camera:c}};var i={id:null,gender:null,initialChapter:0,baseAnatomyObjects:{},bookmark:null,camera:null,moduleData:null,selectedObject:null,generations:null};c.get=function(){return i},c.set=function(d,e){var f=b.getUrlParams();if(f.s&&(i.gender=f.s),f.camera&&b.extend(i,c.setCamera(f.camera)),f.m||f.o){if(f.o){var g=c.setAnatomy(f.o,i.gender);b.extend(i,g)}if(f.m){var h=c.setModule(f.m,i.gender);b.extend(i,h)}if(f.chapter){var j=a.parseInt(f.chapter,10)-1;j===j&&(i.initialChapter=j)}f.lang&&b.extend(i,{lang:f.lang}),d(i)}else if(f.a)c.setPrettyAnatomy({input:f.a,gender:i.gender,generations:f.parent},function(a){d(i=a)},e);else if(f.b||f.be){var k=f.b?"b":"be";c.setBookmark(k,f[k],function(a){d(i=a)},e)}else d(i)},c.setLangTitle=function(a,b,c){f[a]=f[a]||{},f[a][c]=b},c.getLangTitle=function(a,b){return f.hasOwnProperty(a)?f[a][b]:null}}(window),function(a){function b(b,c,d,e,f){var g=a.Human,h=j(b,c,d);g.modules.load(b,h,e,f)}function c(c,d,e,f){var g=a.Human;e===d.initialChapter?g.modules.activate(c,r,{},function(){b(c,d,e,t,function(){b(c,d,e,u,function(){g.events.fire("module.interactive",{moduleId:c}),f()})})}):b(c,d,e,t,function(){b(c,d,e,u,function(){f()})})}function d(a,b,e,f){return q===k?void(f&&f()):void c(a,b,e,function(){q++,e++,e===k&&(e=0),d(a,b,e,f)})}function e(a,b){var c=a.camera||a.flyTo||a.jumpTo;c&&m.extend(c,b)}function f(a,b,c,d){"en"===a?setTimeout(function(){d(c)},0):g(a,b,function(a){h(c,a),d(c)},function(){d(c)})}function g(a,b,c,d){var e;if(p[a]&&(e=p[a][b]),e)setTimeout(function(){c(e)},0);else{var f=["/tr",a,b].join("/"),g=new XMLHttpRequest;g.onreadystatechange=function(){2===this.readyState&&200!==this.status&&g.abort(),4===this.readyState&&(200===this.status?(e=JSON.parse(g.responseText),p[a]=p[a]||{},p[a][b]=e,c(e)):d())},g.open("GET",f,!0),g.send()}}function h(a,b){var c=b.iso_639_1,d=a.chapters||[],e=a.sceneGraph||[],f=b.objects||{},g=b.chapters||[],h=["displayName","title","description"],i=function(a,b){"object"==typeof a&&"object"==typeof b&&h.forEach(function(d){var e;if(e="displayName"===d?b.displayName||b.title:b[d],a.hasOwnProperty(d)&&e){var f=a[d];a[d]=e,o.setLangTitle(c,f,e)}})};i(a,b);var j=function(a){var b=a.objectId,c=f[b];c&&i(a,{displayName:c}),a.objects&&a.objects.forEach(j)};e.forEach(function(a){var b=a.objects||[];b.forEach(j)}),d.forEach(function(a,b){var c=g[b];if(c){i(a,c);var d=a.annotations||[],e=c.annotations||[];d.forEach(function(a,b){var c=e[b];c&&i(a,c)});var f=a.hotspots||[],h=c.hotspots||[];f.forEach(function(a,b){var c=h[b];c&&i(a,c)})}});var k=a.hotspots||[],l=b.hotspots||[];k.forEach(function(a,b){var c=l[b];c&&i(a,c)})}function i(b){var c={};for(var d in b)if(b.hasOwnProperty(d)){var e=a.Human.modules.convertBaseAnatomyObjectId(d);c[e]=b[d]}return c}function j(b,c,d){var e=a.Human.modules.modules[b],f=[],g={};g=Object.keys(c.baseAnatomyObjects).length>0?i(c.baseAnatomyObjects):"number"==typeof d?e.chapters[d].showObjects:e.showObjects;for(var h in g)g.hasOwnProperty(h)&&g[h]&&a.Human.scene.objects[h]&&f.push(a.Human.scene.objects[h]);return f}var k,l,m=a.HumanScene,n=m.sceneGraph={},o=m.content,p={},q=0,r=0,s=["reflections","lights"],t=["material","geometry","transform"],u=["tweens","morph"];n.reset=function(){var b=a.Human,c=m.content.get();if(c.bookmark)b.bookmarks.restore(c.bookmark);else{var d=b.timeline.activeRoot._nowBranch,e=b.timeline.activeRoot._chapters[0];d===e?e.init(0,{camera:!0,annotations:!0,properties:!0,graph:!0,particles:!0},function(){}):b.timeline.scrub({time:0})}},n.load=function(b,c,f){var g,h,i=a.Human;if(b.bookmark)i.bookmarks.restore(b.bookmark,c);else if(b.id){g=b.id;var j=function(){h=JSON.parse(JSON.stringify(i.modules.moduleData[g])),b.camera&&h.chapters[0]&&e(h.chapters[0],b.camera),i.modules.create(g,h,function(){i.modules.load(g,[],s,function(){var e=a.Human.timeline.rootTimelines[g];k=h.chapters.length,l=e._chapters[b.initialChapter],r=e._times[b.initialChapter],d(g,b,b.initialChapter,c)})})},m=function(){f&&f()};b.moduleData?(b.moduleData.moduleId=b.id,i.modules.moduleData[b.id]=b.moduleData,setTimeout(j,0)):n.fetchModule(b,j,m)}else c()},n.initTimeline=function(b){var c=a.Human,d=c.modules.modules[b.id].animation;0===r&&d&&!c.utils.isEmpty(d)?c.timeline.play(d):l.animation&&l.animation.loop&&c.timeline.play({startChapterId:l.id,loop:!0,numChapters:1})},n.stage=function(b){if(b.id){var c=a.Human;b.bookmark||c.timeline.time!==r||n.initTimeline(b);var d=Number(c.request.getSearchParam("load-rotate"));if(d){var e,f=a.document.getElementById(c.containerId||c.CONTAINER_ID),g=function(a){e=a.timeNow-a.timeLast,c.view.camera.rotateY(d*e*.001)},h=function(){c.events.off("tick",g),f.removeEventListener("mousedown",h),f.removeEventListener("touchstart",h)};c.events.on("tick",g),f.addEventListener("mousedown",h),f.addEventListener("touchstart",h)}if(m.getUrlParams().o&&Object.keys(b.baseAnatomyObjects).length>0){var j=i(b.baseAnatomyObjects);c.scene.setEnabledObjects({objects:j}),c.view.camera.fly.flyTo({enabledObjects:!0})}}},n.fetchModule=function(b,c,d){var e=b.id,g=b.lang||"en";if("en"===g)a.Human.modules.fetch(e,c,d);else{var h=function(){var b=a.Human.modules.moduleData[e];f(g,e,b,c)};a.Human.modules.fetch(e,h,d)}}}(window);